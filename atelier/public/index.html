<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Formulaire Atelier – Rectification / Contrôle injecteurs</title>
  <style>
    :root{ --primary:#004080; --accent:#00a7e1; --ink:#073763; --bg:#ffffff; --line:#e5e7eb; }
    *{box-sizing:border-box}
    body{margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; background:#fff; color:var(--ink)}
    .wrap{max-width:960px; margin:24px auto; padding:16px}
    h1{margin:0 0 12px; font-size:1.4rem; color:var(--primary)}
    form{background:#fff; border:1px solid var(--line); border-radius:10px; padding:16px; box-shadow:0 4px 18px rgba(0,0,0,.04)}
    .grid{display:grid; gap:14px}
    @media(min-width:720px){ .grid-2{grid-template-columns:1fr 1fr} }
    label{display:block; font-weight:600; margin:4px 0 6px}
    input, select, textarea{ width:100%; padding:10px 12px; border:1px solid var(--line); border-radius:8px; font-size:1rem; background:#fff }
    textarea{ min-height:120px; resize:vertical }
    .section-title{margin-top:14px; padding-top:10px; border-top:1px dashed var(--line); font-weight:700; color:#0f172a}
    .hidden{display:none}
    .actions{margin-top:16px; display:flex; gap:10px; flex-wrap:wrap}
    button{appearance:none; border:0; border-radius:10px; padding:12px 16px; font-weight:700; cursor:pointer}
    .primary{background:var(--primary); color:#fff}
    .ghost{background:transparent; color:var(--primary); border:1px solid var(--primary)}
    #culasse-lignes{display:grid; gap:10px; margin-top:10px}
    .culasse-row{ display:grid; grid-template-columns:auto 1fr; gap:10px; align-items:center; padding:8px 10px; border:1px solid var(--line); border-radius:8px; background:#fafafa; }
    .culasse-row .refs{grid-column:1 / -1; font-size:0.95rem; color:#0f172a}
    .culasse-row input[type="checkbox"]{width:18px; height:18px}
    .pieces-list{display:grid; gap:10px; margin-top:10px}
    .piece-item{ display:grid; grid-template-columns:auto 1fr; gap:10px; align-items:center; padding:8px 10px; border:1px solid var(--line); border-radius:8px; background:#f8fafc; }

    .pdfMask{position:fixed; inset:0; background:#0008; display:none; align-items:center; justify-content:center; z-index:10000; padding:20px}
    .pdfBox{width:min(900px,96vw); height:min(90vh,800px); background:#fff; border-radius:14px; overflow:hidden; display:flex; flex-direction:column; border:1px solid var(--line)}
    .pdfBar{display:flex; align-items:center; justify-content:space-between; padding:8px 12px; border-bottom:1px solid var(--line); background:#f8fbff}
    .pdfBar .actions{display:flex; gap:8px}
    #pdfFrame{flex:1; width:100%; border:0}
    #printForm{display:none}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Demande d’intervention</h1>

    <form id="form-atelier" novalidate>
      <div class="grid grid-2">
        <div>
          <label for="client">Nom du client</label>
          <input id="client" name="client" type="text" required />
        </div>
        <div>
          <label for="compte">N° de compte</label>
          <input id="compte" name="compte" type="text" />
        </div>
      </div>

      <div class="grid grid-2">
        <div>
          <label for="telephone">Téléphone</label>
          <input id="telephone" name="telephone" type="tel" inputmode="tel" />
        </div>
        <div>
          <label for="email">Adresse mail</label>
          <input id="email" name="email" type="email" />
        </div>
      </div>

      <div class="grid grid-2">
        <div>
          <label for="vehicule">Marque et modèle du véhicule</label>
          <input id="vehicule" name="vehicule" type="text" />
        </div>
        <div>
          <label for="immat">Immatriculation</label>
          <input id="immat" name="immat" type="text" />
        </div>
      </div>

      <div class="grid grid-2">
        <div>
          <label for="dateDemande">Date de la demande</label>
          <input id="dateDemande" name="dateDemande" type="date" required />
        </div>
        <div>
          <label for="magasin">Magasin d'envoi</label>
          <select id="magasin" name="magasin" required>
            <option value="" selected disabled>-- Sélectionnez un magasin --</option>
            <option value="Gleizé">Gleizé</option>
            <option value="Miribel">Miribel</option>
            <option value="Seynod">Seynod</option>
            <option value="Annemasse">Annemasse</option>
          </select>
        </div>
      </div>

      <div class="grid">
        <div>
          <label for="service">Service</label>
          <select id="service" name="service" required>
            <option value="" selected disabled>-- Choisissez un service --</option>
            <option value="Rectification Culasse">Rectification Culasse</option>
            <option value="Contrôle injection Diesel">Contrôle injection Diesel</option>
  <option value="Contrôle injection Essence">Contrôle injection Essence</option>
          </select>
        </div>
      </div>

      <!-- Bloc détails Rectification Culasse -->
      <div id="section-culasse" class="hidden" aria-hidden="true">
        <div class="section-title">Détails Rectification Culasse</div>

        <div class="grid grid-2">
          <div>
            <label for="cylindre">Cylindre</label>
            <select id="cylindre" name="cylindre">
              <option value="" selected disabled>-- Nb de cylindres --</option>
              <option>1</option><option>2</option><option>3</option><option>4</option>
              <option>5</option><option>6</option><option>7</option><option>8</option>
            </select>
          </div>

          <div>
            <label for="soupapes">Soupapes</label>
            <select id="soupapes" name="soupapes">
              <option value="" selected disabled>-- Nb de soupapes --</option>
              <option>2</option><option>4</option><option>8</option><option>16</option><option>24</option>
            </select>
          </div>
        </div>

        <div class="grid grid-2">
          <div>
            <label for="carburant">Carburant</label>
            <select id="carburant" name="carburant">
              <option value="" selected disabled>-- Type de carburant --</option>
              <option>Essence</option>
              <option>Diesel</option>
            </select>
          </div>
        </div>

        <p class="help">Coche les opérations à réaliser. Les références s’affichent quand Cylindre, Soupapes et Carburant sont renseignés.</p>

        <div id="culasse-lignes"></div>

        <div class="section-title">Pièces à Fournir</div>
        <div class="pieces-list" id="pieces-a-fournir">
          <label class="piece-item"><input type="checkbox" name="pieces[]" value="Joint de culasse"><span>Joint de culasse</span></label>
          <label class="piece-item"><input type="checkbox" name="pieces[]" value="Pochette rodage"><span>Pochette rodage</span></label>
          <label class="piece-item"><input type="checkbox" name="pieces[]" value="Joint d'injecteur"><span>Joint d'injecteur</span></label>
        </div>
      </div>

      <!-- Bloc détails Injecteur (visible pour Diesel/Essence) -->
      <div id="section-injecteur" class="hidden" aria-hidden="true">
        <div class="section-title">Détails Contrôle injection</div>
        <div class="grid grid-2">
          <div>
            <label for="nbInjecteurs">Nombre d’injecteurs</label>
            <input id="nbInjecteurs" name="nbInjecteurs" type="number" inputmode="numeric" min="1" step="1" placeholder="Ex. 4" />
          </div>
        </div>
      </div>

      <div class="section-title">Commentaires</div>
      <div>
        <label for="commentaires">Commentaires (optionnel)</label>
        <textarea id="commentaires" name="commentaires" rows="4" placeholder="Vos remarques..."></textarea>
      </div>

      <div class="actions">
        <button type="submit" class="primary">Envoyer</button>
        <button type="reset" class="ghost">Réinitialiser</button>
      </div>
    </form>
  </div>

  <!-- (conservé pour l’aperçu iframe) -->
  <div class="pdfMask" id="pdfMask" aria-hidden="true">
    <div class="pdfBox" role="dialog" aria-label="Aperçu">
      <div class="pdfBar">
        <div style="font-weight:700">Aperçu d’impression</div>
        <div class="actions">
          <button class="ghost" id="pdfReprint" type="button">Imprimer</button>
          <button class="ghost" id="pdfClose" type="button">Fermer</button>
        </div>
      </div>
      <iframe id="pdfFrame" name="pdfFrame" title="Aperçu"></iframe>
    </div>
  </div>
  <form id="printForm" method="POST" target="pdfFrame"><input type="hidden" name="payload" /></form>

  <script>
  const APPSCRIPT_URL = "https://script.google.com/macros/s/AKfycbw4nDGGUaIxrFxukfv-OjJyQ3GoXAtP4IUcttsfg5vevY0fYsPsp5GR2RytyKns1YKHeQ/exec";

  let LIGNES = [], REGLES = [];
  const el = id => document.getElementById(id);
  const allCulasseChosen = () => el('cylindre').value && el('soupapes').value && el('carburant').value;

  async function loadConfig(){
    try{
      const r = await fetch(APPSCRIPT_URL, { cache:"no-store" });
      const data = await r.json();
      LIGNES = (data.lignes||[]).sort((a,b)=>(a.ordre||0)-(b.ordre||0));
      REGLES = data.regles || [];
      renderLignes(); refreshReferences();
    }catch(e){
      console.error(e);
      el('culasse-lignes').innerHTML = '<div style="color:#b91c1c;font-weight:700">Erreur de chargement Sheets.</div>';
    }
  }

  function renderLignes(){
    const host = el('culasse-lignes'); host.innerHTML='';
    LIGNES.forEach(l=>{
      const row=document.createElement('div'); row.className='culasse-row'; row.dataset.ligne=l.ligne;
      const input=document.createElement('input'); input.type='checkbox'; input.name='ligne_'+l.ligne; input.id='input_'+l.ligne;
      const label=document.createElement('label'); label.htmlFor=input.id; label.textContent=l.libelle||l.ligne;
      const refs=document.createElement('div'); refs.className='refs'; refs.id='refs_'+l.ligne;
      input.addEventListener('change', refreshReferences);
      row.append(input,label,refs); host.appendChild(row);
    });
  }

  function matchRegles(service, cyl, soup, carb, ligne){
    const cand = REGLES.filter(r =>
      String(r.ligne).toUpperCase() === String(ligne).toUpperCase() &&
      String(r.service).toLowerCase() === String(service).toLowerCase()
    );
    const score = r => {
      let s=0;
      s += (String(r.cylindres)===String(cyl))?1:(r.cylindres==='*'?0:-999);
      s += (String(r.soupapes)===String(soup))?1:(r.soupapes==='*'?0:-999);
      s += (String(r.carburant).toLowerCase()===String(carb).toLowerCase())?1:(r.carburant==='*'?0:-999);
      return s;
    };
    return cand.map(r=>({r,s:score(r)})).filter(x=>x.s>=0).sort((a,b)=>b.s-a.s).map(x=>x.r);
  }

  function refreshReferences(){
    if (el('service').value !== 'Rectification Culasse') return;
    const cyl = el('cylindre').value, soup = el('soupapes').value, carb = el('carburant').value;
    const ready = allCulasseChosen();
    LIGNES.forEach(l=>{
      const holder = el('refs_'+l.ligne), cb = el('input_'+l.ligne);
      if(!holder||!cb) return;
      if(!cb.checked || !ready){ holder.textContent=''; return; }
      const regles = matchRegles('culasse', cyl, soup, carb, l.ligne);
      if(!regles.length){ holder.textContent=''; return; }
      holder.innerHTML = '<ul style="margin:6px 0 0; padding-left:18px;">' +
        regles.map(r =>
          `<li><strong>${r.reference||''}</strong>${r.libelleref? ' – '+r.libelleref : ''}${(r.prixht||r.prixht===0)?' ('+String(r.prixht)+' € HT)':''}</li>`
        ).join('') + '</ul>';
    });
  }

  function toggleCulasseFields(){
    const service = el('service').value;

    // Culasse
    const isC = service === 'Rectification Culasse';
    const blocC = el('section-culasse');
    blocC.classList.toggle('hidden', !isC);
    blocC.setAttribute('aria-hidden', isC ? 'false' : 'true');
    el('cylindre').required = el('soupapes').required = el('carburant').required = isC;
    if(!isC){ LIGNES.forEach(l=>{ const e=el('refs_'+l.ligne); if(e) e.textContent=''; }); }
    else refreshReferences();

    // Injecteur
    const isInj = (service === 'Contrôle injection Diesel' || service === 'Contrôle injection Essence');
  const blocI = el('section-injecteur');
  blocI.classList.toggle('hidden', !isInj);
  blocI.setAttribute('aria-hidden', isInj ? 'false' : 'true');
  el('nbInjecteurs').required = isInj;
}

  el('service').addEventListener('change', toggleCulasseFields);
  ['cylindre','soupapes','carburant'].forEach(id => el(id).addEventListener('change', refreshReferences));

  const $pdfMask = el('pdfMask'), $pdfFrame = el('pdfFrame'), $printForm = el('printForm'),
        $pdfClose = el('pdfClose'), $pdfReprint = el('pdfReprint');

  function openPrintPreview(payload){
    $printForm.action = "/atelier/api/print-html";
    $printForm.querySelector('[name="payload"]').value = JSON.stringify(payload);
    $pdfFrame.src = 'about:blank';
    $pdfMask.style.display = 'flex';
    $pdfMask.setAttribute('aria-hidden','false');
    $printForm.submit();
  }
  $pdfClose.addEventListener('click', ()=>{
    $pdfMask.style.display='none';
    $pdfMask.setAttribute('aria-hidden','true');
    $pdfFrame.src='about:blank';
  });
  $pdfReprint.addEventListener('click', ()=>{ try{ $pdfFrame.contentWindow?.focus(); $pdfFrame.contentWindow?.print(); }catch{} });

<script>

document.getElementById('form-atelier').addEventListener('submit', async (e)=>{
  e.preventDefault();

  const fd = new FormData(e.target);
  const data = Object.fromEntries(fd.entries());
  const pieces = Array.from(document.querySelectorAll('#pieces-a-fournir input[type="checkbox"]:checked')).map(x => x.value);

  const ops = [];
  const service = el('service').value;
  if (service === 'Rectification Culasse') {
    const cyl = el('cylindre').value, soup = el('soupapes').value, carb = el('carburant').value;
    LIGNES.forEach(l=>{
      const cb = el('input_'+l.ligne);
      if (cb && cb.checked) {
        const regles = matchRegles('culasse', cyl, soup, carb, l.ligne);
        ops.push({
          ligne: l.ligne,
          libelle: l.libelle || l.ligne,
          references: regles.map(r => ({
            reference: r.reference,
            libelleRef: r.libelleref || '',
            prixHT: (r.prixht || r.prixht===0) ? r.prixht : null
          }))
        });
      }
    });
  }

  const commentaires = (el('commentaires').value || '').trim();

  let injecteur = null;
  if (service === 'Contrôle injection Diesel' || service === 'Contrôle injection Essence') {
    injecteur = {
      type: service === 'Contrôle injection Diesel' ? 'Diesel' : 'Essence',
      nombre: (el('nbInjecteurs').value || '').trim()
    };
  }

  const payload = {
    meta: {
      titre: service,
      logoUrl: "https://raw.githubusercontent.com/docudurand/mes-formulaires/main/logodurand.png",
      dateGeneration: new Date().toISOString()
    },
    header: {
      client: data.client || '',
      compte: data.compte || '',
      telephone: data.telephone || '',
      email: data.email || '',
      vehicule: data.vehicule || '',
      immat: data.immat || '',
      dateDemande: data.dateDemande || '',
      magasin: data.magasin || '',
      service: service
    },
    commentaires,
    injecteur,
    culasse: (service === 'Rectification Culasse') ? {
      cylindre: el('cylindre').value || '',
      soupapes: el('soupapes').value || '',
      carburant: el('carburant').value || '',
      operations: ops,
      piecesAFournir: pieces
    } : null
  };

  let no = "";
  try{
    const r = await fetch("/atelier/api/submit", {
      method:"POST",
      headers: { "Content-Type":"application/json" },
      body: JSON.stringify({ payload })
    });
    const js = await r.json();
    if(!r.ok || !js.ok){ alert("Erreur d'enregistrement."); return; }
    no = js.no;
  }catch(err){
    console.error(err);
    alert("Erreur réseau lors de l'enregistrement.");
    return;
  }

  const payloadForPrint = { ...payload, no };
  openPrintPreview(payloadForPrint);
});
</script>
</body>
</html>
