<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Suivi des dossiers Atelier</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --primary:#004080;
      --accent:#00a7e1;
      --ink:#073763;
      --bg:#ffffff;
      --line:#e5e7eb;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background:#f3f4f6;
      color:var(--ink);
    }
    .wrap{
      max-width:1100px;
      margin:24px auto;
      padding:16px;
    }
    h1{
      margin:0 0 4px;
      font-size:1.5rem;
      color:var(--primary);
    }
    .subtitle{
      margin:0 0 16px;
      color:#6b7280;
      font-size:.95rem;
    }
    .card{
      background:#fff;
      border-radius:10px;
      border:1px solid var(--line);
      box-shadow:0 4px 18px rgba(0,0,0,.04);
      padding:12px 12px 16px;
    }
    table{
      width:100%;
      border-collapse:collapse;
      font-size:.9rem;
    }
    thead th{
      text-align:left;
      padding:8px 6px;
      border-bottom:2px solid var(--line);
      background:#f9fafb;
      white-space:nowrap;
    }
    tbody td{
      padding:6px 6px;
      border-bottom:1px solid #e5e7eb;
      vertical-align:middle;
    }
    tbody tr:nth-child(even){
      background:#f9fafb;
    }
    .status-badge{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      padding:2px 8px;
      border-radius:999px;
      font-size:.75rem;
      font-weight:600;
      background:#e5e7eb;
      color:#111827;
    }
    .status-badge.en-cours{ background:#fef3c7; color:#92400e;}
    .status-badge.piece-recu{ background:#d1fae5; color:#065f46;}
    .status-badge.renvoye{ background:#e0f2fe; color:#1e40af;}
    .status-badge.autre{ background:#e5e7eb; color:#111827;}

    .estimation-input{
      width:80px;
      padding:4px 6px;
      border-radius:6px;
      border:1px solid #d1d5db;
      font-size:.85rem;
      text-align:right;
    }
    select.status-select{
      padding:4px 6px;
      border-radius:6px;
      border:1px solid #d1d5db;
      font-size:.85rem;
    }
    button{
      appearance:none;
      border-radius:999px;
      border:0;
      padding:6px 12px;
      font-weight:600;
      font-size:.85rem;
      cursor:pointer;
    }
    .btn-primary{
      background:var(--primary);
      color:#fff;
    }
    .btn-ghost{
      background:#fff;
      color:var(--primary);
      border:1px solid var(--primary);
    }
    .toolbar{
      display:flex;
      gap:8px;
      align-items:center;
      margin-bottom:10px;
      flex-wrap:wrap;
      font-size:.85rem;
    }
    .toolbar label{
      font-weight:600;
      margin-right:4px;
    }
    .toolbar select{
      padding:4px 6px;
      border-radius:6px;
      border:1px solid #d1d5db;
      font-size:.85rem;
    }
    .msg-global{
      margin-top:10px;
      font-size:.9rem;
      min-height:1.2em;
    }
    .msg-ok{color:#16a34a;}
    .msg-err{color:#b91c1c;}

    .loginOverlay{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,0.35);
      display:flex;
      align-items:center;
      justify-content:center;
      z-index:10000;
    }
    .loginBox{
      background:#fff;
      padding:20px 24px;
      border-radius:12px;
      box-shadow:0 4px 18px rgba(0,0,0,.2);
      max-width:320px;
      width:100%;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    }
    .loginBox h2{
      margin:0 0 8px;
      font-size:1.1rem;
      color:#004080;
      text-align:center;
    }
    .loginBox p{
      margin:0 0 10px;
      font-size:.9rem;
      color:#555;
      text-align:center;
    }
    .loginBox input{
      width:100%;
      padding:8px 10px;
      border-radius:8px;
      border:1px solid #d1d5db;
      font-size:1rem;
      margin-bottom:10px;
    }
    .loginBox button{
      width:100%;
      padding:9px 12px;
      border-radius:999px;
      border:0;
      background:#004080;
      color:#fff;
      font-weight:700;
      cursor:pointer;
      font-size:.95rem;
    }
    .loginBox .error{
      margin-top:8px;
      font-size:.85rem;
      color:#b91c1c;
      text-align:center;
      min-height:1.1em;
    }
    .loader{
      width:16px;height:16px;
      border-radius:50%;
      border:2px solid #e5e7eb;
      border-top-color:#004080;
      animation:spin 1s linear infinite;
      display:inline-block;
      vertical-align:middle;
      margin-right:6px;
    }
    @keyframes spin{to{transform:rotate(360deg)}}
  </style>
</head>
<body>
  <!-- Overlay mot de passe -->
  <div class="loginOverlay" id="suiviLoginOverlay">
    <div class="loginBox">
      <h2>Accès suivi atelier</h2>
      <p>Veuillez saisir votre mot de passe.</p>
      <input type="password" id="suiviPassword" placeholder="Mot de passe" />
      <button type="button" id="suiviLoginBtn">Se connecter</button>
      <div class="error" id="suiviError"></div>
    </div>
  </div>

  <div class="wrap">
    <h1>Suivi des dossiers Atelier</h1>
    <p class="subtitle">
      Consultation et mise à jour des dossiers envoyés à l’atelier.
    </p>

    <div class="card">
      <div class="toolbar">
        <div>
          <label for="filterStatus">Filtrer par statut :</label>
          <select id="filterStatus">
            <option value="">Tous</option>
            <option value="Demande envoyé">Demande envoyé</option>
            <option value="En cours">En cours</option>
            <option value="Pièce reçu">Pièce reçu</option>
            <option value="Renvoyé">Renvoyé</option>
          </select>
        </div>
        <div>
          <label for="filterMagasin">Magasin :</label>
          <select id="filterMagasin">
            <option value="">Tous</option>
          </select>
        </div>
      </div>

      <div style="overflow:auto;">
        <table id="table-suivi">
          <thead>
            <tr>
              <th>N° dossier</th>
              <th>Magasin</th>
              <th>Compte</th>
              <th>Client</th>
              <th>Service</th>
              <th>Date demande</th>
              <th>Statut</th>
              <th>Estimation Temps Travaux (Jours)</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="tbody-suivi">
            <tr><td colspan="9">Chargement en cours…</td></tr>
          </tbody>
        </table>
      </div>

      <div id="globalMsg" class="msg-global"></div>
    </div>
  </div>

  <script src="/atelier/config.js"></script>

  <script>
  const cfg = window.__ATELIER_CFG || {};
  const API_BASE =
    (location.hostname.includes("wixsite.com") || location.hostname.endsWith(".wix.com"))
      ? "https://mes-formulaires.onrender.com"
      : location.origin.replace(/\/$/, "");

  const PASS_FULL    = cfg.SUIVI_PASS_FULL    || "";
  const PASS_LIMITED = cfg.SUIVI_PASS_LIMITED || "";

  const $overlay   = document.getElementById("suiviLoginOverlay");
  const $pwdInput  = document.getElementById("suiviPassword");
  const $btnLogin  = document.getElementById("suiviLoginBtn");
  const $errBox    = document.getElementById("suiviError");
  const $tbody     = document.getElementById("tbody-suivi");
  const $filterStatus  = document.getElementById("filterStatus");
  const $filterMagasin = document.getElementById("filterMagasin");
  const $globalMsg = document.getElementById("globalMsg");
  const $table     = document.getElementById("table-suivi");

  let ALL_CASES = [];
  let LIMITED_VIEW = false;

  function setGlobalMsg(text, ok){
    $globalMsg.textContent = text || "";
    $globalMsg.className = "msg-global" + (text ? (ok ? " msg-ok" : " msg-err") : "");
  }

  function hideColumnByHeader(table, headerText){
    if (!table) return;
    const ths = table.querySelectorAll("thead th");
    let idx = -1;
    ths.forEach(function(th,i){
      if (th.textContent.trim() === headerText.trim()){
        idx = i;
      }
    });
    if (idx === -1) return;
    ths[idx].style.display = "none";
    table.querySelectorAll("tbody tr").forEach(function(tr){
      if (tr.children[idx]) tr.children[idx].style.display = "none";
    });
  }

  function applyLimitedView(){
    LIMITED_VIEW = true;
    hideColumnByHeader($table, "Estimation Temps Travaux (Jours)");
    hideColumnByHeader($table, "Actions");
    const btns = document.querySelectorAll('button[data-role="validate"]');
    btns.forEach(b => b.style.display = "none");
  }

  function doLogin(){
    const pwd = ($pwdInput.value || "").trim();
    $errBox.textContent = "";

    if (PASS_FULL && pwd === PASS_FULL){
      $overlay.style.display = "none";
      document.body.style.overflow = "";
      return;
    }
    if (PASS_LIMITED && pwd === PASS_LIMITED){
      applyLimitedView();
      $overlay.style.display = "none";
      document.body.style.overflow = "";
      return;
    }

    $errBox.textContent = "Mot de passe incorrect.";
  }

  $btnLogin.addEventListener("click", doLogin);
  $pwdInput.addEventListener("keydown", function(e){
    if (e.key === "Enter"){
      e.preventDefault();
      doLogin();
    }
  });

  document.addEventListener("DOMContentLoaded", function(){
    if (!PASS_FULL && !PASS_LIMITED){
      $overlay.style.display = "none";
    } else {
      document.body.style.overflow = "hidden";
      $pwdInput.focus();
    }

    loadCases();
  });

  async function loadCases(){
    try{
      setGlobalMsg("", true);
      $tbody.innerHTML =
        '<tr><td colspan="9"><span class="loader"></span>Chargement en cours…</td></tr>';

      const resp = await fetch(API_BASE + "/atelier/api/cases");
      if (!resp.ok) throw new Error("HTTP " + resp.status);
      const js = await resp.json();
      ALL_CASES = (js && js.data) || [];

      populateMagasinFilter();
      renderCases();
    }catch(e){
      console.error(e);
      $tbody.innerHTML =
        '<tr><td colspan="9" style="color:#b91c1c;font-weight:600;">Erreur de chargement des dossiers.</td></tr>';
    }
  }

  function populateMagasinFilter(){
    const mags = new Set();
    ALL_CASES.forEach(c => {
      const m = (c.magasin || "").trim();
      if (m) mags.add(m);
    });
    const current = $filterMagasin.value;
    $filterMagasin.innerHTML = '<option value="">Tous</option>' +
      Array.from(mags).sort().map(m => '<option value="'+m+'">'+m+'</option>').join("");
    if (current) $filterMagasin.value = current;
  }

  function statusBadgeClass(st){
    const s = String(st || "").normalize("NFD").replace(/\p{Diacritic}/gu,"").toLowerCase();
    if (s === "demande envoye") return "";
    if (s === "en cours") return "en-cours";
    if (s === "piece recu") return "piece-recu";
    if (s === "renvoye") return "renvoye";
    return "autre";
  }

  function renderCases(){
    const fStatus  = $filterStatus.value;
    const fMagasin = $filterMagasin.value;

    const rows = ALL_CASES.filter(c => {
      if (fStatus && String(c.status) !== fStatus) return false;
      if (fMagasin && String(c.magasin) !== fMagasin) return false;
      return true;
    });

    if (!rows.length){
      $tbody.innerHTML = '<tr><td colspan="9">Aucun dossier trouvé.</td></tr>';
      if (LIMITED_VIEW) applyLimitedView();
      return;
    }

    const html = rows.map(c => {
      const no = String(c.no || "").padStart(5,"0");
      const date = c.demandeDate || c.date;
      const est  = c.estimation || "";
      const h    = (c.snapshot && c.snapshot.header) || {};

      const client  = h.client  || c.client  || "";
      const compte  = h.compte  || c.compte  || "";
      const magasin = h.magasin || c.magasin || "";
      const service = h.service || c.service || "";
      const vehicule= h.vehicule || "";
      const statut  = c.status || "Demande envoyé";
      const badgeCls = statusBadgeClass(statut);

      return `
        <tr data-no="${no}">
          <td>${no}</td>
          <td>${magasin}</td>
          <td>${compte}</td>
          <td>${client}</td>
          <td>${service}</td>
          <td>${date || ""}</td>
          <td>
            <span class="status-badge ${badgeCls}">${statut}</span>
          </td>
          <td>
            <input class="estimation-input" type="number" min="0" step="1"
                   value="${est}" data-role="estimation" />
          </td>
          <td>
            <select class="status-select" data-role="status-select">
              <option value="Demande envoyé"${statut==="Demande envoyé"?" selected":""}>Demande envoyé</option>
              <option value="En cours"${statut==="En cours"?" selected":""}>En cours</option>
              <option value="Pièce reçu"${statut==="Pièce reçu"?" selected":""}>Pièce reçu</option>
              <option value="Renvoyé"${statut==="Renvoyé"?" selected":""}>Renvoyé</option>
            </select>
            <button type="button" class="btn-primary" data-role="validate">Valider</button>
          </td>
        </tr>`;
    }).join("");

    $tbody.innerHTML = html;

    $tbody.querySelectorAll('button[data-role="validate"]').forEach(btn => {
      btn.addEventListener("click", onClickValidateRow);
    });

    if (LIMITED_VIEW) applyLimitedView();
  }

  async function onClickValidateRow(ev){
    const btn = ev.currentTarget;
    const tr  = btn.closest("tr");
    if (!tr) return;

    const no = tr.getAttribute("data-no");
    const sel = tr.querySelector('select[data-role="status-select"]');
    const inp = tr.querySelector('input[data-role="estimation"]');

    const newStatus = sel ? sel.value : "En cours";
    const estVal = inp ? inp.value : "";

    btn.disabled = true;
    setGlobalMsg("Mise à jour du dossier " + no + "…", true);

    try{
      const resp = await fetch(
        API_BASE + "/atelier/api/cases/" + encodeURIComponent(no) + "/status",
        {
          method:"POST",
          headers:{ "Content-Type":"application/json" },
          body: JSON.stringify({
            status: newStatus,
            estimation: estVal === "" ? "" : Number(estVal)
          })
        }
      );
      if (!resp.ok) throw new Error("HTTP " + resp.status);

      const row = ALL_CASES.find(c => String(c.no).padStart(5,"0") === no);
      if (row){
        row.status = newStatus;
        row.estimation = estVal;
      }

      setGlobalMsg("Dossier " + no + " mis à jour.", true);
      renderCases();
    }catch(e){
      console.error(e);
      setGlobalMsg("Erreur lors de la mise à jour du dossier " + no + ".", false);
      btn.disabled = false;
    }
  }

  $filterStatus.addEventListener("change", renderCases);
  $filterMagasin.addEventListener("change", renderCases);
  </script>
</body>
</html>