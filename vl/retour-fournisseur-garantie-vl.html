<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Retour fournisseur et garantie VL</title>

  <link rel="stylesheet" href="../assets/style.css" />
  <link rel="icon" href="/assets/icons/favicon.ico" sizes="any">
  <link rel="icon" type="image/png" sizes="32x32" href="/assets/icons/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/assets/icons/favicon-16x16.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/assets/icons/apple-touch-icon.png">
  <link rel="manifest" href="/site.webmanifest">
  <meta name="theme-color" content="#e9efff">

  <style>
    .panel { width:min(1600px,100%); margin:0 auto; padding:18px 18px 26px; }

    .accordion{ border:1px solid #dfe5f5; border-radius:14px; background:#fff; overflow:hidden; }
    details{ border-bottom:1px solid #e6ebfb; }
    details:last-child{ border-bottom:0; }
    summary{
      list-style:none;
      cursor:pointer;
      user-select:none;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding:16px 16px;
      font-weight:800;
      background:#f3f6ff;
    }
    summary::-webkit-details-marker{ display:none; }
    .acc-title{ font-size:18px; }
    .acc-body{ padding:14px 16px 18px; }

    .status{ color:#444; font-weight:700; margin:8px 0 12px; }

    .mail-list{ display:grid; gap:8px; }
    .mail-row{
      display:grid;
      grid-template-columns: 240px 1fr;
      gap:12px;
      padding:10px 12px;
      border:1px solid #e6ebfb;
      border-radius:12px;
      background:#fff;
    }
    .mail-supplier{ font-weight:900; }
    .mail-value a{ color:var(--link); text-decoration:none; font-weight:800; }
    .mail-value a:hover{ text-decoration:underline; }

    .filter-row{
      display:flex;
      align-items:center;
      gap:12px;
      flex-wrap:wrap;
      margin:8px 0 10px;
    }
    .filter{
      flex:1;
      min-width:260px;
      background:#fff;
      border:1px solid #dfe5f5;
      border-radius:12px;
      padding:10px 12px;
      font-weight:700;
      outline:none;
    }
    .hint{ color:#666; font-weight:700; font-size:13px; }

    .table-wrap{
      border:1px solid #dfe5f5;
      border-radius:12px;
      overflow:hidden;
      background:#fff;
    }
    table{
      width:100%;
      border-collapse:collapse;
      font-size:14px;
    }
    thead th{
      position:sticky;
      top:0;
      background:#f3f6ff;
      z-index:2;
      text-transform:lowercase;
      font-weight:900;
      padding:10px 10px;
      border-bottom:1px solid #dfe5f5;
      text-align:center;
    }
    tbody td{
      padding:10px 10px;
      border-bottom:1px solid #eef2ff;
      vertical-align:top;
    }
    tbody tr:hover{ background:#fafbff; }
    .td-supplier{ font-weight:900; }
    .td-mail a{ color:var(--link); font-weight:800; text-decoration:none; }
    .td-mail a:hover{ text-decoration:underline; }
    .td-notes{ white-space:pre-wrap; }

    @media (max-width: 900px){
      .mail-row{ grid-template-columns: 1fr; }
    }
  </style>
</head>

<body>
<header class="topbar">
  <div class="brand-left">
    <a href="/index.html" class="brand-link" aria-label="Retour à l'accueil">
      <img src="https://raw.githubusercontent.com/docudurand/mes-formulaires/main/logo2.png" alt="Documents Durand">
    </a>
  </div>

  <nav class="nav" aria-label="Menus">
    <div class="menu" data-menu="pl">
      <button class="menu-btn" type="button">MENU PL</button>
      <div class="dropdown" role="menu" aria-label="Menu PL">
        <a href="../pl/formulaire-creation-reference-pl.html" role="menuitem">FORMULAIRE CREATION REFERENCE PL</a>
        <a href="../pl/fournisseur-pl.html" role="menuitem">FOURNISSEUR PL</a>
        <a href="../pl/liens-garantie-retour-pl.html" role="menuitem">LIENS FORMULAIRE GARANTIE ET RETOUR PL</a>
      </div>
    </div>

    <div class="menu" data-menu="vl">
      <button class="menu-btn is-active" type="button">MENU VL</button>
      <div class="dropdown" role="menu" aria-label="Menu VL">
        <a href="../vl/contact-fournisseur.html" role="menuitem">CONTACT FOURNISSEURS</a>
        <a href="../vl/retour-fournisseur-garantie-vl.html" role="menuitem">RETOUR FOURNISSEUR ET GARANTIE VL</a>
      </div>
    </div>

    <a class="menu-btn" href="/utilitaire/index.html">UTILITAIRE</a>
    <a class="menu-btn" href="/atelier/index.html">ATELIER</a>
    <a class="menu-btn" href="/gestion-garantie/index.html">GESTION GARANTIE</a>
  </nav>

  <div class="brand-right">
    <img src="https://raw.githubusercontent.com/docudurand/mes-formulaires/main/logod.png" alt="D" style="height:34px;">
  </div>
</header>

<main class="wrap">
  <section class="card">
    <div class="content">
      <div class="panel">
        <div class="accordion">

          <details open>
            <summary>
              <span class="acc-title">Mail Retour Fournisseurs</span>
              <span aria-hidden="true">▾</span>
            </summary>
            <div class="acc-body">
              <div id="mailStatus" class="status">Chargement…</div>
              <div class="mail-list" id="mailList"></div>
            </div>
          </details>

          <details open>
            <summary>
              <span class="acc-title">Contact Garantie</span>
              <span aria-hidden="true">▾</span>
            </summary>
            <div class="acc-body">
              <div class="filter-row">
                <input id="filterInput" class="filter" placeholder="Rechercher un fournisseur / email / note…" />
                <div class="hint">Astuce : tape “BOSCH”, “@”, “hub”, etc.</div>
              </div>

              <div id="tableStatus" class="status">Chargement…</div>

              <div class="table-wrap">
                <table>
                  <thead>
                    <tr>
                      <th>fournisseur</th>
                      <th>contact suivie</th>
                      <th>contact demande</th>
                      <th>contact commercial</th>
                      <th>notes</th>
                    </tr>
                  </thead>
                  <tbody id="contactsTbody"></tbody>
                </table>
              </div>
            </div>
          </details>

        </div>
      </div>
    </div>
  </section>
</main>

<script>
  window.__SITE_PREFIX__ = "../";
</script>
<script src="../assets/auth.js"></script>
<script>requireAuth();</script>
<script src="../assets/app.js"></script>

<script>
(function(){
  const API_URL = "/api/vl/retour-garantie";

  const mailStatus = document.getElementById("mailStatus");
  const mailList   = document.getElementById("mailList");

  const tableStatus = document.getElementById("tableStatus");
  const tbody       = document.getElementById("contactsTbody");

  const filterInput = document.getElementById("filterInput");

  let contactsRows = [];

  function esc(s){
    return String(s ?? "")
      .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
      .replaceAll('"',"&quot;").replaceAll("'","&#039;");
  }

  function mailLink(email){
    const e = String(email||"").trim();
    if (!e) return "";
    const safe = esc(e);
    return `<a href="mailto:${safe}">${safe}</a>`;
  }

  function renderMailRetours(list){
    mailList.innerHTML = "";
    if (!Array.isArray(list) || !list.length){
      mailStatus.textContent = "Aucune donnée.";
      return;
    }
    mailStatus.textContent = `${list.length} ligne(s).`;
    for (const row of list){
      const f = (row?.fournisseur ?? "").toString().trim();
      const e = (row?.email ?? "").toString().trim();
      const el = document.createElement("div");
      el.className = "mail-row";
      el.innerHTML = `
        <div class="mail-supplier">${esc(f)} :</div>
        <div class="mail-value">${mailLink(e)}</div>
      `;
      mailList.appendChild(el);
    }
  }

  function norm(s){ return String(s||"").toLowerCase(); }

  function rowText(r){
    return [
      r.fournisseur, r.contactSuivie, r.contactDemande, r.contactCommercial, r.notes
    ].map(x=>String(x||"")).join(" ").toLowerCase();
  }

  function renderContacts(rows){
    tbody.innerHTML = "";
    if (!Array.isArray(rows) || !rows.length){
      tableStatus.textContent = "Aucune donnée.";
      return;
    }
    tableStatus.textContent = `${rows.length} ligne(s).`;

    for (const r of rows){
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td class="td-supplier">${esc(r.fournisseur||"")}</td>
        <td class="td-mail">${r.contactSuivie ? mailLink(r.contactSuivie) : ""}</td>
        <td class="td-mail">${r.contactDemande ? mailLink(r.contactDemande) : ""}</td>
        <td class="td-mail">${r.contactCommercial ? mailLink(r.contactCommercial) : ""}</td>
        <td class="td-notes">${esc(r.notes||"")}</td>
      `;
      tbody.appendChild(tr);
    }
  }

  function applyFilter(){
    const q = norm(filterInput.value).trim();
    if (!q) return renderContacts(contactsRows);
    const filtered = contactsRows.filter(r => rowText(r).includes(q));
    renderContacts(filtered);
  }

  async function load(){
    mailStatus.textContent = "Chargement…";
    tableStatus.textContent = "Chargement…";
    try{
      const r = await fetch(API_URL, { cache:"no-store" });
      if (!r.ok) throw new Error("HTTP " + r.status);
      const data = await r.json();

      renderMailRetours(data?.mailRetour || []);
      contactsRows = Array.isArray(data?.contactsGarantie) ? data.contactsGarantie : [];
      renderContacts(contactsRows);

      filterInput.addEventListener("input", applyFilter);

    }catch(e){
      console.error(e);
      mailStatus.textContent = "❌ Impossible de charger les données.";
      tableStatus.textContent = "❌ Impossible de charger les données.";
    }
  }

  load();
})();
</script>
</body>
</html>
