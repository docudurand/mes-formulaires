<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <title>Clôturer un prêt</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;margin:0;padding:16px;color:#073763}
    .card{max-width:560px;margin:0 auto;background:#fff;border:1px solid #e5e7eb;border-radius:14px;padding:16px;box-shadow:0 6px 18px #0001}
    h1{font-size:1.1rem;margin:0 0 8px}
    label{display:block;font-weight:600;margin-top:10px}
    input,button{width:100%;padding:10px 12px;border:1px solid #e5e7eb;border-radius:10px}
    button{background:#004080;color:#fff;font-weight:700;margin-top:12px;border:0}
    .notice{margin-top:10px;font-size:.95rem}
  </style>
</head>
<body>
  <div class="card">
    <h1>Clôturer le prêt</h1>
    <div id="info" style="opacity:.85"></div>
    <label for="date">Date retour</label>
    <input id="date" type="date">
    <label for="time">Heure retour</label>
    <input id="time" type="time">
    <label for="receptionnaire">Réceptionnaire</label>
    <input id="receptionnaire" type="text" placeholder="Nom réceptionnaire">
    <button id="ok">Valider la clôture</button>
    <div class="notice" id="notice"></div>
  </div>

  <script>
    const BASE_URL = '/pret/api';
    const qp = new URLSearchParams(location.search);
    const loanId = qp.get('loan_id') || '';
    const immat = qp.get('immat') || '';

    const $info = document.getElementById('info');
    const $date = document.getElementById('date');
    const $time = document.getElementById('time');
    const $recept = document.getElementById('receptionnaire');
    const $notice = document.getElementById('notice');
    const $ok = document.getElementById('ok');

    const now=new Date(), p2=n=>String(n).padStart(2,'0');
    $date.value=`${now.getFullYear()}-${p2(now.getMonth()+1)}-${p2(now.getDate())}`;
    $time.value=`${p2(now.getHours())}:${p2(now.getMinutes())}`;

    $info.textContent = immat ? `Véhicule : ${immat}` : 'Véhicule non précisé';

    $ok.addEventListener('click', async ()=>{
      if(!loanId){ $notice.textContent='Identifiant de prêt manquant.'; $notice.style.color='#c62828'; return; }
      try{
        $ok.disabled=true; $notice.textContent='Clôture en cours…'; $notice.style.color='#073763';
        const payload = { date_retour:$date.value, heure_retour:$time.value, receptionnaire_retour:$recept.value.trim() };
        const r = await fetch(`${BASE_URL}/loans/${encodeURIComponent(loanId)}/close`, { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload) });
        const j = await r.json(); if(!j.ok) throw new Error(j.error||'Erreur API');
        $notice.textContent = 'Prêt clôturé.'; $notice.style.color='#2e7d32';
      }catch(e){
        $notice.textContent = 'Échec : '+e.message; $notice.style.color='#c62828';
      }finally{ $ok.disabled=false; }
    });
  </script>
</body>
</html>
