<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Fiche prêt véhicule</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --primary:#004080; --accent:#00a7e1; --bg:#f5f9fc; --ink:#073763; --line:#e5e7eb; --ok:#2e7d32; --err:#c62828;
      --scale: 1.2; --bw: calc(1px * var(--scale));
    }
    *{box-sizing:border-box}
    html{font-size: calc(100% * var(--scale));}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:#fff;color:var(--ink)}
    .wrap{max-width: calc(960px * var(--scale)); margin: calc(24px * var(--scale)) auto; padding: calc(16px * var(--scale))}
    h1{font-size:1.6rem;margin:0 0 calc(6px * var(--scale));text-align:center}
    .sub{color:#445;opacity:.8;text-align:center;margin-bottom:calc(18px * var(--scale))}
    .card{background:#fff;border:var(--bw) solid var(--line);border-radius:calc(14px * var(--scale));padding:calc(16px * var(--scale));box-shadow:0 calc(6px * var(--scale)) calc(18px * var(--scale)) #0001}
    .row{display:grid;gap:calc(12px * var(--scale))}
    @media(min-width:680px){ .row.cols-2{grid-template-columns:1fr 1fr} .row.cols-3{grid-template-columns:1fr 1fr 1fr}}
    label{font-weight:600;margin-bottom:calc(4px * var(--scale));display:block}
    input,select,textarea{width:100%;padding:calc(10px * var(--scale)) calc(12px * var(--scale));border:var(--bw) solid var(--line);border-radius:calc(10px * var(--scale));background:#fff}
    select option[disabled]{color:#999}
    textarea{min-height:calc(84px * var(--scale));resize:vertical}
    .btns{display:flex;flex-wrap:wrap;gap:calc(10px * var(--scale));margin-top:calc(14px * var(--scale))}
    button{border:0;border-radius:calc(12px * var(--scale));padding:calc(10px * var(--scale)) calc(14px * var(--scale));cursor:pointer;font-weight:700}
    .btn{background:var(--primary);color:#fff}
    .btn-sec{background:#eef5ff;color:var(--primary);border:var(--bw) solid #d6e6ff}
    .btn-ghost{background:#fff;border:var(--bw) solid var(--line)}
    .hint{opacity:.8;margin-top:calc(6px * var(--scale))}
    .tag{display:inline-block;padding:calc(4px * var(--scale)) calc(8px * var(--scale));border-radius:999px;border:var(--bw) solid var(--line);background:#fafafa}
    .status-ok{color:var(--ok)} .status-err{color:var(--err)}
    .notice{margin-top:calc(8px * var(--scale))}
    .footer{margin-top:calc(20px * var(--scale));opacity:.9;text-align:center}
    .modalMask{position:fixed;inset:0;background:#0006;display:none;align-items:center;justify-content:center;padding:calc(20px * var(--scale));z-index:9999}
    .modal{background:#fff;border-radius:calc(14px * var(--scale));max-width:calc(520px * var(--scale));width:100%;padding:calc(16px * var(--scale));border:var(--bw) solid var(--line);box-shadow:0 calc(10px * var(--scale)) calc(24px * var(--scale)) #0003}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>DURAND SERVICES</h1>
    <div class="sub">Fiche prêt véhicule (Magasin)</div>

    <div class="card">
      <div class="row cols-2">
        <div>
          <label for="store">Magasin</label>
          <select id="store"></select>
        </div>
        <div>
          <label for="vehicle">Véhicule (immatriculation)</label>
          <select id="vehicle"></select>
          <div class="hint" id="vehInfo"></div>
        </div>
      </div>

      <div class="row cols-2" style="margin-top:calc(10px * var(--scale))">
        <div>
          <label for="chauffeur">Nom du chauffeur</label>
          <input id="chauffeur" type="text" placeholder="Nom du chauffeur" />
        </div>
      </div>

      <div class="row cols-3" style="margin-top:calc(10px * var(--scale))">
        <div>
          <label for="dateDepart">Date départ</label>
          <input id="dateDepart" type="date" />
        </div>
        <div>
          <label for="heureDepart">Heure départ</label>
          <input id="heureDepart" type="time" />
        </div>
        <div>
          <label for="receptionnaireDepart">Réceptionnaire (départ)</label>
          <input id="receptionnaireDepart" type="text" placeholder="Nom réceptionnaire" />
        </div>
      </div>

      <div style="margin-top:calc(10px * var(--scale))">
        <label for="obs">Observations</label>
        <textarea id="obs" placeholder="État du véhicule, accessoires remis, etc."></textarea>
      </div>

      <div style="margin-top:calc(12px * var(--scale))">
        <label for="openLoans">Prêts en cours du magasin</label>
        <select id="openLoans" disabled>
          <option value="">— Sélectionnez d’abord un magasin —</option>
        </select>
        <div class="hint">Choisissez un prêt “En cours” puis cliquez sur « Clôturer un prêt ».</div>
      </div>

      <div class="btns">
        <button class="btn" id="btnSave">Enregistrer le prêt</button>
        <button class="btn-sec" id="btnPdf" title="Génère un PDF à partir des infos saisies">Imprimer la fiche (PDF)</button>
        <button class="btn-sec" id="btnOpenClose" title="Clôturer un prêt en cours">Clôturer un prêt</button>
        <button class="btn-ghost" id="btnReset">Réinitialiser</button>
        <span class="tag" id="statusTag">Prêt non enregistré</span>
      </div>

      <div class="notice" id="notice"></div>
    </div>

    <div class="footer">Astuce : choisissez d’abord le magasin pour voir ses véhicules et prêts en cours.</div>
  </div>

  <div class="modalMask" id="mask">
    <div class="modal">
      <h3 style="margin:0 0 calc(8px * var(--scale))">Clôturer le prêt</h3>
      <p id="mInfo" style="margin:0 0 calc(8px * var(--scale));opacity:.85"></p>
      <div class="row cols-2">
        <div>
          <label for="mDateRet">Date retour</label>
          <input id="mDateRet" type="date">
        </div>
        <div>
          <label for="mHourRet">Heure retour</label>
          <input id="mHourRet" type="time">
        </div>
      </div>
      <div style="margin-top:calc(10px * var(--scale))">
        <label for="mRecep">Réceptionnaire (retour)</label>
        <input id="mRecep" type="text" placeholder="Nom réceptionnaire">
      </div>
      <div style="display:flex;gap:calc(10px * var(--scale));justify-content:flex-end;margin-top:calc(14px * var(--scale))">
        <button class="btn-ghost" id="mCancel">Annuler</button>
        <button class="btn" id="mOk">Valider la clôture</button>
      </div>
      <div class="notice" id="mNotice" style="margin-top:calc(8px * var(--scale))"></div>
    </div>
  </div>

  <script>
    const BASE_URL = '/api';

    const el = (id)=>document.getElementById(id);
    const $store = el('store'), $vehicle = el('vehicle'), $vehInfo = el('vehInfo');
    const $statusTag = el('statusTag'), $notice = el('notice');
    const $openLoans = el('openLoans');

    const $mask=el('mask'), $mInfo=el('mInfo'), $mDateRet=el('mDateRet'), $mHourRet=el('mHourRet'), $mRecep=el('mRecep'), $mNotice=el('mNotice');

    let vehiclesAll = []; let vehiclesIndex = {}; let lastSaved = null;

    async function fetchJSON(url, opts){
      const r = await fetch(url, opts);
      if(!r.ok){ const t = await r.text().catch(()=> ''); throw new Error(`HTTP ${r.status} ${t.slice(0,160)}`); }
      return r.json();
    }
    const setStatus=(t,ok=null)=>{ $statusTag.textContent=t; $statusTag.style.borderColor = ok===true?'#b7e3c3':ok===false?'#f3b7b7':'#e5e7eb'; $statusTag.style.background=ok===true?'#f2faf4':ok===false?'#fff6f6':'#fafafa'; $statusTag.className='tag '+(ok===true?'status-ok':ok===false?'status-err':''); };
    const setNotice=(t,type='info')=>{ $notice.textContent=t||''; $notice.style.color=type==='error'?'#c62828':type==='success'?'#2e7d32':'#073763'; };
    const setModalNotice=(t,type='info')=>{ $mNotice.textContent=t||''; $mNotice.style.color=type==='error'?'#c62828':type==='success'?'#2e7d32':'#073763'; };

    const pad2 = n => String(n).padStart(2,'0');
    function parseMaybeDate(v){
      if(!v && v!==0) return null;
      if(v instanceof Date) return isNaN(v)?null:v;
      if(typeof v === 'number'){ const ms = Math.round((v - 25569) * 86400 * 1000); const d = new Date(ms); return isNaN(d)?null:d; }
      if(typeof v === 'string'){
        if(/^\d{1,2}:\d{2}(:\d{2})?$/.test(v)){ const [h,m] = v.split(':'); const d=new Date(); d.setHours(+h, +m||0, 0, 0); return d; }
        const d = new Date(v); if(!isNaN(d)) return d;
        const m = v.match(/^(\d{4})-(\d{2})-(\d{2})$/); if(m){ const d2 = new Date(+m[1], +m[2]-1, +m[3]); return isNaN(d2)?null:d2; }
      }
      return null;
    }
    function fmtFRDate(d){ const dt=parseMaybeDate(d); return dt?`${pad2(dt.getDate())}/${pad2(dt.getMonth()+1)}/${String(dt.getFullYear()).slice(-2)}`:'—'; }
    function fmtFRTime(t){ const dt=parseMaybeDate(t); return dt?`${pad2(dt.getHours())}:${pad2(dt.getMinutes())}`:'—'; }

    async function loadStores(){
      try{
        const data = await fetchJSON(`${BASE_URL}/stores`);
        $store.innerHTML = '<option value="">-- Sélectionnez un magasin --</option>' +
          data.map(s=>`<option value="${s.code}">${s.nom_affiche}</option>`).join('');
      }catch(e){ setNotice("Impossible de charger les magasins : "+e.message,'error'); }
    }
    async function loadVehicles(){
      try{
        vehiclesAll = await fetchJSON(`${BASE_URL}/vehicles`);
        renderVehicleOptions(null);
      }catch(e){ setNotice("Impossible de charger les véhicules : "+e.message,'error'); }
    }

    function renderVehicleOptions(storeCode){
      vehiclesIndex = {};
      if(!storeCode){
        $vehicle.innerHTML = '<option value="">-- Choisissez un magasin d’abord --</option>';
        $vehInfo.textContent = '';
        return;
      }
      const list = vehiclesAll.filter(v => (v.magasin_home || '') === storeCode);
      if(list.length === 0){
        $vehicle.innerHTML = '<option value="">(Aucun véhicule rattaché à ce magasin)</option>';
        $vehInfo.textContent = '';
        return;
      }
      const opts = ['<option value="">-- Sélectionnez un véhicule --</option>'].concat(
        list.map(v=>{
          vehiclesIndex[v.id] = v;
          const label = `${v.immatriculation} — ${v.marque||''} ${v.modele||''}`.trim();
          const absent = String(v.statut||'').toLowerCase() === 'absent';
          return `<option value="${v.id}" ${absent?'disabled':''}>${label}${absent?' (Absent)':''}</option>`;
        })
      ).join('');
      $vehicle.innerHTML = opts;
      $vehInfo.textContent = '';
    }

    async function loadOpenLoansForStore(storeCode){
      if(!storeCode){
        $openLoans.disabled = true;
        $openLoans.innerHTML = '<option value="">— Sélectionnez d’abord un magasin —</option>';
        return;
      }
      try{
        $openLoans.disabled = true;
        $openLoans.innerHTML = '<option value="">Chargement…</option>';
        const rows = await fetchJSON(`${BASE_URL}/loans/search`);
        const open = (rows||[])
          .filter(r => String(r.status).toLowerCase() === 'en cours' && String(r.magasin_pret||'') === storeCode)
          .sort((a,b)=>{
            const p = s => (s && Date.parse(s)) || 0;
            return (p(b.created_at)-p(a.created_at)) || (p(b.updated_at)-p(a.updated_at)) || (p(b.date_depart)-p(a.date_depart));
          });
        if(open.length === 0){
          $openLoans.innerHTML = '<option value="">(Aucun prêt en cours dans ce magasin)</option>';
          $openLoans.disabled = true;
          return;
        }
        $openLoans.disabled = false;
        $openLoans.innerHTML = ['<option value="">— Sélectionnez un prêt —</option>'].concat(
          open.map(r=>{
            const label = `${r.immatriculation||'—'} — ${r.chauffeur_nom||'—'} — ${fmtFRDate(r.date_depart)} ${fmtFRTime(r.heure_depart)!=='—'?'• '+fmtFRTime(r.heure_depart):''}`;
            return `<option value="${r.loan_id}" data-veh="${r.vehicle_id||''}" data-immat="${r.immatriculation||''}">${label}</option>`;
          })
        ).join('');
      }catch(e){
        $openLoans.disabled = true;
        $openLoans.innerHTML = `<option value="">Erreur de chargement (${e.message})</option>`;
      }
    }

    function currentPayload(){
      const veh = vehiclesIndex[$vehicle.value] || {};
      return {
        vehicle_id: $vehicle.value,
        immatriculation: veh.immatriculation || '',
        magasin_pret: $store.value,
        chauffeur_nom: el('chauffeur').value.trim(),
        date_depart: el('dateDepart').value,
        heure_depart: el('heureDepart').value,
        receptionnaire_depart: el('receptionnaireDepart').value.trim(),
        observations: el('obs').value.trim()
      };
    }

    function openCloseModal(){
      setModalNotice('');
      const storeCode = $store.value;
      const selectedLoanId = $openLoans.value;
      if(!storeCode){
        setNotice('Choisissez un magasin.', 'error'); return;
      }
      if(!selectedLoanId){
        setNotice('Sélectionnez un prêt en cours dans la liste, puis relancez la clôture.', 'error');
        return;
      }
      const opt = $openLoans.options[$openLoans.selectedIndex];
      const immat = opt?.dataset?.immat || '';
      $mInfo.textContent = `Véhicule : ${immat} • Magasin : ${storeCode}`;
      const now = new Date(); const pad=n=>String(n).padStart(2,'0');
      $mDateRet.value = `${now.getFullYear()}-${pad(now.getMonth()+1)}-${pad(now.getDate())}`;
      $mHourRet.value = `${pad(now.getHours())}:${pad(now.getMinutes())}`;
      $mRecep.value = '';
      $mask.style.display='flex';
    }

    // Events
    $store.addEventListener('change', async ()=>{
      const code = $store.value || null;
      renderVehicleOptions(code);
      await loadOpenLoansForStore(code);
    });

    $vehicle.addEventListener('change', ()=>{
      const v = vehiclesIndex[$vehicle.value];
      $vehInfo.textContent = v ? `Magasin d'attache: ${v.magasin_home||'—'} • Statut: ${v.statut||'—'}` : '';
    });

    el('btnOpenClose').addEventListener('click', openCloseModal);
    el('mCancel').addEventListener('click', ()=>{ $mask.style.display='none'; });

    el('mOk').addEventListener('click', async ()=>{
      try{
        setModalNotice('Clôture en cours...');
        const selectedLoanId = $openLoans.value;
        const opt = $openLoans.options[$openLoans.selectedIndex];
        if(!selectedLoanId || !opt){ throw new Error('Sélection de prêt manquante'); }
        const vehicleId = opt.dataset.veh || '';
        const payload = {
          vehicle_id: vehicleId,
          date_retour: $mDateRet.value,
          heure_retour: $mHourRet.value,
          receptionnaire_retour: $mRecep.value.trim()
        };
        const res = await fetch(`${BASE_URL}/loans/${encodeURIComponent(selectedLoanId)}/close`, {
          method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload)
        });
        const j = await res.json(); if(!j.ok) throw new Error(j.error||'Erreur API');

        setModalNotice('Prêt clôturé avec succès.','success');
        setStatus('Prêt clôturé', true);
        setNotice('Le prêt est clôturé. Le véhicule repasse “Présent”.','success');
        $mask.style.display='none';
        await loadVehicles(); renderVehicleOptions($store.value || null);
        await loadOpenLoansForStore($store.value || null);
      }catch(e){
        setModalNotice('Échec de clôture : '+e.message,'error');
      }
    });

    el('btnSave').addEventListener('click', async ()=>{
      const d = currentPayload();
      if(!d.magasin_pret || !d.vehicle_id || !d.chauffeur_nom || !d.date_depart || !d.heure_depart){
        setStatus('Champs manquants', false);
        setNotice('Merci de remplir magasin, véhicule, chauffeur, date et heure de départ.','error');
        return;
      }
      try{
        const r = await fetch(`${BASE_URL}/loans`, { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(d) });
        const j = await r.json(); if(!j.ok) throw new Error(j.error||'Erreur API');
        lastSaved = { ...d, loan_id: j.loan_id || null };
        setStatus('Prêt enregistré', true);
        setNotice('Le prêt a été enregistré. Vous pouvez imprimer la fiche.','success');
        await loadVehicles(); renderVehicleOptions($store.value || null);
        await loadOpenLoansForStore($store.value || null);
      }catch(e){
        setStatus('Erreur à l’enregistrement', false);
        setNotice('Échec : '+e.message,'error');
      }
    });

    el('btnPdf').addEventListener('click', async ()=>{
      const d = lastSaved || currentPayload();
      if(!d.vehicle_id){ setNotice('Choisissez un véhicule avant de générer le PDF.','error'); return; }
      try{
        const r = await fetch(`${BASE_URL}/loans/pdf`, { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(d) });
        const blob = await r.blob(); const url = URL.createObjectURL(blob); window.open(url,'_blank'); URL.revokeObjectURL(url);
      }catch(e){ setNotice('Impossible de générer le PDF : '+e.message,'error'); }
    });

    el('btnReset').addEventListener('click', async ()=>{
      document.querySelectorAll('input, textarea, select').forEach(i=>{ if(i.type!=='select-one') i.value=''; else i.selectedIndex=0; });
      setStatus('Prêt non enregistré'); setNotice(''); $vehInfo.textContent=''; lastSaved=null;
      renderVehicleOptions(null);
      await loadOpenLoansForStore(null);
    });

    (async ()=>{ await Promise.all([loadStores(), loadVehicles()]); })();
  </script>
</body>
</html>
