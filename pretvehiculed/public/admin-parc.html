<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Admin – Parc & prêts véhicules</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{ --primary:#004080; --ink:#073763; --line:#e5e7eb; --scale:1.2; --bw:calc(1px*var(--scale)); }
    *{box-sizing:border-box} html{font-size:calc(100%*var(--scale));}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;color:var(--ink)}
    .wrap{max-width:calc(1200px*var(--scale));margin:calc(24px*var(--scale)) auto;padding:calc(16px*var(--scale))}
    h1{font-size:1.6rem;margin:0 0 calc(12px*var(--scale))}
    .tools{display:flex;flex-wrap:wrap;gap:calc(10px*var(--scale));align-items:end;border:var(--bw) solid var(--line);border-radius:calc(14px*var(--scale));padding:calc(12px*var(--scale));background:#fff}
    label{font-weight:600;margin-bottom:calc(4px*var(--scale));display:block}
    input{padding:calc(10px*var(--scale));border:var(--bw) solid var(--line);border-radius:calc(10px*var(--scale))}
    button{border:0;border-radius:calc(10px*var(--scale));padding:calc(10px*var(--scale)) calc(14px*var(--scale));font-weight:700;cursor:pointer;background:var(--primary);color:#fff}
    table{width:100%;border-collapse:separate;border-spacing:0;margin-top:calc(14px*var(--scale));background:#fff;border:var(--bw) solid var(--line);border-radius:calc(14px*var(--scale));overflow:hidden}
    thead th{background:#f8fbff;text-align:left;padding:calc(10px*var(--scale));border-bottom:var(--bw) solid var(--line)}
    tbody td{padding:calc(10px*var(--scale));border-bottom:var(--bw) solid #f1f3f5;vertical-align:top}
    tr:last-child td{border-bottom:0}
    .pill{display:inline-block;padding:calc(4px*var(--scale)) calc(8px*var(--scale));border-radius:999px;border:var(--bw) solid var(--line)}
    .ok{background:#f2faf4;color:#2e7d32;border-color:#b7e3c3}
    .warn{background:#fff8e1;color:#8a6d00;border-color:#ffe082}
    .right{text-align:right}
    .notice{margin-top:calc(10px*var(--scale))}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Admin – Parc & prêts véhicules</h1>

    <div class="tools">
      <div><label for="qImmat">Immatriculation</label><input id="qImmat" type="text" placeholder="Ex: AA-123-BB"></div>
      <div><label for="qDate">Date</label><input id="qDate" type="date"></div>
      <div><button id="btnSearch">Rechercher</button></div>
      <div style="margin-left:auto"><button id="btnExport" style="background:#eef5ff;color:#004080;border:var(--bw) solid #d6e6ff">Exporter CSV</button></div>
    </div>

    <div class="notice" id="notice"></div>

    <table id="tbl">
      <thead><tr><th>#</th><th>Immat.</th><th>Magasin prêt</th><th>Chauffeur</th><th>Départ</th><th>Retour</th><th>Statut</th><th class="right">Actions</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>

  <script>
    const BASE_URL = '/pret/api';
    const $tbody = document.querySelector('#tbl tbody'); const $notice = document.getElementById('notice');
    const setNotice=(m,t='info')=>{ $notice.textContent=m||''; $notice.style.color=t==='error'?'#c62828':t==='success'?'#2e7d32':'#073763'; };
    async function fetchJSON(url){ const r=await fetch(url); if(!r.ok) throw new Error('HTTP '+r.status); return r.json(); }
    const p2=n=>String(n).padStart(2,'0');
    function parseMaybeDate(v){ if(!v&&v!==0)return null; if(v instanceof Date) return isNaN(v)?null:v; if(typeof v==='number'){const ms=Math.round((v-25569)*86400*1000);const d=new Date(ms);return isNaN(d)?null:d;} if(typeof v==='string'){if(/^\d{1,2}:\d{2}(:\d{2})?$/.test(v)){const[h,m]=v.split(':');const d=new Date();d.setHours(+h,+m||0,0,0);return d;} const d=new Date(v); if(!isNaN(d)) return d; const m=v.match(/^(\d{4})-(\d{2})-(\d{2})$/); if(m){const d2=new Date(+m[1],+m[2]-1,+m[3]); return isNaN(d2)?null:d2;} } return null; }
    const fmtDate=v=>{const d=parseMaybeDate(v); return d?`${p2(d.getDate())}/${p2(d.getMonth()+1)}/${String(d.getFullYear()).slice(-2)}`:'—';};
    const fmtTime=v=>{const d=parseMaybeDate(v); return d?`${p2(d.getHours())}:${p2(d.getMinutes())}`:'—';};
    const pill=s=> s==='En cours' ? '<span class="pill warn">En cours</span>' : s==='Cloturé' ? '<span class="pill ok">Clôturé</span>' : `<span class="pill">${s||'—'}</span>`;

    async function doSearch(){
      const immat=(document.getElementById('qImmat').value||'').trim();
      const date=document.getElementById('qDate').value||'';
      setNotice('Recherche en cours...');
      try{
        const q=new URLSearchParams({immat,date}).toString();
        const rows=await fetchJSON(`${BASE_URL}/loans/search?${q}`);
        render(rows); setNotice(`${rows.length} résultat(s)`);
        window.__rows=rows;
      }catch(e){ setNotice('Erreur : '+e.message,'error'); }
    }
    function render(rows){
      $tbody.innerHTML = rows.map((r,i)=>`
        <tr>
          <td>${i+1}</td>
          <td><strong>${r.immatriculation||'—'}</strong></td>
          <td>${r.magasin_pret||'—'}</td>
          <td>${r.chauffeur_nom||'—'}</td>
          <td>${fmtDate(r.date_depart)}${fmtTime(r.heure_depart)!=='—'?' • '+fmtTime(r.heure_depart):''}</td>
          <td>${fmtDate(r.date_retour)}${fmtTime(r.heure_retour)!=='—'?' • '+fmtTime(r.heure_retour):''}</td>
          <td>${pill(r.status)}</td>
          <td class="right"></td>
        </tr>
      `).join('');
    }
    document.getElementById('btnSearch').addEventListener('click', doSearch);
    document.getElementById('btnExport').addEventListener('click', ()=>{
      const rows=window.__rows||[]; const head=['loan_id','vehicle_id','immatriculation','magasin_pret','chauffeur_nom','date_depart','heure_depart','date_retour','heure_retour','status','receptionnaire_depart','receptionnaire_retour','observations','created_at','updated_at'];
      const csv=[head.join(';')].concat(rows.map(r=>head.map(k=>String(r[k]??'').replaceAll(/[\r\n;]+/g,' ')).join(';'))).join('\n');
      const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='loans_export.csv'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    });
    doSearch();
  </script>
</body>
</html>
