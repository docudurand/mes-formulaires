<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Admin – Parc & prêts véhicules</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{ --primary:#004080; --ink:#073763; --line:#e5e7eb; --scale:1.2; --bw:calc(1px*var(--scale)); }
    *{box-sizing:border-box} html{font-size:calc(100%*var(--scale));}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;color:var(--ink);background:#fff}
    .wrap{max-width:calc(1200px*var(--scale));margin:calc(24px*var(--scale)) auto;padding:calc(16px*var(--scale))}
    h1{font-size:1.6rem;margin:0 0 calc(12px*var(--scale))}
    .tools{display:flex;flex-wrap:wrap;gap:calc(10px*var(--scale));align-items:end;border:var(--bw) solid var(--line);border-radius:calc(14px*var(--scale));padding:calc(12px*var(--scale));background:#fff}
    label{font-weight:600;margin-bottom:calc(4px*var(--scale));display:block}
    input,select{padding:calc(10px*var(--scale));border:var(--bw) solid var(--line);border-radius:calc(10px*var(--scale))}
    button{border:0;border-radius:calc(10px*var(--scale));padding:calc(10px*var(--scale)) calc(14px*var(--scale));font-weight:700;cursor:pointer;background:var(--primary);color:#fff}
    .btn-mini{padding:calc(6px*var(--scale)) calc(10px*var(--scale));font-weight:600}
    .btn-light{background:#eef5ff;color:#004080;border:var(--bw) solid #d6e6ff}
    .btn-ghost{background:#fff;color:#073763;border:var(--bw) solid var(--line)}
    table{width:100%;border-collapse:separate;border-spacing:0;margin-top:calc(14px*var(--scale));background:#fff;border:var(--bw) solid var(--line);border-radius:calc(14px*var(--scale));overflow:hidden}
    thead th{background:#f8fbff;text-align:left;padding:calc(10px*var(--scale));border-bottom:var(--bw) solid var(--line)}
    tbody td{padding:calc(10px*var(--scale));border-bottom:var(--bw) solid #f1f3f5;vertical-align:top}
    tr:last-child td{border-bottom:0}
    .pill{display:inline-block;padding:calc(4px*var(--scale)) calc(8px*var(--scale));border-radius:999px;border:var(--bw) solid var(--line)}
    .ok{background:#f2faf4;color:#2e7d32;border-color:#b7e3c3}
    .warn{background:#fff8e1;color:#8a6d00;border-color:#ffe082}
    .right{text-align:right;white-space:nowrap}
    .stack{display:flex;flex-direction:column;gap:6px;align-items:flex-end}
    .notice{margin-top:calc(10px*var(--scale))}

    .modalMask{position:fixed;inset:0;background:#0006;display:none;align-items:center;justify-content:center;padding:calc(20px*var(--scale));z-index:99999}
    .modal{background:#fff;border-radius:calc(14px*var(--scale));max-width:calc(560px*var(--scale));width:100%;padding:calc(16px*var(--scale));border:var(--bw) solid var(--line);box-shadow:0 calc(10px*var(--scale)) calc(24px*var(--scale)) #0003}

    .row{display:grid;gap:calc(12px*var(--scale))}
    @media(min-width:680px){ .row.cols-2{grid-template-columns:1fr 1fr} }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Admin – Parc & prêts véhicules</h1>

    <div class="tools">
      <div>
        <label for="qImmat">Immatriculation</label>
        <select id="qImmat">
          <option value="">— Toutes —</option>
        </select>
      </div>
      <div>
        <label for="qDate">Date</label>
        <input id="qDate" type="date">
      </div>
      <div style="margin-left:auto">
        <button id="btnExport" class="btn-light" type="button">Exporter CSV</button>
      </div>
    </div>

    <div class="notice" id="notice"></div>

    <table id="tbl">
      <thead>
        <tr>
          <th>#</th><th>Immat.</th><th>Magasin prêt</th><th>Chauffeur</th>
          <th>Départ</th><th>Retour</th><th>Statut</th><th class="right">Actions</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <div class="modalMask" id="mask">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="mTitle">
      <h3 id="mTitle" style="margin:0 0 calc(8px*var(--scale))">Clôturer le prêt</h3>
      <p id="mInfo" style="opacity:.85"></p>
      <div class="row cols-2">
        <div><label for="mDateRet">Date retour</label><input id="mDateRet" type="date"></div>
        <div><label for="mHourRet">Heure retour</label><input id="mHourRet" type="time"></div>
      </div>
      <div style="margin-top:calc(10px*var(--scale))">
        <label for="mRecep">Réceptionnaire (retour)</label>
        <input id="mRecep" type="text" placeholder="Nom réceptionnaire">
      </div>
      <div class="notice" id="mNotice"></div>
      <div style="display:flex;gap:calc(10px*var(--scale));justify-content:flex-end;margin-top:calc(14px*var(--scale))">
        <button class="btn-ghost btn-mini" id="mCancel" type="button">Annuler</button>
        <button class="btn btn-mini" id="mOk" type="button">Valider la clôture</button>
      </div>
    </div>
  </div>

  <div class="modalMask" id="maskEdit">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="eTitle">
      <h3 id="eTitle" style="margin:0 0 calc(8px*var(--scale))">Modifier le prêt</h3>
      <p id="eInfo" style="opacity:.85"></p>

      <div class="row cols-2">
        <div>
          <label for="eMagasin">Magasin prêt</label>
          <select id="eMagasin"></select>
        </div>
        <div>
          <label for="eChauffeur">Chauffeur</label>
          <input id="eChauffeur" type="text" placeholder="Nom du chauffeur">
        </div>
      </div>

      <div class="row cols-2">
        <div>
          <label for="eDateDep">Date départ</label>
          <input id="eDateDep" type="date">
        </div>
        <div>
          <label for="eHourDep">Heure départ</label>
          <input id="eHourDep" type="time">
        </div>
      </div>

      <div>
        <label for="eRecepDep">Réceptionnaire (départ)</label>
        <input id="eRecepDep" type="text" placeholder="Nom réceptionnaire">
      </div>

      <div>
        <label for="eObs">Observations</label>
        <textarea id="eObs" rows="4" style="width:100%;padding:10px 12px;border:var(--bw) solid var(--line);border-radius:calc(10px*var(--scale))"></textarea>
      </div>

      <div class="notice" id="eNotice"></div>
      <div style="display:flex;gap:calc(10px*var(--scale));justify-content:flex-end;margin-top:calc(14px*var(--scale))">
        <button class="btn-ghost btn-mini" id="eCancel" type="button">Annuler</button>
        <button class="btn btn-mini" id="eSave" type="button">Enregistrer les modifications</button>
      </div>
    </div>
  </div>

  <script>
    const BASE_URL = '/pret/api';

    const $tbody = document.querySelector('#tbl tbody');
    const $notice = document.getElementById('notice');
    const setNotice=(m,t='info')=>{ $notice.textContent=m||''; $notice.style.color=t==='error'?'#c62828':t==='success'?'#2e7d32':'#073763'; };

    async function fetchJSON(url, opts){ const r=await fetch(url,opts); if(!r.ok) throw new Error('HTTP '+r.status); return r.json(); }

    const p2=n=>String(n).padStart(2,'0');
    function parseMaybeDate(v){
      if(!v&&v!==0) return null;
      if(v instanceof Date) return isNaN(v)?null:v;
      if(typeof v==='number'){ const ms=Math.round((v-25569)*86400*1000); const d=new Date(ms); return isNaN(d)?null:d; }
      if(typeof v==='string'){
        if(/^\d{1,2}:\d{2}(:\d{2})?$/.test(v)){ const[h,m]=v.split(':'); const d=new Date(); d.setHours(+h,+m||0,0,0); return d; }
        const d=new Date(v); if(!isNaN(d)) return d;
        const m=v.match(/^(\d{4})-(\d{2})-(\d{2})$/); if(m){ const d2=new Date(+m[1],+m[2]-1,+m[3]); return isNaN(d2)?null:d2; }
      }
      return null;
    }
    const fmtDate=v=>{ const d=parseMaybeDate(v); return d?`${p2(d.getDate())}/${p2(d.getMonth()+1)}/${String(d.getFullYear()).slice(-2)}`:'—'; };
    const fmtTime=v=>{ const d=parseMaybeDate(v); return d?`${p2(d.getHours())}:${p2(d.getMinutes())}`:'—'; };
    const toDateInput=v=>{ const d=parseMaybeDate(v); return d?`${d.getFullYear()}-${p2(d.getMonth()+1)}-${p2(d.getDate())}`:''; };
    const toTimeInput=v=>{ const d=parseMaybeDate(v); return d?`${p2(d.getHours())}:${p2(d.getMinutes())}`:''; };
    const pill=s=>{ const n=String(s||'').toLowerCase(); if(n==='en cours') return '<span class="pill warn">En cours</span>'; if(n==='cloturé'||n==='clôturé') return '<span class="pill ok">Clôturé</span>'; return `<span class="pill">${s||'—'}</span>`; };
    const isOpen=s => String(s||'').toLowerCase()==='en cours';

    let __rows = [];
    let __stores = [];

    let __scrollY = 0;
    function lockScroll(){
      __scrollY = window.scrollY || document.documentElement.scrollTop || 0;
      document.body.style.position='fixed';
      document.body.style.top = `-${__scrollY}px`;
      document.body.style.left='0';
      document.body.style.right='0';
      document.body.style.width='100%';
    }
    function unlockScroll(){
      document.body.style.position='';
      document.body.style.top='';
      document.body.style.left='';
      document.body.style.right='';
      document.body.style.width='';
      window.scrollTo(0, __scrollY);
    }

    async function loadStores(){
      try{ __stores = await fetchJSON(`${BASE_URL}/stores`); }catch(_){ __stores = []; }
    }

    async function loadAllLoans(){
      setNotice('Chargement...');
      try{
        const rows=await fetchJSON(`${BASE_URL}/loans/search`);
        __rows = rows;
        populateImmatList(rows);
        applyFilters(); // rend + notice
      }catch(e){ setNotice('Erreur : '+e.message,'error'); }
    }

    function populateImmatList(rows){
      const $qImmat = document.getElementById('qImmat');
      const immats = Array.from(new Set((rows||[]).map(r=>String(r.immatriculation||'').trim()).filter(Boolean))).sort();
      $qImmat.innerHTML = ['<option value="">— Toutes —</option>'].concat(immats.map(v=>`<option value="${v}">${v}</option>`)).join('');
    }

    function render(rows){
      $tbody.innerHTML = rows.map((r,i)=>{
        const closeBtn = isOpen(r.status)
          ? `<button type="button" class="btn-mini btn-light btnClose" data-loan="${r.loan_id}" data-veh="${r.vehicle_id||''}" data-immat="${r.immatriculation||''}">Clôturer</button>`
          : '';
        const editBtn = `<button type="button" class="btn-mini btn-light btnEdit" data-loan="${r.loan_id}" data-veh="${r.vehicle_id||''}" data-immat="${r.immatriculation||''}">Modifier</button>`;
        const actions = `<div class="stack">${closeBtn}${editBtn}</div>`;
        return `
          <tr>
            <td>${i+1}</td>
            <td><strong>${r.immatriculation||'—'}</strong></td>
            <td>${r.magasin_pret||'—'}</td>
            <td>${r.chauffeur_nom||'—'}</td>
            <td>${fmtDate(r.date_depart)}${fmtTime(r.heure_depart)!=='—'?' • '+fmtTime(r.heure_depart):''}</td>
            <td>${fmtDate(r.date_retour)}${fmtTime(r.heure_retour)!=='—'?' • '+fmtTime(r.heure_retour):''}</td>
            <td>${pill(r.status)}</td>
            <td class="right">${actions}</td>
          </tr>
        `;
      }).join('');
    }

    function applyFilters(){
      const immat = (document.getElementById('qImmat').value || '').trim();
      const date = document.getElementById('qDate').value || '';
      const filtered = (__rows||[]).filter(r=>{
        const okImmat = !immat || String(r.immatriculation||'')===immat;
        const okDate  = !date || String(r.date_depart||'').startsWith(date) || String(r.date_retour||'').startsWith(date);
        return okImmat && okDate;
      });
      render(filtered);
      setNotice(`${filtered.length} résultat(s)`);
    }

    document.getElementById('btnExport').addEventListener('click', ()=>{
      const rows=(__rows||[]);
      const head=['loan_id','vehicle_id','immatriculation','magasin_pret','chauffeur_nom','date_depart','heure_depart','date_retour','heure_retour','status','receptionnaire_depart','receptionnaire_retour','observations','created_at','updated_at'];
      const csv=[head.join(';')].concat(rows.map(r=>head.map(k=>String(r[k]??'').replaceAll(/[\r\n;]+/g,' ')).join(';'))).join('\n');
      const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='loans_export.csv'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    });

    const $mask = document.getElementById('mask');
    const $mInfo = document.getElementById('mInfo');
    const $mDateRet = document.getElementById('mDateRet');
    const $mHourRet = document.getElementById('mHourRet');
    const $mRecep = document.getElementById('mRecep');
    const $mNotice = document.getElementById('mNotice');
    const $mCancel = document.getElementById('mCancel');
    const $mOk = document.getElementById('mOk');
    let __ctx = { loanId:'', vehicleId:'', immat:'' };

    const setModalNotice=(t,type='info')=>{ $mNotice.textContent=t||''; $mNotice.style.color=type==='error'?'#c62828':type==='success'?'#2e7d32':'#073763'; };

    function openCloseModal(ctx){
      __ctx = ctx;
      $mInfo.textContent = `Véhicule : ${ctx.immat || '—'}`;
      const now=new Date();
      $mDateRet.value = `${now.getFullYear()}-${p2(now.getMonth()+1)}-${p2(now.getDate())}`;
      $mHourRet.value = `${p2(now.getHours())}:${p2(now.getMinutes())}`;
      $mRecep.value = '';
      setModalNotice('');
      lockScroll();
      $mask.style.display='flex';
    }
    function closeCloseModal(){
      $mask.style.display='none';
      unlockScroll();
    }

    const $maskEdit = document.getElementById('maskEdit');
    const $eInfo    = document.getElementById('eInfo');
    const $eMagasin = document.getElementById('eMagasin');
    const $eChauff  = document.getElementById('eChauffeur');
    const $eDateDep = document.getElementById('eDateDep');
    const $eHourDep = document.getElementById('eHourDep');
    const $eRecepDep= document.getElementById('eRecepDep');
    const $eObs     = document.getElementById('eObs');
    const $eNotice  = document.getElementById('eNotice');
    const $eCancel  = document.getElementById('eCancel');
    const $eSave    = document.getElementById('eSave');
    let __editCtx   = { loanId:'', vehicleId:'', immat:'' };

    function setENotice(msg, type='info'){ $eNotice.textContent = msg || ''; $eNotice.style.color = type==='error'?'#c62828':type==='success'?'#2e7d32':'#073763'; }

    function fillStoreSelect(currentCode){
      $eMagasin.innerHTML = (__stores.length
        ? __stores.map(s=>`<option value="${s.code}">${s.nom_affiche}</option>`).join('')
        : '<option value="">—</option>');
      if(currentCode) $eMagasin.value = currentCode;
    }

    function openEditModal(loanId){
      const row = (__rows||[]).find(r=>String(r.loan_id)===String(loanId));
      if(!row){ setNotice("Impossible d'ouvrir la modification (prêt introuvable).", 'error'); return; }
      __editCtx = { loanId, vehicleId: row.vehicle_id || '', immat: row.immatriculation || '' };

      $eInfo.textContent = `Véhicule : ${__editCtx.immat || '—'}`;
      fillStoreSelect(row.magasin_pret || '');
      $eChauff.value   = row.chauffeur_nom || '';
      $eDateDep.value  = toDateInput(row.date_depart) || '';
      $eHourDep.value  = toTimeInput(row.heure_depart) || '';
      $eRecepDep.value = row.receptionnaire_depart || '';
      $eObs.value      = row.observations || '';
      setENotice('');
      lockScroll();
      $maskEdit.style.display='flex';
    }
    function closeEditModal(){
      $maskEdit.style.display='none';
      unlockScroll();
    }

    $tbody.addEventListener('click', (e)=>{
      const btnC = e.target.closest('.btnClose');
      if(btnC){ openCloseModal({ loanId: btnC.dataset.loan, vehicleId: btnC.dataset.veh||'', immat: btnC.dataset.immat||'' }); return; }
      const btnE = e.target.closest('.btnEdit');
      if(btnE){ openEditModal(String(btnE.dataset.loan)); return; }
    });

    $mCancel.addEventListener('click', closeCloseModal);
    $eCancel.addEventListener('click', closeEditModal);

    $mOk.addEventListener('click', async ()=>{
      try{
        setModalNotice('Clôture en cours…');
        const payload = { vehicle_id: __ctx.vehicleId, date_retour:$mDateRet.value, heure_retour:$mHourRet.value, receptionnaire_retour:$mRecep.value.trim() };
        const r = await fetch(`${BASE_URL}/loans/${encodeURIComponent(__ctx.loanId)}/close`, { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload) });
        const j = await r.json(); if(!j.ok) throw new Error(j.error||'Erreur API');
        setModalNotice('Prêt clôturé.','success');
        closeCloseModal();
        setNotice('Prêt clôturé.','success');
        await loadAllLoans();
      }catch(e){ setModalNotice('Échec : '+e.message,'error'); }
    });

    $eSave.addEventListener('click', async ()=>{
      try{
        setENotice('Enregistrement en cours…');
        const payload = {
          vehicle_id: __editCtx.vehicleId,
          magasin_pret: $eMagasin.value || '',
          chauffeur_nom: $eChauff.value.trim(),
          date_depart: $eDateDep.value,
          heure_depart: $eHourDep.value,
          receptionnaire_depart: $eRecepDep.value.trim(),
          observations: $eObs.value.trim()
        };
        const r = await fetch(`${BASE_URL}/loans/${encodeURIComponent(__editCtx.loanId)}/update`, {
          method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload)
        });
        const j = await r.json(); if(!j.ok) throw new Error(j.error||'Erreur API');
        setENotice('Modifications enregistrées.','success');
        closeEditModal();
        await loadAllLoans();
      }catch(e){
        setENotice('Échec : '+e.message,'error');
      }
    });

    document.getElementById('qImmat').addEventListener('change', applyFilters);
    document.getElementById('qDate').addEventListener('change', applyFilters);

    (async ()=>{ await loadStores(); await loadAllLoans(); })();
  </script>
</body>
</html>