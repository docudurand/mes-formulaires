<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <title>Suivi des dossiers Atelier</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --primary:#004080;
      --line:#e5e7eb;
      --bg:#f3f4f6;
      --ink:#0f172a;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif;
      background:var(--bg);
      color:var(--ink);
      padding:16px;
    }
    h1{
      font-size:1.4rem;
      margin-bottom:10px;
      color:#0b4a6f;
    }
    .wrap{
      max-width:1200px;
      margin:0 auto;
      background:#fff;
      border-radius:12px;
      padding:16px 18px 18px;
      box-shadow:0 1px 3px rgba(0,0,0,.06);
      border:1px solid #e5e7eb;
    }
    .toolbar{
      display:flex;
      flex-wrap:wrap;
      gap:10px 14px;
      align-items:center;
      margin-bottom:10px;
      font-size:.95rem;
    }
    .toolbar label{
      display:flex;
      gap:6px;
      align-items:center;
    }
    select,input[type="search"]{
      font:inherit;
      padding:5px 7px;
      border-radius:6px;
      border:1px solid #d1d5db;
    }
    .yearbar{
      margin:8px 0 12px;
      padding:8px 10px;
      border-radius:10px;
      background:#f9fafb;
      border:1px solid #e5e7eb;
      font-size:.9rem;
    }
    .yearTabs{
      display:flex;
      gap:4px;
      margin-bottom:6px;
      flex-wrap:wrap;
    }
    .yearBtn{
      border-radius:999px;
      border:1px solid #cbd5f5;
      padding:4px 10px;
      font-size:.85rem;
      background:#fff;
      cursor:pointer;
    }
    .yearBtn.active{
      background:#004080;
      color:#fff;
      border-color:#004080;
    }
    .months{
      display:flex;
      flex-wrap:wrap;
      gap:4px;
      margin-bottom:6px;
    }
    .monthBtn{
      border-radius:999px;
      border:1px solid #e5e7eb;
      padding:3px 8px;
      font-size:.8rem;
      background:#fff;
      cursor:pointer;
    }
    .monthBtn.active{
      background:#0b4a6f;
      color:#fff;
      border-color:#0b4a6f;
    }
    .legend{
      font-size:.8rem;
      color:#4b5563;
      margin-top:2px;
    }
    .legend span{
      margin-right:10px;
      display:inline-flex;
      align-items:center;
      gap:4px;
    }
    .dot{
      width:10px;
      height:10px;
      border-radius:999px;
      display:inline-block;
    }
    .tableWrap{
      overflow:auto;
      border-radius:10px;
      border:1px solid #e5e7eb;
      background:#fff;
    }
    table{
      width:100%;
      border-collapse:collapse;
      font-size:.9rem;
      min-width:820px;
    }
    thead{
      background:#f3f4f6;
    }
    th,td{
      padding:6px 8px;
      border-bottom:1px solid #e5e7eb;
      text-align:left;
      vertical-align:middle;
    }
    th{
      font-weight:600;
      font-size:.8rem;
      color:#4b5563;
      white-space:nowrap;
    }
    tbody tr:nth-child(even){
      background:#f9fafb;
    }
    tbody tr:hover{
      background:#eef2ff;
    }
    .nowrap{white-space:nowrap}
    .truncate{
      max-width:180px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .wrap-ok{
      white-space:normal;
    }
    .col-no{width:60px}
    .col-magasin{width:150px}
    .col-compte{width:120px}
    .col-client{width:180px}
    .col-service{width:180px}
    .col-date{width:90px}
    .col-statut{width:120px}
    .col-eta{width:150px}
    .col-actions{width:150px}

    .chip{
      display:inline-flex;
      align-items:center;
      border-radius:999px;
      padding:2px 8px;
      font-size:.75rem;
      font-weight:600;
    }
    .chip.demande{background:#e0f2fe;color:#075985}
    .chip.atelier{background:#ede9fe;color:#5b21b6}
    .chip.piece{background:#dcfce7;color:#166534}
    .chip.renvoye{background:#fef3c7;color:#92400e}

    .etaInput{
      width:60px;
      padding:4px 6px;
      border-radius:6px;
      border:1px solid #d1d5db;
      font:inherit;
    }

    button{
      appearance:none;
      border:1px solid var(--primary);
      background:#fff;
      color:#004080;
      padding:7px 10px;
      border-radius:10px;
      font-weight:700;
      cursor:pointer;
      font-size:.9rem;
    }
    button:disabled{
      opacity:.6;
      cursor:default;
    }
    .etaGroup{
      display:flex;
      align-items:center;
      gap:8px;
      flex-wrap:wrap;
    }
    .btnView{
      white-space:normal;
      line-height:1.05;
      padding:6px 8px;
      min-width:72px;
      max-width:84px;
      text-align:center;
    }
    .spinner{
      width:14px;
      height:14px;
      border:2px solid #e5e7eb;
      border-top-color:#004080;
      border-radius:50%;
      animation:spin 1s linear infinite;
      display:inline-block;
      vertical-align:middle;
    }
    @keyframes spin{to{transform:rotate(360deg)}}

    .mask{
      position:fixed;
      inset:0;
      background:#0008;
      display:none;
      align-items:flex-start;
      justify-content:center;
      z-index:10000;
      padding:16px;
    }
    .box{
      width:min(900px,96vw);
      max-height:min(90vh,800px);
      background:#fff;
      border-radius:14px;
      overflow:auto;
      border:1px solid var(--line);
      margin-top:10px;
    }
    .bar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:8px 12px;
      border-bottom:1px solid var(--line);
      background:#f8fbff;
    }
    .content{padding:12px}
    .grid2{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:6px 14px;
    }
    .label{font-weight:700}
    .section{margin-top:12px}
    .section h3{
      margin:8px 0;
      color:#0b4a6f;
      font-size:.95rem;
    }
    .area{
      border:1px solid var(--line);
      padding:10px;
      white-space:pre-wrap;
    }

    /* Overlay de mot de passe (comme suivi garantie) */
    .loginOverlay{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,0.35);
      display:flex;
      align-items:center;
      justify-content:center;
      z-index:20000;
    }
    .loginBox{
      background:#fff;
      padding:20px 24px;
      border-radius:12px;
      box-shadow:0 4px 18px rgba(0,0,0,0.2);
      max-width:320px;
      width:100%;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    }
    .loginBox h2{
      margin:0 0 8px;
      font-size:1.1rem;
      color:#004080;
      text-align:center;
    }
    .loginBox p{
      margin:0 0 10px;
      font-size:.9rem;
      color:#555;
      text-align:center;
    }
    .loginBox input{
      width:100%;
      padding:8px 10px;
      border-radius:8px;
      border:1px solid #d1d5db;
      font-size:1rem;
      margin-bottom:10px;
    }
    .loginBox button{
      width:100%;
      padding:9px 12px;
      border-radius:999px;
      border:0;
      background:#004080;
      color:#fff;
      font-weight:700;
      cursor:pointer;
      font-size:.95rem;
    }
    .loginBox .error{
      margin-top:8px;
      font-size:.85rem;
      color:#b91c1c;
      text-align:center;
      min-height:1.1em;
    }
    @media (max-width:720px){
      .wrap{padding:12px}
      .toolbar{flex-direction:column;align-items:flex-start}
    }
  </style>
</head>
<body>

<!-- OVERLAY MOT DE PASSE -->
<div class="loginOverlay" id="suiviLoginOverlay">
  <div class="loginBox">
    <h2>Accès suivi atelier</h2>
    <p>Veuillez saisir votre mot de passe.</p>
    <input type="password" id="suiviPassword" placeholder="Mot de passe" />
    <button type="button" id="suiviLoginBtn">Se connecter</button>
    <div class="error" id="suiviError"></div>
  </div>
</div>

<div class="wrap">
  <h1>Suivi des dossiers Atelier</h1>

  <div class="toolbar">
    <label>Filtrer magasin :
      <select id="filterMag">
        <option value="">Tous</option>
        <option>Annemasse</option><option>Bourgoin</option><option>Chasse sur Rhone</option>
        <option>Chassieu</option><option>Gleize</option><option>La Motte Servolex</option>
        <option>Miribel</option><option>Renage</option><option>Rives</option>
        <option>Seynod</option><option>St Egreve</option><option>St-Jean-Bonnefonds</option>
      </select>
    </label>
    <input id="q" type="search"
           placeholder="Rechercher (n°, magasin, compte, client, service…)"
           style="min-width:280px" />
  </div>

  <div class="yearbar" aria-label="Filtre par année et mois (Date de la demande)">
    <div class="yearTabs" role="tablist" aria-label="Années">
      <button type="button" class="yearBtn" data-year="2025"
              role="tab" aria-controls="months-2025" aria-selected="false">2025</button>
      <button type="button" class="yearBtn" data-year="2026"
              role="tab" aria-controls="months-2026" aria-selected="false">2026</button>
    </div>
    <div id="months-2025" class="months" role="tabpanel" aria-label="Mois 2025"></div>
    <div id="months-2026" class="months" role="tabpanel" aria-label="Mois 2026"></div>
    <div class="legend" id="legend"></div>
  </div>

  <div class="tableWrap">
    <table id="tab">
      <colgroup>
        <col class="col-no">
        <col class="col-magasin">
        <col class="col-compte">
        <col class="col-client">
        <col class="col-service">
        <col class="col-date">
        <col class="col-statut">
        <col class="col-eta">
        <col class="col-actions">
      </colgroup>
      <thead>
        <tr>
          <th class="nowrap">N°</th>
          <th class="wrap-ok">Magasin</th>
          <th class="nowrap">N° de compte</th>
          <th class="truncate">Client</th>
          <th class="truncate">Service</th>
          <th class="nowrap">Date</th>
          <th class="nowrap">Statut</th>
          <th class="th-eta">Estimation<br>Temps Travaux<br>(Jours)</th>
          <th class="th-actions">Actions</th>
        </tr>
      </thead>
      <tbody aria-live="polite"></tbody>
    </table>
  </div>
</div>

<!-- MODALE VOIR DOSSIER -->
<div class="mask" id="mask" aria-hidden="true">
  <div class="box" role="dialog" aria-label="Dossier">
    <div class="bar">
      <div id="modalTitle" style="font-weight:800;color:#004080">Dossier</div>
      <div>
        <button id="btnPrint">Imprimer</button>
        <button id="btnClose">Fermer</button>
      </div>
    </div>
    <div class="content" id="modalContent"></div>
  </div>
</div>

<!-- Config mots de passe (servi par ton routeur suivi-dossier) -->
<script src="/suivi-dossier/config.js"></script>

<script>
  const API_BASE =
    (location.hostname.includes("wixsite.com") || location.hostname.endsWith(".wix.com"))
      ? "https://mes-formulaires.onrender.com"
      : location.origin.replace(/\/$/, "");

  const cfgSuivi = window.__SUIVI_CFG || {};
  const PASS_FULL    = cfgSuivi.SUIVI_PASS_FULL    || "";
  const PASS_LIMITED = cfgSuivi.SUIVI_PASS_LIMITED || "";

  const $tbody       = document.querySelector("#tab tbody");
  const $filter      = document.getElementById("filterMag");
  const $q           = document.getElementById("q");
  const $mask        = document.getElementById("mask");
  const $btnClose    = document.getElementById("btnClose");
  const $btnPrint    = document.getElementById("btnPrint");
  const $modalTitle  = document.getElementById("modalTitle");
  const $modalContent= document.getElementById("modalContent");
  const $legend      = document.getElementById("legend");

  const $overlay   = document.getElementById("suiviLoginOverlay");
  const $pwdInput  = document.getElementById("suiviPassword");
  const $btnLogin  = document.getElementById("suiviLoginBtn");
  const $errBox    = document.getElementById("suiviError");

  const yearButtons = Array.from(document.querySelectorAll(".yearBtn"));
  const monthsContainers = {
    2025: document.getElementById("months-2025"),
    2026: document.getElementById("months-2026")
  };

  let ALL_ROWS = [];
  let FILTER_YEAR  = "";
  let FILTER_MONTH = "";
  let IS_LOADING   = true;
  let LIMITED_VIEW = false;

  function esc(s){
    return String(s ?? "").replace(/[&<>"]/g,c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;"}[c]||c));
  }
  function p2(n){return String(n).padStart(2,"0");}
  function parseDate(v){
    if (!v && v!==0) return null;
    const d = new Date(v);
    if (!isNaN(d)) return d;
    const m1 = String(v).match(/^(\d{4})-(\d{2})-(\d{2})$/);
    if (m1){
      const d2 = new Date(+m1[1], +m1[2]-1, +m1[3]); 
      return isNaN(d2)?null:d2;
    }
    const m2 = String(v).match(/^(\d{2})-(\d{2})-(\d{4})$/);
    if (m2){
      const d3 = new Date(+m2[3], +m2[2]-1, +m2[1]); 
      return isNaN(d3)?null:d3;
    }
    return null;
  }
  function fmtJJMMYYYY(v){
    const d = parseDate(v);
    return d ? `${p2(d.getDate())}/${p2(d.getMonth()+1)}/${d.getFullYear()}` : "";
  }

  function statutChip(st){
    const t = String(st||"").normalize("NFD").replace(/\p{Diacritic}/gu,"").toLowerCase();
    let cls="demande", label=st||"Demande envoyé";
    if (t.includes("atelier")) { cls="atelier"; }
    if (t.includes("piece") && t.includes("recu")) { cls="piece"; }
    if (t.includes("renvoye")) { cls="renvoye"; }
    return `<span class="chip ${cls}">${esc(label)}</span>`;
  }

  function setTableLoading(msg){
    $tbody.innerHTML =
      `<tr><td colspan="9" style="text-align:center;padding:16px;">
        <span class="spinner"></span>
        <span style="margin-left:8px;">${esc(msg||"Chargement…")}</span>
       </td></tr>`;
  }

  function setLegend(){
    $legend.innerHTML =
      `<span><span class="dot" style="background:#e0f2fe"></span> Demande envoyé / en cours</span>
       <span><span class="dot" style="background:#ede9fe"></span> En atelier</span>
       <span><span class="dot" style="background:#dcfce7"></span> Pièce reçue</span>
       <span><span class="dot" style="background:#fef3c7"></span> Renvoyé</span>`;
  }

  function buildMonthButtons(){
    Object.values(monthsContainers).forEach(c=>c.innerHTML="");
    const MONTHS = ["01","02","03","04","05","06","07","08","09","10","11","12"];
    [2025,2026].forEach(year=>{
      const cont = monthsContainers[year];
      MONTHS.forEach(m=>{
        const b = document.createElement("button");
        b.type="button";
        b.className="monthBtn";
        b.dataset.year = String(year);
        b.dataset.month = m;
        b.textContent = `${m}/${String(year).slice(2)}`;
        b.addEventListener("click", ()=>{
          FILTER_YEAR = String(year);
          FILTER_MONTH = m;
          yearButtons.forEach(yb=>yb.classList.toggle("active", yb.dataset.year===FILTER_YEAR));
          document.querySelectorAll(".monthBtn").forEach(x=>{
            x.classList.toggle("active", x===b);
          });
          drawTable();
        });
        cont.appendChild(b);
      });
    });
  }

  function applyFilters(rows){
    let out = rows.slice();

    const q = $q.value.trim().toLowerCase();
    const mag = $filter.value;

    if (mag){
      out = out.filter(r => (r.magasin||"") === mag);
    }
    if (q){
      out = out.filter(r=>{
        const no = String(r.no||"");
        const fields = [
          no,
          r.magasin||"",
          r.compte||"",
          r.client||"",
          r.service||""
        ].join(" ").toLowerCase();
        return fields.includes(q);
      });
    }

    if (FILTER_YEAR){
      out = out.filter(r=>{
        const d = parseDate(r.demandeDate || r.date);
        return d && d.getFullYear() === +FILTER_YEAR;
      });
    }
    if (FILTER_MONTH){
      out = out.filter(r=>{
        const d = parseDate(r.demandeDate || r.date);
        return d && p2(d.getMonth()+1) === FILTER_MONTH;
      });
    }

    out.sort((a,b)=>{
      const da = parseDate(a.demandeDate || a.date);
      const db = parseDate(b.demandeDate || b.date);
      const ta = da ? da.getTime() : 0;
      const tb = db ? db.getTime() : 0;
      return tb - ta;
    });

    return out;
  }

  function hideLimitedColumns(){
    const thEta = document.querySelector(".th-eta");
    const thActions = document.querySelector(".th-actions");
    if (thEta) thEta.style.display = "none";
    if (thActions) thActions.style.display = "none";
    document.querySelectorAll(".col-eta, .col-actions").forEach(col=>{
      col.style.display = "none";
    });
    document.querySelectorAll("td[data-col='eta'],td[data-col='actions']").forEach(td=>{
      td.style.display = "none";
    });
  }

  function drawTable(){
    if (IS_LOADING){
      setTableLoading("Chargement des dossiers…");
      return;
    }
    const rows = applyFilters(ALL_ROWS);
    if (!rows.length){
      $tbody.innerHTML =
        `<tr><td colspan="9" style="text-align:center;padding:12px;">Aucun dossier trouvé.</td></tr>`;
      if (LIMITED_VIEW) hideLimitedColumns();
      return;
    }

    const html = rows.map(r=>{
      const no  = String(r.no||"");
      const h   = (r.snapshot && r.snapshot.header) || {};
      const client  = h.client || r.client || "";
      const magasin = h.magasin || r.magasin || "";
      const compte  = h.compte || r.compte  || "";
      const service = h.service|| r.service || "";
      const date    = fmtJJMMYYYY(h.dateDemande || r.demandeDate || r.date);
      const statut  = r.status || r.statut || "Demande envoyé";
      const eta     = r.estimation || "";

      return `
        <tr data-no="${esc(no)}">
          <td class="nowrap">${esc(no.padStart(5,"0"))}</td>
          <td class="wrap-ok">${esc(magasin)}</td>
          <td class="nowrap">${esc(compte)}</td>
          <td class="truncate" title="${esc(client)}">${esc(client)}</td>
          <td class="truncate" title="${esc(service)}">${esc(service)}</td>
          <td class="nowrap">${esc(date)}</td>
          <td class="nowrap">${statutChip(statut)}</td>
          <td data-col="eta">
            <div class="etaGroup">
              <input class="etaInput" type="number" min="0"
                     value="${esc(eta)}"
                     data-no="${esc(no)}" />
            </div>
          </td>
          <td data-col="actions">
            <button class="btnSave" data-no="${esc(no)}">Valider</button>
            <button class="btnView" data-no="${esc(no)}">Voir dossier</button>
          </td>
        </tr>`;
    }).join("");

    $tbody.innerHTML = html;

    if (LIMITED_VIEW){
      hideLimitedColumns();
    }

    // Wiring actions
    $tbody.querySelectorAll(".btnSave").forEach(btn=>{
      btn.addEventListener("click", onClickSaveStatus);
    });
    $tbody.querySelectorAll(".btnView").forEach(btn=>{
      btn.addEventListener("click", onClickView);
    });
  }

  async function loadCases(){
    IS_LOADING = true;
    setTableLoading("Chargement des dossiers…");
    try{
      const resp = await fetch(API_BASE + "/atelier/api/cases");
      if (!resp.ok) throw new Error("HTTP " + resp.status);
      const js = await resp.json();
      const data = (js && js.data) || [];
      ALL_ROWS = data;
      IS_LOADING = false;
      drawTable();
    } catch(e){
      console.error("Erreur /atelier/api/cases:", e);
      IS_LOADING = false;
      $tbody.innerHTML =
        `<tr><td colspan="9" style="text-align:center;padding:16px;color:#b91c1c;">
          Erreur de chargement des dossiers.
         </td></tr>`;
    }
  }

  async function onClickSaveStatus(evt){
    const btn = evt.currentTarget;
    const no  = btn.dataset.no;
    const row = ALL_ROWS.find(r => String(r.no) === String(no));
    if (!row) return;

    const input = $tbody.querySelector(`input.etaInput[data-no="${CSS.escape(no)}"]`);
    const etaVal = input ? input.value.trim() : "";

    btn.disabled = true;
    const oldLabel = btn.textContent;
    btn.innerHTML = '<span class="spinner"></span>';

    try{
      const resp = await fetch(API_BASE + "/atelier/api/cases/" + encodeURIComponent(no) + "/status", {
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify({
          status: row.status || row.statut || "Demande envoyé",
          estimation: etaVal === "" ? "" : Number(etaVal)
        })
      });
      if (!resp.ok){
        throw new Error("HTTP " + resp.status);
      }
      row.estimation = etaVal;
      btn.textContent = "OK";
      setTimeout(()=>{ btn.textContent = oldLabel; btn.disabled=false; }, 700);
    } catch(e){
      console.error("Erreur mise à jour statut:", e);
      btn.textContent = "Erreur";
      setTimeout(()=>{ btn.textContent = oldLabel; btn.disabled=false; }, 1000);
    }
  }

  function buildModalContent(row){
    const h = (row.snapshot && row.snapshot.header) || {};
    const culasse   = row.snapshot && row.snapshot.culasse;
    const inj       = row.snapshot && row.snapshot.injecteur;
    const comm      = (row.snapshot && row.snapshot.commentaires) || "";

    let html = `
      <div class="section">
        <h3>Informations client</h3>
        <div class="grid2">
          <div><span class="label">Client :</span> ${esc(h.client||"")}</div>
          <div><span class="label">N° de compte :</span> ${esc(h.compte||"")}</div>
          <div><span class="label">Téléphone :</span> ${esc(h.telephone||"")}</div>
          <div><span class="label">Mail magasinier/réceptionnaire :</span> ${esc(h.email||"")}</div>
          <div><span class="label">Magasin :</span> ${esc(h.magasin||row.magasin||"")}</div>
          <div><span class="label">Date demande :</span> ${esc(fmtJJMMYYYY(h.dateDemande||row.demandeDate||row.date))}</div>
          <div><span class="label">Véhicule :</span> ${esc(h.vehicule||"")}</div>
          <div><span class="label">Immatriculation :</span> ${esc(h.immat||"")}</div>
        </div>
      </div>
    `;

    if (h.service === "Rectification Culasse" && culasse){
      const ops = Array.isArray(culasse.operations) ? culasse.operations : [];
      const pieces = culasse.piecesAFournir || [];
      html += `
        <div class="section">
          <h3>Détails Rectification Culasse</h3>
          <div class="grid2">
            <div><span class="label">Cylindre :</span> ${esc(culasse.cylindre||"")}</div>
            <div><span class="label">Soupapes :</span> ${esc(culasse.soupapes||"")}</div>
            <div><span class="label">Carburant :</span> ${esc(culasse.carburant||"")}</div>
          </div>
        </div>
        <div class="section">
          <h3>Opérations (cochées)</h3>
          ${
            ops.length
              ? ops.map(op=>{
                  const refs = (op.references||[]).map(r=>{
                    const bits = [];
                    if (r.reference)  bits.push(esc(r.reference));
                    if (r.libelleRef) bits.push(esc(r.libelleRef));
                    if (r.prixHT || r.prixHT === 0) bits.push(esc(String(r.prixHT)) + " € HT");
                    return "<div class='area' style='margin-top:2px;'>" + bits.join(" – ") + "</div>";
                  }).join("");
                  return `<div class="section">
                            <div class="label">${esc(op.libelle||op.ligne||"")}</div>
                            ${refs}
                          </div>`;
                }).join("")
              : "<div class='area'>Aucune opération cochée.</div>"
          }
        </div>
        <div class="section">
          <h3>Pièces à Fournir</h3>
          ${
            pieces.length
              ? "<div class='area'>" + pieces.map(p=>"• "+esc(p)).join("\n") + "</div>"
              : "<div class='area'>Aucune pièce sélectionnée.</div>"
          }
        </div>
      `;
    }

    if ((h.service === "Contrôle injection Diesel" || h.service === "Contrôle injection Essence") && inj){
      html += `
        <div class="section">
          <h3>Détails Contrôle injection</h3>
          <div class="grid2">
            <div><span class="label">Type :</span> ${esc(inj.type||"")}</div>
            <div><span class="label">Nombre d’injecteurs :</span> ${esc(inj.nombre||"")}</div>
          </div>
        </div>
      `;
    }

    if (comm && String(comm).trim()){
      html += `
        <div class="section">
          <h3>Commentaires</h3>
          <div class="area">${esc(comm)}</div>
        </div>`;
    }

    return html;
  }

  function onClickView(evt){
    const no = evt.currentTarget.dataset.no;
    const row = ALL_ROWS.find(r => String(r.no) === String(no));
    if (!row) return;

    $modalTitle.textContent = "Dossier " + String(no).padStart(5,"0");
    $modalContent.innerHTML = buildModalContent(row);
    $mask.style.display = "flex";
    $mask.setAttribute("aria-hidden","false");

    $btnPrint.onclick = () => {
      const payload = row.snapshot || {};
      payload.no = String(row.no||"");
      fetch(API_BASE + "/atelier/api/print-html", {
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify(payload)
      })
        .then(r=>r.text())
        .then(html=>{
          const w = window.open("", "_blank");
          if (!w) return;
          w.document.open();
          w.document.write(html);
          w.document.close();
        })
        .catch(e=>console.error("Erreur print-html:",e));
    };
  }

  $btnClose.addEventListener("click", ()=>{
    $mask.style.display = "none";
    $mask.setAttribute("aria-hidden","true");
  });

  $mask.addEventListener("click", e=>{
    if (e.target === $mask){
      $mask.style.display = "none";
      $mask.setAttribute("aria-hidden","true");
    }
  });

  $filter.addEventListener("change", drawTable);
  $q.addEventListener("input", drawTable);

  // Gestion du login (mot de passe)
  function handleLogin(){
    const pwd = ($pwdInput.value || "").trim();
    if (!pwd){
      $errBox.textContent = "Merci de saisir un mot de passe.";
      return;
    }
    if (PASS_FULL && pwd === PASS_FULL){
      LIMITED_VIEW = false;
      $overlay.style.display = "none";
      initAfterLogin();
      return;
    }
    if (PASS_LIMITED && pwd === PASS_LIMITED){
      LIMITED_VIEW = true;
      $overlay.style.display = "none";
      initAfterLogin();
      return;
    }
    $errBox.textContent = "Mot de passe incorrect.";
  }

  $btnLogin.addEventListener("click", handleLogin);
  $pwdInput.addEventListener("keydown", e=>{
    if (e.key === "Enter"){
      handleLogin();
    }
  });

  function initAfterLogin(){
    setLegend();
    buildMonthButtons();
    loadCases();
  }

  // On n'initialise la page qu'après mot de passe OK
  // (Si tu veux un accès sans mot de passe en dev, tu peux forcer LIMITED_VIEW ou FULL ici)
</script>
</body>
</html>
