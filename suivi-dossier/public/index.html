<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Suivi des dossiers Atelier</title>
<style>
  :root{
    --primary:#004080; --line:#e5e7eb; --ink:#0f172a;
    --s1:#2563eb10; --s2:#16a34a10; --s3:#f59e0b10; --s4:#9333ea10;
    --s1b:#2563eb;   --s2b:#16a34a;   --s3b:#d97706;   --s4b:#7e22ce;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:#fff;color:var(--ink)}
  .wrap{max-width:1680px;margin:22px auto;padding:14px}
  h1{ margin:0 0 10px; color:var(--primary); font-size:1.35rem; }

  .toolbar{display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin:6px 0 12px}
  label{font-weight:600;color:#334155}
  select,input{padding:8px 10px; border:1px solid var(--line); border-radius:10px; font-size:.95rem; background:#fff}

  /* Années / Mois */
  .yearbar{margin:10px 0 12px;display:flex;flex-direction:column;gap:8px}
  .yearTabs{display:flex;gap:8px;flex-wrap:wrap}
  .yearBtn{background:#fff;color:#073763;border:1px solid var(--line);border-radius:999px;padding:6px 12px;font-weight:700;cursor:pointer;font-size:.95rem}
  .yearBtn.active{background:#004080;color:#fff;border-color:#004080}
  .months{display:none;gap:6px;flex-wrap:wrap}
  .months.active{display:flex}
  .monthBtn{background:#fff;border:1px solid var(--line);color:#073763;border-radius:999px;padding:6px 10px;cursor:pointer;font-weight:600;font-size:.9rem}
  .monthBtn.active{background:#eef5ff;border-color:#bcd7ff}
  .legend{opacity:.8;font-size:.9rem}

  /* Tableau (blanc, sans quadrillage) */
  .tableWrap{border:1px solid var(--line);border-radius:12px;background:#fff;overflow:hidden}
  table{width:100%; border-collapse:separate; border-spacing:0 8px; table-layout:fixed; background:#fff}
  thead th{
    background:#f8fbff; text-align:left; padding:10px 12px; color:#334155; font-size:.92rem; border-bottom:1px solid var(--line);
    white-space:nowrap;
  }
  thead th.th-eta, thead th.th-actions{ white-space:normal; line-height:1.15; }
  tbody tr{background:#fff}
  tbody td{padding:10px 12px; font-size:.95rem; vertical-align:middle; border:0; background:#fff}

  /* Largeurs (100%) – Statut ↓, Estimation ↑ */
  .col-no        { width: 5%  }
  .col-magasin   { width: 10% }
  .col-compte    { width: 8%  }
  .col-client    { width: 14% }
  .col-service   { width: 16% }
  .col-date      { width: 9%  }
  .col-statut    { width: 11% } /* réduit */
  .col-eta       { width: 13% } /* élargi */
  .col-actions   { width: 14% }

  .nowrap   { white-space:nowrap; }
  .truncate { overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }

  /* Statuts / contrôles */
  .badge{
    display:inline-flex; align-items:center; justify-content:center;
    padding:5px 8px; border-radius:999px; font-weight:700; font-size:.84rem; min-width:84px; text-align:center;
  }
  .s-1{background:var(--s1); color:var(--s1b)}
  .s-2{background:var(--s2); color:var(--s2b)}
  .s-3{background:var(--s3); color:var(--s3b)}
  .s-4{background:var(--s4); color:var(--s4b)}

  .actions{display:flex; gap:8px; align-items:center; justify-content:flex-end; flex-wrap:nowrap}
  .statusSel{padding:7px 10px; border:1px solid var(--line); border-radius:10px; font-size:.9rem; min-width:150px;}
  .etaSel   {padding:7px 10px; border:1px solid var(--line); border-radius:10px; font-size:.9rem; min-width:110px;}
  button{appearance:none; border:1px solid var(--primary); background:#fff; color:#004080;
    padding:7px 10px; border-radius:10px; font-weight:700; cursor:pointer; font-size:.9rem}
  .btnView{white-space:normal; line-height:1.05; padding:7px 10px; min-width:86px} /* “Voir” au-dessus de “dossier” */

  .spinner{
    width:14px;height:14px;border:2px solid #e5e7eb;border-top-color:#004080;border-radius:50%;animation:spin 1s linear infinite;display:inline-block;vertical-align:middle
  }
  @keyframes spin{to{transform:rotate(360deg)}}

  /* Modale */
  .mask{ position:fixed; inset:0; background:#0008; display:none; align-items:flex-start; justify-content:center; z-index:10000; padding:16px; }
  .box{ width:min(900px,96vw); max-height:min(90vh,800px); background:#fff; border-radius:14px; overflow:auto; border:1px solid var(--line); margin-top:10px; }
  .bar{display:flex; align-items:center; justify-content:space-between; padding:8px 12px; border-bottom:1px solid var(--line); background:#f8fbff}
  .content{padding:12px}
  .grid2{display:grid; grid-template-columns:1fr 1fr; gap:6px 14px}
  .label{font-weight:700}
  .section{margin-top:12px}
  .section h3{margin:8px 0; color:#0b4a6f; font-size:.95rem}
  .area{border:1px solid var(--line); padding:10px; white-space:pre-wrap}
</style>
</head>
<body>

<div class="wrap">
  <h1>Suivi des dossiers Atelier</h1>

  <div class="toolbar">
    <label>Filtrer magasin :
      <select id="filterMag">
        <option value="">Tous</option>
        <option>Gleizé</option><option>Miribel</option><option>Seynod</option><option>Annemasse</option>
      </select>
    </label>
    <input id="q" type="search" placeholder="Rechercher (n°, magasin, compte, client, service…)" style="min-width:280px" />
  </div>

  <!-- Années / Mois -->
  <div class="yearbar" aria-label="Filtre par année et mois (Date de la demande)">
    <div class="yearTabs" role="tablist" aria-label="Années">
      <button type="button" class="yearBtn" data-year="2025" role="tab" aria-controls="months-2025" aria-selected="false">2025</button>
      <button type="button" class="yearBtn" data-year="2026" role="tab" aria-controls="months-2026" aria-selected="false">2026</button>
    </div>
    <div id="months-2025" class="months" role="tabpanel" aria-label="Mois 2025"></div>
    <div id="months-2026" class="months" role="tabpanel" aria-label="Mois 2026"></div>
    <div class="legend" id="legend"></div>
  </div>

  <div class="tableWrap">
    <table id="tab">
      <colgroup>
        <col class="col-no">
        <col class="col-magasin">
        <col class="col-compte">
        <col class="col-client">
        <col class="col-service">
        <col class="col-date">
        <col class="col-statut">
        <col class="col-eta">
        <col class="col-actions">
      </colgroup>
      <thead>
        <tr>
          <th class="nowrap">N°</th>
          <th class="nowrap">Magasin</th>
          <th class="nowrap">N° de compte</th>
          <th class="nowrap">Client</th>
          <th class="nowrap">Service</th>
          <th class="nowrap">Date</th>
          <th class="nowrap">Statut</th>
          <th class="th-eta">Estimation<br>Temps Travaux</th>
          <th class="th-actions">Actions</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<!-- Modale détails -->
<div class="mask" id="mask" aria-hidden="true">
  <div class="box" role="dialog" aria-label="Dossier">
    <div class="bar">
      <div id="modalTitle" style="font-weight:800;color:#004080">Dossier</div>
      <div>
        <button id="btnPrint">Imprimer</button>
        <button id="btnClose">Fermer</button>
      </div>
    </div>
    <div class="content" id="modalContent"></div>
  </div>
</div>

<script>
/* ---------- DOM refs ---------- */
const $tbody = document.querySelector("#tab tbody");
const $filter = document.getElementById("filterMag");
const $q      = document.getElementById("q");
const $mask   = document.getElementById("mask");
const $btnClose = document.getElementById("btnClose");
const $btnPrint = document.getElementById("btnPrint");
const $modalTitle = document.getElementById("modalTitle");
const $modalContent = document.getElementById("modalContent");
const $legend = document.getElementById("legend");

/* ---------- Helpers ---------- */
function setTableLoading(msg){
  $tbody.innerHTML = `<tr><td colspan="9" style="padding:14px 10px;color:#334155">
    <span class="spinner" aria-hidden="true" style="margin-right:8px"></span>${msg||"Chargement…"}
  </td></tr>`;
}
const LABELS = ["Demande envoyé","Pièce reçu","Travaux en cours","Renvoyé"];
function badge(status){
  const m = {"Demande envoyé":"s-1","Pièce reçu":"s-2","Travaux en cours":"s-3","Renvoyé":"s-4"}[status] || "s-1";
  return `<span class="badge ${m}">${status}</span>`;
}
function p2(n){ return String(n).padStart(2,"0"); }
function parseDate(v){
  if (!v && v!==0) return null;
  const d = new Date(v);
  if (!isNaN(d)) return d;
  const m1 = String(v).match(/^(\d{4})-(\d{2})-(\d{2})$/);
  if (m1) { const d2 = new Date(+m1[1], +m1[2]-1, +m1[3]); return isNaN(d2)?null:d2; }
  const m2 = String(v).match(/^(\d{2})-(\d{2})-(\d{4})$/);
  if (m2) { const d2 = new Date(+m2[3], +m2[2]-1, +m2[1]); return isNaN(d2)?null:d2; }
  return null;
}
function fmtJJMMYYYYdash(v){ const d = parseDate(v); return d ? `${p2(d.getDate())}-${p2(d.getMonth()+1)}-${d.getFullYear()}` : "—"; }

/* ---------- Années / Mois ---------- */
const MONTHS_FULL = ["Janvier","Février","Mars","Avril","Mai","Juin","Juillet","Août","Septembre","Octobre","Novembre","Décembre"];
let YEAR_FILTER = '';   // '2025' / '2026' / ''
let MONTH_FILTER = '';  // '1'..'12' / 'all' / ''

function buildMonths(year){
  const ctn = document.getElementById(`months-${year}`); if(!ctn) return;
  ctn.innerHTML = '';
  MONTHS_FULL.forEach((label, idx)=>{
    const m = idx+1;
    const btn = document.createElement('button');
    btn.type = 'button'; btn.className = 'monthBtn';
    btn.dataset.month = String(m); btn.dataset.year = String(year);
    btn.textContent = label; ctn.appendChild(btn);
  });
  const allBtn = document.createElement('button');
  allBtn.type = 'button'; allBtn.className = 'monthBtn';
  allBtn.dataset.month = 'all'; allBtn.dataset.year = String(year);
  allBtn.textContent = 'Tout'; ctn.appendChild(allBtn);
}
function setYearActive(year){
  YEAR_FILTER = String(year||'') || ''; MONTH_FILTER = '';
  document.querySelectorAll('.yearBtn').forEach(b=>{
    const on = String(b.dataset.year)===String(year);
    b.classList.toggle('active', on);
    b.setAttribute('aria-selected', on?'true':'false');
  });
  document.querySelectorAll('.months').forEach(div=>{
    div.classList.toggle('active', div.id===`months-${year}`);
  });
  document.querySelectorAll(`#months-${year} .monthBtn`).forEach(b=> b.classList.remove('active'));
  draw();
}
function setMonthActive(year, month){
  if(String(YEAR_FILTER)!==String(year)) setYearActive(year);
  MONTH_FILTER = String(month||'');
  document.querySelectorAll(`#months-${year} .monthBtn`).forEach(b=>{
    b.classList.toggle('active', String(b.dataset.month)===String(month));
  });
  draw();
}
document.querySelector('.yearTabs').addEventListener('click', (e)=>{
  const b = e.target.closest('.yearBtn'); if(!b) return; setYearActive(b.dataset.year);
});
document.getElementById('months-2025').addEventListener('click', (e)=>{
  const b = e.target.closest('.monthBtn'); if(!b) return; setMonthActive('2025', b.dataset.month);
});
document.getElementById('months-2026').addEventListener('click', (e)=>{
  const b = e.target.closest('.monthBtn'); if(!b) return; setMonthActive('2026', b.dataset.month);
});

/* ---------- Données ---------- */
let rows = [];
function buildEstimateSelect(value){
  const v = Number(value) || "";
  let opts = ""; for (let i=1;i<=10;i++) opts += `<option value="${i}" ${v===i?"selected":""}>${i}</option>`;
  return `<select class="etaSel" aria-label="Estimation Temps Travaux">${opts}</select>`;
}
function matchesYearMonth(d){
  if (!YEAR_FILTER) return true;
  if (!d) return false;
  if (String(d.getFullYear()) !== String(YEAR_FILTER)) return false;
  if (!MONTH_FILTER || MONTH_FILTER==='all') return true;
  return (d.getMonth()+1) === Number(MONTH_FILTER);
}

function draw(){
  const mag = $filter.value.trim().toLowerCase();
  const q = $q.value.trim().toLowerCase();

  const list = [...rows].sort((a,b)=>{
    const da = parseDate(a.demandeDate), db = parseDate(b.demandeDate);
    return (db?db.getTime():0) - (da?da.getTime():0);
  });

  let count = 0;
  $tbody.innerHTML = "";
  list
    .filter(r => !mag || (r.magasin||"").toLowerCase() === mag)
    .filter(r => matchesYearMonth(parseDate(r.demandeDate)))
    .filter(r => {
      if (!q) return true;
      const s = [String(r.no).padStart(5,'0'), r.magasin, r.compte, r.client, r.service, fmtJJMMYYYYdash(r.demandeDate)]
        .join(' ').toLowerCase();
      return s.includes(q);
    })
    .forEach(r => {
      count++;
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td class="col-no nowrap"        title="${String(r.no)}">${String(r.no).padStart(5,'0')}</td>
        <td class="col-magasin truncate" title="${r.magasin||""}">${r.magasin||""}</td>
        <td class="col-compte nowrap"    title="${r.compte||""}">${r.compte||""}</td>
        <td class="col-client truncate"  title="${r.client||""}">${r.client||""}</td>
        <td class="col-service truncate" title="${r.service||""}">${r.service||""}</td>
        <td class="col-date nowrap"      title="${fmtJJMMYYYYdash(r.demandeDate)}">${fmtJJMMYYYYdash(r.demandeDate)}</td>
        <td class="col-statut nowrap">${badge(r.status)}</td>
        <td class="col-eta nowrap">${buildEstimateSelect(r.estimation)}</td>
        <td class="col-actions nowrap">
          <div class="actions">
            <button class="btnView">Voir<br>dossier</button>
            <select class="statusSel">
              ${LABELS.map(lbl=>`<option ${r.status===lbl?"selected":""}>${lbl}</option>`).join("")}
            </select>
            <button class="btnSave">Valider</button>
          </div>
        </td>
      `;

      tr.querySelector(".btnView").addEventListener("click", ()=> openDetails(r));

      tr.querySelector(".btnSave").addEventListener("click", async ()=>{
        const statusSel = tr.querySelector(".statusSel");
        const etaSel = tr.querySelector(".etaSel");
        const saveBtn = tr.querySelector(".btnSave");
        const oldHtml = saveBtn.innerHTML;
        const status = statusSel.value;
        const estimation = Number(etaSel.value);

        try{
          saveBtn.disabled = true; statusSel.disabled = true; etaSel.disabled = true;
          saveBtn.innerHTML = `<span class="spinner" aria-hidden="true" style="margin-right:6px"></span>…`;

          const resp = await fetch(`/atelier/api/cases/${encodeURIComponent(r.no)}/status`, {
            method:"POST",
            headers:{ "Content-Type":"application/json" },
            body: JSON.stringify({ status, estimation })
          });
          if(!resp.ok){ alert("Erreur de mise à jour"); return; }
          r.status = status; r.estimation = estimation;
        } finally{
          saveBtn.innerHTML = oldHtml;
          saveBtn.disabled = false; statusSel.disabled = false; etaSel.disabled = false;
        }
      });

      $tbody.appendChild(tr);
    });

  const ymText = YEAR_FILTER
    ? (MONTH_FILTER && MONTH_FILTER!=='all'
        ? `${MONTHS_FULL[Number(MONTH_FILTER)-1]} ${YEAR_FILTER}`
        : `Tout ${YEAR_FILTER}`)
    : 'Toutes années';
  $legend.textContent = `${count} dossier(s) • ${ymText}`;
}

/* ---------- Détails (modale) ---------- */
function openDetails(row){
  const h = (row.snapshot && row.snapshot.header) || {};
  const com = (row.snapshot && row.snapshot.commentaires) ? String(row.snapshot.commentaires).trim() : "";
  const html = `
    <div class="grid2">
      <div><span class="label">N° :</span> ${String(row.no).padStart(5,'0')}</div>
      <div><span class="label">Date :</span> ${fmtJJMMYYYYdash(row.demandeDate)}</div>
      <div><span class="label">Magasin :</span> ${h.magasin||row.magasin||""}</div>
      <div><span class="label">Statut :</span> ${row.status||""}</div>
      <div><span class="label">Client :</span> ${h.client||row.client||""}</div>
      <div><span class="label">Compte :</span> ${h.compte||row.compte||""}</div>
      <div><span class="label">Véhicule :</span> ${h.vehicule||""}</div>
      <div><span class="label">Immat. :</span> ${h.immat||""}</div>
      <div><span class="label">Service :</span> ${h.service||row.service||""}</div>
      <div><span class="label">Estimation :</span> ${row.estimation || "—"}</div>
    </div>
    ${com ? `<div class="section"><h3>Commentaires</h3><div class="area">${com}</div></div>` : ""}
  `;
  document.getElementById("modalTitle").textContent = `Dossier ${String(row.no).padStart(5,'0')}`;
  document.getElementById("modalContent").innerHTML = html;
  $mask.style.display = "flex";
  $mask.setAttribute("aria-hidden","false");
}
document.getElementById("btnClose").addEventListener("click", ()=>{
  $mask.style.display = "none";
  $mask.setAttribute("aria-hidden","true");
  document.getElementById("modalContent").innerHTML = "";
});
document.getElementById("btnPrint").addEventListener("click", ()=>{
  const w = window.open("", "_blank");
  w.document.write(`<html><head><meta charset="utf-8"><title>Impression</title>
  <style>body{font-family:system-ui,Arial,sans-serif;padding:20px} .label{font-weight:700}</style></head>
  <body>${document.getElementById("modalContent").innerHTML}</body></html>`);
  w.document.close(); w.focus(); w.print(); w.close();
});

/* ---------- Chargement ---------- */
function load(){
  setTableLoading("Chargement des dossiers…");
  fetch("/atelier/api/cases")
    .then(r=>r.json())
    .then(json=>{
      const data = (json && json.data) || [];
      rows = data.map(x=>{
        const h = (x.snapshot && x.snapshot.header) || {};
        return {
          ...x,
          magasin: x.magasin || (h && h.magasin) || "",
          compte:  x.compte  || (h && h.compte)  || "",
          client:  x.client  || (h && h.client)  || "",
          service: x.service || (h && h.service) || "",
          demandeDate: x.demandeDate || (h && h.dateDemande) || "",
          estimation: Number(x.estimation || "") || ""
        };
      });

      buildMonths(2025);
      buildMonths(2026);

      const now = new Date(); const y = now.getFullYear(), m = now.getMonth()+1;
      if (y === 2025 || y === 2026) setMonthActive(String(y), String(m));
      else { YEAR_FILTER=''; MONTH_FILTER=''; draw(); }
    })
    .catch(e=>{
      console.error(e);
      $tbody.innerHTML = `<tr><td colspan="9" style="padding:14px 10px;color:#b91c1c">Erreur de chargement.</td></tr>`;
      alert("Erreur de chargement.");
    });
}

document.getElementById("filterMag").addEventListener("change", draw);
$q.addEventListener("input", draw);

load();
</script>
</body>
</html>
