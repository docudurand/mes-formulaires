<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Suivi des dossiers Atelier</title>
  <style>
    :root{
      --bg:#f3f4f6;
      --card:#ffffff;
      --line:#e5e7eb;
      --ink:#0f172a;
      --accent:#004080;
      --accent-soft:#dbeafe;
    }
    *{box-sizing:border-box;}
    body{
      margin:0;
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif;
      background:var(--bg);
      color:var(--ink);
    }
    h1,h2{margin:0;}

    .wrap{
      max-width:1200px;
      margin:20px auto 40px;
      padding:0 12px;
    }
    h1{
      font-size:1.5rem;
      margin-bottom:12px;
      color:var(--accent);
    }
    .toolbar{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      padding:10px 12px;
      background:var(--card);
      border-radius:10px;
      border:1px solid var(--line);
      margin-bottom:12px;
    }
    .toolbar label{
      font-size:.9rem;
      display:flex;
      align-items:center;
      gap:6px;
    }
    .toolbar select,
    .toolbar input[type="search"]{
      border-radius:999px;
      border:1px solid var(--line);
      padding:6px 10px;
      font-size:.9rem;
    }

    .yearbar{
      margin-bottom:12px;
      background:var(--card);
      border-radius:10px;
      border:1px solid var(--line);
      padding:10px 12px;
    }
    .yearTabs{
      display:flex;
      gap:8px;
      margin-bottom:8px;
      flex-wrap:wrap;
    }
    .yearBtn{
      border-radius:999px;
      border:1px solid var(--accent);
      background:#fff;
      padding:4px 10px;
      font-size:.85rem;
      cursor:pointer;
    }
    .yearBtn.active{
      background:var(--accent);
      color:#fff;
    }
    .months{
      display:none;
      gap:6px;
      flex-wrap:wrap;
      margin-bottom:6px;
    }
    .months.active{display:flex;}
    .monthBtn{
      border-radius:999px;
      border:1px solid var(--line);
      background:#fff;
      padding:3px 8px;
      font-size:.8rem;
      cursor:pointer;
    }
    .monthBtn.active{
      background:var(--accent-soft);
      border-color:var(--accent);
      color:var(--accent);
    }
    .legend{
      font-size:.85rem;
      color:#4b5563;
    }

    .tableWrap{
      background:var(--card);
      border-radius:10px;
      border:1px solid var(--line);
      overflow:auto;
    }
    table{
      border-collapse:collapse;
      width:100%;
      font-size:.9rem;
    }
    thead{
      background:#f9fafb;
      position:sticky;
      top:0;
      z-index:1;
    }
    th,td{
      padding:6px 8px;
      border-bottom:1px solid var(--line);
      vertical-align:middle;
    }
    th{
      text-align:left;
      font-size:.8rem;
      font-weight:600;
      color:#4b5563;
      white-space:nowrap;
    }
    td{
      font-size:.9rem;
    }
    .nowrap{white-space:nowrap;}
    .truncate{
      max-width:220px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .wrap-ok{
      white-space:normal;
      word-break:break-word;
      max-width:160px;
    }

    .badge{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      padding:2px 8px;
      border-radius:999px;
      font-size:.75rem;
      font-weight:600;
    }
    .badge.s-1{background:#e0f2fe;color:#0369a1;}
    .badge.s-2{background:#dcfce7;color:#166534;}
    .badge.s-3{background:#fef3c7;color:#92400e;}
    .badge.s-4{background:#fee2e2;color:#b91c1c;}

    .etaGroup{
      display:flex;
      align-items:center;
      gap:6px;
    }
    .etaSel{
      border-radius:8px;
      border:1px solid var(--line);
      padding:3px 6px;
      font-size:.85rem;
    }
    .actions{
      display:flex;
      gap:6px;
      align-items:center;
    }
    .actions select{
      border-radius:8px;
      border:1px solid var(--line);
      padding:3px 6px;
      font-size:.85rem;
    }
    .actions button{
      border-radius:8px;
      border:none;
      padding:5px 10px;
      font-size:.8rem;
      cursor:pointer;
      background:var(--accent);
      color:#fff;
      font-weight:600;
    }
    .btnView{
      border-radius:8px;
      border:1px solid var(--accent);
      padding:4px 8px;
      font-size:.75rem;
      cursor:pointer;
      background:#fff;
      color:var(--accent);
      line-height:1.1;
    }

    .mask{
      position:fixed;
      inset:0;
      background:rgba(15,23,42,.45);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:40;
    }
    .mask.active{display:flex;}
    .mask .box{
      background:#fff;
      border-radius:12px;
      width:90%;
      max-width:800px;
      max-height:90vh;
      display:flex;
      flex-direction:column;
      overflow:hidden;
      box-shadow:0 10px 25px rgba(15,23,42,.3);
    }
    .mask .bar{
      padding:10px 12px;
      border-bottom:1px solid var(--line);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      background:#f9fafb;
    }
    .mask .bar button{
      border-radius:999px;
      border:1px solid var(--accent);
      background:#fff;
      color:var(--accent);
      font-size:.8rem;
      padding:4px 10px;
      cursor:pointer;
    }
    .mask .content{
      padding:10px 12px;
      overflow:auto;
      font-size:.9rem;
    }
    .spinner{
      width:14px;height:14px;
      border-radius:50%;
      border:2px solid #e5e7eb;
      border-top-color:var(--accent);
      animation:spin 1s linear infinite;
      display:inline-block;
    }
    @keyframes spin{to{transform:rotate(360deg);}}

    .loginOverlay{
      position:fixed;
      inset:0;
      background:rgba(15,23,42,0.6);
      z-index:50;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .loginBox{
      background:#fff;
      border-radius:14px;
      padding:20px 18px 18px;
      max-width:320px;
      width:90%;
      box-shadow:0 10px 25px rgba(15,23,42,.4);
      border:1px solid var(--line);
      text-align:center;
    }
    .loginBox h2{
      font-size:1.1rem;
      margin-bottom:6px;
      color:var(--accent);
    }
    .loginBox p{
      margin:0 0 10px;
      font-size:.9rem;
      color:#4b5563;
    }
    .loginBox input{
      width:100%;
      border-radius:999px;
      border:1px solid var(--line);
      padding:8px 10px;
      font-size:.9rem;
      margin-bottom:8px;
    }
    .loginBox button{
      width:100%;
      border-radius:999px;
      border:none;
      padding:8px 10px;
      font-weight:700;
      background:var(--accent);
      color:#fff;
      cursor:pointer;
      font-size:.95rem;
    }
    .loginBox .error{
      margin-top:8px;
      font-size:.85rem;
      color:#b91c1c;
      min-height:1.1em;
    }
  </style>
</head>
<body>

<div class="loginOverlay" id="suiviLoginOverlay">
  <div class="loginBox">
    <h2>Accès suivi atelier</h2>
    <p>Veuillez saisir votre mot de passe.</p>
    <input type="password" id="suiviPassword" placeholder="Mot de passe" />
    <button type="button" id="suiviLoginBtn">Se connecter</button>
    <div class="error" id="suiviError"></div>
  </div>
</div>

<div class="wrap">
  <h1>Suivi des dossiers Atelier</h1>

  <div class="toolbar">
    <label>Filtrer magasin :
      <select id="filterMag">
        <option value="">Tous</option>
        <option>Annemasse</option>
        <option>Bourgoin</option>
        <option>Chasse sur Rhone</option>
        <option>Chassieu</option>
        <option>Gleize</option>
        <option>La Motte Servolex</option>
        <option>Miribel</option>
        <option>Renage</option>
        <option>Rives</option>
        <option>Seynod</option>
        <option>St Egreve</option>
        <option>St-Jean-Bonnefonds</option>
      </select>
    </label>
    <input id="q" type="search"
           placeholder="Rechercher (n°, magasin, compte, client, service…)"
           style="min-width:280px" />
  </div>

  <div class="yearbar" aria-label="Filtre par année et mois (Date de la demande)">
    <div class="yearTabs" role="tablist" aria-label="Années">
      <button type="button" class="yearBtn" data-year="2025"
              role="tab" aria-controls="months-2025" aria-selected="false">2025</button>
      <button type="button" class="yearBtn" data-year="2026"
              role="tab" aria-controls="months-2026" aria-selected="false">2026</button>
    </div>
    <div id="months-2025" class="months" role="tabpanel" aria-label="Mois 2025"></div>
    <div id="months-2026" class="months" role="tabpanel" aria-label="Mois 2026"></div>
    <div class="legend" id="legend"></div>
  </div>

  <div class="tableWrap">
    <table id="tab">
      <colgroup>
        <col class="col-no">
        <col class="col-magasin">
        <col class="col-compte">
        <col class="col-client">
        <col class="col-service">
        <col class="col-date">
        <col class="col-statut">
        <col class="col-eta">
        <col class="col-actions">
      </colgroup>
      <thead>
        <tr>
          <th class="nowrap">N°</th>
          <th class="wrap-ok">Magasin</th>
          <th class="nowrap">N° de compte</th>
          <th class="truncate">Client</th>
          <th class="truncate">Service</th>
          <th class="nowrap">Date</th>
          <th class="nowrap">Statut</th>
          <th class="th-eta">Estimation<br>Temps Travaux<br>(Jours)</th>
          <th class="th-actions">Actions</th>
        </tr>
      </thead>
      <tbody aria-live="polite"></tbody>
    </table>
  </div>
</div>

<div class="mask" id="mask" aria-hidden="true">
  <div class="box" role="dialog" aria-label="Dossier">
    <div class="bar">
      <div id="modalTitle" style="font-weight:800;color:#004080">Dossier</div>
      <div>
        <button id="btnPrint">Imprimer</button>
        <button id="btnClose">Fermer</button>
      </div>
    </div>
    <div class="content" id="modalContent"></div>
  </div>
</div>

<script src="/suivi-dossier/config.js"></script>

<script>
const API_BASE =
  (location.hostname.includes("wixsite.com") || location.hostname.endsWith(".wix.com"))
    ? "https://mes-formulaires.onrender.com"
    : location.origin.replace(/\/$/, "");

const cfgSuivi = window.__SUIVI_CFG || {};
const PASS_FULL    = cfgSuivi.SUIVI_PASS_FULL    || "";
const PASS_LIMITED = cfgSuivi.SUIVI_PASS_LIMITED || "";

const $tbody        = document.querySelector("#tab tbody");
const $filter       = document.getElementById("filterMag");
const $q            = document.getElementById("q");
const $mask         = document.getElementById("mask");
const $btnClose     = document.getElementById("btnClose");
const $btnPrint     = document.getElementById("btnPrint");
const $modalTitle   = document.getElementById("modalTitle");
const $modalContent = document.getElementById("modalContent");
const $legend       = document.getElementById("legend");

const $overlay  = document.getElementById("suiviLoginOverlay");
const $pwdInput = document.getElementById("suiviPassword");
const $btnLogin = document.getElementById("suiviLoginBtn");
const $errBox   = document.getElementById("suiviError");

let IS_LOADING   = true;
let LIMITED_VIEW = false;
let rows = [];

function setTableLoading(msg){
  $tbody.innerHTML = `<tr><td colspan="9" style="padding:14px 10px;color:#334155">
    <span class="spinner" aria-hidden="true" style="margin-right:8px"></span>${msg || "Chargement…"}
  </td></tr>`;
}

const LABELS = ["Demande envoyé","Pièce reçu","Travaux en cours","Renvoyé"];
function badge(status){
  const m = {"Demande envoyé":"s-1","Pièce reçu":"s-2","Travaux en cours":"s-3","Renvoyé":"s-4"}[status] || "s-1";
  return `<span class="badge ${m}">${status}</span>`;
}
function p2(n){ return String(n).padStart(2,"0"); }
function parseDate(v){
  if (!v && v!==0) return null;
  const d = new Date(v);
  if (!isNaN(d)) return d;
  const m1 = String(v).match(/^(\d{4})-(\d{2})-(\d{2})$/);
  if (m1){ const d2 = new Date(+m1[1], +m1[2]-1, +m1[3]); return isNaN(d2)?null:d2; }
  const m2 = String(v).match(/^(\d{2})-(\d{2})-(\d{4})$/);
  if (m2){ const d3 = new Date(+m2[3], +m2[2]-1, +m2[1]); return isNaN(d3)?null:d3; }
  return null;
}
function fmtJJMMYYYYdash(v){
  const d = parseDate(v);
  return d ? `${p2(d.getDate())}-${p2(d.getMonth()+1)}-${d.getFullYear()}` : "—";
}
function esc(s){
  return String(s ?? "").replace(/[&<>"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;'}[c]));
}

const MONTHS_FULL = ["Janvier","Février","Mars","Avril","Mai","Juin","Juillet","Août","Septembre","Octobre","Novembre","Décembre"];
let YEAR_FILTER  = "";
let MONTH_FILTER = "";

function buildMonths(year){
  const ctn = document.getElementById(`months-${year}`); if (!ctn) return;
  ctn.innerHTML = "";
  MONTHS_FULL.forEach((label, idx)=>{
    const m = idx+1;
    const btn = document.createElement("button");
    btn.type = "button";
    btn.className = "monthBtn";
    btn.dataset.month = String(m);
    btn.dataset.year  = String(year);
    btn.textContent   = label;
    ctn.appendChild(btn);
  });
  const allBtn = document.createElement("button");
  allBtn.type = "button";
  allBtn.className = "monthBtn";
  allBtn.dataset.month = "all";
  allBtn.dataset.year  = String(year);
  allBtn.textContent   = "Tout";
  ctn.appendChild(allBtn);
}
function setYearActive(year){
  YEAR_FILTER  = String(year || "") || "";
  MONTH_FILTER = "";
  document.querySelectorAll(".yearBtn").forEach(b=>{
    const on = String(b.dataset.year) === String(year);
    b.classList.toggle("active", on);
    b.setAttribute("aria-selected", on ? "true" : "false");
  });
  document.querySelectorAll(".months").forEach(div=>{
    div.classList.toggle("active", div.id === `months-${year}`);
  });
  document.querySelectorAll(`#months-${year} .monthBtn`).forEach(b=> b.classList.remove("active"));
  draw();
}
function setMonthActive(year, month){
  if (String(YEAR_FILTER) !== String(year)) setYearActive(year);
  MONTH_FILTER = String(month || "");
  document.querySelectorAll(`#months-${year} .monthBtn`).forEach(b=>{
    b.classList.toggle("active", String(b.dataset.month) === String(month));
  });
  draw();
}
document.querySelector(".yearTabs").addEventListener("click", (e)=>{
  const b = e.target.closest(".yearBtn"); if (!b) return;
  setYearActive(b.dataset.year);
});
document.getElementById("months-2025").addEventListener("click", (e)=>{
  const b = e.target.closest(".monthBtn"); if (!b) return;
  setMonthActive("2025", b.dataset.month);
});
document.getElementById("months-2026").addEventListener("click", (e)=>{
  const b = e.target.closest(".monthBtn"); if (!b) return;
  setMonthActive("2026", b.dataset.month);
});

function buildEstimateSelect(value){
  const v = (value === "" || value === null || value === undefined) ? "" : Number(value);
  let opts = `<option value="" ${v === "" ? "selected":""}></option>`;
  for (let i=1;i<=10;i++){
    opts += `<option value="${i}" ${v === i ? "selected":""}>${i}</option>`;
  }
  return `<select class="etaSel" aria-label="Estimation Temps Travaux">${opts}</select>`;
}
function matchesYearMonth(d){
  if (!YEAR_FILTER) return true;
  if (!d) return false;
  if (String(d.getFullYear()) !== String(YEAR_FILTER)) return false;
  if (!MONTH_FILTER || MONTH_FILTER === "all") return true;
  return (d.getMonth()+1) === Number(MONTH_FILTER);
}

function applyLimitedView(){
  LIMITED_VIEW = true;
  hideLimitedColumns();
}
function hideLimitedColumns(){
  document.querySelectorAll(".th-eta, .th-actions, .col-eta, .col-actions").forEach(el=>{
    el.style.display = "none";
  });
  document.querySelectorAll("td.col-eta, td.col-actions").forEach(el=>{
    el.style.display = "none";
  });
  document.querySelectorAll(".btnSave").forEach(b=>{
    b.style.display = "none";
  });
}

function doLogin(){
  const pwd = ($pwdInput.value || "").trim();
  $errBox.textContent = "";

  if (PASS_FULL && pwd === PASS_FULL){
    $overlay.style.display = "none";
    document.body.style.overflow = "";
    return;
  }
  if (PASS_LIMITED && pwd === PASS_LIMITED){
    applyLimitedView();
    $overlay.style.display = "none";
    document.body.style.overflow = "";
    return;
  }

  $errBox.textContent = "Mot de passe incorrect.";
}

$btnLogin.addEventListener("click", doLogin);
$pwdInput.addEventListener("keydown", function(e){
  if (e.key === "Enter"){
    e.preventDefault();
    doLogin();
  }
});

document.addEventListener("DOMContentLoaded", function(){
  buildMonths(2025);
  buildMonths(2026);

  setYearActive("2025");

  if (!PASS_FULL && !PASS_LIMITED){
    $overlay.style.display = "none";
  } else {
    document.body.style.overflow = "hidden";
    $pwdInput.focus();
  }

  loadCases();
});

function closeModal(){
  $mask.classList.remove("active");
  $mask.setAttribute("aria-hidden","true");
}
function printModal(){
  const w = window.open("", "_blank", "noopener,noreferrer");
  if (!w) return;
  const html = `
    <!doctype html>
    <html><head><meta charset="utf-8">
      <title>Impression dossier</title>
      <style>
        body{font-family:Arial,Helvetica,sans-serif;font-size:12px;color:#111;margin:15mm;}
        h2{margin-top:0;}
        table{border-collapse:collapse;width:100%;margin-top:8px;}
        td,th{border:1px solid #e5e7eb;padding:4px 6px;font-size:12px;}
        .label{font-weight:700;background:#f9fafb;}
      </style>
    </head>
    <body>${$modalContent.innerHTML}</body></html>`;
  w.document.open();
  w.document.write(html);
  w.document.close();
  w.focus();
  w.print();
}
$btnClose.addEventListener("click", closeModal);
$btnPrint.addEventListener("click", printModal);
$mask.addEventListener("click", (e)=>{
  if (e.target === $mask) closeModal();
});

async function loadCases(){
  IS_LOADING = true;
  setTableLoading("Chargement des dossiers…");
  try{
    const resp = await fetch(`${API_BASE}/atelier/api/cases`);
    if (!resp.ok) throw new Error("HTTP " + resp.status);
    const js = await resp.json();
    rows = (js && js.data) || [];
  } catch(e){
    console.error(e);
    $tbody.innerHTML = `<tr><td colspan="9" style="padding:14px 10px;color:#b91c1c">
      Erreur lors du chargement des dossiers.
    </td></tr>`;
    return;
  } finally{
    IS_LOADING = false;
  }
  draw();
}

function openDetails(row){
  const h   = (row.snapshot && row.snapshot.header)    || {};
  const cul = (row.snapshot && row.snapshot.culasse)   || null;
  const inj = (row.snapshot && row.snapshot.injecteur) || null;
  const com = (row.snapshot && row.snapshot.commentaires) || "";

  let html = "";
  html += `<div><b>N° dossier :</b> ${esc(String(row.no).padStart(5,"0"))}</div>`;
  html += `<div><b>Magasin :</b> ${esc(h.magasin || row.magasin || "")}</div>`;
  html += `<div><b>Client :</b> ${esc(h.client || row.client || "")}</div>`;
  html += `<div><b>Service :</b> ${esc(h.service || row.service || "")}</div>`;
  html += `<div><b>Date demande :</b> ${fmtJJMMYYYYdash(h.dateDemande || row.demandeDate)}</div>`;
  html += `<div><b>Statut :</b> ${esc(row.status || "")}</div>`;

  if (cul){
    html += `<h3>Rectification culasse</h3>`;
    html += `<div><b>Cylindre :</b> ${esc(cul.cylindre || "")}</div>`;
    html += `<div><b>Soupapes :</b> ${esc(cul.soupapes || "")}</div>`;
    html += `<div><b>Carburant :</b> ${esc(cul.carburant || "")}</div>`;
  }
  if (inj){
    html += `<h3>Contrôle injection</h3>`;
    html += `<div><b>Type :</b> ${esc(inj.type || "")}</div>`;
    html += `<div><b>Nombre d’injecteurs :</b> ${esc(inj.nombre || "")}</div>`;
  }
  if (com && com.trim()){
    html += `<h3>Commentaires</h3>`;
    html += `<div style="white-space:pre-wrap;border:1px solid #e5e7eb;padding:6px 8px;border-radius:6px;">${esc(com)}</div>`;
  }

  $modalTitle.textContent = `Dossier ${String(row.no).padStart(5,"0")}`;
  $modalContent.innerHTML = html;
  $mask.classList.add("active");
  $mask.setAttribute("aria-hidden","false");
}

function draw(){
  if (IS_LOADING){
    setTableLoading("Chargement des dossiers…");
    return;
  }

  const mag = $filter.value.trim().toLowerCase();
  const q   = $q.value.trim().toLowerCase();

  const list = [...rows].sort((a,b)=>{
    const da = parseDate(a.demandeDate), db = parseDate(b.demandeDate);
    return (db ? db.getTime() : 0) - (da ? da.getTime() : 0);
  });

  let count = 0;
  $tbody.innerHTML = "";
  list
    .filter(r => !mag || (r.magasin || "").toLowerCase() === mag)
    .filter(r => matchesYearMonth(parseDate(r.demandeDate)))
    .filter(r => {
      if (!q) return true;
      const s = [
        String(r.no).padStart(5,"0"),
        r.magasin,
        r.compte,
        r.client,
        r.service,
        fmtJJMMYYYYdash(r.demandeDate)
      ].join(" ").toLowerCase();
      return s.includes(q);
    })
    .forEach(r => {
      count++;
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td class="col-no nowrap"        title="${String(r.no)}">${String(r.no).padStart(5,"0")}</td>
        <td class="col-magasin wrap-ok"  title="${r.magasin || ""}">${r.magasin || ""}</td>
        <td class="col-compte nowrap"    title="${r.compte || ""}">${r.compte || ""}</td>
        <td class="col-client truncate"  title="${r.client || ""}">${r.client || ""}</td>
        <td class="col-service truncate" title="${r.service || ""}">${r.service || ""}</td>
        <td class="col-date nowrap"      title="${fmtJJMMYYYYdash(r.demandeDate)}">${fmtJJMMYYYYdash(r.demandeDate)}</td>
        <td class="col-statut nowrap">${badge(r.status)}</td>
        <td class="col-eta nowrap">
          <div class="etaGroup">
            ${buildEstimateSelect(r.estimation)}
            <button class="btnView">Voir<br>dossier</button>
          </div>
        </td>
        <td class="col-actions nowrap">
          <div class="actions">
            <select class="statusSel">
              ${LABELS.map(lbl => `<option ${r.status === lbl ? "selected":""}>${lbl}</option>`).join("")}
            </select>
            <button class="btnSave">Valider</button>
          </div>
        </td>
      `;

      tr.querySelector(".btnView").addEventListener("click", ()=> openDetails(r));

      const btnSave   = tr.querySelector(".btnSave");
      const statusSel = tr.querySelector(".statusSel");
      const etaSel    = tr.querySelector(".etaSel");

      btnSave.addEventListener("click", async ()=>{
        const oldHtml = btnSave.innerHTML;
        const status  = statusSel.value;
        const estimation = etaSel.value ? Number(etaSel.value) : "";

        try{
          btnSave.disabled   = true;
          statusSel.disabled = true;
          etaSel.disabled    = true;
          btnSave.innerHTML  = `<span class="spinner" aria-hidden="true"></span>`;

          const resp = await fetch(
            `${API_BASE}/atelier/api/cases/${encodeURIComponent(r.no)}/status`,
            {
              method:"POST",
              headers:{ "Content-Type":"application/json" },
              body: JSON.stringify({ status, estimation })
            }
          );
          if (!resp.ok){
            alert(`Erreur de mise à jour (${resp.status})`);
            return;
          }

          r.status     = status;
          r.estimation = estimation;

          const badgeCell = tr.querySelector(".col-statut");
          if (badgeCell) badgeCell.innerHTML = badge(r.status);
        } finally{
          btnSave.innerHTML   = oldHtml;
          btnSave.disabled    = false;
          statusSel.disabled  = false;
          etaSel.disabled     = false;
        }
      });

      $tbody.appendChild(tr);
    });

  if (count === 0){
    $tbody.innerHTML = `<tr><td colspan="9" style="padding:14px 10px;color:#334155">
      Aucun dossier.
    </td></tr>`;
  }

  const ymText = YEAR_FILTER
    ? (MONTH_FILTER && MONTH_FILTER !== "all"
        ? `${MONTHS_FULL[Number(MONTH_FILTER)-1]} ${YEAR_FILTER}`
        : `Tout ${YEAR_FILTER}`)
    : "Toutes années";
  $legend.textContent = `${count} dossier(s) • ${ymText}`;

  if (LIMITED_VIEW){
    hideLimitedColumns();
  }
}

$filter.addEventListener("change", draw);
$q.addEventListener("input", draw);
</script>
</body>
</html>
