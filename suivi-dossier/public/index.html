<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Suivi des dossiers Atelier</title>
<style>
  :root{
    --primary:#004080; --line:#e5e7eb; --ink:#0f172a;
    --s1:#2563eb10; --s2:#16a34a10; --s3:#f59e0b10; --s4:#9333ea10;
    --s1b:#2563eb;   --s2b:#16a34a;   --s3b:#d97706;   --s4b:#7e22ce;
  }
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:#fff;color:var(--ink)}
  .wrap{max-width:1360px;margin:24px auto;padding:16px}
  h1{ margin:0 0 12px; color:var(--primary); font-size:1.4rem; }
  .toolbar{display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin:8px 0 16px}
  select,input{padding:10px 12px; border:1px solid var(--line); border-radius:8px; font-size:1rem}

  .tableWrap{border:1px solid var(--line);border-radius:12px;background:#fff;overflow:hidden}
  table{width:100%; border-collapse:separate; border-spacing:0 8px; table-layout:fixed;}
  thead th{
    padding:10px 12px; text-align:left; font-size:.95rem; color:#334155; background:#f8fbff; border-bottom:1px solid var(--line);
    white-space:nowrap;
  }
  tbody tr{background:#f9fafb; border:1px solid var(--line)}
  tbody td{padding:9px 10px; font-size:.95rem; vertical-align:middle;}

  .col-no        { width: 6%  }
  .col-magasin   { width: 12% }
  .col-compte    { width: 12% }
  .col-client    { width: 18% }
  .col-service   { width: 16% }
  .col-date      { width: 8%  }
  .col-statut    { width: 10% }
  .col-eta       { width: 8%  }
  .col-actions   { width: 10% }

  .nowrap    { white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
  .truncate  { overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }

  .badge{
    display:inline-flex; align-items:center; justify-content:center;
    padding:6px 10px; border-radius:999px; font-weight:700; font-size:.85rem; min-width:100px; text-align:center;
  }
  .s-1{background:var(--s1); color:var(--s1b)}
  .s-2{background:var(--s2); color:var(--s2b)}
  .s-3{background:var(--s3); color:var(--s3b)}
  .s-4{background:var(--s4); color:var(--s4b)}

  .actions{display:flex; gap:6px; align-items:center; justify-content:flex-end}
  button{appearance:none; border:1px solid var(--primary); background:#fff; color:var(--primary); padding:7px 10px; border-radius:10px; font-weight:700; cursor:pointer; white-space:nowrap; font-size:.9rem}
  .statusSel,.etaSel{padding:7px 8px; border:1px solid var(--line); border-radius:10px; font-size:.9rem; max-width:100%}

  .spinner{
    width:16px;height:16px;border:2px solid #e5e7eb;border-top-color:var(--primary);
    border-radius:50%;animation:spin 1s linear infinite;display:inline-block;vertical-align:middle
  }
  @keyframes spin{to{transform:rotate(360deg)}}

  .mask{
    position:fixed; inset:0; background:#0008; display:none;
    align-items:flex-start; justify-content:center;
    z-index:10000; padding:20px;
  }
  .box{
    width:min(900px,96vw); max-height:min(90vh,800px);
    background:#fff; border-radius:14px; overflow:auto; border:1px solid var(--line);
    margin-top:12px;
  }
  .bar{display:flex; align-items:center; justify-content:space-between; padding:10px 14px; border-bottom:1px solid var(--line); background:#f8fbff}
  .content{padding:14px}
  .grid2{display:grid; grid-template-columns:1fr 1fr; gap:8px 16px}
  .label{font-weight:700}
  .section{margin-top:14px}
  .section h3{margin:10px 0; color:#0b4a6f; font-size:1rem}
  .bul{margin:6px 0}
  .sub{margin:2px 0 0 18px}
  .area{border:1px solid var(--line); padding:10px; white-space:pre-wrap}
</style>
</head>
<body>

  <div class="wrap">
    <h1>Suivi des dossiers Atelier</h1>
    <div class="toolbar">
      <label>Filtrer magasin :
        <select id="filterMag">
          <option value="">Tous</option>
          <option>Gleizé</option><option>Miribel</option><option>Seynod</option><option>Annemasse</option>
        </select>
      </label>

      <label>Jour :
        <select id="filterDay"></select>
      </label>

      <label>Mois :
        <select id="filterMonth"></select>
      </label>

      <label>Année :
        <select id="filterYear"></select>
      </label>

      <input id="q" type="search" placeholder="Rechercher (n°, magasin, compte, client, service, date…)" style="min-width:280px" />
    </div>

    <div class="tableWrap">
      <table id="tab">
        <colgroup>
          <col class="col-no">
          <col class="col-magasin">
          <col class="col-compte">
          <col class="col-client">
          <col class="col-service">
          <col class="col-date">
          <col class="col-statut">
          <col class="col-eta">
          <col class="col-actions">
        </colgroup>
        <thead>
          <tr>
            <th class="nowrap">N°</th>
            <th class="nowrap">Magasin</th>
            <th class="nowrap">N° de compte</th>
            <th class="nowrap">Client</th>
            <th class="nowrap">Service</th>
            <th class="nowrap">Date</th>
            <th class="nowrap">Statut</th>
            <th class="nowrap">Estimation Temps Travaux</th>
            <th class="nowrap">Actions</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <div class="mask" id="mask" aria-hidden="true">
    <div class="box" role="dialog" aria-label="Dossier">
      <div class="bar">
        <div id="modalTitle" style="font-weight:800;color:#004080">Dossier</div>
        <div>
          <button id="btnPrint">Imprimer</button>
          <button id="btnClose">Fermer</button>
        </div>
      </div>
      <div class="content" id="modalContent"></div>
    </div>
  </div>

<script>
const $tbody = document.querySelector("#tab tbody");
const $filter = document.getElementById("filterMag");
const $year   = document.getElementById("filterYear");
const $month  = document.getElementById("filterMonth");
const $day    = document.getElementById("filterDay");
const $q      = document.getElementById("q");

const $mask   = document.getElementById("mask");
const $btnClose = document.getElementById("btnClose");
const $btnPrint = document.getElementById("btnPrint");
const $modalTitle = document.getElementById("modalTitle");
const $modalContent = document.getElementById("modalContent");

function setTableLoading(msg){
  $tbody.innerHTML = `<tr><td colspan="9" style="padding:16px 12px;color:#334155">
    <span class="spinner" aria-hidden="true" style="margin-right:8px"></span>${msg||"Chargement…"}
  </td></tr>`;
}

const LABELS = ["Demande envoyé","Pièce reçu","Travaux en cours","Renvoyé"];
function badge(status){
  const m = {
    "Demande envoyé":"s-1",
    "Pièce reçu":"s-2",
    "Travaux en cours":"s-3",
    "Renvoyé":"s-4"
  }[status] || "s-1";
  return `<span class="badge ${m}">${status}</span>`;
}

function p2(n){ return String(n).padStart(2,"0"); }
function fmtJJMMYYYYdash(v){
  if (!v) return "—";
  const d = new Date(v);
  if (isNaN(d)) return "—";
  return `${p2(d.getDate())}-${p2(d.getMonth()+1)}-${d.getFullYear()}`;
}

function buildYearOptions(list){
  const years = new Set();
  const nowY = new Date().getFullYear();
  (list||[]).forEach(r=>{
    const d = r.demandeDate ? new Date(r.demandeDate) : null;
    if (d && !isNaN(d)) years.add(d.getFullYear());
  });
  if (years.size === 0) years.add(nowY);
  const sorted = Array.from(years).sort((a,b)=>b-a);
  $year.innerHTML = sorted.map(y=>`<option value="${y}">${y}</option>`).join("");
  $year.value = String(sorted.includes(nowY) ? nowY : (sorted[0] || nowY));
}
function buildMonthOptions() {
  const months = ["Janvier","Février","Mars","Avril","Mai","Juin","Juillet","Août","Septembre","Octobre","Novembre","Décembre"];
  $month.innerHTML = `<option value="">Tous</option>` + months.map((m,i)=>`<option value="${i+1}">${m}</option>`).join("");
  $month.value = "";
}
function updateDayOptions() {
  const y = Number($year.value) || new Date().getFullYear();
  const m = Number($month.value) || 0;
  const maxDay = m ? new Date(y, m, 0).getDate() : 31;
  const prev = $day.value;
  let html = `<option value="">Tous</option>`;
  for (let d = 1; d <= maxDay; d++) html += `<option value="${d}">${String(d).padStart(2,"0")}</option>`;
  $day.innerHTML = html;
  if (prev && Number(prev) <= maxDay) $day.value = prev; else $day.value = "";
}

let rows = [];

function buildEstimateSelect(value){
  const v = Number(value) || "";
  let opts = "";
  for (let i=1;i<=10;i++){
    opts += `<option value="${i}" ${v===i?"selected":""}>${i}</option>`;
  }
  return `<select class="etaSel" aria-label="Estimation Temps Travaux">${opts}</select>`;
}

function draw(){
  const mag = $filter.value.trim().toLowerCase();
  const q = $q.value.trim().toLowerCase();
  const yearVal  = ($year.value  || "").trim();
  const monthVal = ($month.value || "").trim();
  const dayVal   = ($day.value   || "").trim();

  const list = [...rows].sort((a,b)=>{
    const da = a.demandeDate ? new Date(a.demandeDate) : null;
    const db = b.demandeDate ? new Date(b.demandeDate) : null;
    const ta = da && !isNaN(da) ? da.getTime() : 0;
    const tb = db && !isNaN(db) ? db.getTime() : 0;
    return tb - ta;
  });

  $tbody.innerHTML = "";
  list
    .filter(r => !mag || (r.magasin||"").toLowerCase() === mag)
    .filter(r => { if (!yearVal) return true; const d = r.demandeDate ? new Date(r.demandeDate) : null; return d && !isNaN(d) && String(d.getFullYear()) === yearVal; })
    .filter(r => { if (!monthVal) return true; const d = r.demandeDate ? new Date(r.demandeDate) : null; return d && !isNaN(d) && (d.getMonth()+1) === Number(monthVal); })
    .filter(r => { if (!dayVal) return true; const d = r.demandeDate ? new Date(r.demandeDate) : null; return d && !isNaN(d) && d.getDate() === Number(dayVal); })
    .filter(r => { if (!q) return true; const searchable = ([
        String(r.no).padStart(5,'0'), r.magasin, r.compte, r.client, r.service, fmtJJMMYYYYdash(r.demandeDate)
      ].join(' ')).toLowerCase(); return searchable.includes(q); })
    .forEach(r => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td class="col-no nowrap"        title="${String(r.no)}">${String(r.no).padStart(5,'0')}</td>
        <td class="col-magasin truncate" title="${r.magasin||""}">${r.magasin||""}</td>
        <td class="col-compte nowrap"    title="${r.compte||""}">${r.compte||""}</td>
        <td class="col-client truncate"  title="${r.client||""}">${r.client||""}</td>
        <td class="col-service truncate" title="${r.service||""}">${r.service||""}</td>
        <td class="col-date nowrap"      title="${fmtJJMMYYYYdash(r.demandeDate)}">${fmtJJMMYYYYdash(r.demandeDate)}</td>
        <td class="col-statut nowrap">${badge(r.status)}</td>
        <td class="col-eta nowrap">${buildEstimateSelect(r.estimation)}</td>
        <td class="col-actions nowrap">
          <div class="actions">
            <button class="btnView" title="Voir le dossier">Voir</button>
            <select class="statusSel" title="Changer le statut">
              ${LABELS.map(lbl=>`<option ${r.status===lbl?"selected":""}>${lbl}</option>`).join("")}
            </select>
            <button class="btnSave" title="Valider les changements">Valider</button>
          </div>
        </td>
      `;

      tr.querySelector(".btnView").addEventListener("click", ()=> openDetails(r));

      tr.querySelector(".btnSave").addEventListener("click", async ()=>{
        const statusSel = tr.querySelector(".statusSel");
        const etaSel = tr.querySelector(".etaSel");
        const saveBtn = tr.querySelector(".btnSave");
        const oldHtml = saveBtn.innerHTML;

        const status = statusSel.value;
        const estimation = Number(etaSel.value);

        try{
          saveBtn.disabled = true; statusSel.disabled = true; etaSel.disabled = true;
          saveBtn.innerHTML = `<span class="spinner" aria-hidden="true" style="margin-right:6px"></span>…`;

          const resp = await fetch(`/atelier/api/cases/${encodeURIComponent(r.no)}/status`, {
            method:"POST",
            headers:{ "Content-Type":"application/json" },
            body: JSON.stringify({ status, estimation })
          });
          if(!resp.ok){
            alert("Erreur de mise à jour");
            return;
          }
          r.status = status;
          r.estimation = estimation;
        } finally{
          saveBtn.innerHTML = oldHtml;
          saveBtn.disabled = false; statusSel.disabled = false; etaSel.disabled = false;
        }
      });

      $tbody.appendChild(tr);
    });
}

function esc(s){ return String(s ?? "").replace(/[&<>"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;'}[c])); }

function openDetails(row){
  const h = (row.snapshot && row.snapshot.header) || {};
  const cul = (row.snapshot && row.snapshot.culasse) || null;
  const inj = (row.snapshot && row.snapshot.injecteur) || null;
  const com = (row.snapshot && row.snapshot.commentaires) ? String(row.snapshot.commentaires).trim() : "";

  $modalTitle.textContent = `Dossier ${String(row.no).padStart(5,'0')} — ${h.service || row.service || ""}`;

  let opsHTML = "";
  if (cul && Array.isArray(cul.operations) && cul.operations.length){
    opsHTML = cul.operations.map(op=>{
      const refs = Array.isArray(op.references) ? op.references.map(r=>{
        const bits = [];
        if (r.reference) bits.push(esc(r.reference));
        if (r.libelleRef) bits.push(esc(r.libelleRef));
        if (r.prixHT || r.prixHT===0) bits.push(`${esc(String(r.prixHT))} € HT`);
        return `<div class="sub">- ${bits.join(" – ")}</div>`;
      }).join("") : "";
      return `<div class="bul">• ${esc(op.libelle || op.ligne)}</div>${refs}`;
    }).join("");
  }

  const piecesHTML = (cul && Array.isArray(cul.piecesAFournir) && cul.piecesAFournir.length)
    ? cul.piecesAFournir.map(p=>`<div class="bul">• ${esc(p)}</div>`).join("")
    : "<div class='bul' style='opacity:.7'>Aucune pièce sélectionnée.</div>";

  $modalContent.innerHTML = `
    <div class="grid2">
      <div><span class="label">N° dossier :</span> ${esc(String(row.no).padStart(5,'0'))}</div>
      <div><span class="label">Date :</span> ${fmtJJMMYYYYdash(row.demandeDate)}</div>
      <div><span class="label">Magasin :</span> ${esc(h.magasin||row.magasin||"")}</div>
      <div><span class="label">Statut :</span> ${esc(row.status||"")}</div>
      <div><span class="label">Client :</span> ${esc(h.client||row.client||"")}</div>
      <div><span class="label">N° de compte :</span> ${esc(h.compte||row.compte||"")}</div>
      <div><span class="label">Téléphone :</span> ${esc(h.telephone||"")}</div>
      <div><span class="label">Email :</span> ${esc(h.email||"")}</div>
      <div><span class="label">Véhicule :</span> ${esc(h.vehicule||"")}</div>
      <div><span class="label">Immat. :</span> ${esc(h.immat||"")}</div>
      <div><span class="label">Service :</span> ${esc(h.service||row.service||"")}</div>
      <div><span class="label">Estimation :</span> ${esc(row.estimation || "—")}</div>
      <div><span class="label">Date demande :</span> ${esc(fmtJJMMYYYYdash(h.dateDemande||row.demandeDate))}</div>
    </div>

    ${h.service === "Rectification Culasse" && cul ? `
      <div class="section">
        <h3>Détails Rectification Culasse</h3>
        <div class="grid2">
          <div><span class="label">Cylindre :</span> ${esc(cul.cylindre||"")}</div>
          <div><span class="label">Soupapes :</span> ${esc(cul.soupapes||"")}</div>
          <div><span class="label">Carburant :</span> ${esc(cul.carburant||"")}</div>
        </div>
        <div class="section">
          <h3>Opérations</h3>
          ${opsHTML || "<div class='bul' style='opacity:.7'>Aucune opération cochée.</div>"}
        </div>
        <div class="section">
          <h3>Pièces à fournir</h3>
          ${piecesHTML}
        </div>
      </div>
    ` : ""}

    ${(h.service === "Contrôle injection Diesel" || h.service === "Contrôle injection Essence") && inj ? `
      <div class="section">
        <h3>Détails Contrôle injection</h3>
        <div class="grid2">
          <div><span class="label">Type :</span> ${esc(inj.type||"")}</div>
          <div><span class="label">Nb injecteurs :</span> ${esc(inj.nombre||"")}</div>
        </div>
      </div>
    ` : ""}

    ${com ? `
      <div class="section">
        <h3>Commentaires</h3>
        <div class="area">${esc(com)}</div>
      </div>
    ` : ""}
  `;

  $mask.style.display = "flex";
  $mask.setAttribute("aria-hidden","false");
}

document.getElementById("btnClose").addEventListener("click", ()=>{
  $mask.style.display = "none";
  $mask.setAttribute("aria-hidden","true");
  $modalContent.innerHTML = "";
});
document.getElementById("btnPrint").addEventListener("click", ()=>{
  const w = window.open("", "_blank");
  w.document.write(`
    <html>
      <head>
        <title>${$modalTitle.textContent}</title>
        <meta charset="utf-8" />
        <style>
          body{font-family:system-ui,Arial,sans-serif;padding:20px;color:#0f172a}
          h3{color:#004080;margin-top:16px}
          .label{font-weight:700}
          .grid2{display:grid;grid-template-columns:1fr 1fr;gap:8px 16px;margin-bottom:10px}
          .section{margin-top:14px}
          .bul{margin:6px 0}
          .sub{margin:2px 0 0 18px}
          .area{border:1px solid #ccc;padding:10px;white-space:pre-wrap}
        </style>
      </head>
      <body>
        ${$modalContent.innerHTML}
      </body>
    </html>
  `);
  w.document.close(); w.focus(); w.print(); w.close();
});

function load(){
  setTableLoading("Chargement des dossiers…");
  fetch("/atelier/api/cases")
    .then(r=>r.json())
    .then(json=>{
      const data = (json && json.data) || [];
      rows = data.map(x=>{
        const h = (x.snapshot && x.snapshot.header) || {};
        return {
          ...x,
          magasin: x.magasin || (h && h.magasin) || "",
          compte:  x.compte  || (h && h.compte)  || "",
          client:  x.client  || (h && h.client)  || "",
          service: x.service || (h && h.service) || "",
          demandeDate: x.demandeDate || (h && h.dateDemande) || "",
          estimation: Number(x.estimation || "") || ""
        };
      });
      buildYearOptions(rows);
      buildMonthOptions();
      updateDayOptions();
      draw();
    })
    .catch(e=>{
      console.error(e);
      $tbody.innerHTML = `<tr><td colspan="9" style="padding:16px 12px;color:#b91c1c">Erreur de chargement.</td></tr>`;
      alert("Erreur de chargement.");
    });
}

$filter.addEventListener("change", draw);
$month.addEventListener("change", () => { updateDayOptions(); draw(); });
$day.addEventListener("change", draw);
$year.addEventListener("change", () => { updateDayOptions(); draw(); });
$q.addEventListener("input", draw);

load();
</script>
</body>
</html>