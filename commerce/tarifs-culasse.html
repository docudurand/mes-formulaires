<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Tarifs Culasse</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --primary:#071E57;
      --accent:#1E8AFF;
      --ink:#0f172a;
      --muted:#6b7280;
      --bg:#ffffff;
      --line:#e5e7eb;
      --card:#f8fafc;
      --radius:14px;
    }
    *{box-sizing:border-box}
    body{margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; background:#fff; color:var(--ink)}
    .wrap{max-width:980px; margin:18px auto; padding:14px}
    .head{
      display:flex; align-items:flex-end; justify-content:space-between; gap:12px; flex-wrap:wrap;
      border:1px solid var(--line); border-radius:var(--radius); padding:14px 14px 12px;
      background:linear-gradient(180deg,#f5f8ff, #ffffff);
    }
    h1{margin:0; font-size:1.25rem; letter-spacing:.02em; color:var(--primary)}
    .sub{margin:6px 0 0; color:var(--muted); font-size:.92rem}
    .grid{display:grid; gap:12px; margin-top:14px}
    @media(min-width:760px){ .grid-2{grid-template-columns:1fr 1fr} }
    label{display:block; font-weight:700; font-size:.92rem; margin:0 0 6px}
    select{
      width:100%; padding:10px 12px; border:1px solid var(--line); border-radius:12px; font-size:1rem; background:#fff;
    }
    .section{
      margin-top:14px; border:1px solid var(--line); border-radius:var(--radius); background:#fff; overflow:hidden;
    }
    .sectionTitle{
      padding:12px 14px; font-weight:900; letter-spacing:.04em; text-transform:uppercase;
      background:#f8fbff; border-bottom:1px solid var(--line); color:var(--primary); font-size:.85rem;
    }
    .cards{display:grid; gap:12px; padding:14px}
    @media(min-width:760px){ .cards{grid-template-columns:1fr 1fr} }
    .card{
      border:1px solid var(--line); border-radius:12px; padding:12px 12px 10px;
      background:var(--card);
    }
    .card h2{margin:0 0 6px; font-size:1.02rem; color:var(--ink)}
    .hint{margin:0 0 8px; color:var(--muted); font-size:.88rem}
    .refs ul{margin:8px 0 0; padding-left:18px}
    .refs li{margin:6px 0}
    .pill{
      display:inline-block; padding:2px 8px; border-radius:999px; background:#eef2ff; color:var(--primary);
      font-weight:800; font-size:.78rem; letter-spacing:.02em;
    }
    .warn{color:#b91c1c; font-weight:800}
    .ok{color:#16a34a; font-weight:800}
    .topHelp{margin-top:10px; color:var(--muted); font-size:.92rem}
    .footerNote{margin:10px 0 0; color:var(--muted); font-size:.85rem}
    html.dsg-in-iframe, html.dsg-in-iframe body { height:auto !important; overflow-x:hidden !important; overflow-y:auto !important; }
  </style>
</head>

<script>window.__SITE_PREFIX__ = "../";</script>
<script src="../assets/auth.js"></script>
<script>try{ requireAuth(); }catch(e){}</script>

<body>
<script>
(function () {
  try {
    if (window.self !== window.top) document.documentElement.classList.add("dsg-in-iframe");
  } catch (e) {
    document.documentElement.classList.add("dsg-in-iframe");
  }

  function heightNow() {
    const b = document.body;
    const d = document.documentElement;
    return Math.max(
      d ? d.scrollHeight : 0,
      d ? d.offsetHeight : 0,
      d ? d.clientHeight : 0,
      b ? b.scrollHeight : 0,
      b ? b.offsetHeight : 0,
      b ? b.clientHeight : 0
    );
  }
  function send() { parent.postMessage({ type: "dsg-iframe-size", height: heightNow() + 24 }, "*"); }

  window.addEventListener("load", send, { once: true });

  try { const ro = new ResizeObserver(() => send()); ro.observe(document.documentElement); } catch (e) {}
  window.addEventListener("message", (e) => { if (e.data && e.data.type === "dsg-iframe-request-size") send(); });

  let n = 0;
  const it = setInterval(() => { send(); if (++n >= 20) clearInterval(it); }, 300);
})();
</script>

  <div class="wrap">
    <div class="head">
      <div>
        <h1>Tarifs Culasse</h1>
        <p class="sub">Sélectionne VL/PL, cylindres, soupapes et carburant : les références s’affichent pour <span class="pill">Épreuve</span> et <span class="pill">Surfaçage</span>.</p>
      </div>
      <div class="topHelp" id="status">Chargement des tarifs…</div>
    </div>

    <div class="grid grid-2">
      <div>
        <label for="segment">VL / PL</label>
        <select id="segment">
          <option value="" selected>-- VL ou PL --</option>
          <option>VL</option>
          <option>PL</option>
        </select>
      </div>

      <div>
        <label for="cylindre">Cylindre</label>
        <select id="cylindre">
          <option value="" selected>-- Nb de cylindres --</option>
          <option>1</option><option>2</option><option>3</option><option>4</option>
          <option>5</option><option>6</option><option>7</option><option>8</option>
        </select>
      </div>

      <div>
        <label for="soupapes">Soupapes</label>
        <select id="soupapes">
          <option value="" selected>-- Nb de soupapes --</option>
          <option>2</option><option>4</option><option>8</option><option>16</option><option>24</option>
        </select>
      </div>

      <div>
        <label for="carburant">Carburant</label>
        <select id="carburant">
          <option value="" selected>-- Type de carburant --</option>
          <option>Essence</option>
          <option>Diesel</option>
        </select>
      </div>
    </div>

    <div class="section" aria-label="Tarifs">
      <div class="sectionTitle">Tarifs selon sélection</div>
      <div class="cards">
        <div class="card">
          <h2>Épreuve</h2>
          <p class="hint">Références associées à ton choix.</p>
          <div class="refs" id="refs_epreuve"></div>
        </div>

        <div class="card">
          <h2>Surfaçage</h2>
          <p class="hint">Références associées à ton choix.</p>
          <div class="refs" id="refs_surfacage"></div>
        </div>
      </div>
    </div>

    <p class="footerNote" id="footerNote"></p>
  </div>

  <script src="/atelier/config.js"></script>
  <script>
    const APPSCRIPT_URL = (window.__ATELIER_CFG && window.__ATELIER_CFG.GS_URL) || "";
    const $ = (id) => document.getElementById(id);

    let REGLES = [];
    let LINE_EP = null;
    let LINE_SU = null;

    function norm(s){
      return String(s||"")
        .normalize("NFD").replace(/[\u0300-\u036f]/g,"")
        .toUpperCase()
        .trim();
    }

    function findBestLine(keys){
      const cand = Array.from(new Set(REGLES
        .filter(r => String(r.service||"").toLowerCase() === "culasse")
        .map(r => r.ligne)
        .filter(Boolean)
        .map(String)
      ));

      const keysN = keys.map(norm);
      for (const l of cand){
        const ln = norm(l);
        if (keysN.some(k => ln === k)) return l;
      }
      for (const l of cand){
        const ln = norm(l);
        if (keysN.some(k => ln.includes(k))) return l;
      }
      return null;
    }

    function matchRegles(service, cyl, soup, carb, seg, ligne){
      const cand = REGLES.filter(r =>
        norm(r.ligne) === norm(ligne) &&
        String(r.service||"").toLowerCase() === String(service||"").toLowerCase()
      );

      const score = r => {
        const vlpl = norm(r.vl_pl || r['vl/pl'] || r.vlpl || '');
        const segU = norm(seg);
        let s = 0;

        s += (String(r.cylindres) === String(cyl)) ? 1 : (r.cylindres === '*' ? 0 : -999);

        if (String(soup || '') !== '') {
          s += (String(r.soupapes) === String(soup)) ? 1 : (r.soupapes === '*' ? 0 : -999);
        }

        s += (String(r.carburant||'').toLowerCase() === String(carb||'').toLowerCase()) ? 1 : (r.carburant === '*' ? 0 : -999);
        s += (vlpl === '' || vlpl === '*' || vlpl === segU) ? 1 : -999;

        return s;
      };

      return cand
        .map(r => ({ r, s: score(r) }))
        .filter(x => x.s >= 0)
        .sort((a,b) => b.s - a.s)
        .map(x => x.r);
    }

    function ready(){
      return $('segment').value && $('cylindre').value && $('soupapes').value && $('carburant').value;
    }

    function renderRefs(holderId, ligne){
      const holder = $(holderId);
      if (!holder) return;

      if (!ligne){
        holder.innerHTML = '<div class="warn">Ligne introuvable dans les règles Sheets.</div>';
        return;
      }

      if (!ready()){
        holder.innerHTML = '<div class="hint">Renseigne tous les sélecteurs pour afficher les références.</div>';
        return;
      }

      const seg = $('segment').value,
            cyl = $('cylindre').value,
            soup = $('soupapes').value,
            carb = $('carburant').value;

      const regles = matchRegles('culasse', cyl, soup, carb, seg, ligne);

      if (!regles.length){
        holder.innerHTML = '<div class="warn">Aucune référence trouvée pour cette combinaison.</div>';
        return;
      }

      holder.innerHTML =
        '<ul>' + regles.map(r => {
          const ref = (r.reference||'').trim();
          const lib = (r.libelleref||r.libelleRef||'').trim();
          const prix = (r.prixht || r.prixht===0) ? String(r.prixht) : '';
          const suffix = prix ? ` (${prix} € HT)` : '';
          return `<li><strong>${ref || '-'}</strong>${lib ? ' – ' + lib : ''}${suffix}</li>`;
        }).join('') + '</ul>';
    }

    function refresh(){
      renderRefs('refs_epreuve', LINE_EP);
      renderRefs('refs_surfacage', LINE_SU);
      const ok = ready();
      $('footerNote').textContent = ok
        ? "Tarifs issus des règles Atelier (Rectification Culasse)."
        : "";
    }

    async function init(){
      const status = $('status');
      try{
        if (!APPSCRIPT_URL) throw new Error("GS_ATELIER_URL non défini (/atelier/config.js).");
        const r = await fetch(APPSCRIPT_URL, { cache:"no-store" });
        const data = await r.json();
        REGLES = data.regles || [];

        LINE_EP = findBestLine(["EPREUVE","EPREUVE CULASSE","EPREUVE / CONTROLE", "EPREUVE ETANCHEITE"]);
        LINE_SU = findBestLine(["SURFACAGE","SURFACAGE CULASSE","SURFACAGE PLAN DE JOINT","SURFACAGE PJ"]);

        status.innerHTML = '<span class="ok">Tarifs chargés ✅</span>';
        if (!LINE_EP || !LINE_SU){
          status.innerHTML = '<span class="warn">Tarifs chargés, mais une ligne est introuvable (Épreuve ou Surfaçage).</span>';
        }

        refresh();
      }catch(e){
        console.error(e);
        status.innerHTML = '<span class="warn">Erreur de chargement des tarifs ❌</span>';
        $('refs_epreuve').innerHTML = '<div class="warn">Impossible de charger les règles depuis Google Sheets.</div>';
        $('refs_surfacage').innerHTML = '<div class="warn">Impossible de charger les règles depuis Google Sheets.</div>';
      }
    }

    ['segment','cylindre','soupapes','carburant'].forEach(id => $(id).addEventListener('change', refresh));
    window.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
