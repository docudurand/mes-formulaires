<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Présences DSG</title>
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;800&display=swap" rel="stylesheet">
<style>
:root{--brand:#d21f3c;--bg:#f6f7f8;--text:#111;--muted:#666;--line:#e5e7eb;--ok:#1a7f37;--warn:#b45309;--abs:#9b1c1c}
*{box-sizing:border-box} html,body{margin:0;padding:0;font-family:Montserrat,system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif;color:var(--text);background:var(--bg)}
.app-header{display:flex;align-items:baseline;gap:1rem;padding:12px 16px;background:#fff;border-bottom:1px solid var(--line)}
.app-header h1{margin:0;font-weight:800;letter-spacing:.5px}
.app-header .today{color:var(--muted)}
.tabs{display:flex;gap:8px;padding:8px 12px;border-bottom:1px solid var(--line);background:#fff;position:sticky;top:0;z-index:5}
.tab{appearance:none;border:1px solid var(--line);background:#fff;border-radius:10px;padding:10px 14px;cursor:pointer;font-weight:700}
.tab.active{border-color:var(--brand);color:#fff;background:var(--brand)}
.tab-panel{display:none;padding:16px} .tab-panel.active{display:block}
.grid-buttons{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:10px}
.grid-buttons button{padding:14px 12px;font-weight:700;border-radius:14px;border:1px solid var(--line);background:#fff;cursor:pointer}
.grid-buttons button.active{border-color:var(--brand);outline:3px solid color-mix(in srgb,var(--brand),transparent 70%)}
.toolbar{display:flex;align-items:center;gap:10px;padding:10px 12px;margin-bottom:10px;background:#fff;border:1px solid var(--line);border-radius:12px;flex-wrap:wrap}
.toolbar .spacer{flex:1}
button.primary{background:var(--brand);color:#fff;border:0;border-radius:10px;padding:10px 14px;font-weight:700;cursor:pointer}
button.badge{border:1px solid var(--line);background:#fff;border-radius:999px;padding:6px 10px;font-weight:700;cursor:pointer}
button.badge[data-code="P"]{color:var(--ok)}
button.badge[data-code="ABS"]{color:var(--abs)}
button.badge[data-code="MAL"]{color:#946200}
.table{width:100%;border-collapse:collapse;background:#fff;border:1px solid var(--line);margin:18px 0;border-radius:12px;overflow:hidden}
.table th,.table td{border:1px solid var(--line);padding:8px;text-align:center}
.table thead th.sub-label{ color: var(--muted); font-weight:600 }
.section-title{margin-top:26px;margin-bottom:6px;font-weight:800;text-transform:uppercase;color:var(--brand)}
.row-label{white-space:nowrap;text-align:left;font-weight:600}
.sub-label{font-size:.86rem;color:var(--muted);font-style:italic;white-space:nowrap}
.cell{min-width:32px;height:30px;cursor:pointer;user-select:none;position:relative;background:#fff}
.cell.weekend{background:#000;color:#fff}
.cell.selected{outline:3px solid #2563eb44}
.cell.P{background:#e8f5ec;color:var(--ok);font-weight:700}
.cell.CP{background:#e8f0fe;color:#1f3aa8;font-weight:700}
.cell.ABS{background:#fdecec;color:#a20000;font-weight:700}
.cell.MAL{background:#fff6e5;color:#946200;font-weight:700}
.cell.R{background:#f3f3f3;color:#333;font-weight:700}
.hint,.legend{color:var(--muted);font-size:.9rem}
.error{color:#a40000;font-weight:700}
.loading{padding:14px;color:var(--muted)}
@media (max-width:900px){ .cell{min-width:26px;height:28px} }
</style>
</head>
<body>
  <header class="app-header">
    <h1>Présences DSG</h1>
    <div class="today">Aujourd’hui : <span id="today"></span></div>
  </header>

  <main>
    <nav class="tabs">
      <button class="tab active" data-tab="magasins">Magasins</button>
      <button class="tab" data-tab="saisie">Saisie du jour</button>
      <button class="tab" data-tab="resume">Résumé du mois</button>
    </nav>

    <!-- Onglet 1 -->
    <section id="tab-magasins" class="tab-panel active">
      <p class="hint">Choisissez un magasin :</p>
      <div id="magasin-buttons" class="grid-buttons"></div>
    </section>

    <!-- Onglet 2 -->
    <section id="tab-saisie" class="tab-panel">
      <div class="toolbar">
        <div><b>Magasin :</b> <span id="current-magasin">—</span></div>
        <div><b>Date :</b> <input id="saisie-date" type="date"/></div>
        <div class="spacer"></div>
        <button class="badge" id="btn-clear">Vider</button>
        <button class="badge" data-code="P">P</button>
        <button class="badge" data-code="CP">CP</button>
        <button class="badge" data-code="ABS">ABS</button>
        <button class="badge" data-code="MAL">MAL</button>
        <button class="badge" data-code="R">R</button>
        <button class="badge" id="btn-fill-all">Tout mettre P</button>
        <button id="btn-save" class="primary">Enregistrer</button>
        <button class="badge" id="btn-diag">Diag API</button>
      </div>
      <div id="saisie-content"></div>
      <div class="legend">Sélection : clic (cellule), Ctrl/Cmd (ajouts), Shift (plage), clic sur l’entête = toute la colonne.</div>
      <p id="saisie-error" class="error" style="display:none"></p>
    </section>

    <!-- Onglet 3 -->
    <section id="tab-resume" class="tab-panel">
      <div class="toolbar">
        <div><b>Mois :</b> <input id="resume-month" type="month"/></div>
        <div class="spacer"></div>
        <button id="btn-refresh-resume">Recharger</button>
      </div>
      <div id="resume-content"></div>
      <p id="resume-error" class="error" style="display:none"></p>
    </section>
  </main>

<script>
/* ---------- util ---------- */
const pad=n=>n<10?`0${n}`:`${n}`;
const todayISO=()=>{const d=new Date();return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;}
const thisYM=()=>{const d=new Date();return `${d.getFullYear()}-${pad(d.getMonth()+1)}`;}
const ymd=d=>`${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
const daysOfMonth=ym=>{ const [y,m]=ym.split('-').map(x=>+x); const out=[]; for(let i=1;i<=new Date(y,m,0).getDate();i++) out.push(new Date(y,m-1,i)); return out; };
const dowLetter=d=>["D","L","M","M","J","V","S"][d.getDay()];
let apiBase = new URLSearchParams(location.search).get('api') || ''; // permet aussi ?api=/presences
const API_CANDIDATES = [apiBase, '/presences', '/presence'].filter(Boolean);

async function detectApiBase(){
  for (const base of API_CANDIDATES){
    try {
      const r = await fetch(base + '/_diag', { cache:'no-store' });
      if (r.ok) { apiBase = base; console.log('[API] base =', apiBase); return; }
    } catch {}
  }
  // dernier recours
  apiBase = '/presences';
  console.warn('[API] fallback sur', apiBase);
}
// lancer la détection au chargement
detectApiBase();

const MAGASINS = [
 "ANNEMASSE","BOURGOIN","CHASSE SUR RHONE","CHASSIEU","GLEIZE",
 "LA MOTTE SERVOLEX","MIRIBEL","PAVI","RENAGE","RIVES",
 "SAINT-MARTIN-D'HERES","SEYNOD","ST EGREVE","ST-JEAN-BONNEFONDS"
];
const CODES=["P","CP","ABS","MAL","R"];

/* ---------- état ---------- */
let currentMagasin=null;
let personnel=null;
let selectedCells=new Set();

/* ---------- DOM ---------- */
const $today=document.getElementById('today');
const $tabs=[...document.querySelectorAll('.tab')];
const $panels={ magasins:document.getElementById('tab-magasins'),
                saisie:document.getElementById('tab-saisie'),
                resume:document.getElementById('tab-resume') };
const $magBtnsWrap=document.getElementById('magasin-buttons');
const $currMag=document.getElementById('current-magasin');
const $dateInput=document.getElementById('saisie-date');
const $saisieContent=document.getElementById('saisie-content');
const $btnSave=document.getElementById('btn-save');
const $btnFillAll=document.getElementById('btn-fill-all');
const $btnClear=document.getElementById('btn-clear');
const $resumeMonth=document.getElementById('resume-month');
const $btnRefreshResume=document.getElementById('btn-refresh-resume');
const $resumeContent=document.getElementById('resume-content');
const $saisieError=document.getElementById('saisie-error');
const $resumeError=document.getElementById('resume-error');
const $btnDiag=document.getElementById('btn-diag');

$today.textContent=todayISO();
$dateInput.value=todayISO();
$resumeMonth.value=thisYM();

/* ---------- tabs ---------- */
$tabs.forEach(b=>b.addEventListener('click',()=>switchTab(b.dataset.tab)));
function switchTab(key){
  document.querySelectorAll('.tab').forEach(t=>t.classList.toggle('active',t.dataset.tab===key));
  Object.entries($panels).forEach(([k,el])=>el.classList.toggle('active',k===key));
  if(key==="resume") loadResume();
}

/* ---------- magasins ---------- */
MAGASINS.forEach(m=>{
  const b=document.createElement('button'); b.textContent=m;
  b.addEventListener('click',()=>selectMagasin(m,b)); $magBtnsWrap.appendChild(b);
});
async function selectMagasin(mag,btn){
  currentMagasin=mag;
  document.querySelectorAll('#magasin-buttons button').forEach(x=>x.classList.remove('active'));
  btn.classList.add('active'); $currMag.textContent=mag;
  await loadPersonnel();
  buildSaisieUI();
  await prefillDay();
  switchTab('saisie');
}

/* ---------- API helpers ---------- */
const api = (path,opt={}) => fetch(apiBase+path,{headers:{'Content-Type':'application/json'},...opt});

/* ---------- personnel ---------- */
async function loadPersonnel(){
  try{
    const r=await api(`/personnel?magasin=${encodeURIComponent(currentMagasin)}`);
    if(!r.ok) throw new Error("HTTP "+r.status);
    personnel=await r.json();
  }catch(e){
    // fallback lisible
    personnel={
      employes:[{nom:"BARRET",prenom:"Olivier"},{nom:"THOLIN",prenom:"Claire"},{nom:"PICHARD",prenom:"Damien"}],
      interims:[{nom:"PEREZ",prenom:"Clara"}],
      livreurs:{
        "WARNING":["Matin","A. Midi"],
        "NAVETTE NUIT ALL COURS":["NUIT"],
        "C CHEZ VOUS":["10H","12H","16H"]
      }
    };
  }
}

/* ---------- UI Saisie ---------- */
function clearSelection(){ selectedCells.forEach(c=>c.classList.remove('selected')); selectedCells.clear(); }
function handleCellClick(ev,td){
  const isShift=ev.shiftKey, isCtrl=ev.ctrlKey||ev.metaKey;
  if(isShift && selectedCells.size){
    const last=[...selectedCells][selectedCells.size-1];
    const rectRange=(a,b)=>{
      const ar=a.closest('tr').rowIndex, ac=a.cellIndex;
      const br=b.closest('tr').rowIndex, bc=b.cellIndex;
      const r1=Math.min(ar,br), r2=Math.max(ar,br);
      const c1=Math.min(ac,bc), c2=Math.max(ac,bc);
      const table=a.closest('table');
      for(let r=r1;r<=r2;r++) for(let c=c1;c<=c2;c++){
        const cell=table.rows[r].cells[c]; if(cell && cell.classList.contains('cell')){ cell.classList.add('selected'); selectedCells.add(cell);}
      }
    };
    rectRange(last,td);
  }else if(isCtrl){
    td.classList.toggle('selected'); td.classList.contains('selected')?selectedCells.add(td):selectedCells.delete(td);
  }else{
    clearSelection(); td.classList.add('selected'); selectedCells.add(td);
  }
}
function headerSelectColumn(th){
  const idx=th.cellIndex; const table=th.closest('table'); clearSelection();
  [...table.tBodies[0].rows].forEach(tr=>{
    const td=tr.cells[idx]; if(td && td.classList.contains('cell')){ td.classList.add('selected'); selectedCells.add(td); }
  });
}
function union(...arrs){ return [...new Set(arrs.flat().filter(Boolean))]; }

function buildSection(title, rows){
  const headerSlots = union(...rows.map(r=>r.slots||[]));
  const table=document.createElement('table'); table.className='table';
  const thead=document.createElement('thead');
  const tr1=document.createElement('tr');
  tr1.innerHTML='<th class="row-label">Nom / Ligne</th>'+headerSlots.map(s=>`<th>${s}</th>`).join('');
  tr1.querySelectorAll('th').forEach((th,i)=>{ if(i>0) th.addEventListener('click',()=>headerSelectColumn(th)); });
  thead.appendChild(tr1); table.appendChild(thead);
  const tbody=document.createElement('tbody');

  rows.forEach(r=>{
    const tr=document.createElement('tr');
    const nameTd=document.createElement('td'); nameTd.className='row-label'; nameTd.textContent=r.label; tr.appendChild(nameTd);
    headerSlots.forEach(slot=>{
      const td=document.createElement('td'); td.className='cell'; td.dataset.slot=slot;
      td.addEventListener('click',ev=>handleCellClick(ev,td)); tr.appendChild(td);
    });
    tbody.appendChild(tr);
  });
  table.appendChild(tbody);

  const h=document.createElement('div'); h.className='section-title'; h.textContent=title;
  const wrap=document.createElement('div'); wrap.appendChild(h); wrap.appendChild(table);
  return wrap;
}

function buildSaisieUI(){
  $saisieContent.innerHTML='';
  clearSelection();
  const sections=[];

  const empRows=(personnel?.employes||[]).map(p=>({label:`${p.nom} ${p.prenom||""}`.trim(), slots:["Matin","A. Midi"]}));
  if(empRows.length) sections.push({title:"EMPLOYÉS", rows:empRows});

  const intRows=(personnel?.interims||[]).map(p=>({label:`${p.nom} ${p.prenom||""}`.trim(), slots:["Matin","A. Midi"]}));
  if(intRows.length) sections.push({title:"INTÉRIM", rows:intRows});

  Object.entries(personnel?.livreurs||{}).forEach(([g,slots])=>{
    const rows=[{label:g, slots: slots && slots.length? slots: ["Matin","A. Midi"]}];
    sections.push({title:`LIVREURS — ${g}`, rows});
  });

  sections.forEach(s=> $saisieContent.appendChild(buildSection(s.title, s.rows)));
}

/* ---------- actions palette ---------- */
document.querySelectorAll('button.badge[data-code]').forEach(btn=>{
  btn.addEventListener('click',()=>{
    const code=btn.dataset.code; if(!selectedCells.size) return;
    selectedCells.forEach(td=>{
      CODES.forEach(c=>td.classList.remove(c));
      td.textContent = code==='P'||code==='CP'||code==='ABS'||code==='MAL'||code==='R' ? code : '';
      if(code) td.classList.add(code);
    });
  });
});
$btnFillAll.addEventListener('click',()=>{
  document.querySelectorAll('#saisie-content td.cell').forEach(td=>{
    CODES.forEach(c=>td.classList.remove(c));
    td.textContent='P'; td.classList.add('P');
  });
});
$btnClear.addEventListener('click',()=>{
  selectedCells.forEach(td=>{ CODES.forEach(c=>td.classList.remove(c)); td.textContent=''; });
});

/* ---------- prefill / save ---------- */
async function prefillDay(){
  if(!currentMagasin) return;
  try{
    const day=$dateInput.value;
    const r=await api(`/day?magasin=${encodeURIComponent(currentMagasin)}&date=${day}`);
    if(!r.ok) return;
    const payload=await r.json(); applyPrefill(payload?.data||{});
  }catch{}
}
function applyPrefill(data){
  const map=new Map((data.rows||[]).map(r=>[`${r.label}`, r.values||{}]));
  $saisieContent.querySelectorAll('tbody tr').forEach(tr=>{
    const label=tr.querySelector('.row-label').textContent.trim();
    const vals=map.get(label)||{};
    tr.querySelectorAll('td.cell').forEach(td=>{
      const v=vals[td.dataset.slot]||''; CODES.forEach(c=>td.classList.remove(c));
      td.textContent=v; if(v) td.classList.add(v);
    });
  });
}
function collectData(){
  const rows=[];
  $saisieContent.querySelectorAll('tbody tr').forEach(tr=>{
    const label=tr.querySelector('.row-label').textContent.trim();
    const values={};
    tr.querySelectorAll('td.cell').forEach(td=>values[td.dataset.slot]=td.textContent.trim());
    rows.push({label, values});
  });
  return {rows};
}
$btnSave.addEventListener('click', async ()=>{
  if(!currentMagasin) return;
  const data=collectData(); $btnSave.disabled=true;
  try{
    const r=await api('/save',{method:'POST',body:JSON.stringify({magasin:currentMagasin,date:$dateInput.value,data})});
    if(!r.ok) throw new Error('save failed');
    alert('Enregistré ✔');
  }catch{ alert("Échec de l'enregistrement"); }
  finally{ $btnSave.disabled=false; }
});
$dateInput.addEventListener('change',prefillDay);

/* ---------- résumé du mois ---------- */
async function loadResume(){
  $resumeError.style.display='none';
  $resumeContent.innerHTML='<div class="loading">Chargement en cours…</div>';
  try{
    const ym=$resumeMonth.value;
    const r=await api(`/month?yyyymm=${ym}`);
    if(!r.ok) throw new Error('HTTP '+r.status);
    const data=await r.json();
    renderResume(ym,data);
  }catch(e){
    $resumeError.textContent="Impossible de charger le résumé.";
    $resumeError.style.display='block';
    $resumeContent.innerHTML='';
  }
}
$btnRefreshResume.addEventListener('click',loadResume);

/* ====== NE PAS OUVRIR UN NOUVEAU <script> ICI ====== */
function renderResume(yyyymm, monthData){
  const days = daysOfMonth(yyyymm);
  const container = document.createElement("div");
  container.innerHTML = "";

  const norm = s => String(s||"").trim().replace(/\s+/g," ").toUpperCase();
  const isWE = d => { const x=d.getDay(); return x===0 || x===6; };

  // fabrique un tableau mensuel pour un "bloc" (titre, rows, slots)
  function buildMonthBlock(title, rows, slots, fileByDay){
    const block = document.createElement("div");
    const h = document.createElement("div");
    h.className = "section-title";
    h.textContent = title;
    block.appendChild(h);

    const table = document.createElement("table");
    table.className = "table";

    // --- EN-TÊTE à 3 lignes (lettre / numéro / créneaux)
    const thead = document.createElement("thead");

    const tr1 = document.createElement("tr");
    const th0 = document.createElement("th");
    th0.className = "row-label";
    th0.textContent = "Nom / Ligne";
    tr1.appendChild(th0);
    days.forEach(d=>{
      const th = document.createElement("th");
      th.colSpan = slots.length;
      th.textContent = dowLetter(d);
      tr1.appendChild(th);
    });
    thead.appendChild(tr1);

    const tr1b = document.createElement("tr");
    const th0b = document.createElement("th");
    th0b.className = "sub-label"; th0b.textContent = " ";
    tr1b.appendChild(th0b);
    days.forEach(d=>{
      const th = document.createElement("th");
      th.colSpan = slots.length;
      th.textContent = String(d.getDate());
      tr1b.appendChild(th);
    });
    thead.appendChild(tr1b);

    const tr2 = document.createElement("tr");
    const th00 = document.createElement("th");
    th00.className = "sub-label"; th00.textContent = " ";
    tr2.appendChild(th00);
    days.forEach(()=>{
      slots.forEach(s=>{
        const th = document.createElement("th");
        th.textContent = s;
        tr2.appendChild(th);
      });
    });
    thead.appendChild(tr2);
    table.appendChild(thead);

    // --- Corps
    const tbody = document.createElement("tbody");

    rows.forEach(row=>{
      const tr = document.createElement("tr");
      const tdName = document.createElement("td");
      tdName.className = "row-label";
      tdName.textContent = row.label;
      tr.appendChild(tdName);

      days.forEach(d=>{
        const dk = ymd(d);
        const rec = fileByDay[dk];
        let values = {};
        if(rec?.data?.rows){
          const found = rec.data.rows.find(r => norm(r.label) === norm(row.label));
          values = found?.values || {};
        }
        slots.forEach(slot=>{
          const td = document.createElement("td");
          td.className = "cell";
          if(isWE(d)) td.classList.add("weekend");
          const v = values[slot] || "";
          td.textContent = v;
          if(v) td.classList.add(v); // .P, .CP, .ABS, .MAL, .R -> déjà stylées
          tr.appendChild(td);
        });
      });

      tbody.appendChild(tr);
    });

    table.appendChild(tbody);
    block.appendChild(table);
    return block;
  }

  // Pour chaque magasin, produire les blocs comme dans “Saisie”
  MAGASINS.forEach(mag=>{
    const wrapper = document.createElement("div");
    // Titre magasin
    const t = document.createElement("div");
    t.className = "section-title";
    t.style.marginTop = "10px";
    t.textContent = mag;
    wrapper.appendChild(t);

    const fileByDay = monthData.files?.[mag] || {};
    const pers = monthData.personnel?.[mag] || {employes:[], interims:[], livreurs:{}};

    // EMPLOYÉS
    if(pers.employes?.length){
      const rows = pers.employes.map(p=>({label:`${p.nom} ${p.prenom||""}`.trim()}));
      const slots = ["Matin","A. Midi"];
      wrapper.appendChild(buildMonthBlock("EMPLOYÉS", rows, slots, fileByDay));
    }

    // INTÉRIM
    if(pers.interims?.length){
      const rows = pers.interims.map(p=>({label:`${p.nom} ${p.prenom||""}`.trim()}));
      const slots = ["Matin","A. Midi"];
      wrapper.appendChild(buildMonthBlock("INTÉRIM", rows, slots, fileByDay));
    }

    // LIVREURS — un bloc par groupe, avec ses créneaux
    const livreurs = pers.livreurs || {};
    Object.keys(livreurs).forEach(g=>{
      const slots = (livreurs[g] && livreurs[g].length) ? livreurs[g] : ["Matin","A. Midi"];
      // Dans “Saisie” c’est une seule ligne par groupe
      const rows = [{label: g}];
      wrapper.appendChild(buildMonthBlock(`LIVREURS — ${g}`, rows, slots, fileByDay));
    });

    container.appendChild(wrapper);
  });

  $resumeContent.innerHTML = "";
  $resumeContent.appendChild(container);
}
</script>
</body>
</html>