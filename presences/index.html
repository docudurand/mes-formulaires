<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Présences – DSG</title>
  <style>
    :root{ --brand:#d21f3c; --line:#e5e7eb; --muted:#667085; }
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:#f6f7f8;color:#101828}
    header{display:flex;align-items:center;gap:12px;padding:12px 16px;background:#fff;border-bottom:1px solid var(--line)}
    header h1{margin:0;font-weight:800;font-size:18px}
    .tabs{display:flex;gap:8px;padding:10px 12px;background:#fff;border-bottom:1px solid var(--line);position:sticky;top:0;z-index:5}
    .tab{border:1px solid var(--line);background:#fff;border-radius:10px;padding:9px 12px;cursor:pointer;font-weight:700}
    .tab.active{background:var(--brand);border-color:var(--brand);color:#fff}
    .panel{display:none;padding:16px}
    .panel.active{display:block}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:10px}
    .grid button{padding:14px 12px;border:1px solid var(--line);background:#fff;border-radius:14px;font-weight:700;cursor:pointer}
    .grid button.active{border-color:var(--brand);outline:3px solid rgba(210,31,60,.12)}
    .toolbar{display:flex;align-items:center;gap:10px;flex-wrap:wrap;background:#fff;border:1px solid var(--line);border-radius:12px;padding:10px}
    .codes{display:flex;gap:8px;flex-wrap:wrap;background:#fff;border:1px solid var(--line);border-radius:12px;padding:8px 10px;margin-top:10px}
    .badge{border:1px solid var(--line);background:#fff;border-radius:999px;padding:6px 10px;font-weight:700;cursor:pointer}
    .table{width:100%;border-collapse:collapse;background:#fff;border:1px solid var(--line);margin:14px 0;border-radius:12px;overflow:hidden}
    .table th,.table td{border:1px solid var(--line);padding:8px;text-align:center}
    .table thead th{background:#fafafa;font-weight:800}
    .row-label{text-align:left;white-space:nowrap;font-weight:700}
    .cell{min-width:32px;height:30px;cursor:pointer;user-select:none;background:#fff;position:relative}
    .cell.selected{outline:3px solid #2563eb44}
    /* Codes */
    .cell.P{background:#e8f5ec;color:#1a7f37;font-weight:700}
    .cell.CP{background:#efe6ff;color:#6b21a8;font-weight:700}
    .cell.AM{background:#fee2e2;color:#b91c1c;font-weight:700}
    .cell.AT{background:#dcfce7;color:#15803d;font-weight:700}
    .cell.F{background:#ccfbf1;color:#0f766e;font-weight:700}
    .cell.Cep{background:#ffedd5;color:#b45309;font-weight:700}
    .cell.Ann{background:#fce7f3;color:#be185d;font-weight:700}
    .cell.SS{background:#ffe4e6;color:#be123c;font-weight:700}
    .cell.E{background:#ecfccb;color:#65a30d;font-weight:700}
    .cell.R{background:#dcfce7;color:#15803d;font-weight:700}
    .cell.D{background:#dbeafe;color:#1d4ed8;font-weight:700}
    .cell.RI{background:#fef9c3;color:#a16207;font-weight:700}
    .cell.UST{background:#fef3c7;color:#92400e;font-weight:700}
    .cell.PSITE{background:#f5d0aa;color:#6b3e00;font-weight:700}
    .cell.FERIE{ background:#e5e7eb !important; color:#111 !important; font-weight:800; }
    .cell.weekend{background:#000 !important;color:#fff !important;font-weight:800 !important}
    .section-title{margin:8px 0 6px 0;font-weight:800;color:var(--brand);text-transform:uppercase}
    .hint{color:var(--muted)}
    .error{color:#b42318;font-weight:800}
    /* spinner */
    .inline-loading{display:flex;align-items:center;gap:8px}
    .spinner{width:16px;height:16px;border:2px solid #ccc;border-top-color:#6b7280;border-radius:50%;animation:sp .8s linear infinite}
    @keyframes sp{to{transform:rotate(360deg)}}
  </style>
</head>
<body>
<header>
  <h1>Présences Durand Services</h1>
  <div class="hint">Aujourd’hui : <span id="today"></span></div>
</header>

<nav class="tabs">
  <button class="tab active" data-tab="magasins">Magasins</button>
  <button class="tab" data-tab="saisie">Saisie du jour</button>
  <button class="tab" data-tab="resume">Résumé</button>
  <button class="tab" data-tab="admin">Admin</button>
</nav>

<section id="p-magasins" class="panel active">
  <p class="hint">Choisissez un magasin :</p>
  <div id="mag-buttons" class="grid"></div>
</section>

<section id="p-saisie" class="panel">
  <div class="toolbar">
    <div><b>Magasin :</b> <span id="cur-mag">—</span></div>
    <div><b>Date :</b> <input id="saisie-date" type="date"/></div>
    <button id="btn-save" class="badge" style="border-radius:12px;background:#d21f3c;color:#fff;border:0">Enregistrer</button>
    <button id="btn-fill" class="badge">Tout mettre P</button>
    <span id="save-busy" class="inline-loading" style="display:none"><span class="spinner"></span><span>Enregistrement…</span></span>
  </div>
  <div id="codes" class="codes"></div>
  <div id="saisie"></div>
  <p id="saisie-error" class="error" style="display:none"></p>
</section>

<section id="p-resume" class="panel">
  <div class="toolbar">
    <div><b>Mois :</b> <input id="res-month" type="month"/></div>
    <div><b>Magasin :</b> <select id="res-store"></select></div>
    <button id="btn-load" class="badge" style="border-radius:12px;background:#d21f3c;color:#fff;border:0">Charger</button>
  </div>
  <div id="resume"></div>
</section>

<section id="p-admin" class="panel">
  <div class="toolbar" id="admin-login">
    <input id="admin-pass" type="password" placeholder="Mot de passe admin"/>
    <label><input id="remember" type="checkbox"/> Mémoriser</label>
    <button id="btn-login" class="badge" style="border-radius:12px;background:#d21f3c;color:#fff;border:0">Se connecter</button>
  </div>
  <div class="toolbar" id="admin-range" style="display:none">
    <select id="ar-magasin"></select>
    <select id="ar-personnel"><option value="">— Personnel —</option></select>
    <select id="ar-code"></select>
    <input id="ar-du" type="date"/>
    <input id="ar-au" type="date"/>
    <button id="ar-add" class="badge" style="border-radius:12px;background:#d21f3c;color:#fff;border:0">Ajouter</button>
    <span id="ar-msg" class="hint"></span>
  </div>
</section>

<script>
(function(){
  const pad=n=>n<10?`0${n}`:`${n}`;
  const todayISO=()=>{const d=new Date();return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`};
  const ymd=d=>`${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
  const norm=s=>String(s||"").trim().replace(/\s+/g," ").toUpperCase();
  const FERIES=new Set(["2025-01-01","2025-04-21","2025-05-01","2025-05-08","2025-05-29","2025-07-14","2025-08-15","2025-11-01","2025-11-11","2025-12-25"]);
  const isHoliday=iso=>FERIES.has(String(iso));
  const apiBase='/presence';

  // ---- Tabs
  const $tabs=[...document.querySelectorAll('.tab')];
  const panels={ magasins:document.getElementById('p-magasins'), saisie:document.getElementById('p-saisie'), resume:document.getElementById('p-resume'), admin:document.getElementById('p-admin') };
  $tabs.forEach(b=>b.addEventListener('click',()=>switchTab(b.dataset.tab)));
  function switchTab(key){
    document.querySelectorAll('.tab').forEach(t=>t.classList.toggle('active',t.dataset.tab===key));
    Object.entries(panels).forEach(([k,el])=>el.classList.toggle('active',k===key));
    if(key==='admin'){ populateAdminCodes(); if(currentMagasin) $arMag.value=currentMagasin; }
  }

  // ---- DOM
  document.getElementById('today').textContent=todayISO();
  const $magButtons=document.getElementById('mag-buttons');
  const $curMag=document.getElementById('cur-mag');
  const $date=document.getElementById('saisie-date');
  const $saisie=document.getElementById('saisie');
  const $codes=document.getElementById('codes');
  const $btnSave=document.getElementById('btn-save');
  const $btnFill=document.getElementById('btn-fill');
  const $busy=document.getElementById('save-busy');

  const $resMonth=document.getElementById('res-month');
  const $resStore=document.getElementById('res-store');
  const $resume=document.getElementById('resume');

  const $loginBox=document.getElementById('admin-login');
  const $rangeBox=document.getElementById('admin-range');
  const $pass=document.getElementById('admin-pass');
  const $remember=document.getElementById('remember');
  const $btnLogin=document.getElementById('btn-login');
  const $arMag=document.getElementById('ar-magasin');
  const $arPers=document.getElementById('ar-personnel');
  const $arCode=document.getElementById('ar-code');
  const $arDu=document.getElementById('ar-du');
  const $arAu=document.getElementById('ar-au');
  const $arAdd=document.getElementById('ar-add');
  const $arMsg=document.getElementById('ar-msg');

  // ---- Data
  const MAGASINS=["ANNEMASSE","BOURGOIN","CHASSE SUR RHONE","CHASSIEU","GLEIZE","LA MOTTE SERVOLEX","MIRIBEL","PAVI","RENAGE","RIVES","SAINT-MARTIN-D'HERES","SEYNOD","ST EGREVE","ST-JEAN-BONNEFONDS"];
  MAGASINS.forEach(m=>{ const b=document.createElement('button'); b.textContent=m; b.onclick=()=>selectMagasin(m,b); $magButtons.appendChild(b); });
  MAGASINS.forEach(m=>{ const o=document.createElement('option'); o.value=m; o.textContent=m; $resStore.appendChild(o); const a=document.createElement('option'); a.value=m; a.textContent=m; $arMag.appendChild(a); });

  const MAIN_CODES=['P','CP','AM','AT','F','Cep','Ann','SS','E','R','D','RI','UST','NP'];
  const PSITES=Array.from({length:20},(_,i)=>`P${i+1}`);
  const ALL = MAIN_CODES.concat(PSITES);

  function addCodeBtn(code,label){
    const b=document.createElement('button'); b.className='badge'; b.textContent=code; b.title=label||code;
    if(code==='NP'){ b.style.background='#000'; b.style.color='#fff'; b.style.borderColor='#000'; }
    b.onclick=()=>{
      document.querySelectorAll('#saisie .cell.selected').forEach(td=>{
        ALL.forEach(c=>td.classList.remove(c));
        td.classList.remove('PSITE','FERIE');
        td.textContent=code;
        if(code==='NP'){ td.classList.add('weekend'); }
        else{
          td.classList.add(code);
          if(/^P\d+$/.test(code)) td.classList.add('PSITE');
          if(isHoliday($date.value) && code==='F') td.classList.add('FERIE');
        }
      });
    };
    return b;
  }
  MAIN_CODES.forEach(c=>$codes.appendChild(addCodeBtn(c,c)));
  const strip=document.createElement('div'); strip.style.display='flex'; strip.style.gap='6px'; strip.style.overflowX='auto'; PSITES.forEach(c=>strip.appendChild(addCodeBtn(c,'Présence autre site'))); $codes.appendChild(strip);

  // ---- Helpers Ajax
  function delay(ms){return new Promise(r=>setTimeout(r,ms))}
  async function fetchJSON(path,opts={},retries=1){
    const r=await fetch(apiBase+path,{...opts,headers:Object.assign({'Content-Type':'application/json'},opts.headers||{})});
    if(!r.ok){ if(retries>0){ await delay(300); return fetchJSON(path,opts,retries-1);} throw new Error(await r.text()); }
    return r.json();
  }

  // ---- Build Saisie UI
  let currentMagasin=null, personnel=null;
  let LAST_DAY_SNAPSHOT={ byKey:new Map(), date:null };
  function takeSnapshotFromData(day){
    const map=new Map();
    (day?.rows||[]).forEach(r=>{
      const k=norm(r.label||''); const vals=Object.assign({}, r.values||{});
      Object.keys(vals).forEach(s=> vals[s]=String(vals[s]||'').trim().toUpperCase());
      if(k) map.set(k, vals);
    });
    LAST_DAY_SNAPSHOT={ byKey:map, date:$date.value||null };
  }
  function computeCpDeltaAgainstSnapshotFromDOM(){
    const out=[];
    document.querySelectorAll('#saisie tbody tr').forEach(tr=>{
      const label=tr.querySelector('.row-label').textContent||'';
      const key=norm(label);
      const before=LAST_DAY_SNAPSHOT.byKey.get(key)||{};
      const now={}; tr.querySelectorAll('td.cell').forEach(td=> now[td.dataset.slot||'']=(td.textContent||'').trim().toUpperCase());
      let delta=0;
      Object.keys(Object.assign({},before,now)).forEach(slot=>{
        const b=before[slot]||''; const a=now[slot]||'';
        if(b!=='CP' && a==='CP') delta-=0.5;
        else if(b==='CP' && a!=='CP') delta+=0.5;
      });
      if(delta){
        const parts=String(label).trim().split(/\s+/);
        const nom=(parts[0]||'').toUpperCase(); const prenom=parts.slice(1).join(' ');
        out.push({ fullName:label.trim(), nom, prenom, delta:Number(delta.toFixed(2)) });
      }
    });
    return out;
  }

  function buildSection(title, rows){
    const headerSlots=['Matin','A. Midi'];
    const wrap=document.createElement('div'); const tt=document.createElement('div'); tt.className='section-title'; tt.textContent=title; wrap.appendChild(tt);
    const table=document.createElement('table'); table.className='table';
    const thead=document.createElement('thead');
    const tr=document.createElement('tr'); tr.innerHTML='<th class="row-label">Nom</th>'+headerSlots.map(s=>`<th>${s}</th>`).join(''); thead.appendChild(tr);
    table.appendChild(thead);
    const tbody=document.createElement('tbody');
    rows.forEach(r=>{
      const tr=document.createElement('tr');
      const name=document.createElement('td'); name.className='row-label'; name.textContent=r.label; tr.appendChild(name);
      headerSlots.forEach(slot=>{
        const td=document.createElement('td'); td.className='cell'; td.dataset.slot=slot;
        td.onclick=(ev)=>{
          const isCtrl=ev.ctrlKey||ev.metaKey;
          if(isCtrl){ td.classList.toggle('selected'); }
          else{ document.querySelectorAll('#saisie .cell.selected').forEach(c=>c.classList.remove('selected')); td.classList.add('selected'); }
        };
        tr.appendChild(td);
      });
      tbody.appendChild(tr);
    });
    table.appendChild(tbody);
    wrap.appendChild(table);
    return wrap;
  }

  function buildSaisie(){
    $saisie.innerHTML='';
    const emp=(personnel?.employes||[]).map(p=>({label:`${p.nom} ${p.prenom||''}`.trim()}));
    const inter=(personnel?.interims||[]).map(p=>({label:`${p.nom} ${p.prenom||''}`.trim()}));
    if(emp.length) $saisie.appendChild(buildSection('EMPLOYÉS', emp));
    if(inter.length) $saisie.appendChild(buildSection('INTÉRIM', inter));
    paintWeekendInSaisie();
  }

  function paintWeekendInSaisie(){
    const v=$date.value; if(!v) return;
    const d=new Date(v); const we=(d.getDay()===0||d.getDay()===6);
    document.querySelectorAll('#saisie td.cell').forEach(td=>{
      td.classList.toggle('weekend', we || td.textContent.trim()==='NP');
      if(isHoliday(v) && td.textContent.trim()==='F') td.classList.add('FERIE');
    });
  }
  $date.addEventListener('change',()=>{ prefillDay(); paintWeekendInSaisie(); });

  async function loadPersonnel(){ try{ personnel=await fetchJSON(`/personnel?magasin=${encodeURIComponent(currentMagasin)}`); }catch{ personnel={employes:[],interims:[],livreurs:{}}; } }
  async function prefillDay(){
    try{
      const day=$date.value;
      const payload=await fetchJSON(`/day?magasin=${encodeURIComponent(currentMagasin)}&date=${day}`);
      takeSnapshotFromData(payload?.data||{});
      const map=new Map((payload?.data?.rows||[]).map(r=>[norm(r.label), r.values||{}]));
      document.querySelectorAll('#saisie tbody tr').forEach(tr=>{
        const key=norm(tr.querySelector('.row-label').textContent);
        const vals=map.get(key)||{};
        tr.querySelectorAll('td.cell').forEach(td=>{
          const v=vals[td.dataset.slot]||'';
          ALL.forEach(c=>td.classList.remove(c)); td.classList.remove('PSITE','FERIE','weekend');
          td.textContent=v;
          if(v){
            if(v==='NP'){ td.classList.add('weekend'); }
            else{ td.classList.add(v); if(/^P\d+$/.test(v)) td.classList.add('PSITE'); if(isHoliday(day) && v==='F') td.classList.add('FERIE'); }
          }
        });
      });
    }catch{}
  }

  // ---- Actions
  async function postAdjustConges(payload){
    const list=Array.isArray(payload?.entries)?payload.entries:(Array.isArray(payload)?payload:[]);
    if(!list.length) return true;
    try{
      await fetch('/presence/adjust-conges',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({ magasin: payload.magasin||'', date: payload.date||'', entries:list })});
    }catch(e){ console.warn('[adjust-conges] proxy failed', e?.message||e); }
    return true;
  }

  $btnFill.onclick=()=>{ document.querySelectorAll('#saisie td.cell').forEach(td=>{ if(!td.textContent.trim()){ td.textContent='P'; td.classList.add('P'); } }); };

  $btnSave.addEventListener('click', async ()=>{
    if(!currentMagasin) return;
    $btnSave.disabled=true; if($busy) $busy.style.display='flex';
    const rows=[]; document.querySelectorAll('#saisie tbody tr').forEach(tr=>{ const label=tr.querySelector('.row-label').textContent; const values={}; tr.querySelectorAll('td.cell').forEach(td=> values[td.dataset.slot]=td.textContent.trim()); rows.push({label,values}); });
    try{
      await fetchJSON('/save',{method:'POST',body:JSON.stringify({ magasin:currentMagasin, date:$date.value, data:{rows} })});
      const entries=computeCpDeltaAgainstSnapshotFromDOM();
      if(entries.length){ await postAdjustConges({ magasin: currentMagasin, date:$date.value, entries }); takeSnapshotFromData({rows}); }
      alert('Enregistré ✔');
    }catch(e){ alert('Échec de l’enregistrement'); }
    finally{ $btnSave.disabled=false; if($busy) $busy.style.display='none'; }
  });

  async function selectMagasin(m,btn){
    currentMagasin=m; document.querySelectorAll('#mag-buttons button').forEach(x=>x.classList.remove('active')); if(btn) btn.classList.add('active');
    $curMag.textContent=m; panels.saisie.classList.add('active'); document.querySelector('.tab[data-tab="saisie"]').classList.add('active'); document.querySelector('.tab[data-tab="magasins"]').classList.remove('active'); panels.magasins.classList.remove('active');
    await loadPersonnel(); buildSaisie(); $date.value=todayISO(); await prefillDay(); paintWeekendInSaisie();
  }

  // ---- Résumé (simplifié)
  document.getElementById('btn-load').onclick=async ()=>{
    $resume.innerHTML='<div class="inline-loading"><span class="spinner"></span><span>Chargement…</span></div>';
    try{
      const ym=document.getElementById('res-month').value; const mg=$resStore.value;
      const data=await fetchJSON(`/month-store?yyyymm=${ym}&magasin=${encodeURIComponent(mg)}`);
      $resume.textContent = 'Résumé chargé.'; // placeholder (ton rendu existant peut être remis ici si besoin)
    }catch{ $resume.textContent='Erreur de chargement.'; }
  };

  // ---- Admin
  $btnLogin.onclick=(ev)=>{
    ev.preventDefault();
    const token=$pass.value.trim(); if(!token){ alert('Mot de passe requis'); return; }
    sessionStorage.setItem('leavesToken', token); if($remember.checked){ try{ localStorage.setItem('leavesToken', token); }catch{} }
    $loginBox.style.display='none'; $rangeBox.style.display='flex'; if(currentMagasin) $arMag.value=currentMagasin;
  };

  function populateAdminCodes(){
    $arCode.innerHTML='';
    const base=[
      ['','— Code —'],['CP','CP — Congé payé'],['P','P — Présent'],['AM','AM — Arrêt maladie'],
      ['AT','AT — Accident travail'],['F','F — Formation'],['Cep','Cep — Congé exceptionnel'],
      ['Ann','Ann — Absence non motivée'],['SS','SS — Sans solde'],['E','E — École'],['R','R — Récup'],
      ['D','D — Déplacement'],['RI','RI — Récup inventaire'],['UST','UST — Un seul tour']
    ];
    base.forEach(([v,t])=>{ const o=document.createElement('option'); o.value=v; o.textContent=t; $arCode.appendChild(o); });
    PSITES.forEach(c=>{ const o=document.createElement('option'); o.value=c; o.textContent=`${c} — Présence autre site`; $arCode.appendChild(o); });
  }

  $arMag.addEventListener('change', loadAdminPers);
  async function loadAdminPers(){
    $arPers.innerHTML='<option value="">— Chargement… —</option>'; $arPers.disabled=true;
    try{
      const pers=await fetchJSON(`/personnel?magasin=${encodeURIComponent($arMag.value)}`);
      $arPers.innerHTML='<option value="">— Sélectionnez —</option>';
      const add=(p)=>{ const o=document.createElement('option'); o.value=`${p.nom} ${p.prenom||''}`.trim(); o.textContent=`${(p.nom||'').toUpperCase()} ${p.prenom||''}`.trim(); o.dataset.nom=p.nom||''; o.dataset.prenom=p.prenom||''; o.dataset.slots='Matin|A. Midi'; $arPers.appendChild(o); };
      (pers.employes||[]).forEach(add); (pers.interims||[]).forEach(add);
      $arPers.disabled=false;
    }catch{ $arPers.innerHTML='<option value="">— Erreur —</option>'; }
  }

  $arAdd.addEventListener('click', async ()=>{
    const token=sessionStorage.getItem('leavesToken'); if(!token){ alert("Connectez-vous d'abord."); return; }
    $arAdd.disabled=true; $arMsg.innerHTML='<span class="spinner"></span> Ajout en cours…'; $arMsg.style.color='#667085';
    try{
      const magasin=$arMag.value, opt=$arPers.selectedOptions[0], code=$arCode.value, du=$arDu.value, au=$arAu.value;
      if(!magasin || !opt || !code || !du || !au){ $arMsg.textContent='Champs manquants.'; $arMsg.style.color='#b42318'; return; }
      const nom=opt.dataset.nom||'', prenom=opt.dataset.prenom||'';
      // Ajustement CP côté admin : −0,5 par jour ouvré (on sait qu’un second process écrit la période → total = −1 / jour)
      if(code==='CP'){
        let workdays=0; const d1=new Date(du), d2=new Date(au);
        for(let d=new Date(d1); d<=d2; d.setDate(d.getDate()+1)){
          const iso=ymd(d); const g=d.getDay(); if(g!==0 && g!==6 && !isHoliday(iso)) workdays++;
        }
        const delta = -0.5 * workdays;
        if(delta) await postAdjustConges({ magasin, date:du, entries:[{ fullName: opt.value || `${nom} ${prenom}`.trim(), nom, prenom, delta }] });
      }
      // Marquage de la période
      await fetchJSON('/range-mark',{ method:'POST', body:JSON.stringify({ magasin, nom, prenom, code, dateDu:du, dateAu:au, slots:['Matin','A. Midi'] }) });
      $arMsg.textContent='Ajout effectué ✔'; $arMsg.style.color='#027a48';
    }catch(e){ $arMsg.textContent='Échec de l’ajout.'; $arMsg.style.color='#b42318'; }
    finally{ $arAdd.disabled=false; }
  });

  // Init
  document.getElementById('res-month').value = `${new Date().getFullYear()}-${pad(new Date().getMonth()+1)}`;
})();</script>
</body>
</html>
