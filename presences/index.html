<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Présences DSG</title>
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;800&display=swap" rel="stylesheet">
<style>
:root{ --brand:#d21f3c; --bg:#f6f7f8; --text:#111; --muted:#666; --line:#e5e7eb; --tabsH:52px; }
*{box-sizing:border-box}
html,body{margin:0;padding:0;font-family:Montserrat,system-ui,-apple-system,"Segoe UI",Roboto,Arial,sans-serif;color:var(--text);background:#f6f7f8}
.app-header{display:flex;align-items:baseline;gap:1rem;padding:12px 16px;background:#fff;border-bottom:1px solid var(--line)}
.app-header h1{margin:0;font-weight:800;letter-spacing:.5px}
.app-header .today{color:var(--muted)}
.tabs{display:flex;gap:8px;padding:8px 12px;border-bottom:1px solid var(--line);background:#fff;position:sticky;top:0;z-index:5}
.tab{appearance:none;border:1px solid var(--line);background:#fff;border-radius:10px;padding:10px 14px;cursor:pointer;font-weight:700}
.tab.active{border-color:var(--brand);color:#fff;background:var(--brand)}
.tab-panel{display:none;padding:16px}
.tab-panel.active{display:block}
.grid-buttons{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:10px}
.grid-buttons button{padding:14px 12px;font-weight:700;border-radius:14px;border:1px solid var(--line);background:#fff;cursor:pointer}
.grid-buttons button.active{border-color:var(--brand);outline:3px solid color-mix(in srgb,var(--brand),transparent 70%)}
.toolbar{display:flex;align-items:center;gap:10px;padding:10px 12px;margin-bottom:10px;background:#fff;border:1px solid var(--line);border-radius:12px;flex-wrap:wrap}
.codes-bar{display:flex;align-items:center;gap:8px;flex-wrap:wrap;background:#fff;border:1px solid var(--line);border-radius:12px;padding:8px 10px}
.psite-strip{ display:flex; gap:8px; overflow-x:auto; padding-bottom:4px; }
.psite-strip .badge{ flex:0 0 auto; }
.psite-strip::-webkit-scrollbar{ height:6px; }
.psite-strip::-webkit-scrollbar-thumb{ background:#ddd; border-radius:999px; }
button.badge{border:1px solid var(--line);background:#fff;border-radius:999px;padding:6px 10px;font-weight:700;cursor:pointer}
button.badge.code{border-radius:8px}
button.primary { background: var(--brand); color: #fff; border: 0; border-radius: 12px; padding: 10px 16px; font-weight: 800; letter-spacing: .2px; box-shadow: 0 2px 0 rgba(0,0,0,.04); cursor:pointer }
button.primary:disabled{ opacity:.6; cursor:not-allowed }
.table{width:100%;border-collapse:collapse;background:#fff;border:1px solid var(--line);margin:18px 0;border-radius:12px;overflow:hidden}
.table th,.table td{border:1px solid var(--line);padding:8px;text-align:center}
.table thead th{background:#fafafa;font-weight:800}
.row-label{text-align:left;font-weight:600;white-space:nowrap}
.cell{min-width:32px;height:30px;cursor:pointer;user-select:none;position:relative;background:#fff}
.cell.selected{outline:3px solid #2563eb44}
/* Codes */
.cell.P{background:#e8f5ec;color:#1a7f37;font-weight:700}
.cell.CP{background:#efe6ff;color:#6b21a8;font-weight:700}
.cell.AM{background:#fee2e2;color:#b91c1c;font-weight:700}
.cell.UST{background:#fef3c7;color:#92400e;font-weight:700}
.cell.AT{background:#dcfce7;color:#15803d;font-weight:700}
.cell.F{background:#ccfbf1;color:#0f766e;font-weight:700}
.cell.Cep{background:#ffedd5;color:#b45309;font-weight:700}
.cell.Ann{background:#fce7f3;color:#be185d;font-weight:700}
.cell.SS{background:#ffe4e6;color:#be123c;font-weight:700}
.cell.E{background:#ecfccb;color:#65a30d;font-weight:700}
.cell.R{background:#dcfce7;color:#15803d;font-weight:700}
.cell.D{background:#dbeafe;color:#1d4ed8;font-weight:700}
.cell.RI{background:#fef9c3;color:#a16207;font-weight:700}
.cell.PSITE{background:#f5d0aa;color:#6b3e00;font-weight:700}
.cell.FERIE{ background:#e5e7eb !important; color:#111 !important; font-weight:800; }
/* Week-end DOIT rester noir quoiqu'il arrive */
.cell.weekend{background:#000 !important;color:#fff !important;font-weight:800 !important}
/* Codes bar badges */
.badge.code[data-code="P"]  {background:#e8f5ec;color:#1a7f37;border-color:#d9f0e1}
.badge.code[data-code="CP"] {background:#efe6ff;color:#6b21a8;border-color:#e7ddff}
.badge.code[data-code="AM"] {background:#fee2e2;color:#b91c1c}
.badge.code[data-code="UST"]{background:#fef3c7;color:#92400e}
.badge.code[data-code="AT"] {background:#dcfce7;color:#15803d}
.badge.code[data-code="F"]  {background:#ccfbf1;color:#0f766e}
.badge.code[data-code="Cep"]{background:#ffedd5;color:#b45309}
.badge.code[data-code="Ann"]{background:#fce7f3;color:#be185d}
.badge.code[data-code="SS"] {background:#ffe4e6;color:#be123c}
.badge.code[data-code="E"]  {background:#ecfccb;color:#65a30d}
.badge.code[data-code="R"]  {background:#dcfce7;color:#15803d}
.badge.code[data-code="D"]  {background:#dbeafe;color:#1d4ed8}
.badge.code[data-code="RI"] {background:#fef9c3;color:#a16207}
.badge.code[data-code^="P"]:not([data-code="P"]){background:#f5d0aa;color:#6b3e00}
.hint{color:#666}
.error{color:#a40000;font-weight:700}
.loading{padding:14px;color:#666}
.section-title{margin-top:8px;margin-bottom:6px;font-weight:800;text-transform:uppercase;color: var(--brand)}
</style>
<script>window.GS_PRESENCES_URL = window.GS_PRESENCES_URL || (window.__GS_PRESENCES_URL__ || "");</script>
</head>
<body>
<header class="app-header">
  <h1>Présences Durand Services</h1>
  <div class="today">Aujourd’hui : <span id="today"></span></div>
</header>

<main>
  <nav class="tabs">
    <button class="tab active" data-tab="magasins">Magasins</button>
    <button class="tab" data-tab="saisie">Saisie du jour</button>
    <button class="tab" data-tab="resume">Résumé du mois</button>
    <button class="tab" data-tab="leaves">Admin</button>
  </nav>

  <section id="tab-magasins" class="tab-panel active">
    <p class="hint">Choisissez un magasin :</p>
    <div id="magasin-buttons" class="grid-buttons"></div>
    <div id="magasin-loading" class="loading" style="display:none">Chargement du personnel…</div>
  </section>

  <section id="tab-saisie" class="tab-panel">
    <div class="toolbar">
      <div><b>Magasin :</b> <span id="current-magasin">—</span></div>
      <div><b>Date :</b> <input id="saisie-date" type="date"/></div>
      <button id="btn-save" class="primary">Enregistrer</button>
      <button id="btn-fill-all" class="badge">Tout mettre P</button>
    </div>
    <div id="codes-bar" class="codes-bar" aria-label="Codes de saisie"></div>
    <div id="saisie-content"></div>
    <p id="saisie-error" class="error" style="display:none"></p>
  </section>

  <section id="tab-resume" class="tab-panel">
    <div class="toolbar">
      <div><b>Mois :</b> <input id="resume-month" type="month"/></div>
      <div><b>Magasin :</b> <select id="resume-store"></select></div>
      <button id="btn-load-store" class="primary">Charger</button>
    </div>
    <div id="resume-content"></div>
    <p id="resume-error" class="error" style="display:none"></p>
  </section>

  <section id="tab-leaves" class="tab-panel">
    <div class="toolbar" style="width:100%">
      <form id="leaves-login-form" autocomplete="on" style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
        <input id="leaves-user" name="username" type="text" value="admin" autocomplete="username" style="display:none">
        <input id="leaves-pass" name="password" type="password" placeholder="Mot de passe admin" autocomplete="current-password"/>
        <label style="display:flex;align-items:center;gap:6px"><input type="checkbox" id="remember-pw"> Mémoriser</label>
        <button type="submit" id="btn-login" class="primary">Se connecter</button>
      </form>
    </div>
    <div id="admin-range" class="toolbar" style="display:none">
      <select id="ar-magasin"></select>
      <select id="ar-personnel"><option value="">— Personnel —</option></select>
      <select id="ar-code"></select>
      <input id="ar-du" type="date"/>
      <input id="ar-au" type="date"/>
      <button id="ar-add" class="primary">Ajouter</button>
      <div id="ar-msg" class="hint"></div>
    </div>
    <div id="leaves-content" class="admin-box"></div>
    <p id="leaves-error" class="error" style="display:none"></p>
  </section>
</main>

<script>
document.addEventListener('DOMContentLoaded', () => {
// ===== Helpers =====
const pad = n => n<10 ? `0${n}` : `${n}`;
const todayISO = () => { const d=new Date(); return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`; };
const thisYM = () => { const d=new Date(); return `${d.getFullYear()}-${pad(d.getMonth()+1)}`; };
const ymd = d => `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
const norm = s => String(s||"").trim().replace(/\s+/g," ").toUpperCase();
const union = (...arrs) => [...new Set(arrs.flat().filter(Boolean))];
const dowLetter = d => ["D","L","M","M","J","V","S"][d.getDay()];

// Fériés (échantillon)
const FERIES = new Set(["2025-01-01","2025-05-01","2025-05-08","2025-07-14","2025-11-11","2025-12-25"]);
const isHoliday = iso => FERIES.has(String(iso));

// ===== DOM refs =====
const $today = document.getElementById('today');
const $tabs = [...document.querySelectorAll('.tab')];
const $panels = {
  magasins: document.getElementById('tab-magasins'),
  saisie:   document.getElementById('tab-saisie'),
  resume:   document.getElementById('tab-resume'),
  leaves:   document.getElementById('tab-leaves'),
};
const $magBtnsWrap = document.getElementById('magasin-buttons');
const $magLoading  = document.getElementById('magasin-loading');
const $currMag     = document.getElementById('current-magasin');
const $dateInput   = document.getElementById('saisie-date');
const $saisieContent = document.getElementById('saisie-content');
const $btnSave     = document.getElementById('btn-save');
const $btnFillAll  = document.getElementById('btn-fill-all');
const $resumeMonth = document.getElementById('resume-month');
const $resumeStore = document.getElementById('resume-store');
const $btnLoadStore= document.getElementById('btn-load-store');
const $resumeContent = document.getElementById('resume-content');
const $resumeError = document.getElementById('resume-error');
const $codesBar    = document.getElementById('codes-bar');
// Admin
const $loginForm   = document.getElementById('leaves-login-form');
const $leavesPass  = document.getElementById('leaves-pass');
const $rememberPw  = document.getElementById('remember-pw');
const $leavesContent = document.getElementById('leaves-content');
const $leavesError = document.getElementById('leaves-error');
const $arBox = document.getElementById('admin-range');
const $arMag = document.getElementById('ar-magasin');
const $arPers= document.getElementById('ar-personnel');
const $arCode= document.getElementById('ar-code');
const $arDu  = document.getElementById('ar-du');
const $arAu  = document.getElementById('ar-au');
const $arAdd = document.getElementById('ar-add');
const $arMsg = document.getElementById('ar-msg');

$today.textContent = todayISO();
$resumeMonth.value = thisYM();

// ===== Data =====
const MAGASINS = ["ANNEMASSE","BOURGOIN","CHASSE SUR RHONE","CHASSIEU","GLEIZE","LA MOTTE SERVOLEX","MIRIBEL","PAVI","RENAGE","RIVES","SAINT-MARTIN-D'HERES","SEYNOD","ST EGREVE","ST-JEAN-BONNEFONDS"];
const MAIN_CODES = ['P','CP','AM','AT','F','Cep','Ann','SS','E','R','D','RI','UST','NP'];
const PSITE_CODES = Array.from({length:20}, (_,i)=>`P${i+1}`);
const CODE_DEFS = [
  {code:'P',label:'Présent'},{code:'CP',label:'Congé payé'},{code:'AM',label:'Arrêt maladie'},
  {code:'AT',label:'Accident travail'},{code:'F',label:'Formation'},{code:'Cep',label:'Congé exceptionnel'},
  {code:'Ann',label:'Absence non motivée'},{code:'SS',label:'Sans solde'},{code:'E',label:'École'},
  {code:'R',label:'Récup'},{code:'D',label:'Déplacement'},{code:'RI',label:'Récup inventaire'},
  {code:'UST',label:'Un seul tour'},{code:'NP',label:'Non planifié'},
  ...PSITE_CODES.map(c=>({code:c,label:'Présence autre site'})),
];
const ALL_CODES = CODE_DEFS.map(d=>d.code);

const apiBase = '/presence';

// ===== Utils Ajax =====
function delay(ms){ return new Promise(r=>setTimeout(r,ms)); }
async function fetchJSON(path, opts={}, retries=1){
  const ctrl = new AbortController(); const t = setTimeout(()=>ctrl.abort(), 15000);
  try{
    const headers = Object.assign({'Content-Type':'application/json'}, opts.headers||{});
    const r = await fetch(apiBase+path, { ...opts, headers, signal: ctrl.signal });
    if(!r.ok) throw new Error(await r.text());
    return await r.json();
  }catch(e){
    if(retries>0){ await delay(300); return fetchJSON(path, opts, retries-1); }
    throw e;
  }finally{ clearTimeout(t); }
}

// ===== Tabs =====
$tabs.forEach(btn => btn.addEventListener('click', () => switchTab(btn.dataset.tab)));
function switchTab(key){
  document.querySelectorAll('.tab').forEach(t=>t.classList.toggle('active',t.dataset.tab===key));
  Object.entries($panels).forEach(([k,el])=>el.classList.toggle('active',k===key));
  if(key==='leaves'){
    populateAdminCodes();
    const token = sessionStorage.getItem('leavesToken');
    $arBox.style.display = token ? 'flex' : 'none';
    $leavesError.style.display = token ? 'none' : 'block';
    if(token && currentMagasin) $arMag.value = currentMagasin;
  }
}

// ===== Magasins buttons =====
function buildMagButtons(){
  $magBtnsWrap.innerHTML='';
  MAGASINS.forEach(m=>{
    const b=document.createElement('button'); b.textContent=m;
    b.addEventListener('click',()=>selectMagasin(m,b));
    $magBtnsWrap.appendChild(b);
  });
}
buildMagButtons();

// ===== Codes bar =====
function buildGlobalCodesBar(){
  $codesBar.innerHTML = '';
  const clearBtn=document.createElement('button');
  clearBtn.className='badge'; clearBtn.textContent='Vider';
  clearBtn.addEventListener('click',()=>{
    const scope=[...selectedCells]; if(!scope.length) return;
    scope.forEach(td=>{ ALL_CODES.forEach(c=>td.classList.remove(c)); td.classList.remove('PSITE','FERIE','weekend'); td.textContent=''; });
  });
  $codesBar.appendChild(clearBtn);
  const addBtn=(code,label)=>{
    const b=document.createElement('button'); b.className='badge code'; b.dataset.code=code; b.textContent=code; b.title=`${code} ${label||''}`.trim();
    if(code==='NP'){ b.style.background='#000'; b.style.color='#fff'; b.style.borderColor='#000'; b.title='NP Non planifié (fond noir)'; }
    b.addEventListener('click',()=>{
      const scope=[...selectedCells]; if(!scope.length) return;
      scope.forEach(td=>{
        ALL_CODES.forEach(c=>td.classList.remove(c));
        td.classList.remove('PSITE','FERIE');
        const wasWeekend = td.classList.contains('weekend');
        td.textContent = code;
        if(code==='NP'){ td.classList.add('weekend'); }
        else {
          td.classList.toggle('weekend', wasWeekend); // préserver fond weekend si déjà présent
          td.classList.add(code);
          if(/^P\d+$/.test(code)) td.classList.add('PSITE');
        }
      });
    });
    return b;
  };
  MAIN_CODES.forEach(c => $codesBar.appendChild(addBtn(c, CODE_DEFS.find(d=>d.code===c)?.label)));
  const strip=document.createElement('div'); strip.className='psite-strip';
  PSITE_CODES.forEach(c=> strip.appendChild(addBtn(c,'Présence autre site')));
  $codesBar.appendChild(strip);
}

// ===== Saisie UI =====
let currentMagasin=null, personnel=null, selectedCells=new Set();
let HIST_ROWS_SAISIE = [];
let LAST_DAY_SNAPSHOT = { byKey: new Map(), date: null };

function clearSelection(){ selectedCells.forEach(c=>c.classList.remove('selected')); selectedCells.clear(); }
function handleCellClick(ev,td){
  const isShift=ev.shiftKey, isCtrl=ev.ctrlKey||ev.metaKey;
  if(isShift && selectedCells.size){
    const last=[...selectedCells][selectedCells.size-1];
    const rect=(a,b)=>{
      const ar=a.closest('tr').rowIndex, ac=a.cellIndex;
      const br=b.closest('tr').rowIndex, bc=b.cellIndex;
      const table=a.closest('table');
      const r1=Math.min(ar,br), r2=Math.max(ar,br);
      const c1=Math.min(ac,bc), c2=Math.max(ac,bc);
      for(let r=r1;r<=r2;r++) for(let c=c1;c<=c2;c++){
        const cell=table.rows[r].cells[c];
        if(cell && cell.classList.contains('cell')){ cell.classList.add('selected'); selectedCells.add(cell); }
      }
    };
    rect(last,td);
  }else if(isCtrl){
    td.classList.toggle('selected'); td.classList.contains('selected')?selectedCells.add(td):selectedCells.delete(td);
  }else{
    clearSelection(); td.classList.add('selected'); selectedCells.add(td);
  }
}

function buildSection(title, rows){
  const headerSlots = union(...rows.map(r=>r.slots||[]));
  const wrap=document.createElement('div');
  const titleEl=document.createElement('div'); titleEl.className='section-title'; titleEl.textContent=title;
  wrap.appendChild(titleEl);
  const table=document.createElement('table'); table.className='table';
  const thead=document.createElement('thead');
  const tr1=document.createElement('tr');
  tr1.innerHTML='<th class="row-label">Nom / Ligne</th>'+headerSlots.map(s=>`<th>${s}</th>`).join('');
  thead.appendChild(tr1); table.appendChild(thead);
  const tbody=document.createElement('tbody');
  rows.forEach(r=>{
    const tr=document.createElement('tr');
    const nameTd=document.createElement('td'); nameTd.className='row-label'; nameTd.textContent=r.label; tr.appendChild(nameTd);
    headerSlots.forEach(slot=>{
      const td=document.createElement('td'); td.className='cell'; td.dataset.slot=slot;
      td.addEventListener('click',ev=>handleCellClick(ev,td));
      tr.appendChild(td);
    });
    tbody.appendChild(tr);
  });
  table.appendChild(tbody);
  wrap.appendChild(table);
  return wrap;
}

function labelsFromDayData(dayData){ return (dayData?.rows || []).map(r => String(r.label||"").trim()).filter(Boolean); }

function buildSaisieUI(){
  $saisieContent.innerHTML=''; clearSelection();
  const sections=[];
  const empRows=(personnel?.employes||[]).map(p=>({label:`${p.nom} ${p.prenom||""}`.trim(), slots:["Matin","A. Midi"]}));
  if(empRows.length) sections.push({title:"EMPLOYÉS", rows:empRows});
  const intRows=(personnel?.interims||[]).map(p=>({label:`${p.nom} ${p.prenom||""}`.trim(), slots:["Matin","A. Midi"]}));
  if(intRows.length) sections.push({title:"INTÉRIM", rows:intRows});
  Object.entries(personnel?.livreurs||{}).forEach(([g,slots])=>{
    const rows=[{label:g, slots: (slots&&slots.length)? slots : ["Matin","A. Midi"]}];
    sections.push({title:`LIVREURS — ${g}`, rows});
  });
  if (Array.isArray(HIST_ROWS_SAISIE) && HIST_ROWS_SAISIE.length){
    sections.push({ title:"HISTORIQUE (ce jour)", rows: HIST_ROWS_SAISIE });
  }
  sections.forEach(s=> $saisieContent.appendChild(buildSection(s.title, s.rows)));
  paintWeekendInSaisie();
}

function takeSnapshotFromData(day){
  try{
    const map = new Map();
    (day?.rows||[]).forEach(r=>{
      const k = norm(r.label||'');
      const vals = Object.assign({}, r.values||{});
      Object.keys(vals).forEach(s=> vals[s] = String(vals[s]||'').trim().toUpperCase());
      if(k) map.set(k, vals);
    });
    LAST_DAY_SNAPSHOT = { byKey: map, date: $dateInput?.value || null };
  }catch(e){}
}

function applyPrefill(data){
  try{ takeSnapshotFromData(data); }catch(e){}
  const map = new Map((data.rows || []).map(r => [norm(r.label), r.values || {}]));
  $saisieContent.querySelectorAll('tbody tr').forEach(tr => {
    const labelKey = norm(tr.querySelector('.row-label').textContent.trim());
    const vals = map.get(labelKey) || {};
    tr.querySelectorAll('td.cell').forEach(td => {
      const v = vals[td.dataset.slot] || '';
      ALL_CODES.forEach(c => td.classList.remove(c));
      td.classList.remove('PSITE','FERIE','weekend');
      td.textContent = v;
      if (v) {
        if (v === 'NP') td.classList.add('weekend');
        else {
          td.classList.add(v);
          if (/^P\d+$/.test(v)) td.classList.add('PSITE');
          if (isSaisieHoliday() && v === 'F') td.classList.add('FERIE');
        }
      }
    });
  });
  paintWeekendInSaisie();
}

function isSaisieWeekend(){
  const v = $dateInput.value; if(!v) return false;
  const d = new Date(v); const g = d.getDay(); return g===0 || g===6;
}
function isSaisieHoliday(){ const v = $dateInput.value; return v ? isHoliday(v) : false; }
function paintWeekendInSaisie(){
  const we = isSaisieWeekend();
  document.querySelectorAll('#saisie-content td.cell').forEach(td=>{
    td.classList.toggle('weekend', we || td.textContent.trim()==='NP');
  });
}

function applyHolidayDefaultsForDay(){
  const day = $dateInput.value;
  if(!day || !isHoliday(day)) return;
  $saisieContent.querySelectorAll('td.cell').forEach(td=>{
    const cur = td.textContent.trim();
    if(!cur){
      td.textContent = 'F';
      td.classList.add('F','FERIE');
    }else if(cur==='F'){
      td.classList.add('FERIE');
    }
  });
}

function collectData(){
  const rows=[];
  $saisieContent.querySelectorAll('tbody tr').forEach(tr=>{
    const label=tr.querySelector('.row-label').textContent.trim();
    const values={};
    tr.querySelectorAll('td.cell').forEach(td=>values[td.dataset.slot]=td.textContent.trim());
    rows.push({label, values});
  });
  return {rows};
}

// Snapshot CP delta
function computeCpDeltaAgainstSnapshotFromDOM(){
  const out=[];
  document.querySelectorAll('#saisie-content tbody tr').forEach(tr=>{
    const label = tr.querySelector('.row-label')?.textContent || '';
    const key = norm(label);
    const before = LAST_DAY_SNAPSHOT.byKey.get(key) || {};
    const now={}; tr.querySelectorAll('td.cell').forEach(td=>{ now[td.dataset.slot||'']= (td.textContent||'').trim().toUpperCase(); });
    let delta = 0;
    Object.keys(Object.assign({}, before, now)).forEach(slot=>{
      const b = before[slot]||''; const a = now[slot]||'';
      if (b!=='CP' && a==='CP') delta -= 0.5;
      else if (b==='CP' && a!=='CP') delta += 0.5;
    });
    if (delta){
      const parts = String(label).trim().split(/\\s+/);
      const nom = (parts[0]||'').toUpperCase();
      const prenom = parts.slice(1).join(' ');
      out.push({ fullName: label.trim(), nom, prenom, delta: Number(delta.toFixed(2)) });
    }
  });
  return out;
}

// ===== Backend calls for day/personnel =====
async function loadPersonnel(){
  try{ personnel = await fetchJSON(`/personnel?magasin=${encodeURIComponent(currentMagasin)}`); }
  catch{ personnel = { employes:[], interims:[], livreurs:{} }; }
}
async function prefillDay(){
  if(!currentMagasin) return;
  try{
    const day=$dateInput.value;
    const payload = await fetchJSON(`/day?magasin=${encodeURIComponent(currentMagasin)}&date=${day}`);
    const labelsInDay = labelsFromDayData(payload?.data);
    const currentLabels = new Set([...document.querySelectorAll('#saisie-content .row-label')].map(el=>norm(el.textContent)));
    const missing = labelsInDay.map(lbl => ({ raw: lbl, key: norm(lbl) })).filter(x => !currentLabels.has(x.key));
    if (missing.length){
      const rowsMap = new Map((payload?.data?.rows||[]).map(r => [norm(r.label||""), r]));
      HIST_ROWS_SAISIE = missing.map(x=>{
        const rec = rowsMap.get(x.key) || {};
        const slots = Object.keys(rec.values || {});
        return { label: rec.label || x.raw, slots: (slots.length ? slots : ["Matin","A. Midi"]) };
      });
      buildSaisieUI();
    }else{ HIST_ROWS_SAISIE = []; }
    applyPrefill(payload?.data||{});
    applyHolidayDefaultsForDay();
  }catch{}
}

// ===== Saisie actions =====
$btnSave.addEventListener('click', async ()=>{
  if(!currentMagasin) return;
  const data=collectData(); $btnSave.disabled=true;
  try{
    await fetchJSON('/save',{method:'POST',body:JSON.stringify({magasin:currentMagasin,date:$dateInput.value,data})});
    try{
      const entries = computeCpDeltaAgainstSnapshotFromDOM();
      if (entries && entries.length){
        await postAdjustConges({ magasin: currentMagasin, date: $dateInput?.value || todayISO(), entries });
        takeSnapshotFromData(collectData());
      }
    }catch(e){ console.warn('postAdjustConges failed', e?.message||e); }
    alert('Enregistré ✔');
  }catch{ alert("Échec de l'enregistrement"); }
  finally{ $btnSave.disabled=false; }
});

document.getElementById('btn-fill-all').addEventListener('click', ()=>{
  document.querySelectorAll('#saisie-content td.cell').forEach(td=>{ if (!td.textContent.trim()) { td.textContent='P'; td.classList.add('P'); } });
});

$dateInput.addEventListener('change',async ()=>{ await prefillDay(); paintWeekendInSaisie(); });

// ===== Résumé =====
MAGASINS.forEach(m=>{ const o=document.createElement('option'); o.value=m; o.textContent=m; $resumeStore.appendChild(o); });
document.getElementById('btn-load-store').addEventListener('click', loadResumeForStore);

async function loadResumeForStore(){
  $resumeError.style.display='none';
  $resumeContent.innerHTML='<div class="loading">Chargement en cours…</div>';
  const ym=$resumeMonth.value, mag=$resumeStore.value;
  try{
    const data = await fetchJSON(`/month-store?yyyymm=${ym}&magasin=${encodeURIComponent(mag)}`);
    renderOneStore(ym, mag, data);
  }catch(e){
    $resumeError.textContent="Impossible de charger le résumé.";
    $resumeError.style.display='block';
    $resumeContent.innerHTML='';
  }
}

function renderOneStore(yyyymm, magasin, data){
  const days = (function(ym){ const [y,m]=ym.split('-').map(Number); const out=[]; for(let i=1;i<=new Date(y,m,0).getDate();i++) out.push(new Date(y,m-1,i)); return out; })(yyyymm);
  const file = data.file || {};
  const pers = data.personnel || {employes:[], interims:[], livreurs:{}};
  const wrap = document.createElement('div');
  const title = document.createElement('div'); title.className='section-title'; title.textContent=magasin; wrap.appendChild(title);
  const makeSection = (title, labels, slotsResolver) => {
    if(!labels.length) return null;
    const all=new Set(), order=[];
    labels.forEach(lbl=>{
      const key = norm(lbl);
      Object.values(file).forEach(day=>{
        const found = (day?.data?.rows||[]).find(r=> norm(r.label)===key);
        if(found){ Object.keys(found.values||{}).forEach(s=>{ if(!all.has(s)){ all.add(s); order.push(s); } }); }
      });
      const def = slotsResolver(lbl) || [];
      def.forEach(s=>{ if(!all.has(s)){ all.add(s); order.push(s); }});
    });
    const table=document.createElement('table'); table.className='table';
    const thead=document.createElement('thead');
    const trA=document.createElement('tr');
    trA.innerHTML = '<th class="row-label">Nom / Ligne</th>';
    days.forEach(d=>{ const th=document.createElement('th'); th.colSpan=order.length; th.textContent=dowLetter(d); thead.appendChild(trA); trA.appendChild(th); });
    const trB=document.createElement('tr'); trB.innerHTML = '<th> </th>'; days.forEach(d=>{ const th=document.createElement('th'); th.colSpan=order.length; th.textContent=String(d.getDate()); trB.appendChild(th); });
    const trC=document.createElement('tr'); trC.innerHTML = '<th> </th>'; days.forEach(()=>{ order.forEach(s=>{ const th=document.createElement('th'); th.textContent=s; trC.appendChild(th); }); });
    thead.appendChild(trA); thead.appendChild(trB); thead.appendChild(trC);
    table.appendChild(thead);
    const tbody=document.createElement('tbody');
    labels.forEach(lbl=>{
      const tr=document.createElement('tr');
      const td0=document.createElement('td'); td0.className='row-label'; td0.textContent=lbl; tr.appendChild(td0);
      days.forEach(d=>{
        const dk = ymd(d);
        const rec = file[dk];
        let values={};
        if(rec?.data?.rows){
          const found = rec.data.rows.find(r => norm(r.label) === norm(lbl));
          values = found?.values || {};
        }
        order.forEach(slot=>{
          const td=document.createElement('td'); td.className='cell';
          const g = d.getDay(); if (g===0 || g===6) td.classList.add('weekend');
          let v = values[slot] || '';
          if(!v && isHoliday(dk)) v = 'F';
          td.textContent = v;
          if(v){
            if (v === 'NP') td.classList.add('weekend');
            else {
              td.classList.add(v);
              if (/^P\d+$/.test(v)) td.classList.add('PSITE');
              if (isHoliday(dk) && v === 'F') td.classList.add('FERIE');
            }
          }
          tr.appendChild(td);
        });
      });
      tbody.appendChild(tr);
    });
    table.appendChild(tbody);
    const block=document.createElement('div');
    const sub=document.createElement('div'); sub.className='section-title'; sub.style.marginTop='10px'; sub.textContent=title;
    block.appendChild(sub); block.appendChild(table);
    return block;
  };
  const empLabels = (pers.employes||[]).map(p=>`${p.nom} ${p.prenom||""}`.trim());
  const intLabels = (pers.interims||[]).map(p=>`${p.nom} ${p.prenom||""}`.trim());
  const empSec = makeSection("EMPLOYÉS", empLabels, ()=>["Matin","A. Midi"]); if(empSec) wrap.appendChild(empSec);
  const intSec = makeSection("INTÉRIM", intLabels, ()=>["Matin","A. Midi"]); if(intSec) wrap.appendChild(intSec);
  $resumeContent.innerHTML=''; $resumeContent.appendChild(wrap);
}

// ===== Admin =====
function populateAdminCodes(){
  if(!$arCode) return;
  const opts = [
    {v:'', t:'— Code —'},
    {v:'CP', t:'CP — Congé payé'},
    {v:'P', t:'P — Présent'},
    {v:'AM', t:'AM — Arrêt maladie'},
    {v:'AT', t:'AT — Accident travail'},
    {v:'F', t:'F — Formation'},
    {v:'Cep', t:'Cep — Congé exceptionnel'},
    {v:'Ann', t:'Ann — Absence non motivée'},
    {v:'SS', t:'SS — Sans solde'},
    {v:'E', t:'E — École'},
    {v:'R', t:'R — Récup'},
    {v:'D', t:'D — Déplacement'},
    {v:'RI', t:'RI — Récup inventaire'},
    {v:'UST', t:'UST — Un seul tour'}
  ];
  const psite = Array.from({length:20}, (_,i)=>({v:`P${i+1}`, t:`P${i+1} — Présence autre site`}));
  $arCode.innerHTML = '';
  [...opts, ...psite].forEach(o=>{
    const op=document.createElement('option'); op.value=o.v; op.textContent=o.t; $arCode.appendChild(op);
  });
}

$loginForm.addEventListener('submit', (ev)=>{
  ev.preventDefault();
  const pw = $leavesPass.value.trim();
  if(!pw){ alert('Mot de passe requis'); return; }
  sessionStorage.setItem('leavesToken', pw);
  if($rememberPw.checked){ try{ localStorage.setItem('leavesToken', pw); }catch{} }
  $leavesError.style.display='none';
  $arBox.style.display='flex';
  if(currentMagasin) $arMag.value = currentMagasin;
  populateAdminCodes();
});

$arMag.addEventListener('change', loadAdminPersonnel);
async function loadAdminPersonnel(){
  $arPers.innerHTML = '<option value="">— Chargement… —</option>'; $arPers.disabled = true;
  const mag = $arMag.value;
  if(!mag){ $arPers.innerHTML = '<option value="">— Personnel —</option>'; $arPers.disabled = true; return; }
  try{
    const pers = await fetchJSON(`/personnel?magasin=${encodeURIComponent(mag)}`);
    const defaultSlots = ["Matin","A. Midi"];
    $arPers.innerHTML = '<option value="">— Sélectionnez —</option>';
    const add = (p)=>{
      const o=document.createElement('option');
      o.value = `${p.nom} ${p.prenom||""}`.trim();
      o.textContent = `${(p.nom||'').toUpperCase()} ${p.prenom||""}`.trim();
      o.dataset.nom = p.nom || ""; o.dataset.prenom = p.prenom || "";
      o.dataset.slots = defaultSlots.join('|');
      $arPers.appendChild(o);
    };
    (pers.employes||[]).forEach(add);
    (pers.interims||[]).forEach(add);
    Object.entries(pers.livreurs||{}).forEach(([g,slots])=>{
      const o = document.createElement('option');
      o.value = g;
      o.textContent = `Livreur — ${g}`;
      o.dataset.nom = g; o.dataset.prenom = "";
      o.dataset.slots = (Array.isArray(slots) && slots.length ? slots : defaultSlots).join('|');
      $arPers.appendChild(o);
    });
    $arPers.disabled = false;
  }catch{
    $arPers.innerHTML = '<option value="">— Erreur réseau —</option>'; $arPers.disabled = true;
  }
}

// Envoi CP vers Apps Script
async function postAdjustConges(payload){
  const list = Array.isArray(payload?.entries) ? payload.entries : (Array.isArray(payload) ? payload : []);
  if (!Array.isArray(list) || !list.length) return true;
  const base = (window.GS_PRESENCES_URL || "").trim();
  if (!base) { console.warn("[adjustcp] GS_PRESENCES_URL manquant"); return true; }
  const url = base + (base.includes("?") ? "&" : "?") + "action=adjustcp";
  const reqs = list.map(e => {
    const full = String(e.fullName||"").trim();
    const nom = (e.nom || (full.split(/\\s+/)[0]||"")).trim();
    const prenom = (e.prenom || (full.split(/\\s+/).slice(1).join(" ")||"")).trim();
    const body = JSON.stringify({ magasin: payload.magasin || e.magasin || "", nom, prenom, delta: Number(e.delta||0) });
    return fetch(url, { method:"POST", headers:{ "Content-Type":"application/json" }, body }).then(r=>r.json()).catch(()=>({ok:false}));
  });
  await Promise.allSettled(reqs);
  return true;
}

// Admin > Ajouter
$arAdd.addEventListener('click', async () => {
  const old = $arAdd.textContent; $arAdd.textContent = 'Ajout en cours…'; $arAdd.disabled = true; $arMsg.textContent='Ajout en cours…'; $arMsg.style.color='#666';
  try{
    const code = ($arCode||{}).value || '';
    if (code !== 'CP') { $arMsg.textContent = "Ajout effectué ✔ (hors CP)"; $arMsg.style.color="#1a7f37"; return; }
    const mag = ($arMag||{}).value || currentMagasin || '';
    const opt = ($arPers||{}).selectedOptions?.[0];
    const du = ($arDu||{}).value || '', au = ($arAu||{}).value || '';
    if (!mag || !opt || !du || !au){ $arMsg.textContent="Champs manquants."; $arMsg.style.color="#a40000"; return; }

    const nom = (opt.dataset?.nom||'').trim();
    const prenom = (opt.dataset?.prenom||'').trim();
    const slots = String(opt.dataset?.slots||'Matin|A. Midi').split('|').map(s=>s.trim()).filter(Boolean);
    const slotsCount = Math.max(1, slots.length);

    // jours ouvrés dans [du..au]
    let workdays = 0;
    try{ const d1=new Date(du), d2=new Date(au); for(let d=new Date(d1); d<=d2; d.setDate(d.getDate()+1)){ const iso = ymd(d); const g=d.getDay(); if(g!==0 && g!==6 && !isHoliday(iso)) workdays++; } }catch{}

    const delta = -0.5 * slotsCount * workdays;
    if (delta){
      await postAdjustConges({ magasin: mag, entries: [{ nom, prenom, delta }] });
    }
    $arMsg.textContent="Ajout effectué ✔"; $arMsg.style.color="#1a7f37";
  }catch(e){ console.warn('Admin add error', e); $arMsg.textContent="Échec de l’ajout."; $arMsg.style.color="#a40000"; }
  finally{ $arAdd.textContent = old; $arAdd.disabled = false; }
});

// ===== Select a magasin =====
async function selectMagasin(mag,btn){
  currentMagasin=mag;
  document.querySelectorAll('#magasin-buttons button').forEach(x=>x.classList.remove('active'));
  if (btn) btn.classList.add('active');
  $currMag.textContent=mag;
  $magLoading.style.display='block';
  try{ await loadPersonnel(); } finally { $magLoading.style.display='none'; }
  HIST_ROWS_SAISIE = [];
  buildSaisieUI();
  buildGlobalCodesBar();
  $dateInput.value=todayISO();
  await prefillDay();
  switchTab('saisie');
}

// Init magasins in Admin select
MAGASINS.forEach(m=>{ const o=document.createElement('option'); o.value=m; o.textContent=m; $arMag.appendChild(o); });

// Defaults
document.getElementById('today').textContent = todayISO();
$resumeMonth.value=thisYM();

}); // DOMContentLoaded
</script>
</body>
</html>
