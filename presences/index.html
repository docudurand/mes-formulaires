<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Présences DSG</title>
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;800&display=swap" rel="stylesheet">
<style>
:root{
  --brand:#d21f3c;
  --bg:#f6f7fb;
  --line:#e6e7ee;
  --muted:#6b7280;
  --text:#111827;
}
*{box-sizing:border-box}
html,body{margin:0;padding:0;background:var(--bg);color:var(--text);font-family:Montserrat,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
.app-header{display:flex;align-items:center;justify-content:space-between;padding:14px 18px;background:#fff;border-bottom:1px solid var(--line);position:sticky;top:0;z-index:10}
.app-header h1{margin:0;font-size:20px;font-weight:800;color:var(--brand)}
.app-header .today{color:var(--muted);font-size:13px}
.tabs{display:flex;gap:8px;padding:10px 12px;border-bottom:1px solid var(--line);background:#fff;position:sticky;top:58px;z-index:9}
.tab{appearance:none;border:1px solid var(--line);background:#fff;border-radius:10px;padding:8px 12px;font-weight:600;cursor:pointer}
.tab.active{border-color:var(--brand);color:#fff;background:var(--brand)}
.tab-panel{display:none;padding:14px}
.tab-panel.active{display:block}
.toolbar{display:flex;gap:10px;align-items:center;padding:10px;background:#fff;border:1px solid var(--line);border-radius:12px;margin-bottom:10px;flex-wrap:wrap}
.toolbar .spacer{flex:1}
.badge{appearance:none;border:1px solid var(--line);background:#fff;border-radius:999px;padding:7px 10px;font-weight:600;cursor:pointer}
.primary{background:var(--brand);border-color:var(--brand);color:#fff}
.loading{color:var(--muted)}
.error{color:#b91c1c;font-weight:600}
select,input[type="date"],input[type="password"]{border:1px solid var(--line);border-radius:8px;padding:6px 8px;background:#fff}
.section-title{font-weight:800;color:#111;font-size:15px;margin:10px 2px 6px}
.section-sub{font-weight:700;color:#374151;margin:8px 0 6px}
.table{border-collapse:collapse;width:100%;background:#fff;border:1px solid var(--line);border-radius:12px;overflow:hidden}
.table th,.table td{border:1px solid var(--line);padding:6px 8px;text-align:center;font-size:13px}
.table .row-label,.table .sub-label{text-align:left;background:#fafafa;font-weight:700}
.table td.cell{cursor:pointer;min-width:38px}
.table td.weekend{background:#fafafa}
.P{background:#e8f5e9}
.CP{background:#e3f2fd}
.ABS{background:#fff7ed}
.MAL{background:#fde2e2}
.R{background:#f3e8ff}
.selected{outline:2px solid #0ea5e9}
.mag-divider{height:1px;background:var(--line);margin:18px 0}

.section-toolbar{
  display:flex; gap:8px; align-items:center;
  padding:8px 10px; margin:6px 0 4px;
  background:#fff; border:1px solid var(--line); border-radius:10px; flex-wrap:wrap;
}
.section-toolbar .title{
  font-weight:800; text-transform:uppercase; color:var(--brand); margin-right:6px;
}
.section-toolbar .spacer{ flex:1; }
</style>
</head>
<body>
<header class="app-header">
  <h1>Présences DSG</h1>
  <div class="today">Aujourd’hui : <span id="today"></span></div>
</header>

<main>
  <nav class="tabs">
    <button class="tab active" data-tab="magasins">Magasins</button>
    <button class="tab" data-tab="saisie">Saisie du jour</button>
    <button class="tab" data-tab="resume">Résumé du mois</button>
    <button class="tab" data-tab="leaves">Demandes de congés</button>
  </nav>

  <section id="tab-magasins" class="tab-panel active">
    <div class="toolbar">
      <div><b>Choisissez un magasin</b></div>
      <div class="spacer"></div>
      <span id="magasin-loading" class="loading" style="display:none">Chargement…</span>
    </div>
    <div id="magasin-buttons" style="display:flex;flex-wrap:wrap;gap:8px"></div>
  </section>

  <section id="tab-saisie" class="tab-panel">
    <div class="toolbar">
      <div><b>Magasin :</b> <span id="current-magasin">—</span></div>
      <div><b>Date :</b> <input id="saisie-date" type="date"/></div>
      <div class="spacer"></div>
      <button id="btn-save" class="primary">Enregistrer</button>
      <button id="btn-fill-all" class="badge">Tout mettre P</button>
      <button class="badge" id="btn-diag">Diag API</button>
    </div>
    <div id="saisie-content"></div>
    <p id="saisie-error" class="error" style="display:none"></p>
  </section>

  <section id="tab-resume" class="tab-panel">
    <div class="toolbar">
      <div><b>Mois :</b> <input id="resume-month" type="month"/></div>
      <div><b>Magasin :</b>
        <select id="resume-store"><option value="">—</option></select>
      </div>
      <div class="spacer"></div>
      <button id="btn-load-store" class="primary">Charger</button>
    </div>
    <div id="resume-content"></div>
    <p id="resume-error" class="error" style="display:none"></p>
  </section>

  <section id="tab-leaves" class="tab-panel">
    <div class="toolbar">
      <input id="leaves-pass" type="password" placeholder="Mot de passe admin" />
      <button id="btn-login" class="primary">Se connecter</button>
      <div class="spacer"></div>
      <button id="btn-reload-leaves" class="badge">Recharger</button>
    </div>
    <div id="leaves-content"></div>
    <p id="leaves-error" class="error" style="display:none"></p>
  </section>
</main>

<script>
const pad=n=>n<10?`0${n}`:`${n}`;
const todayISO=()=>{const d=new Date();return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;}
const thisYM = ()=>{const d=new Date();return `${d.getFullYear()}-${pad(d.getMonth()+1)}`;}
const ymd = d=>`${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
const daysOfMonth = ym=>{ const [y,m]=ym.split('-').map(Number); const out=[]; for(let i=1;i<=new Date(y,m,0).getDate();i++) out.push(new Date(y,m-1,i)); return out; };
const dowLetter = d=>["D","L","M","M","J","V","S"][d.getDay()];
const norm = s => String(s||"").trim().replace(/\s+/g," ").toUpperCase();

const apiBase = '/presence';
const MAGASINS = [
 "ANNEMASSE","BOURGOIN","CHASSE SUR RHONE","CHASSIEU","GLEIZE",
 "LA MOTTE SERVOLEX","MIRIBEL","PAVI","RENAGE","RIVES",
 "SAINT-MARTIN-D'HERES","SEYNOD","ST EGREVE","ST-JEAN-BONNEFONDS"
];
const CODES=["P","CP","ABS","MAL","R"];

let currentMagasin=null, personnel=null, selectedCells=new Set();

sessionStorage.removeItem('leavesToken');

const $today=document.getElementById('today');
const $tabs=[...document.querySelectorAll('.tab')];
const $panels={ magasins:document.getElementById('tab-magasins'),
                saisie:document.getElementById('tab-saisie'),
                resume:document.getElementById('tab-resume'),
                leaves:document.getElementById('tab-leaves') };
const $magBtnsWrap=document.getElementById('magasin-buttons');
const $magLoading=document.getElementById('magasin-loading');
const $currMag=document.getElementById('current-magasin');
const $dateInput=document.getElementById('saisie-date');
const $saisieContent=document.getElementById('saisie-content');
const $btnSave=document.getElementById('btn-save');
const $btnFillAll=document.getElementById('btn-fill-all');
const $resumeMonth=document.getElementById('resume-month');
const $resumeStore=document.getElementById('resume-store');
const $btnLoadStore=document.getElementById('btn-load-store');
const $resumeContent=document.getElementById('resume-content');
const $resumeError=document.getElementById('resume-error');
const $btnDiag=document.getElementById('btn-diag');
const $leavesPass=document.getElementById('leaves-pass');
const $btnLogin=document.getElementById('btn-login');
const $btnReloadLeaves=document.getElementById('btn-reload-leaves');
const $leavesContent=document.getElementById('leaves-content');
const $leavesError=document.getElementById('leaves-error');

$today.textContent=todayISO(); 
$dateInput.value=todayISO(); 
$resumeMonth.value=thisYM();
MAGASINS.forEach(m=>{ const o=document.createElement('option'); o.value=m; o.textContent=m; $resumeStore.appendChild(o); });
MAGASINS.forEach(m=>{ const b=document.createElement('button'); b.className='badge'; b.textContent=m; b.addEventListener('click',()=>selectMagasin(m,b)); $magBtnsWrap.appendChild(b); });
$tabs.forEach(btn => btn.addEventListener('click', () => switchTab(btn.dataset.tab)));

async function fetchJSON(path, opts={}, retries=1){
  const ctrl = new AbortController();
  const t = setTimeout(()=>ctrl.abort(), 15000);
  try{
    const headers = Object.assign({'Content-Type':'application/json'}, opts.headers||{});
    const token = sessionStorage.getItem('leavesToken');
    if(path.startsWith('/leaves')){ if(token) headers['X-Admin-Token'] = token; }
    const r = await fetch(apiBase+path, { ...opts, headers, signal: ctrl.signal });
    if(!r.ok){
      const txt = await r.text().catch(()=> '');
      if (r.status === 401 && path.startsWith('/leaves')) throw new Error('401');
      throw new Error(txt || ('HTTP '+r.status));
    }
    return await r.json();
  }catch(e){
    if(retries>0){ await new Promise(r=>setTimeout(r,300)); return fetchJSON(path, opts, retries-1); }
    throw e;
  }finally{ clearTimeout(t); }
}

function switchTab(key){
  document.querySelectorAll('.tab').forEach(t=>t.classList.toggle('active',t.dataset.tab===key));
  Object.entries($panels).forEach(([k,el])=>el.classList.toggle('active',k===key));
  if(key==="leaves"){
    const token = sessionStorage.getItem('leavesToken');
    if(!token){
      $leavesError.textContent = "Veuillez vous connecter avec le mot de passe admin pour afficher les demandes.";
      $leavesError.style.display='block';
      $leavesContent.innerHTML = "";
      return;
    }
    loadLeaves();
  }
}

async function selectMagasin(mag,btn){
  currentMagasin=mag;
  document.querySelectorAll('#magasin-buttons button').forEach(x=>x.classList.remove('primary'));
  btn.classList.add('primary'); $currMag.textContent=mag;
  $magLoading.style.display='block';
  await loadPersonnel();
  $magLoading.style.display='none';
  buildSaisieUI();
  await prefillDay();
  switchTab('saisie');
}

async function loadPersonnel(){
  try{ personnel = await fetchJSON(`/personnel?magasin=${encodeURIComponent(currentMagasin)}`); }
  catch{ personnel = { employes:[], interims:[], livreurs:{} }; }
}

function clearSelection(){ selectedCells.forEach(c=>c.classList.remove('selected')); selectedCells.clear(); }
function handleCellClick(ev,td){
  const isShift=ev.shiftKey, isCtrl=ev.ctrlKey||ev.metaKey;
  if(isShift && selectedCells.size){
    const last=[...selectedCells][selectedCells.size-1];
    const rectRange=(a,b)=>{
      const ar=a.closest('tr').rowIndex, ac=a.cellIndex;
      const br=b.closest('tr').rowIndex, bc=b.cellIndex;
      const r1=Math.min(ar,br), r2=Math.max(ar,br);
      const c1=Math.min(ac,bc), c2=Math.max(ac,bc);
      const table=a.closest('table');
      for(let r=r1;r<=r2;r++) for(let c=c1;c<=c2;c++){
        const cell=table.rows[r].cells[c];
        if(cell && cell.classList.contains('cell')){ cell.classList.add('selected'); selectedCells.add(cell); }
      }
    };
    rectRange(last,td);
  }else if(isCtrl){
    td.classList.toggle('selected'); td.classList.contains('selected')?selectedCells.add(td):selectedCells.delete(td);
  }else{
    clearSelection(); td.classList.add('selected'); selectedCells.add(td);
  }
}
function headerSelectColumn(th){
  const idx=th.cellIndex; const table=th.closest('table'); clearSelection();
  [...table.tBodies[0].rows].forEach(tr=>{
    const td=tr.cells[idx]; if(td && td.classList.contains('cell')){ td.classList.add('selected'); selectedCells.add(td); }
  });
}
function union(...arrs){ return [...new Set(arrs.flat().filter(Boolean))]; }

/* section avec barre d’actions locale */
function buildSection(title, rows){
  const headerSlots = union(...rows.map(r=>r.slots||[]));

  const table=document.createElement('table'); table.className='table';
  const thead=document.createElement('thead');
  const tr1=document.createElement('tr');
  tr1.innerHTML='<th class="row-label">Nom / Ligne</th>'+headerSlots.map(s=>`<th>${s}</th>`).join('');
  tr1.querySelectorAll('th').forEach((th,i)=>{ if(i>0) th.addEventListener('click',()=>headerSelectColumn(th)); });
  thead.appendChild(tr1); table.appendChild(thead);
  const tbody=document.createElement('tbody');

  rows.forEach(r=>{
    const tr=document.createElement('tr');
    const nameTd=document.createElement('td'); nameTd.className='row-label'; nameTd.textContent=r.label; tr.appendChild(nameTd);
    headerSlots.forEach(slot=>{
      const td=document.createElement('td'); td.className='cell'; td.dataset.slot=slot;
      td.addEventListener('click',ev=>handleCellClick(ev,td)); tr.appendChild(td);
    });
    tbody.appendChild(tr);
  });
  table.appendChild(tbody);

  const bar=document.createElement('div'); bar.className='section-toolbar';
  const titleEl=document.createElement('div'); titleEl.className='title'; titleEl.textContent=title; bar.appendChild(titleEl);

  const makeBtn=(label, code=null, {allP=false, clear=false}={})=>{
    const b=document.createElement('button'); b.className='badge'; b.textContent=label;
    b.addEventListener('click',()=>{
      const cells = table.querySelectorAll('td.cell');
      cells.forEach(td=>{
        ["P","CP","ABS","MAL","R"].forEach(c=>td.classList.remove(c));
        if(clear){ td.textContent=''; return; }
        if(allP){ td.textContent='P'; td.classList.add('P'); return; }
        if(code){ td.textContent=code; td.classList.add(code); }
      });
    });
    return b;
  };
  bar.appendChild(makeBtn("Vider", null, {clear:true}));
  bar.appendChild(makeBtn("P","P"));
  bar.appendChild(makeBtn("CP","CP"));
  bar.appendChild(makeBtn("ABS","ABS"));
  bar.appendChild(makeBtn("MAL","MAL"));
  bar.appendChild(makeBtn("R","R"));
  bar.appendChild(makeBtn("Tout mettre P", null, {allP:true}));

  const wrap=document.createElement('div');
  const sub=document.createElement('div'); sub.className='section-sub'; sub.textContent=title;
  wrap.appendChild(bar);
  wrap.appendChild(table);
  return wrap;
}

function buildSaisieUI(){
  $saisieContent.innerHTML='';
  clearSelection();
  const sections=[];
  const empRows=(personnel?.employes||[]).map(p=>({label:`${p.nom} ${p.prenom||""}`.trim(), slots:["Matin","A. Midi"]}));
  if(empRows.length) sections.push({title:"EMPLOYÉS", rows:empRows});
  const intRows=(personnel?.interims||[]).map(p=>({label:`${p.nom} ${p.prenom||""}`.trim(), slots:["Matin","A. Midi"]}));
  if(intRows.length) sections.push({title:"INTÉRIM", rows:intRows});
  Object.entries(personnel?.livreurs||{}).forEach(([g,slots])=>{
    const rows=[{label:g, slots: (slots&&slots.length)? slots : ["Matin","A. Midi"]}];
    sections.push({title:`LIVREURS — ${g}`, rows});
  });
  sections.forEach(s=> $saisieContent.appendChild(buildSection(s.title, s.rows)));
}

$btnFillAll.addEventListener('click', ()=>{
  document.querySelectorAll('#saisie-content td.cell').forEach(td=>{
    ["P","CP","ABS","MAL","R"].forEach(c=>td.classList.remove(c));
    td.textContent = 'P';
    td.classList.add('P');
  });
});

async function prefillDay(){
  if(!currentMagasin) return;
  try{
    const day=$dateInput.value;
    const payload = await fetchJSON(`/day?magasin=${encodeURIComponent(currentMagasin)}&date=${day}`);
    applyPrefill(payload?.data||{});
  }catch{}
}
function applyPrefill(data){
  const map=new Map((data.rows||[]).map(r=>[`${r.label}`, r.values||{}]));
  $saisieContent.querySelectorAll('tbody tr').forEach(tr=>{
    const label=tr.querySelector('.row-label').textContent.trim();
    const vals=map.get(label)||{};
    tr.querySelectorAll('td.cell').forEach(td=>{
      const v=vals[td.dataset.slot]||''; ["P","CP","ABS","MAL","R"].forEach(c=>td.classList.remove(c));
      td.textContent=v; if(v) td.classList.add(v);
    });
  });
}
function collectData(){
  const rows=[];
  $saisieContent.querySelectorAll('tbody tr').forEach(tr=>{
    const label=tr.querySelector('.row-label').textContent.trim();
    const values={};
    tr.querySelectorAll('td.cell').forEach(td=>values[td.dataset.slot]=td.textContent.trim());
    rows.push({label, values});
  });
  return {rows};
}
document.getElementById('btn-save').addEventListener('click', async ()=>{
  if(!currentMagasin) return;
  const data=collectData(); $btnSave.disabled=true;
  try{
    await fetchJSON('/save',{method:'POST',body:JSON.stringify({magasin:currentMagasin,date:$dateInput.value,data})});
    alert('Enregistré ✔');
  }catch{ alert("Échec de l'enregistrement"); }
  finally{ $btnSave.disabled=false; }
});
$dateInput.addEventListener('change',prefillDay);
$btnDiag.addEventListener('click', async ()=>{
  try{ const r = await fetchJSON('/_diag'); alert('Diag: '+(r?.ok?'OK':'KO')); }
  catch{ alert('Diag KO'); }
});

$btnLoadStore.addEventListener('click', loadResumeForStore);
async function loadResumeForStore(){
  $resumeError.style.display='none';
  $resumeContent.innerHTML='<div class="loading">Chargement en cours…</div>';
  const ym=$resumeMonth.value, mag=$resumeStore.value;
  try{
    const data = await fetchJSON(`/month-store?yyyymm=${ym}&magasin=${encodeURIComponent(mag)}`);
    renderOneStore(ym, mag, data);
  }catch(e){
    $resumeError.textContent="Impossible de charger le résumé.";
    $resumeError.style.display='block';
    $resumeContent.innerHTML='';
  }
}
function renderOneStore(yyyymm, magasin, data){
  const days = daysOfMonth(yyyymm);
  const file = data.file || {};
  const pers = data.personnel || {employes:[], interims:[], livreurs:{}};

  const wrap = document.createElement('div');
  const title = document.createElement('div'); title.className='section-title'; title.textContent=magasin; wrap.appendChild(title);

  const isWE = d => { const x=d.getDay(); return x===0||x===6; };

  function makeSection(title, labels, slotsResolver){
    if(!labels.length) return null;

    const all=new Set(), order=[];
    labels.forEach(lbl=>{
      const key = norm(lbl);
      Object.values(file).forEach(day=>{
        const found = (day?.data?.rows||[]).find(r=> norm(r.label)===key);
        if(found){ Object.keys(found.values||{}).forEach(s=>{ if(!all.has(s)){ all.add(s); order.push(s); } }); }
      });
      const def = slotsResolver(lbl) || [];
      def.forEach(s=>{ if(!all.has(s)){ all.add(s); order.push(s); }});
    });

    const table=document.createElement('table'); table.className='table';
    const thead=document.createElement('thead');
    const trA=document.createElement('tr');
    const th0=document.createElement('th'); th0.className='row-label'; th0.textContent='Nom / Ligne'; trA.appendChild(th0);
    days.forEach(d=>{ const th=document.createElement('th'); th.colSpan=order.length; th.textContent=dowLetter(d); trA.appendChild(th); });
    thead.appendChild(trA);

    const trB=document.createElement('tr');
    const thB0=document.createElement('th'); thB0.className='sub-label'; thB0.textContent=' '; trB.appendChild(thB0);
    days.forEach(d=>{ const th=document.createElement('th'); th.colSpan=order.length; th.textContent=String(d.getDate()); trB.appendChild(th); });
    thead.appendChild(trB);

    const trC=document.createElement('tr');
    const thC0=document.createElement('th'); thC0.className='sub-label'; thC0.textContent=' '; trC.appendChild(thC0);
    days.forEach(()=>{ order.forEach(s=>{ const th=document.createElement('th'); th.textContent=s; trC.appendChild(th); }); });
    thead.appendChild(trC);

    table.appendChild(thead);

    const tbody=document.createElement('tbody');
    labels.forEach(lbl=>{
      const tr=document.createElement('tr');
      const td0=document.createElement('td'); td0.className='row-label'; td0.textContent=lbl; tr.appendChild(td0);
      days.forEach(d=>{
        const dk = ymd(d);
        const rec = file[dk];
        let values={};
        if(rec?.data?.rows){
          const found = rec.data.rows.find(r => norm(r.label) === norm(lbl));
          values = found?.values || {};
        }
        order.forEach(slot=>{
          const td=document.createElement('td'); td.className='cell';
          if(isWE(d)) td.classList.add('weekend');
          const v = values[slot] || '';
          td.textContent = v;
          if(v) td.classList.add(v);
          tr.appendChild(td);
        });
      });
      tbody.appendChild(tr);
    });

    table.appendChild(tbody);
    const block=document.createElement('div'); 
    const sub=document.createElement('div'); sub.className='section-sub'; sub.textContent=title;
    block.appendChild(sub); block.appendChild(table);
    return block;
  }

  const empLabels = (pers.employes||[]).map(p=>`${p.nom} ${p.prenom||""}`.trim());
  const intLabels = (pers.interims||[]).map(p=>`${p.nom} ${p.prenom||""}`.trim());

  const empSec = makeSection("EMPLOYÉS", empLabels, ()=>["Matin","A. Midi"]);
  if(empSec) wrap.appendChild(empSec);

  const intSec = makeSection("INTÉRIM", intLabels, ()=>["Matin","A. Midi"]);
  if(intSec) wrap.appendChild(intSec);

  Object.entries(pers.livreurs||{}).forEach(([g,slots])=>{
    const sec = makeSection(`LIVREURS — ${g}`, [g], ()=> (slots&&slots.length? slots : ["Matin","A. Midi"]));
    if(sec) wrap.appendChild(sec);
  });

  wrap.appendChild(Object.assign(document.createElement('div'),{className:'mag-divider'}));
  $resumeContent.innerHTML=''; $resumeContent.appendChild(wrap);
}

$btnLogin.addEventListener('click', ()=>{
  const pw = $leavesPass.value.trim();
  if(!pw){ alert('Mot de passe requis'); return; }
  sessionStorage.setItem('leavesToken', pw);
  $leavesError.style.display='none';
  $leavesContent.innerHTML = '';
  loadLeaves();
});
$btnReloadLeaves.addEventListener('click', loadLeaves);

async function loadLeaves(){
  const token = sessionStorage.getItem('leavesToken');
  if(!token){
    $leavesError.textContent = "Veuillez vous connecter avec le mot de passe admin pour afficher les demandes.";
    $leavesError.style.display='block';
    $leavesContent.innerHTML = "";
    return;
  }
  $leavesError.style.display='none';
  $leavesContent.innerHTML = '<div class="loading">Chargement des demandes…</div>';
  try{
    const data = await fetchJSON('/leaves?all=1', { headers:{} });
    const arr = Array.isArray(data.leaves) ? data.leaves : [];
    if(!arr.length){ $leavesContent.innerHTML = '<div class="loading">Aucune demande trouvée.</div>'; return; }
    renderLeaves(arr);
  }catch(e){
    const msg = (String(e?.message||'').includes('401'))
      ? "Mot de passe invalide (401)."
      : "Impossible de charger les demandes (mot de passe ou réseau).";
    $leavesError.textContent = msg;
    $leavesError.style.display='block';
    $leavesContent.innerHTML = '';
  }
}
function renderLeaves(items){
  items.sort((a,b)=> String(b.createdAt).localeCompare(String(a.createdAt)));
  const wrap=document.createElement('div');

  const makeBtn = (label, fn) => { const b=document.createElement('button'); b.className='badge'; b.textContent=label; b.addEventListener('click', fn); return b; };

  items.forEach(it=>{
    const card=document.createElement('div');
    card.style.border='1px solid var(--line)'; card.style.borderRadius='10px'; card.style.background='#fff';
    card.style.padding='10px'; card.style.margin='8px 0';

    const h = document.createElement('div');
    h.innerHTML = `<b>${(it.nom||'').toUpperCase()} ${it.prenom||''}</b> — <span style="color:var(--muted)">${it.magasin||'?'}</span>`;
    card.appendChild(h);

    const p = document.createElement('div');
    p.style.fontSize='.95rem';
    p.innerHTML = `Période: <b>${it.dateDu}</b> → <b>${it.dateAu}</b> • ${it.nbJours||'?'} jour(s) • Service: ${it.service||'-'} • Email: ${it.email||''}`;
    card.appendChild(p);

    const status = document.createElement('div');
    status.style.marginTop='6px';
    status.innerHTML = `Statut: <b>${it.status}</b>` + (it.reason? ` — ${it.reason}`:'');
    card.appendChild(status);

    if(String(it.status)==="pending"){
      const actions = document.createElement('div'); actions.style.marginTop='8px'; actions.style.display='flex'; actions.style.gap='8px';
      const ok = makeBtn('Accepter', ()=> decideLeave(it.id,'accept'));
      const ko = makeBtn('Refuser', ()=> { const r=prompt("Motif du refus ? (optionnel)",""); decideLeave(it.id,'reject', r||""); });
      actions.appendChild(ok); actions.appendChild(ko);
      card.appendChild(actions);
    }

    wrap.appendChild(card);
  });

  $leavesContent.innerHTML=''; $leavesContent.appendChild(wrap);
}
async function decideLeave(id, decision, reason=""){
  try{
    await fetchJSON('/leaves/decision', { method:'POST', body: JSON.stringify({ id, decision, reason }) });
    alert('Décision enregistrée.');
    loadLeaves();
  }catch(e){
    alert('Échec de la décision: ' + (e?.message||''));
  }
}

document.getElementById('today').textContent = todayISO();
</script>
</body>
</html>