<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin - Outils</title>
  <style>
    :root{
      --primary:#004080;
      --ink:#073763;
      --bg:#f5f9fc;
      --card:#ffffff;
      --line:#e5e7eb;
      --shadow:0 8px 26px rgba(0,0,0,0.08);
      --radius:16px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      color:var(--ink);
      background:var(--bg);
    }
    header{
      background:var(--card);
      box-shadow:var(--shadow);
      position:sticky;
      top:0;
      z-index:50;
    }
    .tabs{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      padding:10px 16px 14px;
      border-top:1px solid var(--line);
    }
    .tab{
      appearance:none;
      border:1px solid var(--line);
      background:#fff;
      color:var(--ink);
      padding:8px 14px;
      border-radius:999px;
      cursor:pointer;
      font-weight:700;
      font-size:.95rem;
    }
    .tab[aria-selected="true"]{
      background:var(--primary);
      border-color:var(--primary);
      color:#fff;
    }
    .panelWrap{
      padding:14px 16px 18px;
    }
    .panel{
      display:none;
      background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--radius);
      overflow:hidden;
      box-shadow:var(--shadow);
    }
    .panel.active{display:block}
    .frame{
      width:100%;
      height:calc(100vh - 92px);
      border:0;
      background:#fff;
    }
    .note{
      padding:10px 14px;
      border-bottom:1px solid var(--line);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
      background:#fbfdff;
    }
    .note small{color:#47607a}
    .btn{
      appearance:none;
      border:1px solid var(--line);
      background:#fff;
      padding:8px 12px;
      border-radius:10px;
      cursor:pointer;
      font-weight:700;
      color:var(--ink);
    }
    .btn:hover{border-color:#bfc7d1}
  </style>
</head>
<body>

<header>
  <div class="tabs" role="tablist" aria-label="Outils admin">
    <button class="tab" role="tab" id="tab-parc"  aria-controls="panel-parc"  aria-selected="true"  data-target="parc">Parc & prets</button>
    <button class="tab" role="tab" id="tab-comp"  aria-controls="panel-comp"  aria-selected="false" data-target="comp">Compteurs</button>
    <button class="tab" role="tab" id="tab-mails" aria-controls="panel-mails" aria-selected="false" data-target="mails">Suivi e-mails</button>
    <button class="tab" role="tab" id="tab-monitor" aria-controls="panel-monitor" aria-selected="false" data-target="monitor">Monitor</button>
  </div>
</header>

<div class="panelWrap">
  <section class="panel active" id="panel-parc" role="tabpanel" aria-labelledby="tab-parc">
    <iframe class="frame" title="Parc & prets véhicules" data-src="/pret/admin"></iframe>
  </section>

  <section class="panel" id="panel-comp" role="tabpanel" aria-labelledby="tab-comp">
    <iframe class="frame" title="Compteurs" data-src="/compteur.html"></iframe>
  </section>

  <section class="panel" id="panel-mails" role="tabpanel" aria-labelledby="tab-mails">
    <iframe class="frame" title="Suivi e-mails" data-src="/suivi-mails.html"></iframe>
  </section>

  <section class="panel" id="panel-monitor" role="tabpanel" aria-labelledby="tab-monitor">
    <div class="note">
      <button class="btn" id="btn-unlock-monitor" type="button">Débloquer Monitor</button>
    </div>
    <iframe class="frame" title="Monitor" data-src="/monitor/"></iframe>
  </section>
</div>

<script>
  const tabs = Array.from(document.querySelectorAll(".tab"));
  const panels = {
    parc:    document.getElementById("panel-parc"),
    comp:    document.getElementById("panel-comp"),
    mails:   document.getElementById("panel-mails"),
    monitor: document.getElementById("panel-monitor"),
  };

  const MONITOR_TOKEN_STORAGE_KEY = "dsg_monitor_token";

  function ensureIframeLoaded(panel){
    const iframe = panel.querySelector("iframe[data-src]");
    if(!iframe) return;

    // Monitor: on s'assure que le cookie d'auth est posé avant de charger l'iframe,
    // sinon le backend renvoie 401 (unauthorized) sur /monitor/stream, /monitor/logs, etc.
    if(panel.id === "panel-monitor"){
      ensureMonitorAuth().then((ok) => {
        if(ok && !iframe.src){
          iframe.src = iframe.dataset.src;
        }
      });
      return;
    }

    if(!iframe.src){
      iframe.src = iframe.dataset.src;
    }
  }

  function setActive(key, pushHash=true){
    tabs.forEach(t => {
      const on = (t.dataset.target === key);
      t.setAttribute("aria-selected", on ? "true" : "false");
    });

    Object.entries(panels).forEach(([k, p]) => {
      const on = (k === key);
      p.classList.toggle("active", on);
      if(on) ensureIframeLoaded(p);
    });

    if(pushHash){
      location.hash = key;
    }
  }

  document.querySelector(".tabs").addEventListener("click", (e) => {
    const btn = e.target.closest(".tab");
    if(!btn) return;
    setActive(btn.dataset.target, true);
  });

  async function ensureMonitorAuth(forcePrompt=false){
    let token = localStorage.getItem(MONITOR_TOKEN_STORAGE_KEY) || "";

    if(forcePrompt || !token){
      token = prompt("Token Monitor :") || "";
      token = token.trim();
      if(!token) return false;
      localStorage.setItem(MONITOR_TOKEN_STORAGE_KEY, token);
    }

    try{
      // IMPORTANT: le cookie HttpOnly monitor_token est posé côté serveur
      // uniquement si une requête authentifiée passe (Authorization: Bearer ...).
      const res = await fetch("/monitor/health", {
        method: "GET",
        headers: { "Authorization": "Bearer " + token },
        cache: "no-store",
        credentials: "same-origin"
      });

      if(res.ok){
        return true;
      }

      // mauvais token -> on efface
      if(res.status === 401){
        localStorage.removeItem(MONITOR_TOKEN_STORAGE_KEY);
        alert("Token Monitor incorrect (401).");
        return false;
      }

      alert("Erreur Monitor (" + res.status + ").");
      return false;
    }catch(err){
      alert("Impossible de contacter le Monitor: " + (err && err.message ? err.message : err));
      return false;
    }
  }

  document.getElementById("btn-unlock-monitor").addEventListener("click", async () => {
    const ok = await ensureMonitorAuth(true);
    if(!ok) return;
    const iframe = document.querySelector("#panel-monitor iframe[data-src]");
    if(iframe){
      iframe.src = iframe.dataset.src + (iframe.dataset.src.includes("?") ? "&" : "?") + "t=" + Date.now();
    }
  });

  // init
  const initial = (location.hash || "#parc").replace("#", "");
  if(panels[initial]){
    setActive(initial, false);
  }else{
    ensureIframeLoaded(panels.parc);
  }
</script>

</body>
</html>
