<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin - Monitor & Pub</title>
  <style>
    :root{
      --primary:#004080;
      --ink:#073763;
      --bg:#f5f9fc;
      --card:#ffffff;
      --line:#e5e7eb;
      --shadow:0 8px 26px rgba(0,0,0,0.08);
      --radius:16px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      color:var(--ink);
      background:var(--bg);
    }
    header{
      background:var(--card);
      box-shadow:var(--shadow);
      position:sticky;
      top:0;
      z-index:50;
    }
    .tabs{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      padding:10px 16px 14px;
      border-top:1px solid var(--line);
    }
    .tab{
      appearance:none;
      border:1px solid var(--line);
      background:#fff;
      color:var(--ink);
      padding:8px 12px;
      border-radius:999px;
      font-weight:700;
      cursor:pointer;
    }
    .tab[aria-selected="true"]{
      background:var(--primary);
      border-color:var(--primary);
      color:#fff;
    }
    .panelWrap{
      width:100%;
      margin:0;
      padding:14px 16px 18px;
    }
    .panel{
      display:none;
      background:#fff;
      border:1px solid var(--line);
      border-radius:var(--radius);
      overflow:hidden;
      box-shadow:var(--shadow);
    }
    .panel.active{display:block}

    .frame{
      width:100%;
      height:calc(100vh - 140px);
      border:0;
      display:block;
      background:#fff;
    }

    .pubWrap{
      width:100%;
      height:calc(100vh - 140px);
      background:#000;
      overflow:hidden;
      position:relative;
    }
    .pubTrack{
      display:flex;
      height:100%;
      width:100%;
      transition:transform 0.8s ease;
    }
    .pubSlide{
      min-width:100%;
      height:100%;
      background-position:center;
      background-repeat:no-repeat;
      background-size:cover;
    }

    @media (max-width:600px){
      .frame{
        height:calc(100vh - 150px);
        min-height:620px;
      }
      .pubWrap{
        height:calc(100vh - 150px);
        min-height:620px;
      }
    }
  </style>
</head>
<body>

<header>
  <div class="tabs" role="tablist" aria-label="Outils admin">
    <button class="tab" role="tab" id="tab-monitor" aria-controls="panel-monitor" aria-selected="true" data-target="monitor">Monitor</button>
    <button class="tab" role="tab" id="tab-pub" aria-controls="panel-pub" aria-selected="false" data-target="pub">Pub</button>
  </div>
</header>

<div class="panelWrap">
  <section class="panel active" id="panel-monitor" role="tabpanel" aria-labelledby="tab-monitor">
    <iframe class="frame" title="Monitor" data-src="https://mes-formulaires.onrender.com/monitor?token=DsG_Monitor_2026!"></iframe>
  </section>

  <section class="panel" id="panel-pub" role="tabpanel" aria-labelledby="tab-pub">
    <div class="pubWrap">
      <div class="pubTrack" id="pub-track"></div>
    </div>
  </section>
</div>

<script>
  const tabs = Array.from(document.querySelectorAll(".tab"));
  const panels = {
    monitor: document.getElementById("panel-monitor"),
    pub: document.getElementById("panel-pub"),
  };

  function ensureIframeLoaded(panel){
    const iframe = panel.querySelector("iframe[data-src]");
    if(!iframe) return;
    if(!iframe.src){
      iframe.src = iframe.dataset.src;
    }
  }

  function setActive(key, pushHash=true){
    tabs.forEach(t => {
      const on = (t.dataset.target === key);
      t.setAttribute("aria-selected", on ? "true" : "false");
    });

    Object.entries(panels).forEach(([k, p]) => {
      const on = (k === key);
      p.classList.toggle("active", on);
      if(on) ensureIframeLoaded(p);
    });

    if(pushHash){
      location.hash = key;
    }
  }

  document.querySelector(".tabs").addEventListener("click", (e) => {
    const btn = e.target.closest(".tab");
    if(!btn) return;
    setActive(btn.dataset.target, true);
  });

  const initial = (location.hash || "#monitor").replace("#", "");
  if(panels[initial]){
    setActive(initial, false);
  }else{
    ensureIframeLoaded(panels.monitor);
  }

  const images = [
    "/images/image1.jpeg",
    "/images/image2.jpeg",
    "/images/image3.jpeg",
  ];

  const track = document.getElementById("pub-track");
  images.forEach((src) => {
    const slide = document.createElement("div");
    slide.className = "pubSlide";
    slide.style.backgroundImage = `url('${src}')`;
    track.appendChild(slide);
  });

  let index = 0;
  function advance(){
    if (!track || images.length === 0) return;
    index = (index + 1) % images.length;
    track.style.transform = `translateX(-${index * 100}%)`;
  }

  if (images.length > 1) {
    setInterval(advance, 30000);
  }

  function getMonitorToken(){
    const frame = document.querySelector("#panel-monitor iframe");
    if (!frame) return "";
    const src = frame.dataset.src || frame.src || "";
    try {
      const url = new URL(src, window.location.origin);
      return url.searchParams.get("token") || "";
    } catch {
      return "";
    }
  }

  function startMonitorAlertWatcher(){
    const token = getMonitorToken();
    if (!token) return;
    const streamUrl = `/monitor/stream?token=${encodeURIComponent(token)}`;
    const source = new EventSource(streamUrl);

    source.addEventListener("log", (event) => {
      try {
        const entry = JSON.parse(event.data || "{}");
        const level = String(entry.level || "").toLowerCase();
        if (level === "warn" || level === "error") {
          setActive("monitor", true);
        }
      } catch {
        // Ignore malformed entries.
      }
    });

    source.addEventListener("error", () => {
      // Ignore stream errors; monitor tab remains available.
    });
  }

  startMonitorAlertWatcher();\n</script>\n</body>
</html>


