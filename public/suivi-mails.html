<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Suivi des envois e-mail</title>
  <style>
    :root{
      --primary:#004080;
      --accent:#00a7e1;
      --bg:#f5f9fc;
      --card:#ffffff;
      --text:#073763;
      --muted:#47607a;
      --shadow:0 8px 26px rgba(0,0,0,0.08);
      --radius:16px;
      --border:#d3dbe6;
      --thead:#eef5ff;
      --ok:#16a34a;
      --bad:#b00020;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      background:var(--bg);
      color:var(--text);
      font-family:"Montserrat",system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    }
    header{
      background:var(--card);
      box-shadow:var(--shadow);
      padding:18px 22px;
      position:sticky;
      top:0;
      z-index:10;
    }
    .wrap{max-width:1200px;margin:0 auto}
    h1{margin:0 0 8px;font-size:1.6rem;color:var(--primary)}
    p.sub{margin:0;color:var(--muted)}
    main.wrap{padding:18px 22px 40px}

    .toolbar{
      display:flex;flex-wrap:wrap;gap:10px;
      align-items:end;margin:18px 0;
    }
    .field{
      display:flex;flex-direction:column;gap:6px;
      min-width:180px;
    }
    .field label{font-size:.92rem;color:var(--muted)}
    input, select, button{
      padding:10px 12px;
      border-radius:10px;
      border:1px solid var(--border);
      background:#fff;
      font-size:0.95rem;
      outline:none;
    }
    input:focus, select:focus{border-color:var(--accent)}
    button{
      cursor:pointer;
      border:0;
      background:var(--primary);
      color:#fff;
      font-weight:700;
      box-shadow:var(--shadow);
    }
    button.secondary{
      background:#6b7280;
      box-shadow:none;
    }

    .grid{
      display:grid;
      grid-template-columns:repeat(3,1fr);
      gap:16px;
      margin:14px 0 18px;
    }
    @media(max-width:900px){.grid{grid-template-columns:1fr}}
    .card{
      background:var(--card);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:18px;
    }
    .label{font-size:.95rem;color:var(--muted)}
    .value{font-size:2.2rem;font-weight:800;margin-top:6px;color:var(--primary)}
    .hint{color:var(--muted);font-size:.92rem;margin-top:8px}

    table{
      width:100%;
      border-collapse:collapse;
      background:var(--card);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    thead{background:var(--thead)}
    th, td{
      padding:12px 14px;
      text-align:left;
      border-bottom:1px solid #eef0f4;
      vertical-align:top;
      font-size:.95rem;
    }
    th{font-weight:800;color:var(--primary)}
    .ok{color:var(--ok);font-weight:800}
    .bad{color:var(--bad);font-weight:800}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;font-size:.9rem}
    .chip{
      display:inline-block;
      padding:4px 10px;
      border-radius:999px;
      background:#eaf6ff;
      color:var(--primary);
      font-size:.85rem;
      margin-left:8px;
      font-weight:700;
    }
    .rowline{
      display:flex;gap:10px;flex-wrap:wrap;align-items:center;
      margin-top:10px;
    }
    .checkbox{
      display:flex;align-items:center;gap:8px;
      color:var(--muted);font-size:.92rem;
    }
  </style>
</head>

<body>

<main class="wrap">
  <div class="toolbar">
    <div class="field" style="min-width:280px;">
      <label for="token">Token admin</label>
      <input id="token" type="password" placeholder="ADMIN_TOKEN (Render)">
      <div class="rowline">
        <label class="checkbox">
          <input id="remember" type="checkbox">
          Mémoriser ce token sur ce navigateur
        </label>
        <button class="secondary" type="button" onclick="clearToken()">Effacer token</button>
      </div>
    </div>

    <div class="field" style="min-width:140px;">
      <label for="limit">Limite</label>
      <input id="limit" type="number" value="200" min="1" max="1000">
    </div>

    <div class="field">
      <label for="formType">Formulaire</label>
      <select id="formType">
        <option value="">Tous</option>
        <option value="ramasse">Ramasse</option>
        <option value="creation-reference-vl">Création réf. VL</option>
        <option value="creation-reference-pl">Création réf. PL</option>
        <option value="creation-pneu-vl">Création pneu VL</option>
      </select>
    </div>

    <div class="field">
      <label for="status">Statut</label>
      <select id="status">
        <option value="">Tous</option>
        <option value="sent">sent</option>
        <option value="failed">failed</option>
      </select>
    </div>

    <div class="field" style="min-width:220px;">
      <label for="to">Destinataire contient</label>
      <input id="to" placeholder="ex: @durand.fr">
    </div>

    <div class="field" style="min-width:220px;">
      <label for="subject">Objet contient</label>
      <input id="subject" placeholder="ex: Demande de ramasse">
    </div>

    <div class="field" style="min-width:170px;">
      <label for="dateFrom">Date du</label>
      <input id="dateFrom" type="date">
    </div>

    <div class="field" style="min-width:170px;">
      <label for="dateTo">Date au</label>
      <input id="dateTo" type="date">
    </div>

    <div class="field" style="min-width:260px;">
      <label for="q">Recherche globale</label>
      <input id="q" placeholder="email, objet, formulaire, statut, meta…">
    </div>

    <div class="field" style="min-width:160px;">
      <label>&nbsp;</label>
      <button type="button" onclick="loadLogs()">Rafraîchir</button>
    </div>
  </div>

  <section class="grid">
    <div class="card">
      <div class="label">Envois affichés</div>
      <div class="value" id="k_count">0</div>
      <div class="hint" id="k_info">—</div>
    </div>
    <div class="card">
      <div class="label">OK (sent)</div>
      <div class="value" id="k_sent">0</div>
      <div class="hint">sur la liste filtrée</div>
    </div>
    <div class="card">
      <div class="label">Échecs (failed)</div>
      <div class="value" id="k_failed">0</div>
      <div class="hint">sur la liste filtrée</div>
    </div>
  </section>

  <div style="overflow-x:auto;">
    <table>
      <thead>
        <tr>
          <th style="min-width:160px;">Date</th>
          <th style="min-width:260px;">Destinataire</th>
          <th style="min-width:260px;">Objet</th>
          <th style="min-width:190px;">Formulaire</th>
          <th style="min-width:110px;">Statut</th>
          <th>Erreur</th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>
  </div>

</main>

<script>
const TOKEN_KEY = "MAILLOG_ADMIN_TOKEN_v1";

function escapeHtml(s){
  return String(s ?? "").replace(/[&<>"']/g, c => ({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
  }[c]));
}

function parseISO(ts){
  const d = new Date(ts);
  return isNaN(d) ? null : d;
}

function fmtFR(ts){
  const d = parseISO(ts);
  return d ? d.toLocaleString("fr-FR") : (ts || "");
}

function readToken(){
  const saved = localStorage.getItem(TOKEN_KEY) || "";
  if (saved) {
    document.getElementById("token").value = saved;
    document.getElementById("remember").checked = true;
  }
}

function persistToken(){
  const remember = document.getElementById("remember").checked;
  const token = document.getElementById("token").value.trim();
  if (remember && token) localStorage.setItem(TOKEN_KEY, token);
  else localStorage.removeItem(TOKEN_KEY);
}

function clearToken(){
  localStorage.removeItem(TOKEN_KEY);
  document.getElementById("token").value = "";
  document.getElementById("remember").checked = false;
}

function buildServerQuery() {

  const limit = encodeURIComponent(document.getElementById("limit").value.trim() || "200");
  const q = encodeURIComponent(document.getElementById("q").value.trim());
  return `/api/mail-logs?limit=${limit}&q=${q}`;
}

function applyClientFilters(rows){
  const fForm = document.getElementById("formType").value.trim();
  const fStatus = document.getElementById("status").value.trim();
  const fTo = document.getElementById("to").value.trim().toLowerCase();
  const fSub = document.getElementById("subject").value.trim().toLowerCase();

  const df = document.getElementById("dateFrom").value;
  const dt = document.getElementById("dateTo").value;

  const dateFrom = df ? new Date(df + "T00:00:00") : null;
  const dateTo   = dt ? new Date(dt + "T23:59:59") : null;

  return rows.filter(x => {
    if (fForm && String(x.formType || "") !== fForm) return false;
    if (fStatus && String(x.status || "") !== fStatus) return false;

    if (fTo) {
      const to = String(x.to || "").toLowerCase();
      if (!to.includes(fTo)) return false;
    }

    if (fSub) {
      const sub = String(x.subject || "").toLowerCase();
      if (!sub.includes(fSub)) return false;
    }

    if (dateFrom || dateTo) {
      const d = parseISO(x.ts);
      if (!d) return false;
      if (dateFrom && d < dateFrom) return false;
      if (dateTo && d > dateTo) return false;
    }

    return true;
  });
}

function render(rows){
  const tbody = document.getElementById("tbody");
  tbody.innerHTML = "";

  let sent = 0, failed = 0;

  for (const x of rows){
    if (x.status === "sent") sent++;
    if (x.status === "failed") failed++;

    const tr = document.createElement("tr");
    const cls = x.status === "sent" ? "ok" : (x.status === "failed" ? "bad" : "");
    tr.innerHTML = `
      <td>${escapeHtml(fmtFR(x.ts))}</td>
      <td>${escapeHtml(x.to || "")}</td>
      <td>${escapeHtml(x.subject || "")}</td>
      <td>${escapeHtml(x.formType || "")}</td>
      <td class="${cls}">${escapeHtml(x.status || "")}</td>
      <td>${escapeHtml(x.error || "")}</td>
    `;
    tbody.appendChild(tr);
  }

  document.getElementById("k_count").textContent = String(rows.length);
  document.getElementById("k_sent").textContent = String(sent);
  document.getElementById("k_failed").textContent = String(failed);
  document.getElementById("k_info").textContent = rows.length ? "OK" : "Aucun résultat (avec les filtres actuels)";
}

async function loadLogs(){
  persistToken();

  const token = document.getElementById("token").value.trim();
  const url = buildServerQuery();

  document.getElementById("k_info").textContent = "Chargement…";
  document.getElementById("tbody").innerHTML = "";

  const res = await fetch(url, {
    cache: "no-store",
    headers: { "x-admin-token": token }
  });

  if(!res.ok){
    const t = await res.text().catch(()=> "");
    document.getElementById("k_info").textContent = "Erreur API / accès refusé : " + t;
    render([]);
    return;
  }

  const data = await res.json();
  const rows = Array.isArray(data) ? data : (data.logs || []);
  const filtered = applyClientFilters(rows);
  render(filtered);
}

readToken();

["formType","status","to","subject","dateFrom","dateTo"].forEach(id => {
  const el = document.getElementById(id);
  if (!el) return;
  el.addEventListener("change", () => loadLogs());
});
document.getElementById("q").addEventListener("keydown", (e) => {
  if (e.key === "Enter") loadLogs();
});
document.getElementById("remember").addEventListener("change", persistToken);
</script>

</body>
</html>
