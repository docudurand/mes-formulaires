<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <title>Demande de Jours de Congés</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
  <style>
    :root{ --bg:#f5f7fb; --card:#fff; --primary:#004080; --text:#073763; --muted:#6b7280; --border:#e5e7eb;
           --space:16px; --control-h:44px; }
    *, *::before, *::after { box-sizing:border-box; }
    html,body{ margin:0; padding:0; background:var(--bg);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial; color:var(--text); }
    .wrap{ max-width:520px; margin:0 auto; padding:16px; }
    .card{ background:var(--card); border:1px solid var(--border); border-radius:16px;
      box-shadow:0 6px 24px rgba(0,0,0,.06); padding:16px; }
    .logo{ text-align:center; margin-bottom:12px; }
    .logo img{ max-width:160px; height:auto; }
    h1{ font-size:1.35rem; margin:8px 0 20px; color:var(--primary); text-align:center; }
    .field{ margin-bottom:var(--space); } .field:last-child{ margin-bottom:0; }
    label{ display:block; font-weight:600; font-size:.95rem; margin-bottom:8px; }
    select,input,button{ width:100%; max-width:100%; min-width:0; padding:12px; border-radius:10px;
      border:1px solid var(--border); font-size:1rem; background:#fff; }
    input[type="date"]{ width:100%; min-height:var(--control-h); padding:10px; line-height:1.2;
      -webkit-appearance:none; appearance:none; background-color:#fff; }
    input:focus,select:focus{ outline:2px solid #cde4ff; border-color:#93c5fd; }
    .row{ display:grid; grid-template-columns:minmax(0,1fr) minmax(0,1fr); gap:16px; align-items:start; }
    .row>div{ min-width:0; }
    @media (max-width:480px){ .row{ grid-template-columns:1fr; gap:12px; } }
    .alert{ display:none; margin-top:10px; padding:10px; border-radius:10px }
    .ok{ background:#ecfeff; border:1px solid #a5f3fc; color:#0e7490 }
    .err{ background:#fef2f2; border:1px solid #fecaca; color:#991b1b }
    .desktop-gate{ display:none; text-align:center; padding:24px; }
    @media (min-width:821px){ .mobile-only{ display:none } .desktop-gate{ display:block } }
    .sig-wrap{border:1px solid var(--border);border-radius:10px;background:#fff;padding:8px;overflow:hidden;}
    .sig-canvas{width:100%;height:180px;display:block;touch-action:none;}
    .sig-actions{display:flex;justify-content:center;margin-top:8px;}
    .sig-actions button{width:auto;min-width:120px;padding:10px 20px;}
    .sig-wrap.invalid{border-color:#ef4444;box-shadow:0 0 0 3px rgba(239,68,68,.15);}
    .muted{ color:var(--muted); font-size:.9rem; margin-top:6px; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="desktop-gate">
      <h2>Accès mobile requis</h2>
      <p class="muted">Ce formulaire est consultable uniquement sur smartphone (QR code).</p>
    </div>

    <div class="mobile-only">
      <div class="card">
        <div class="logo">
          <img src="https://raw.githubusercontent.com/docudurand/mes-formulaires/main/logodurand.png" alt="Logo Durand Services">
        </div>
        <h1>Demande de Jours de Congés</h1>

<form id="formConges" novalidate>
  <div class="field">
    <label for="magasin">Magasin *</label>
    <select id="magasin" required>
      <option value="">-- Sélectionnez votre magasin --</option>
      <option>ANNEMASSE</option>
      <option>BOURGOIN</option>
      <option>CHASSE SUR RHONE</option>
      <option>CHASSIEU</option>
      <option>GLEIZE</option>
      <option>LA MOTTE SERVOLEX</option>
      <option>MIRIBEL</option>
      <option>PAVI</option>
      <option>RENAGE</option>
      <option>RIVES</option>
      <option>SAINT-MARTIN-D'HERES</option>
      <option>SEYNOD</option>
      <option>ST EGREVE</option>
      <option>ST-JEAN-BONNEFONDS</option>
    </select>
  </div>

  <div class="field">
    <label for="nom">Nom *</label>
    <input id="nom" type="text" placeholder="Ex: DUPONT" required autocomplete="family-name" />
  </div>
  <div class="field">
    <label for="prenom">Prénom *</label>
    <input id="prenom" type="text" placeholder="Ex: Marie" required autocomplete="given-name" />
  </div>

  <div class="field">
    <label for="email">Adresse e-mail du demandeur *</label>
    <input id="email" type="email" inputmode="email" placeholder="prenom.nom@entreprise.fr" required autocomplete="email" />
  </div>

  <div class="field">
    <label for="service">Service *</label>
    <select id="service" required>
      <option value="">-- Sélectionez votre service --</option>
      <option>Magasin V.L</option>
      <option>Magasin P.L</option>
      <option>Industrie</option>
      <option>Atelier V.L</option>
      <option>Atelier P.L</option>
      <option>Rectification</option>
      <option>Administratif</option>
      <option>Commercial</option>
      <option>Matériel</option>
    </select>
  </div>

  <div class="field">
    <div class="row">
      <div>
        <label for="dateDu">Du *</label>
        <input id="dateDu" type="date" required />
      </div>
      <div>
        <label for="dateAu">Au *</label>
        <input id="dateAu" type="date" required />
      </div>
    </div>
  </div>
  <div class="field">
    <label for="nbJours">Nombre de jours (calcul automatique) *</label>
    <input id="nbJours" type="number" inputmode="numeric" min="1" step="1" placeholder="Calculé à partir des dates" required readonly />
    <div id="nbHint" class="muted">Les samedis et dimanches ne sont pas comptés.</div>
  </div>

  <div class="field">
    <label>Signature électronique *</label>
    <div class="sig-wrap">
      <canvas id="signaturePad" class="sig-canvas"></canvas>
      <div class="sig-actions">
        <button type="button" id="clearSig">Effacer</button>
      </div>
    </div>
  </div>

  <button id="submitBtn" type="submit" style="margin-top:6px;background:var(--primary);color:#fff;border:0;">Envoyer la demande</button>

  <div id="ok" class="alert ok">✅ Demande envoyée. Merci !</div>
  <div id="err" class="alert err">❌ Impossible d'envoyer la demande. Réessayez.</div>
</form>
      </div>
    </div>
  </div>

<script>
(function gate(){
  const wide = window.matchMedia("(min-width: 821px)").matches;
  document.querySelector(".mobile-only").style.display = wide ? "none" : "block";
  document.querySelector(".desktop-gate").style.display = wide ? "block" : "none";
})();

const canvas = document.getElementById('signaturePad');
const ctx = canvas.getContext('2d');
let drawing = false, strokes = [], currentStroke = [];
function resizeCanvas(){
  const data = canvas.toDataURL();
  const img = new Image();
  img.onload = () => {
    canvas.width = canvas.clientWidth;
    canvas.height = canvas.clientHeight;
    ctx.fillStyle = '#fff';
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
  };
  img.src = data;
}
canvas.width = canvas.clientWidth;
canvas.height = canvas.clientHeight;
ctx.lineWidth = 2; ctx.lineCap = 'round'; ctx.strokeStyle = '#111'; ctx.fillStyle = '#fff';
ctx.fillRect(0, 0, canvas.width, canvas.height);
window.addEventListener('resize', resizeCanvas);
function pos(e){ const r=canvas.getBoundingClientRect(); const t=e.touches&&e.touches[0];
  return { x:(t?t.clientX:e.clientX)-r.left, y:(t?t.clientY:e.clientY)-r.top }; }
function start(e){ e.preventDefault(); drawing=true; currentStroke=[pos(e)]; }
function move(e){ if(!drawing) return; const p=pos(e); const lp=currentStroke[currentStroke.length-1];
  ctx.beginPath(); ctx.moveTo(lp.x, lp.y); ctx.lineTo(p.x, p.y); ctx.stroke(); currentStroke.push(p); }
function end(){ if(!drawing) return; drawing=false; if(currentStroke.length>0) strokes.push(currentStroke); }
canvas.addEventListener('mousedown', start); canvas.addEventListener('mousemove', move);
canvas.addEventListener('mouseup', end); canvas.addEventListener('mouseleave', end);
canvas.addEventListener('touchstart', start, { passive:false }); canvas.addEventListener('touchmove', move, { passive:false });
canvas.addEventListener('touchend', end);
document.getElementById('clearSig').onclick = () => { strokes=[]; ctx.fillStyle='#fff'; ctx.fillRect(0,0,canvas.width,canvas.height); };

const $dateDu = document.getElementById('dateDu');
const $dateAu = document.getElementById('dateAu');
const $nb     = document.getElementById('nbJours');
const $nbHint = document.getElementById('nbHint');

function businessDaysInclusive(duStr, auStr){
  if(!duStr || !auStr) return 0;
  const du = new Date(duStr+"T00:00:00");
  const au = new Date(auStr+"T00:00:00");
  if(isNaN(du) || isNaN(au) || au < du) return 0;
  let n = 0, d = new Date(du);
  while(d <= au){
    const day = d.getDay();
    if(day !== 0 && day !== 6) n++;
    d.setDate(d.getDate()+1);
  }
  return n;
}
function updateNb(){
  const n = businessDaysInclusive($dateDu.value, $dateAu.value);
  $nb.value = n ? String(n) : "";
  $nbHint.textContent = n ? `Les samedis et dimanches ne sont pas comptés. → ${n} jour(s)` : `Les samedis et dimanches ne sont pas comptés.`;
}
$dateDu.addEventListener('change', updateNb);
$dateAu.addEventListener('change', updateNb);

const form = document.getElementById("formConges");
const btn  = document.getElementById("submitBtn");
const ok   = document.getElementById("ok");
const err  = document.getElementById("err");

form.addEventListener("submit", async (e) => {
  e.preventDefault(); ok.style.display="none"; err.style.display="none";

  updateNb();

  const magasin = document.getElementById("magasin").value.trim();
  const nom     = document.getElementById("nom").value.trim();
  const prenom  = document.getElementById("prenom").value.trim();
  const service = document.getElementById("service").value.trim();
  const nbJours = document.getElementById("nbJours").value.trim();
  const dateDu  = document.getElementById("dateDu").value;
  const dateAu  = document.getElementById("dateAu").value;
  const email   = document.getElementById("email").value.trim();

  if (!magasin || !nom || !prenom || !service || !nbJours || !dateDu || !dateAu || !email) {
    return showErr("Merci de remplir tous les champs obligatoires.");
  }
  if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) return showErr("Adresse e-mail invalide.");
  const n = Number(nbJours); if (!Number.isFinite(n) || n <= 0) return showErr("La période choisie ne contient aucun jour ouvré.");
  if (new Date(dateAu) < new Date(dateDu)) return showErr("La date 'Au' doit être ≥ 'Du'.");
  if (strokes.length === 0) {
    const sig = document.querySelector('.sig-wrap'); sig.classList.add('invalid'); sig.setAttribute('aria-invalid','true');
    return showErr("Merci de signer.");
  }
  const sigWrap = document.querySelector('.sig-wrap'); sigWrap.classList.remove('invalid'); sigWrap.removeAttribute('aria-invalid');

  const signatureData = canvas.toDataURL("image/png");

  btn.disabled = true; btn.textContent = "Envoi…";
  try {
    const res = await fetch("/conges/api", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ magasin, nom, prenom, service, nbJours: n, dateDu, dateAu, email, signatureData })
    });
    const data = await res.json().catch(() => ({}));
    if (res.ok && data.ok) {
      ok.style.display = "block"; err.style.display = "none";
      form.reset(); document.getElementById('clearSig').click(); updateNb();
    } else {
      showErr("Envoi impossible. Vérifiez vos infos et réessayez.");
    }
  } catch (e2) {
    showErr("Erreur réseau. Réessayez.");
  } finally {
    btn.disabled = false; btn.textContent = "Envoyer la demande";
  }
});

function showErr(msg){ err.textContent = "❌ " + msg; err.style.display = "block"; ok.style.display = "none"; }
</script>
</body>
</html>