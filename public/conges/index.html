<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <title>Demande de Jours de Congés</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
  <style>
    :root{
      --bg:#f5f7fb; --card:#fff; --primary:#004080; --text:#073763; --muted:#6b7280; --border:#e5e7eb;
      --space:16px; --control-h:44px;
    }
    *, *::before, *::after { box-sizing:border-box; }
    html,body{margin:0;padding:0;background:var(--bg);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;color:var(--text);}
    .wrap{max-width:520px;margin:0 auto;padding:16px;}
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;
      box-shadow:0 6px 24px rgba(0,0,0,.06);padding:16px;}
    .logo{text-align:center;margin-bottom:12px;}
    .logo img{max-width:160px;height:auto;}
    h1{font-size:1.35rem;margin:8px 0 20px;color:var(--primary);text-align:center;}
    .field{margin-bottom:var(--space);} .field:last-child{margin-bottom:0;}
    label{display:block;font-weight:600;font-size:.95rem;margin-bottom:8px;}
    select,input,button{width:100%;max-width:100%;min-width:0;padding:12px;border-radius:10px;
      border:1px solid var(--border);font-size:1rem;background:#fff;}
    input[type="date"]{width:100%;min-height:var(--control-h);padding:10px;line-height:1.2;
      -webkit-appearance:none;appearance:none;background-color:#fff;}
    input:focus,select:focus{outline:2px solid #cde4ff;border-color:#93c5fd;}
    .row{display:grid;grid-template-columns:minmax(0,1fr) minmax(0,1fr);gap:16px;align-items:start;}
    .row>div{min-width:0;}
    @media (max-width:480px){.row{grid-template-columns:1fr;gap:12px;}}
    .alert{display:none;margin-top:10px;padding:10px;border-radius:10px}
    .ok{background:#ecfeff;border:1px solid #a5f3fc;color:#0e7490}
    .err{background:#fef2f2;border:1px solid #fecaca;color:#991b1b}
    .desktop-gate{display:none;text-align:center;padding:24px;}
    @media (min-width:821px){.mobile-only{display:none}.desktop-gate{display:block}}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="desktop-gate">
      <h2>Accès mobile requis</h2>
      <p class="muted">Ce formulaire est consultable uniquement sur smartphone (QR code).</p>
    </div>

    <div class="mobile-only">
      <div class="card">

        <div class="logo">
          <img src="https://raw.githubusercontent.com/docudurand/mes-formulaires/main/logodurand.png" alt="Logo Durand Services">
        </div>

        <h1>Demande de Jours de Congés</h1>

        <form id="formConges" novalidate>
          <div class="field">
            <label for="magasin">Magasin *</label>
            <select id="magasin" required>
              <option value="">-- Sélectionnez votre magasin --</option>
              <option>Gleizé</option>
              <option>Miribel</option>
              <option>Villefranche-sur-Saône</option>
              <option>Bourg-en-Bresse</option>
              <option>Mâcon</option>
            </select>
          </div>

          <div class="field">
            <label for="nomPrenom">Nom & Prénom *</label>
            <input id="nomPrenom" type="text" placeholder="Ex: Dupont Marie" required autocomplete="name" />
          </div>

          <div class="field">
            <label for="service">Service *</label>
            <select id="service" required>
              <option value="">-- Sélectionnez votre service --</option>
              <option>Magasin V.L</option>
              <option>Magasin P.L</option>
              <option>Industrie</option>
              <option>Atelier V.L</option>
              <option>Atelier P.L</option>
              <option>Rectification</option>
              <option>Administratif</option>
              <option>Commercial</option>
              <option>Matériel</option>
            </select>
          </div>

          <div class="field">
            <label for="nbJours">Demande de pouvoir bénéficier de … jours de congés *</label>
            <input id="nbJours" type="number" inputmode="numeric" min="1" step="1" placeholder="Nombre de jours" required />
          </div>

          <div class="field">
            <div class="row">
              <div>
                <label for="dateDu">Du *</label>
                <input id="dateDu" type="date" required />
              </div>
              <div>
                <label for="dateAu">Au *</label>
                <input id="dateAu" type="date" required />
              </div>
            </div>
          </div>

          <div class="field">
            <label for="email">Adresse e-mail du demandeur *</label>
            <input id="email" type="email" inputmode="email" placeholder="prenom.nom@entreprise.fr" required autocomplete="email" />
          </div>

          <button id="submitBtn" type="submit" style="margin-top:6px;background:var(--primary);color:#fff;border:0;">Envoyer la demande</button>

          <div id="ok" class="alert ok">✅ Demande envoyée. Merci !</div>
          <div id="err" class="alert err">❌ Impossible d'envoyer la demande. Réessayez.</div>
        </form>
      </div>
    </div>
  </div>

  <script>
    (function gate(){
      const wide = window.matchMedia("(min-width: 821px)").matches;
      document.querySelector(".mobile-only").style.display = wide ? "none" : "block";
      document.querySelector(".desktop-gate").style.display = wide ? "block" : "none";
    })();

    const form = document.getElementById("formConges");
    const btn  = document.getElementById("submitBtn");
    const ok   = document.getElementById("ok");
    const err  = document.getElementById("err");

    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      ok.style.display = "none"; err.style.display = "none";

      const magasin   = document.getElementById("magasin").value.trim();
      const nomPrenom = document.getElementById("nomPrenom").value.trim();
      const service   = document.getElementById("service").value.trim();
      const nbJours   = document.getElementById("nbJours").value.trim();
      const dateDu    = document.getElementById("dateDu").value;
      const dateAu    = document.getElementById("dateAu").value;
      const email     = document.getElementById("email").value.trim();

      if (!magasin || !nomPrenom || !service || !nbJours || !dateDu || !dateAu || !email) {
        showErr("Merci de remplir tous les champs obligatoires."); return;
      }
      if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) { showErr("Adresse e-mail invalide."); return; }
      const n = Number(nbJours);
      if (!Number.isFinite(n) || n <= 0) { showErr("Le nombre de jours doit être > 0."); return; }
      if (new Date(dateAu) < new Date(dateDu)) { showErr("La date 'Au' doit être ≥ 'Du'."); return; }

      btn.disabled = true; btn.textContent = "Envoi…";
      try {
        const res = await fetch("/conges/api", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ magasin, nomPrenom, service, nbJours: n, dateDu, dateAu, email })
        });
        const data = await res.json().catch(() => ({}));
        if (res.ok && data.ok) { ok.style.display = "block"; err.style.display = "none"; form.reset(); }
        else { showErr("Envoi impossible. Vérifiez vos infos et réessayez."); }
      } catch (e) {
        showErr("Erreur réseau. Réessayez.");
      } finally {
        btn.disabled = false; btn.textContent = "Envoyer la demande";
      }
    });

    function showErr(msg){
      err.textContent = "❌ " + msg;
      err.style.display = "block";
      ok.style.display = "none";
    }
  </script>
</body>
</html>