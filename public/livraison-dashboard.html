<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Livraison ‚Äì Tableau de bord</title>
  <meta name="theme-color" content="#003c8f">
  <style>
    html,body{height:100%;overflow:hidden}
    body{font-family:system-ui,-apple-system,Segoe UI,sans-serif;margin:0;background:#f6f7fb}
    .wrap{width:min(98vw,1900px);max-width:1900px;margin:0 auto;padding:16px;height:100vh;box-sizing:border-box;overflow:hidden}
    .card{background:#fff;border-radius:16px;box-shadow:0 2px 10px rgba(0,0,0,.06);padding:16px}
    .pageCard{height:100%;display:flex;flex-direction:column;overflow:hidden}
    .viewArea{flex:1;min-height:0;overflow:hidden}
    .panel{display:flex;flex-direction:column;min-height:0;overflow:hidden}
    .fillRow{flex:1;min-height:0;align-items:stretch}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .top{display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap}
    h1{font-size:18px;margin:0}
    .muted{color:#666;font-size:13px}
    .pill{padding:6px 10px;border-radius:999px;font-size:13px;font-weight:700;display:inline-flex;gap:6px;align-items:center}
    .p-att{background:#fff7ed;color:#9a3412}
    .p-val{background:#ecfeff;color:#155e75}
    .p-liv{background:#ecfdf5;color:#166534}
    .p-cls{background:#f3f4f6;color:#111827}
    .btn{border:0;border-radius:12px;padding:10px 12px;font-weight:800;cursor:pointer}
    .btn-ghost{background:#fff;border:1px solid #dbeafe;color:#1d4ed8}
    select{width:100%;box-sizing:border-box;border:1px solid #d1d5db;border-radius:12px;padding:10px;font-size:14px;background:#fff}
    .tabs{display:flex;gap:8px;flex-wrap:wrap}
    .tab{padding:8px 12px;border-radius:999px;border:1px solid #dbeafe;background:#fff;cursor:pointer;font-weight:800}
    .tab.active{background:#2563eb;color:#fff;border-color:#2563eb}
    .sep{height:10px}
    .list{display:flex;flex-direction:column;gap:10px;flex:1;min-height:0;overflow:auto;overscroll-behavior:contain;scrollbar-gutter:stable}
    .item{display:flex;justify-content:space-between;gap:10px;align-items:center;padding:10px 12px;border-radius:12px;background:#fff;border:1px solid #eef2ff}
    .item.active{border-color:#2563eb;box-shadow:0 0 0 2px rgba(37,99,235,.15)}
    .small{font-size:12px;color:#6b7280}
    .cols{display:grid;grid-template-columns:repeat(3,minmax(320px,1fr));gap:14px;flex:1;min-height:0;height:100%}
    @media(max-width:1100px){.cols{grid-template-columns:1fr}}
    .box{border:1px solid #eef2ff;border-radius:12px;padding:10px;background:#fbfdff;display:flex;flex-direction:column;min-height:0;height:100%}
    .box h2{margin:0 0 8px;font-size:15px}
    .badge{display:inline-flex;align-items:center;gap:6px;padding:4px 8px;border-radius:999px;font-size:12px;font-weight:800;background:#f3f4f6;color:#111827}

    .group{border:1px solid #eef2ff;border-radius:12px;background:#fff;overflow:hidden}
    .groupHeader{display:flex;justify-content:space-between;align-items:center;gap:10px;padding:10px 12px;background:#f8fafc;border-bottom:1px solid #eef2ff;position:sticky;top:0;z-index:2}
    .groupHeader .title{font-weight:900;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .groupBody{display:flex;flex-direction:column;gap:10px;padding:10px 12px}
    .groupCount{font-size:12px;font-weight:900;background:#eef2ff;color:#1f2937;border-radius:999px;padding:4px 8px;white-space:nowrap}

    .iconBtn{border:0;background:#fff;border:1px solid #e5e7eb;border-radius:10px;padding:6px 8px;cursor:pointer;font-size:16px;line-height:1}
    .iconBtn:active{transform:scale(.98)}
    .iconBtn.ok{border-color:#bbf7d0}
    .iconBtn.box{border-color:#bfdbfe}
    .iconBtn:disabled{opacity:.45;cursor:not-allowed}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card pageCard">
      <div class="top">
        <div>
          <h1>Livraison ‚Äì Tableau de bord magasin</h1>
          <div class="muted" id="sub">Choisis une agence.</div>
        </div>
        <div class="row" style="align-items:center">
          <select id="magasinSelect" style="min-width:220px;max-width:320px">
            <option value="">‚Äî Choisir un magasin ‚Äî</option>
          </select>
          <button class="btn btn-ghost" id="btnClear">Tout afficher</button>
        </div>
      </div>

      <div class="sep"></div>

      <div class="tabs">
        <button class="tab active" data-view="encours">En cours</button>
        <button class="tab" data-view="classes">Class√©s</button>
      </div>

      <div class="sep"></div>

      <div class="row" id="globalCounters"></div>

      <div class="sep"></div>

      <div class="viewArea" id="viewArea">

      <div id="encoursView" style="display:flex;flex-direction:column;flex:1;min-height:0;overflow:hidden">
        <div class="row fillRow" style="align-items:stretch">
          <div class="card panel" style="flex:1;min-width:260px">
            <div style="display:flex;justify-content:space-between;align-items:center;gap:10px">
              <h2 style="margin:0;font-size:15px">Tourn√©es en cours</h2>
              <span class="badge" id="autoInfo"></span>
            </div>
            <div class="muted">Clique une tourn√©e pour voir le d√©tail.</div>
            <div class="sep"></div>
            <div id="tourneesActives" class="list"></div>
          </div>

          <div class="card panel" style="flex:2;min-width:280px">
            <h2 style="margin:0 0 6px 0;font-size:15px">D√©tail tourn√©e</h2>
            <div class="muted" id="detailTitle">Aucune tourn√©e s√©lectionn√©e (affichage global).</div>
            <div class="sep"></div>

            <div class="cols">
              <div class="box">
                <h2><span class="pill p-att">En attente</span></h2>
                <div class="list" id="listAtt"></div>
              </div>
              <div class="box">
                <h2><span class="pill p-val">Valid√©s</span></h2>
                <div class="list" id="listVal"></div>
              </div>
              <div class="box">
                <h2><span class="pill p-liv">Livr√©s</span></h2>
                <div class="list" id="listLiv"></div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div id="classesView" style="display:none;flex-direction:column;flex:1;min-height:0;overflow:hidden">
        <div class="card panel">
          <h2 style="margin:0 0 6px 0;font-size:15px">Tourn√©es class√©es</h2>
          <div class="muted"></div>
          <div class="sep"></div>
          <div id="tourneesClassees" class="list"></div>
        </div>
      </div>

      </div>

    </div>
  </div>

<script>
const API_BASE = "https://mes-formulaires.onrender.com";
  const apiUrl = (u) => (String(u).startsWith("http") ? u : (API_BASE + u));

  const qs = new URLSearchParams(location.search);

  const magasinSelect = document.getElementById("magasinSelect");
  const btnClear = document.getElementById("btnClear");

  const subEl = document.getElementById("sub");
  const globalCounters = document.getElementById("globalCounters");

  const tourneesActivesEl = document.getElementById("tourneesActives");
  const tourneesClasseesEl = document.getElementById("tourneesClassees");

  const detailTitle = document.getElementById("detailTitle");
  const listAtt = document.getElementById("listAtt");
  const listVal = document.getElementById("listVal");
  const listLiv = document.getElementById("listLiv");

  let magasin = "";
  let currentView = "encours";
  let state = { tournees: [], colis: [] };
  let selectedTourneeId = "";
  let expandedClassees = new Set();
  let refreshTimer = null;
  let paramsCache = [];
  let livreurTourneeMap = new Map();

  window.addEventListener("unhandledrejection", (e)=>{ console.error("[Dashboard] unhandledrejection", e.reason); });
  window.addEventListener("error", (e)=>{ console.error("[Dashboard] error", e.error || e.message); });

  function escapeHtml(s){
    return String(s || "").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  }


  function normStatut(st){
    const s = String(st||"").trim().toUpperCase();
    if (s === "EN ATTENTE") return "EN_ATTENTE";
    if (s === "EN_ATTENTE") return "EN_ATTENTE";
    if (s.startsWith("EN_")) return s;
    if (s.startsWith("VAL")) return "VALIDE";
    if (s.startsWith("LIVR")) return "LIVRE";
    if (s.startsWith("CLAS")) return "CLASSEE";
    return s.replace(/\s+/g,"_");
  }
  function buildLivreurTourneeMap(){
    livreurTourneeMap = new Map();
    if (!magasin || !Array.isArray(paramsCache)) return;

    const magKey = String(magasin||"").trim().toUpperCase();

    paramsCache.forEach(r => {
      if (!r) return;
      const codeAg = String(r.codeAgence || "").trim().toUpperCase();
      const ag = String(r.agence || "").trim().toUpperCase();
      if (codeAg !== magKey && ag !== magKey) return;

      const nom = String(r.tournee || r.codeTournee || "").trim();
      if (!nom) return;

      const k1 = String(r.codeTransporteur || "").trim().toUpperCase();
      const k2 = String(r.transporteur || "").trim().toUpperCase();
      if (k1) livreurTourneeMap.set(k1, nom);
      if (k2) livreurTourneeMap.set(k2, nom);
    });
  }

  function formatLivreurTournee(livreurId) {
    const liv = String(livreurId || "").trim();
    return liv ? `Livreur: ${liv}` : "";
  }


  function pad2(n){ return String(n).padStart(2,"0"); }

  function formatMajHHMM(iso){
    if (!iso) return "";
    const d = new Date(iso);
    if (isNaN(d)) return "";
    return `${pad2(d.getHours())}:${pad2(d.getMinutes())}`;
  }

  function isSameLocalDay(a, b){
    return a.getFullYear()===b.getFullYear() && a.getMonth()===b.getMonth() && a.getDate()===b.getDate();
  }
  function isTodayIso(iso){
    if (!iso) return false;
    const d = new Date(iso);
    if (isNaN(d)) return false;
    return isSameLocalDay(d, new Date());
  }
  function isLivreToday(c){

    return isTodayIso(c.dateMaj) || isTodayIso(c.dateAjout);
  }

  function isLivreVisible(c){
    return (currentView === "encours") ? isLivreToday(c) : true;
  }

  function formatTourneeTitle(iso){
    const d = new Date(iso);
    if (isNaN(d)) return "";
    const jj = pad2(d.getDate());
    const mm = pad2(d.getMonth()+1);
    const aa = String(d.getFullYear()).slice(-2);
    const hh = pad2(d.getHours());
    const mn = pad2(d.getMinutes());
    return `${jj}/${mm}/${aa} ${hh}:${mn}`;
  }


  function shortExcerpt_(t, n=260){
    const s = String(t||"").replace(/\s+/g," ").trim();
    return s.length > n ? (s.slice(0,n) + "‚Ä¶") : s;
  }

  async function fetchJson_(url){
    let r;
    try{
      r = await fetch(url);
    }catch(e){
      throw new Error("Fetch impossible (r√©seau/CORS): " + (e && e.message ? e.message : e));
    }
    const ct = (r.headers.get("content-type") || "").toLowerCase();
    const text = await r.text().catch(()=> "");
    let j = null;
    if (ct.includes("application/json") || ct.includes("text/json")) {
      try{ j = JSON.parse(text || "{}"); }catch(e){  }
    } else {
      try{ j = JSON.parse(text || "{}"); }catch(e){  }
    }
    if (!r.ok) {
      const msg = (j && (j.error || j.message)) ? (j.error || j.message) : shortExcerpt_(text);
      throw new Error(`HTTP ${r.status} ${r.statusText} ‚Äî ${msg || "R√©ponse vide"}`);
    }
    if (!j) {
      throw new Error("R√©ponse non-JSON: " + shortExcerpt_(text));
    }
    return j;
  }

  function showLoadError_(context, err){
    const msg = (err && err.message) ? err.message : String(err||"Erreur inconnue");
    console.error("[Dashboard] " + context, err);
    subEl.textContent = `Erreur de chargement (${context}): ${msg}`;
  }


  async function apiPost(url, body) {
    const r = await fetch(apiUrl(url), {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(body || {})
    });
    const j = await r.json().catch(()=> ({}));
    if (!r.ok || j.success === false) throw new Error(j.error || "Erreur API");
    return j;
  }

  function openMapsFromColis(c) {
    const lat = Number(c.gpsLat);
    const lng = Number(c.gpsLng);
    if (!isFinite(lat) || !isFinite(lng)) {
      alert("Pas de coordonn√©es GPS pour ce colis.");
      return;
    }
    const url = `https://www.google.com/maps?q=${encodeURIComponent(lat + "," + lng)}&z=18`;
    window.open(url, "_blank", "noopener,noreferrer");
  }

  function mkMiniItem(text, right, actionsHtml) {
    const div = document.createElement("div");
    div.className = "item";
    div.innerHTML = `
      <div style="display:flex;align-items:center;gap:10px;min-width:0">
        <div style="min-width:0">
          <div style="font-weight:900;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${escapeHtml(text)}</div>
          ${right ? `<div class="small">${escapeHtml(right||"")}</div>` : ``}
        </div>
      </div>
      <div style="display:flex;align-items:center;gap:8px;flex-wrap:nowrap">
        ${actionsHtml || ``}
      </div>
    `;
    return div;
  }

  function setGlobalCounters(stats) {
    globalCounters.innerHTML = `
      <span class="pill p-att">En attente: <b>${stats.enAttente}</b></span>
      <span class="pill p-val">Valid√©s: <b>${stats.valides}</b></span>
      <span class="pill p-liv">Livr√©s: <b>${stats.livres}</b></span>
    `;
  }

  function computeStatsFor(filterFn) {
    const list = state.colis.filter(filterFn);
    let enAttente=0, valides=0, livres=0;
    for (const c of list) {
      const st = normStatut(c.statut);
      if (st==="EN_ATTENTE") enAttente++;
      else if (st==="VALIDE") valides++;
      else if (st==="LIVRE") { if (isLivreVisible(c)) livres++; }
    }
    return { enAttente, valides, livres };
  }

  function renderTournees() {
    tourneesActivesEl.innerHTML = "";
    const actives = state.tournees.filter(t => {
      const st = normStatut(t.statut);
      return st !== "CLASSEE";
    });

    if (!actives.length) {
      tourneesActivesEl.appendChild(mkMiniItem("Aucune tourn√©e en cours", ""));
    } else {
      actives.slice(0, 120).forEach(t => {
        const div = document.createElement("div");
        div.className = "item" + (t.tourneeId === selectedTourneeId ? " active" : "");
        div.innerHTML = `
          <div>
            <div style="font-weight:900;white-space:nowrap">${escapeHtml(formatTourneeTitle(t.dateCreation) || t.tourneeId)}</div>
            <div class="small">Total ${Number(t.total||0)}</div>
          </div>
          <div class="small" style="display:flex;gap:6px;flex-wrap:wrap;justify-content:flex-end">
            ${(() => {
              const tid = String(t.tourneeId);
              let a=0,v=0,l=0;
              for (const c of state.colis) {
                if (String(c.tourneeId)!==tid) continue;
                const st = normStatut(c.statut);
                if (st==="EN_ATTENTE") a++;
                else if (st==="VALIDE") v++;
                else if (st==="LIVRE" && isLivreToday(c)) l++;
              }
              return `
                <span class="pill p-att" style="padding:4px 8px;font-size:12px">Att ${a}</span>
                <span class="pill p-val" style="padding:4px 8px;font-size:12px">Val ${v}</span>
                <span class="pill p-liv" style="padding:4px 8px;font-size:12px">Liv ${l}</span>
              `;
            })()}
          </div>
        `;
        div.addEventListener("click", () => {
          selectedTourneeId = (selectedTourneeId === t.tourneeId) ? "" : t.tourneeId;
          renderDetail();
          renderTournees();
        });
        tourneesActivesEl.appendChild(div);
      });
    }

    tourneesClasseesEl.innerHTML = "";
    const classes = state.tournees.filter(t => normStatut(t.statut) === "CLASSEE");
    if (!classes.length) {
      tourneesClasseesEl.appendChild(mkMiniItem("Aucune tourn√©e class√©e", ""));
    } else {
      classes.slice(0, 200).forEach(t => {
        const tid = String(t.tourneeId);
        const isOpen = expandedClassees.has(tid);

        const div = document.createElement("div");
        div.className = "item";
        div.style.flexDirection = "column";
        div.style.alignItems = "stretch";

        const header = document.createElement("div");
        header.style.display = "flex";
        header.style.justifyContent = "space-between";
        header.style.alignItems = "center";
        header.style.gap = "10px";
        header.style.cursor = "pointer";

        header.innerHTML = `
          <div>
            <div style="font-weight:900;white-space:nowrap">${escapeHtml(formatTourneeTitle(t.dateCreation) || t.tourneeId)}</div>
            <div class="small">Total ${Number(t.total||0)}</div>
          </div>
          <div style="display:flex;align-items:center;gap:10px">
            <div class="pill p-cls" style="padding:6px 10px;font-size:12px">Class√©e</div>
            <div class="badge" style="background:#eef2ff">${isOpen ? "‚ñ≤" : "‚ñº"}</div>
          </div>
        `;

        const body = document.createElement("div");
        body.style.display = isOpen ? "" : "none";
        body.style.marginTop = "10px";

        const liv = state.colis.filter(c => String(c.tourneeId)===tid && normStatut(c.statut)==="LIVRE");
        if (!liv.length) {
          body.appendChild(mkMiniItem("Aucun colis", ""));
        } else {
          const list = document.createElement("div");
          list.className = "list";
          liv.slice(0, 800).forEach(c => {
            const rightBase = c.livreurId ? formatLivreurTournee(c.livreurId, c.tournee, c.codeTournee) : "";
            const lieu = String(c.gpsLieu || "").trim();
            const hhmm = formatMajHHMM(c.dateMaj) || "";
            let right = rightBase;
            if (lieu) right = right ? (right + " ‚Ä¢ üìç " + lieu) : ("üìç " + lieu);
            if (hhmm) right = right ? (right + " ‚Ä¢ ‚è± " + hhmm) : ("‚è± " + hhmm);
            const hasGps = isFinite(Number(c.gpsLat)) && isFinite(Number(c.gpsLng));
            const actionsHtml = `
              <button class="iconBtn" title="${hasGps ? "Suivi GPS (Google Maps)" : "Pas de GPS"}" data-act="suivi" data-bon="${escapeHtml(c.bon)}" data-tourneeid="${escapeHtml(tid)}" ${hasGps ? "" : "disabled"}>üìç</button>
              <button class="iconBtn" title="${hasGps ? "Nommer / modifier le client (rayon 30m)" : "Pas de GPS"}" data-act="nommer" data-bon="${escapeHtml(c.bon)}" data-tourneeid="${escapeHtml(tid)}" ${hasGps ? "" : "disabled"}>üè∑</button>
            `;
            list.appendChild(mkMiniItem(c.bon, right, actionsHtml));
          });
          body.appendChild(list);
        }

        header.addEventListener("click", () => {
          const open = expandedClassees.has(tid);
          if (open) expandedClassees.delete(tid); else expandedClassees.add(tid);
          renderTournees();
        });

        div.appendChild(header);
        div.appendChild(body);
        tourneesClasseesEl.appendChild(div);
      });
    }
  }


  function tourneeMetaById_(tourneeId){
    const tid = String(tourneeId||"");
    const t = state.tournees.find(x => String(x.tourneeId) === tid);
    if (!t) return { dateCreation:"", title: tid, hhmm:"", ms: -1 };
    const iso = t.dateCreation || "";
    const ms = iso ? (new Date(iso)).getTime() : -1;
    const title = formatTourneeTitle(iso) || tid;
    const hhmm = formatMajHHMM(iso) || "";
    return { dateCreation: iso, title, hhmm, ms: isNaN(ms)?-1:ms };
  }

  function renderLivresGrouped_(parent, list, includeTournee){
    parent.innerHTML = "";
    if (!Array.isArray(list) || !list.length) return;

    const groups = new Map();
    for (const c of list){
      const tid = String(c.tourneeId || "");
      const liv = String(c.livreurId || "").trim() || "‚Äî";
      const key = tid + "||" + liv;
      if (!groups.has(key)){
        const meta = tourneeMetaById_(tid);
        groups.set(key, { tid, liv, meta, items: [] });
      }
      groups.get(key).items.push(c);
    }

    const arr = Array.from(groups.values());
    arr.sort((a,b)=>{
      const ta = a.meta.ms, tb = b.meta.ms;
      if (ta !== tb) return (ta<0?1:ta) - (tb<0?1:tb);
      return String(a.liv).localeCompare(String(b.liv));
    });

    for (const g of arr){
      g.items.sort((a,b)=>{
        const ma = a.dateMaj ? new Date(a.dateMaj).getTime() : 0;
        const mb = b.dateMaj ? new Date(b.dateMaj).getTime() : 0;
        return ma - mb;
      });

      const group = document.createElement("div");
      group.className = "group";

      const h = document.createElement("div");
      h.className = "groupHeader";

      const left = document.createElement("div");
      left.style.minWidth = "0";

      const t1 = document.createElement("div");
      t1.className = "title";
      const hhmm = g.meta.hhmm ? g.meta.hhmm : "‚Äî:‚Äî";
      t1.textContent = includeTournee ? (`‚è± ${hhmm} ‚Äî Livreur ${g.liv}`) : (`Livreur ${g.liv}`);

      const t2 = document.createElement("div");
      t2.className = "small";
      t2.textContent = includeTournee ? (`Tourn√©e: ${g.meta.title}`) : "";

      left.appendChild(t1);
      if (includeTournee) left.appendChild(t2);

      const count = document.createElement("div");
      count.className = "groupCount";
      count.textContent = String(g.items.length);

      h.appendChild(left);
      h.appendChild(count);

      const body = document.createElement("div");
      body.className = "groupBody";

      g.items.forEach(c => {
        const lieu = String(c.gpsLieu || "").trim();
        const hh = formatMajHHMM(c.dateMaj) || "";
        let right = "";
        if (lieu) right = right ? (right + " ‚Ä¢ üìç " + lieu) : ("üìç " + lieu);
        if (hh) right = right ? (right + " ‚Ä¢ ‚è± " + hh) : ("‚è± " + hh);

        const hasGps = isFinite(Number(c.gpsLat)) && isFinite(Number(c.gpsLng));
        const actionsHtml = `
          <button class="iconBtn" title="${hasGps ? "Suivi GPS (Google Maps)" : "Pas de GPS"}" data-act="suivi" data-bon="${escapeHtml(c.bon)}" ${hasGps ? "" : "disabled"}>üìç</button>
          <button class="iconBtn" title="${hasGps ? "Nommer / modifier le client (rayon 30m)" : "Pas de GPS"}" data-act="nommer" data-bon="${escapeHtml(c.bon)}" ${hasGps ? "" : "disabled"}>üè∑</button>
        `;
        body.appendChild(mkMiniItem(c.bon, right, actionsHtml));
      });

      group.appendChild(h);
      group.appendChild(body);
      parent.appendChild(group);
    }
  }

  function renderDetail() {
    const filter = c => (!selectedTourneeId || c.tourneeId === selectedTourneeId);
    const stats = computeStatsFor(filter);
    setGlobalCounters(stats);

    detailTitle.textContent = selectedTourneeId
      ? ("Tourn√©e: " + (formatTourneeTitle((state.tournees.find(t=>t.tourneeId===selectedTourneeId)||{}).dateCreation) || selectedTourneeId))
      : "Aucune tourn√©e s√©lectionn√©e (affichage global).";

    const att = state.colis.filter(c => filter(c) && normStatut(c.statut)==="EN_ATTENTE");
    const val = state.colis.filter(c => filter(c) && normStatut(c.statut)==="VALIDE");
    const liv = state.colis.filter(c => filter(c) && normStatut(c.statut)==="LIVRE" && isLivreVisible(c));

    listAtt.innerHTML = ""; listVal.innerHTML = ""; listLiv.innerHTML = "";

    const add = (parent, c) => {
      const st = normStatut(c.statut);
      const rightBase = c.livreurId ? formatLivreurTournee(c.livreurId, c.tournee, c.codeTournee) : "";
      const lieu = String(c.gpsLieu || "").trim();
      const hhmm = formatMajHHMM(c.dateMaj) || "";
      let right = rightBase;
      if (String(c.statut||"").toUpperCase()==="LIVRE" && lieu) {
        right = right ? (right + " ‚Ä¢ üìç " + lieu) : ("üìç " + lieu);
      }
      if ((st === "VALIDE" || st === "LIVRE") && hhmm) {
        right = right ? (right + " ‚Ä¢ ‚è± " + hhmm) : ("‚è± " + hhmm);
      }
      let actionsHtml = "";

      if (st === "EN_ATTENTE") {
        actionsHtml = `
          <button class="iconBtn ok" title="Valider" data-act="valider" data-bon="${escapeHtml(c.bon)}">‚úÖ</button>
          <button class="iconBtn box" title="Livrer" data-act="livrer" data-bon="${escapeHtml(c.bon)}">üì¶</button>
        `;
      } else if (st === "VALIDE") {
        actionsHtml = `
          <button class="iconBtn box" title="Livrer" data-act="livrer" data-bon="${escapeHtml(c.bon)}">üì¶</button>
        `;
      } else if (st === "LIVRE") {
        const hasGps = isFinite(Number(c.gpsLat)) && isFinite(Number(c.gpsLng));
        actionsHtml = `
          <button class="iconBtn" title="${hasGps ? "Suivi GPS (Google Maps)" : "Pas de GPS"}" data-act="suivi" data-bon="${escapeHtml(c.bon)}" ${hasGps ? "" : "disabled"}>üìç</button>
          <button class="iconBtn" title="${hasGps ? "Nommer / modifier le client (rayon 30m)" : "Pas de GPS"}" data-act="nommer" data-bon="${escapeHtml(c.bon)}" ${hasGps ? "" : "disabled"}>üè∑</button>
        `;
      }

      parent.appendChild(mkMiniItem(c.bon, right, actionsHtml));
    };

    att.slice(0, 700).forEach(c => add(listAtt, c));
    val.slice(0, 700).forEach(c => add(listVal, c));
    const livLimited = liv.slice(0, 700);
    const includeTournee = !selectedTourneeId;
    renderLivresGrouped_(listLiv, livLimited, includeTournee);

    const handleActionClick = async (ev) => {
      const btn = ev.target && ev.target.closest ? ev.target.closest("button[data-act]") : null;
      if (!btn) return;
      const act = btn.getAttribute("data-act");
      const bon = btn.getAttribute("data-bon");
      if (!act || !bon) return;

if (act === "nommer") {
  const found = state.colis.find(x => String(x.bon) === String(bon) && (!selectedTourneeId || String(x.tourneeId) === String(selectedTourneeId)));
  if (!found) { alert("Colis introuvable."); return; }
  const current = String(found.gpsLieu || "").trim();
  const name = prompt("Nom du client / entreprise (rayon 30m) :", current);
  if (name === null) return;
  const clean = String(name).trim();
  if (!clean) { alert("Nom vide."); return; }
  btn.disabled = true;
  try {
    await apiPost("/api/navette/set-lieu", {
      magasin,
      bon,
      row: found.row || "",
      gpsLat: found.gpsLat || "",
      gpsLng: found.gpsLng || "",
      gpsLieu: clean
    });
    await refresh();
  } catch (e) {
    alert("Erreur: " + (e && e.message ? e.message : e));
  } finally {
    btn.disabled = false;
  }
  return;
}

      if (act === "suivi") {
        const found = state.colis.find(x => String(x.bon) === String(bon) && (!selectedTourneeId || String(x.tourneeId) === String(selectedTourneeId)));
        if (!found) { alert("Colis introuvable."); return; }
        openMapsFromColis(found);
        return;
      }

      if (!selectedTourneeId) {
        alert("S√©lectionne d'abord une tourn√©e √† gauche.");
        return;
      }

      btn.disabled = true;
      try {
        if (act === "valider") {
          await apiPost("/api/navette/valider", { tourneeId: selectedTourneeId, magasin, bon, livreurId: "" });
        } else if (act === "livrer") {
          await apiPost("/api/navette/livrer", { tourneeId: selectedTourneeId, magasin, bon, livreurId: "" });
        }
        await refresh();
      } catch (e) {
        alert("Erreur: " + (e && e.message ? e.message : e));
      } finally {
        btn.disabled = false;
      }
    };

    [listAtt, listVal, listLiv].forEach(el => {
      if (!el) return;
      el.onclick = handleActionClick;
    });

tourneesClasseesEl.onclick = async (ev) => {
  const btn = ev.target && ev.target.closest ? ev.target.closest("button[data-act]") : null;
  if (!btn) return;
  const act = btn.getAttribute("data-act");
  const bon = btn.getAttribute("data-bon");
  const tid = btn.getAttribute("data-tourneeid");
  if (!act || !bon || !tid) return;

  const found = state.colis.find(x => String(x.bon) === String(bon) && String(x.tourneeId) === String(tid));
  if (!found) { alert("Colis introuvable."); return; }

  if (act === "suivi") {
    openMapsFromColis(found);
    return;
  }
  if (act === "nommer") {
    const current = String(found.gpsLieu || "").trim();
    const name = prompt("Nom du client / entreprise (rayon 30m) :", current);
    if (name === null) return;
    const clean = String(name).trim();
    if (!clean) { alert("Nom vide."); return; }

    btn.disabled = true;
    try {
      await apiPost("/api/navette/set-lieu", {
        magasin,
        bon,
        row: found.row || "",
        gpsLat: found.gpsLat || "",
        gpsLng: found.gpsLng || "",
        gpsLieu: clean
      });
      await refresh();
    } catch (e) {
      alert("Erreur: " + (e && e.message ? e.message : e));
    } finally {
      btn.disabled = false;
    }
  }
};
  }

  function setNeutral() {
    subEl.textContent = "Choisis une agence.";
    setGlobalCounters({enAttente:0, valides:0, livres:0});
    state = { tournees: [], colis: [] };
    selectedTourneeId = "";
    renderTournees();
    renderDetail();
  }

  async function loadMagasins() {
    let data;
    try {
      data = await fetchJson_(apiUrl("/api/kilometrage/params"));
    } catch (err) {
      showLoadError_("PARAMS", err);
      return;
    }

    if (!Array.isArray(data)) {
      showLoadError_("PARAMS", new Error("R√©ponse inattendue: " + shortExcerpt_(JSON.stringify(data))))
      return;
    }

    paramsCache = data;

    const list = Array.from(new Set(
      data.map(r => String((r && r.codeAgence) || "").trim().toUpperCase()).filter(Boolean)
    )).sort((a,b)=>a.localeCompare(b,"fr"));

    magasinSelect.innerHTML = `<option value="">‚Äî Choisir une agence ‚Äî</option>` +
      list.map(m => `<option value="${escapeHtml(m)}">${escapeHtml(m)}</option>`).join("");

    magasin = "";
    magasinSelect.value = "";
    livreurTourneeMap = new Map();
    setNeutral();
  }

  async function refresh() {
    if (!magasin) { setNeutral(); return; }

    subEl.textContent = "Chargement‚Ä¶";
    let data;
    try {
      data = await fetchJson_(apiUrl(`/api/navette/dashboard?magasin=${encodeURIComponent(magasin)}`));
    } catch (err) {
      showLoadError_("DASHBOARD", err);
      return;
    }
    if (!data || data.success === false) {
      showLoadError_("DASHBOARD", new Error((data && (data.error || data.message)) || "R√©ponse invalide"));
      return;
    }

    state.tournees = data.tournees || [];
    state.colis = data.colis || [];

    const ts = new Date().toLocaleTimeString("fr-FR");
    subEl.textContent = `Agence: ${magasin} ‚Ä¢ Jour: ${new Date().toLocaleDateString("fr-FR")} ‚Ä¢ Tourn√©es: ${state.tournees.length} ‚Ä¢ Colis: ${state.colis.length} ‚Ä¢ MAJ: ${ts}`;

    renderTournees();
    renderDetail();

    const u = new URL(location.href);
    u.searchParams.set("magasin", magasin);
    history.replaceState(null, "", u.toString());
  }

  function startAutoRefresh() {
    if (refreshTimer) clearInterval(refreshTimer);
    refreshTimer = setInterval(() => {
      if (magasin) refresh();
    }, 10000);
  }

  magasinSelect.addEventListener("change", async () => {
    magasin = String(magasinSelect.value || "").trim().toUpperCase();
    selectedTourneeId = "";
    buildLivreurTourneeMap();
    await refresh();
  });

  btnClear.addEventListener("click", () => {
    selectedTourneeId = "";
    expandedClassees = new Set();
    renderTournees();
    renderDetail();
  });

  document.querySelectorAll(".tab").forEach(b=>{
    b.addEventListener("click", ()=>{
      document.querySelectorAll(".tab").forEach(x=>x.classList.remove("active"));
      b.classList.add("active");
      const view = b.dataset.view;
      currentView = view;
      document.getElementById("encoursView").style.display = (view==="encours") ? "" : "none";
      document.getElementById("classesView").style.display = (view==="classes") ? "" : "none";
      renderDetail();
    });
  });

  setNeutral();
  startAutoRefresh();
  loadMagasins().catch(err => {
    subEl.textContent = "Erreur: " + err.message;
  });
</script>
</body>
</html>
