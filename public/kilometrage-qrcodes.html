<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Générateur de QR codes – Kilométrage tournées</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #f3f4f6;
      margin: 0;
      padding: 0;
    }
    .wrap {
      max-width: 900px;
      margin: 0 auto;
      padding: 16px;
    }
    .card {
      background: #ffffff;
      border-radius: 12px;
      padding: 16px;
      box-shadow: 0 1px 4px rgba(0,0,0,0.08);
    }
    .logo {
      text-align: center;
      margin-bottom: 12px;
    }
    .logo img {
      max-width: 160px;
      height: auto;
    }
    h1 {
      margin: 4px 0 16px;
      font-size: 1.3rem;
      text-align: center;
    }
    .grid {
      display: grid;
      grid-template-columns: minmax(0, 1.3fr) minmax(0, 1fr);
      gap: 16px;
    }
    @media (max-width: 768px) {
      .grid {
        grid-template-columns: 1fr;
      }
    }
    .field {
      margin-bottom: 10px;
    }
    label {
      display: block;
      font-size: 0.9rem;
      margin-bottom: 4px;
      font-weight: 600;
    }
    input, select, button, textarea {
      width: 100%;
      box-sizing: border-box;
      padding: 8px 10px;
      border-radius: 8px;
      border: 1px solid #d1d5db;
      font-size: 0.95rem;
      font-family: inherit;
    }
    button {
      border: none;
      cursor: pointer;
      background: #004080;
      color: #fff;
      font-weight: 600;
      margin-top: 6px;
    }
    button.secondary {
      background: #4b5563;
    }
    .muted {
      font-size: 0.85rem;
      color: #6b7280;
      margin-top: 4px;
    }
    #qrcode {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 12px;
      background: #f9fafb;
      border-radius: 12px;
      min-height: 260px;
    }
    #qrcode canvas, #qrcode img {
      max-width: 100%;
      height: auto;
    }
    .url-box {
      margin-top: 8px;
    }
    .url-box input {
      font-family: monospace;
      font-size: 0.8rem;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="logo">
        <img id="durandLogo"
             src="https://raw.githubusercontent.com/docudurand/mes-formulaires/main/logodurand.png"
             alt="Logo Durand Services" />
      </div>
      <h1>Générateur de QR codes – Kilométrage tournées</h1>

      <div class="grid">
        <div>
          <div class="field">
            <label for="baseUrl">URL de base</label>
            <input id="baseUrl" type="text"
                   value="https://mes-formulaires.onrender.com/kilometrage-saisie.html" />
            <div class="muted">
              Change-la si tu utilises un autre domaine (Wix proxy, etc.).
            </div>
          </div>

          <div class="field">
            <label for="agence">Agence (depuis PARAMS)</label>
            <select id="agence">
              <option value="">— Sélectionne une agence —</option>
            </select>
            <div class="muted">
              La liste est alimentée par l’onglet <strong>PARAMS</strong> du fichier Google Sheets.
            </div>
          </div>

          <div class="field">
            <label for="tourneePreset">Tournée / Transporteur (depuis PARAMS)</label>
            <select id="tourneePreset">
              <option value="">— Choisir une tournée —</option>
            </select>
            <div class="muted">
              Choisis une tournée pour pré-remplir les champs ci-dessous. Tu peux ensuite les modifier.
            </div>
          </div>

          <div class="field">
            <label for="transporteur">Nom du transporteur</label>
            <input id="transporteur" type="text" placeholder="Ex : WARNING" />
          </div>

          <div class="field">
            <label for="codeTransporteur">Code transporteur</label>
            <input id="codeTransporteur" type="text" placeholder="Ex : WARNING" />
            <div class="muted">Par défaut, on reprend le nom en majuscules sans espaces.</div>
          </div>

          <div class="field">
            <label for="tournee">Nom de la tournée</label>
            <input id="tournee" type="text" placeholder="Ex : Tournée 1" />
          </div>

          <div class="field">
            <label for="codeTournee">Code tournée</label>
            <input id="codeTournee" type="text" placeholder="Ex : T1" />
            <div class="muted">Servira comme identifiant dans le Google Sheet.</div>
          </div>

          <button id="btnGenerate">Générer le QR code</button>

          <div class="url-box">
            <label for="finalUrl">URL générée</label>
            <input id="finalUrl" type="text" readonly />
          </div>

        </div>

        <div>
          <div id="qrcode">Le QR code apparaîtra ici</div>
          <button id="btnDownload" class="secondary" style="width:100%;margin-top:8px;" disabled>
            Télécharger la fiche QR (PNG)
          </button>
          <div class="muted">
            Le fichier téléchargé contient le logo Durand, le nom du magasin, le nom de la tournée
            et le QR code. Tu peux ensuite le stocker sur ton FTP Freebox et l’imprimer.
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <script>
    const $agence = document.getElementById("agence");
    const $tourneePreset = document.getElementById("tourneePreset");
    const $transporteur = document.getElementById("transporteur");
    const $codeTransporteur = document.getElementById("codeTransporteur");
    const $tournee = document.getElementById("tournee");
    const $codeTournee = document.getElementById("codeTournee");
    const $baseUrl = document.getElementById("baseUrl");
    const $finalUrl = document.getElementById("finalUrl");
    const $btnGenerate = document.getElementById("btnGenerate");
    const $btnDownload = document.getElementById("btnDownload");
    const $qrcode = document.getElementById("qrcode");
    const $logoImg = document.getElementById("durandLogo");

    let qrInstance = null;
    let allParams = [];

    function slugify(str) {
      return (str || "")
        .normalize("NFD")
        .replace(/[\u0300-\u036f]/g, "")
        .replace(/[^A-Za-z0-9]+/g, "_")
        .replace(/^_+|_+$/g, "")
        .toUpperCase();
    }

    async function loadParams() {
      try {
        const res = await fetch("/api/kilometrage/params");
        const data = await res.json().catch(() => []);
        if (!Array.isArray(data)) {
          console.error("PARAMS inattendus :", data);
          return;
        }
        allParams = data;

        const setAgences = new Set();
        allParams.forEach(p => {
          const ag = p.agence || p.codeAgence;
          if (ag) setAgences.add(ag);
        });

        $agence.innerHTML = '<option value="">— Sélectionne une agence —</option>';
        Array.from(setAgences).sort().forEach(ag => {
          const opt = document.createElement("option");
          opt.value = ag;
          opt.textContent = ag;
          $agence.appendChild(opt);
        });
      } catch (err) {
        console.error("Erreur chargement PARAMS :", err);
      }
    }

    function refreshTourneesForAgence() {
      const ag = $agence.value;
      $tourneePreset.innerHTML = '<option value="">— Choisir une tournée —</option>';

      if (!ag) return;

      const filtered = allParams.filter(p => {
        const a = p.agence || p.codeAgence;
        return a === ag;
      });

      filtered.forEach((p, index) => {
        const opt = document.createElement("option");
        opt.value = String(index);
        opt.textContent = (p.tournee || "Tournée") + " – " + (p.transporteur || p.codeTransporteur || "Transporteur");
        opt.dataset.index = String(index);
        $tourneePreset.appendChild(opt);
      });
    }

    $agence.addEventListener("change", () => {
      refreshTourneesForAgence();
      $transporteur.value = "";
      $codeTransporteur.value = "";
      $tournee.value = "";
      $codeTournee.value = "";
    });

    $tourneePreset.addEventListener("change", () => {
      const ag = $agence.value;
      if (!ag) return;

      const filtered = allParams.filter(p => {
        const a = p.agence || p.codeAgence;
        return a === ag;
      });

      const idxStr = $tourneePreset.value;
      const idx = parseInt(idxStr, 10);
      if (isNaN(idx) || !filtered[idx]) return;

      const p = filtered[idx];
      $transporteur.value = p.transporteur || "";
      $codeTransporteur.value = p.codeTransporteur || slugify(p.transporteur || "");
      $tournee.value = p.tournee || "";
      $codeTournee.value = p.codeTournee || "";
    });

    function buildUrl() {
      const base = ($baseUrl.value || "").trim();
      const agence = $agence.value.trim();
      const transporteur = $transporteur.value.trim();
      let codeTrans = $codeTransporteur.value.trim();
      const tournee = $tournee.value.trim();
      const codeTournee = $codeTournee.value.trim();

      if (!base || !agence || !tournee || !codeTournee || !transporteur) {
        alert("Merci de remplir au minimum : base URL, agence, transporteur, tournée et code tournée.");
        return null;
      }

      if (!codeTrans) {
        codeTrans = slugify(transporteur);
        $codeTransporteur.value = codeTrans;
      }

      const url =
        base +
        "?agence=" + encodeURIComponent(agence) +
        "&codeAgence=" + encodeURIComponent(agence) +
        "&tournee=" + encodeURIComponent(tournee) +
        "&codeTournee=" + encodeURIComponent(codeTournee) +
        "&chauffeur=" + encodeURIComponent(transporteur) +
        "&codeChauffeur=" + encodeURIComponent(codeTrans);

      return url;
    }

    $btnGenerate.addEventListener("click", () => {
      const url = buildUrl();
      if (!url) return;

      $finalUrl.value = url;

      $qrcode.innerHTML = "";
      qrInstance = new QRCode($qrcode, {
        text: url,
        width: 256,
        height: 256,
        correctLevel: QRCode.CorrectLevel.L
      });

      setTimeout(() => {
        const canvas = $qrcode.querySelector("canvas");
        $btnDownload.disabled = !canvas;
      }, 200);
    });

    $btnDownload.addEventListener("click", async () => {
      const qrCanvas = $qrcode.querySelector("canvas");
      if (!qrCanvas) return;

      const agence = $agence.value || "AGENCE";
      const tournee = $tournee.value || "TOURNÉE";
      const tourneeCode = slugify($tournee.value || "TOURNEE");

      const W = 900;
      const H = 1200;
      const canvas = document.createElement("canvas");
      canvas.width = W;
      canvas.height = H;
      const ctx = canvas.getContext("2d");

      ctx.fillStyle = "#ffffff";
      ctx.fillRect(0, 0, W, H);

      const logoSrc = $logoImg ? $logoImg.src : "";
      if (logoSrc) {
        try {
          await new Promise((resolve, reject) => {
            const img = new Image();
            img.crossOrigin = "anonymous";
            img.onload = () => {
              const maxLogoWidth = 260;
              const ratio = img.width > 0 ? maxLogoWidth / img.width : 1;
              const logoW = img.width * ratio;
              const logoH = img.height * ratio;
              const x = (W - logoW) / 2;
              const y = 40;
              ctx.drawImage(img, x, y, logoW, logoH);
              resolve();
            };
            img.onerror = () => resolve();
            img.src = logoSrc;
          });
        } catch (e) {
          console.warn("Logo non dessiné :", e);
        }
      }

      ctx.fillStyle = "#111827";
      ctx.textAlign = "center";

      ctx.font = "bold 34px system-ui";
      ctx.fillText("Magasin : " + agence, W / 2, 250);

      ctx.font = "bold 32px system-ui";
      ctx.fillText("Tournée : " + tournee, W / 2, 300);

      const qrSize = 450;
      const qrX = (W - qrSize) / 2;
      const qrY = 360;
      ctx.drawImage(qrCanvas, qrX, qrY, qrSize, qrSize);

      ctx.font = "14px system-ui";
      ctx.fillStyle = "#4b5563";
      ctx.fillText("Durand Services – Suivi kilométrique des tournées", W / 2, H - 40);

      const dataUrl = canvas.toDataURL("image/png");
      const a = document.createElement("a");
      a.href = dataUrl;
      a.download = `QR_${agence}_${tourneeCode}.png`;
      a.click();
    });

    loadParams();
  </script>
</body>
</html>