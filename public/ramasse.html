<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Demande de ramasse de pi√®ces</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: Arial, sans-serif; background: #f0f4f8; margin: 0; padding: 10px; }
    .form-container {
      background: white; padding: 30px; border-radius: 12px;
      box-shadow: 0 0 20px rgba(0,0,0,0.05); max-width: 800px; margin: auto;
    }
    h2 { text-align: center; color: #1e90ff; margin-bottom: 20px; }
    label { display: block; margin-top: 15px; font-weight: bold; color: #333; }
    input, select, textarea {
      width: 100%; padding: 5px; margin-top: 5px; border: 1px solid #ccc;
      border-radius: 8px; font-size: 1rem; box-sizing: border-box;
    }
    .info-box {
      background: #f7fafc; border: 1px solid #e2e8f0; border-radius: 8px;
      padding: 10px 12px; margin-top: 8px; color: #374151; font-weight: bold;
    }
    .file-preview { margin-top: 10px; }
    .file-item {
      background: #f0f0f0; border-radius: 5px; margin-bottom: 8px; padding: 8px;
      display: flex; justify-content: space-between; align-items: center;
    }
    .file-item img { max-height: 40px; margin-right: 10px; }
    .file-item button { background: red; color: white; border: none; padding: 3px 6px; cursor: pointer; }
    .paste-zone {
      border: 2px dashed #aaa; padding: 15px; margin-top: 10px; border-radius: 6px;
      text-align: center; color: #555; background: #fafafa;
    }
    button[type="submit"] { margin-top: 20px; background: #007bff; color: white; border: none; padding: 12px; border-radius: 4px; cursor: pointer; }
    .status { margin-top: 15px; font-weight: bold; }
  </style>
</head>
<body>
  <div class="form-container">
    <h2>üß∞ Demande de ramasse de pi√®ces</h2>

    <form id="ramasseForm" enctype="multipart/form-data">
      <script>window.RAMASSE_API_BASE = window.RAMASSE_API_BASE || 'https://mes-formulaires.onrender.com';</script>

      <label for="fournisseur">Fournisseur</label>
      <select id="fournisseur" name="fournisseur" required></select>

      <div class="info-box" id="magasinBox">
        Magasin en charge : <span id="magasinCharge">‚Äî</span>
      </div>
      <input type="hidden" name="magasin" id="magasin" />

      <label for="email">Votre Adresse e-mail</label>
      <input type="email" id="email" name="email" list="emailsList" required />
      <datalist id="emailsList"></datalist>

      <label for="magasinDest">Magasin destination</label>
      <select id="magasinDest" name="magasinDest" required>
        <option value="" disabled selected>‚Äî Choisir ‚Äî</option>
      </select>

      <label for="pieces">R√©f√©rences de la/les pi√®ce(s) √† r√©cup√©rer</label>
      <textarea id="pieces" name="pieces" rows="3" placeholder="Ex : 1234ABC, 9876XYZ" required></textarea>

      <label for="commentaire">Commentaire (optionnel)</label>
      <textarea id="commentaire" name="commentaire" rows="3" placeholder="Informations compl√©mentaires‚Ä¶"></textarea>

      <label for="file">Pi√®ce jointe</label>
      <input type="file" id="file" name="file" required />

      <div class="paste-zone" id="pasteZone">
        üì∏ Vous pouvez aussi coller une capture d‚Äô√©cran avec <strong>Ctrl+V</strong>
      </div>

      <div class="file-preview" id="filePreview"></div>

      <button type="submit">Envoyer</button>
      <div id="status" class="status"></div>
    </form>
  </div>

  <script>
    const API_BASE = (window.RAMASSE_API_BASE || "");

    const emailInput = document.getElementById('email');
    const emailsList = document.getElementById('emailsList');
    const LS_KEY = 'emails_history';

    (function fillEmailSuggestions(){
      const stored = JSON.parse(localStorage.getItem(LS_KEY) || '[]');
      stored.forEach(addr => {
        const opt = document.createElement('option');
        opt.value = addr;
        emailsList.appendChild(opt);
      });
      if (stored.length === 1) emailInput.value = stored[0];
    })();

    function saveEmail(addr){
      const arr = JSON.parse(localStorage.getItem(LS_KEY) || '[]');
      if (!arr.includes(addr)) {
        arr.push(addr);
        localStorage.setItem(LS_KEY, JSON.stringify(arr));
      }
    }

    async function loadFournisseurs(){
      const res = await fetch(`${API_BASE}/api/ramasse/fournisseurs`);
      if(!res.ok) throw new Error('Impossible de charger les fournisseurs');
      return res.json();
    }
    async function loadMagasins(){
      const res = await fetch(`${API_BASE}/api/ramasse/magasins`);
      if(!res.ok) throw new Error('Impossible de charger les magasins');
      return res.json();
    }

    function setMagasin(magasin){
      const display = magasin && magasin !== '‚Äî' ? magasin : '‚Äî';
      const hiddenVal = magasin && magasin !== '‚Äî' ? magasin : '';
      document.getElementById('magasinCharge').textContent = display;
      document.getElementById('magasin').value = hiddenVal;
    }

    (async () => {
      try {
        const [fournisseurs, magasins] = await Promise.all([loadFournisseurs(), loadMagasins()]);

        const selF = document.getElementById('fournisseur');
        selF.innerHTML = '<option value="" disabled selected>‚Äî Choisir ‚Äî</option>' +
          fournisseurs.map(f => `<option value="${f.name.replaceAll('"','&quot;')}" data-magasin="${(f.magasin||'').replaceAll('"','&quot;')}">${f.name}</option>`).join('');
        selF.addEventListener('change', () => {
          const opt = selF.selectedOptions[0];
          setMagasin(opt?.getAttribute('data-magasin') || '');
          const mgVal = document.getElementById('magasin').value.trim();
          selF.setCustomValidity(mgVal ? '' : 'Veuillez choisir un fournisseur qui poss√®de un magasin en charge.');
        });

        const selM = document.getElementById('magasinDest');
        selM.innerHTML = '<option value="" disabled selected>‚Äî Choisir ‚Äî</option>' +
          magasins.map(m => `<option value="${String(m).replaceAll('"','&quot;')}">${m}</option>`).join('');
      } catch(e){ console.error(e); }
    })();

    const fileInput   = document.getElementById('file');
    const filePreview = document.getElementById('filePreview');
    const pasteZone   = document.getElementById('pasteZone');
    let pastedFile = null;

    function renderPreview(){
      filePreview.innerHTML = '';
      const file = fileInput.files?.[0] || pastedFile;
      if(!file) return;

      const div = document.createElement('div');
      div.className = 'file-item';
      const isImage = file.type.startsWith('image/');
      const preview = isImage ? `<img src="${URL.createObjectURL(file)}" alt="image">` : '';
      div.innerHTML = `
        <div style="display:flex; align-items:center; gap:10px;">
          ${preview}
          <span>${file.name}</span>
        </div>
        <button type="button" id="btnRemove">X</button>
      `;
      filePreview.appendChild(div);
      div.querySelector('#btnRemove').addEventListener('click', ()=>{
        pastedFile = null; fileInput.value = ''; renderPreview();
      });
    }

    fileInput.addEventListener('change', renderPreview);

    pasteZone.addEventListener('paste', (ev)=>{
      const items = ev.clipboardData?.items || [];
      for(const item of items){
        if(item.kind === 'file'){
          const f = item.getAsFile();
          if(f){
            pastedFile = new File([f], f.name || 'capture.png', { type: f.type || 'image/png' });
          }
        }
      }
      renderPreview();
    });

    const form = document.getElementById('ramasseForm');
    const statusEl = document.getElementById('status');
    const selF = document.getElementById('fournisseur');

    form.addEventListener('submit', async (e)=>{
      e.preventDefault();
      statusEl.textContent = '‚è≥ Envoi en cours...';
      statusEl.style.color = 'black';

      const mgVal = document.getElementById('magasin').value.trim();
      if(!mgVal){
        selF.setCustomValidity('Veuillez choisir un fournisseur valide (magasin en charge manquant).');
        selF.reportValidity();
        statusEl.textContent = '‚ùå Veuillez choisir un fournisseur valide (magasin en charge manquant).';
        statusEl.style.color = 'red';
        return;
      } else {
        selF.setCustomValidity('');
      }

      const fd = new FormData(form);
      const cleaned = (fd.get('pieces')||'').toString()
        .split(/\n|,/).map(s=>s.trim()).filter(Boolean).join(', ');
      fd.set('pieces', cleaned);

      const f = pastedFile || (fileInput.files && fileInput.files[0]);
      if(f){ fd.set('file', f, f.name); }

      try {
        const res = await fetch(`${API_BASE}/api/ramasse`, { method:'POST', body: fd });
        const out = await res.json().catch(()=>({}));
        if(!res.ok) throw new Error(out.error || 'Erreur inconnue');

        statusEl.textContent = '‚úÖ Demande envoy√©e. Vous recevrez un accus√© d√®s prise en charge.';
        statusEl.style.color = 'green';

        if(emailInput.value) saveEmail(emailInput.value.trim());

        form.reset(); pastedFile = null; renderPreview(); setMagasin('‚Äî');
      } catch(err){
        statusEl.textContent = '‚ùå ' + err.message;
        statusEl.style.color = 'red';
      }
    });
  </script>
</body>
</html>