<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Navette – Tableau de bord</title>
  <meta name="theme-color" content="#003c8f">
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,sans-serif;margin:0;background:#f6f7fb}
    .wrap{max-width:1100px;margin:0 auto;padding:14px}
    .card{background:#fff;border-radius:14px;box-shadow:0 2px 10px rgba(0,0,0,.06);padding:14px}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .top{display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap}
    h1{font-size:18px;margin:0}
    .muted{color:#666;font-size:13px}
    .pill{padding:6px 10px;border-radius:999px;font-size:13px;font-weight:700;display:inline-flex;gap:6px;align-items:center}
    .p-att{background:#fff7ed;color:#9a3412}
    .p-val{background:#ecfeff;color:#155e75}
    .p-liv{background:#ecfdf5;color:#166534}
    .p-cls{background:#f3f4f6;color:#111827}
    .btn{border:0;border-radius:12px;padding:10px 12px;font-weight:800;cursor:pointer}
    .btn-ghost{background:#fff;border:1px solid #dbeafe;color:#1d4ed8}
    select{width:100%;box-sizing:border-box;border:1px solid #d1d5db;border-radius:12px;padding:10px;font-size:14px;background:#fff}
    .tabs{display:flex;gap:8px;flex-wrap:wrap}
    .tab{padding:8px 12px;border-radius:999px;border:1px solid #dbeafe;background:#fff;cursor:pointer;font-weight:800}
    .tab.active{background:#2563eb;color:#fff;border-color:#2563eb}
    .sep{height:10px}
    .list{display:flex;flex-direction:column;gap:8px;max-height:440px;overflow:auto}
    .item{display:flex;justify-content:space-between;gap:10px;align-items:center;padding:10px 12px;border-radius:12px;background:#fff;border:1px solid #eef2ff}
    .item.active{border-color:#2563eb;box-shadow:0 0 0 2px rgba(37,99,235,.15)}
    .small{font-size:12px;color:#6b7280}
    .cols{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
    @media(max-width:900px){.cols{grid-template-columns:1fr}}
    .box{border:1px solid #eef2ff;border-radius:12px;padding:10px;background:#fbfdff}
    .box h2{margin:0 0 8px;font-size:15px}
    .badge{display:inline-flex;align-items:center;gap:6px;padding:4px 8px;border-radius:999px;font-size:12px;font-weight:800;background:#f3f4f6;color:#111827}
  </style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <div class="top">
      <div>
        <h1>Navette – Tableau de bord magasin</h1>
        <div class="muted" id="sub">Chargement des agences…</div>
      </div>
      <div class="row" style="align-items:center">
        <select id="magasinSelect" style="min-width:220px;max-width:320px">
          <option value="">— Choisir une agence —</option>
        </select>
        <button class="btn btn-ghost" id="btnClear">Tout afficher</button>
      </div>
    </div>

    <div class="sep"></div>

    <div class="tabs">
      <button class="tab active" data-view="encours">En cours</button>
      <button class="tab" data-view="classes">Classés</button>
    </div>

    <div class="sep"></div>

    <div class="row" id="globalCounters"></div>

    <div class="sep"></div>

    <div id="encoursView">
      <div class="row" style="align-items:flex-start">
        <div class="card" style="flex:1;min-width:260px">
          <h2 style="margin:0;font-size:15px">Tournées en cours</h2>
          <div class="sep"></div>
          <div id="tourneesActives" class="list"></div>
        </div>

        <div class="card" style="flex:2;min-width:280px">
          <h2 style="margin:0 0 6px 0;font-size:15px">Détail tournée</h2>
          <div class="muted" id="detailTitle">Aucune tournée sélectionnée.</div>
          <div class="sep"></div>

          <div class="cols">
            <div class="box">
              <h2><span class="pill p-att">En attente</span></h2>
              <div class="list" id="listAtt"></div>
            </div>
            <div class="box">
              <h2><span class="pill p-val">Validés</span></h2>
              <div class="list" id="listVal"></div>
            </div>
            <div class="box">
              <h2><span class="pill p-liv">Livrés</span></h2>
              <div class="list" id="listLiv"></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div id="classesView" style="display:none">
      <div class="card">
        <h2 style="margin:0 0 6px 0;font-size:15px">Tournées classées</h2>
        <div class="sep"></div>
        <div id="tourneesClassees" class="list"></div>
      </div>
    </div>
  </div>
</div>

<script>
const magasinSelect = document.getElementById("magasinSelect");
const subEl = document.getElementById("sub");

async function loadAgencesFromParams(){
  const res = await fetch("/api/kilometrage?mode=params");
  const rows = await res.json();

  if (!Array.isArray(rows)) {
    throw new Error("Réponse params invalide");
  }

  const agences = [...new Set(
    rows.map(r => (r.codeAgence || "").toString().trim().toUpperCase()).filter(Boolean)
  )].sort((a,b)=>a.localeCompare(b,"fr"));

  magasinSelect.innerHTML =
    '<option value="">— Choisir une agence —</option>' +
    agences.map(a => `<option value="${a}">${a}</option>`).join("");

  subEl.textContent = "Choisis une agence.";
}

loadAgencesFromParams().catch(err=>{
  subEl.textContent = "Erreur chargement agences";
  console.error(err);
});

document.querySelectorAll(".tab").forEach(b=>{
  b.addEventListener("click", ()=>{
    document.querySelectorAll(".tab").forEach(x=>x.classList.remove("active"));
    b.classList.add("active");
    document.getElementById("encoursView").style.display = (b.dataset.view==="encours") ? "" : "none";
    document.getElementById("classesView").style.display = (b.dataset.view==="classes") ? "" : "none";
  });
});
</script>
</body>
</html>
