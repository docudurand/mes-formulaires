<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Saisie kilom√©trage tourn√©e</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <link rel="apple-touch-icon" sizes="180x180" href="icon-km.png" />
  <meta name="apple-mobile-web-app-title" content="Km tourn√©e" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />
  <meta name="theme-color" content="#003c8f">

  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #f7f7f7;
      margin: 0;
      padding: 0;
      display: flex;
      min-height: 100vh;
      align-items: center;
      justify-content: center;
    }
    .card {
      background: #fff;
      padding: 20px 24px;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
      max-width: 460px;
      width: 100%;
    }
    .logo { text-align: center; margin-bottom: 12px; }
    .logo img { max-width: 160px; height: auto; }

    h1 { font-size: 1.3rem; margin: 0 0 4px 0; text-align: center; }
    .sub { font-size: 0.9rem; color: #666; text-align: center; margin-bottom: 12px; }

    .info {
      font-size: 0.9rem;
      margin-bottom: 12px;
      padding: 8px 10px;
      border-radius: 8px;
      background: #f0f4ff;
    }

    .tabs {
      display: flex;
      gap: 10px;
      margin: 10px 0 14px 0;
    }
    .tabBtn {
      flex: 1;
      border: 1px solid #c7d2fe;
      background: #fff;
      color: #1e3a8a;
      border-radius: 999px;
      padding: 10px 0;
      font-weight: 800;
      cursor: pointer;
      font-size: 0.95rem;
    }
    .tabBtn.active {
      background: #2563eb;
      border-color: #2563eb;
      color: #fff;
    }

    label { display: block; font-size: 0.9rem; margin-top: 10px; margin-bottom: 4px; }
    input[type="date"], input[type="number"], textarea, select {
      width: 100%;
      box-sizing: border-box;
      padding: 8px 10px;
      border-radius: 8px;
      border: 1px solid #ccc;
      font-size: 0.95rem;
      font-family: inherit;
      background-color: #ffffff;
      -webkit-appearance: none;
      appearance: none;
    }
    input[type="date"], input[type="number"], select { height: 44px; line-height: 1.2; }
    textarea { resize: vertical; min-height: 60px; }

    button.primary {
      margin-top: 16px;
      width: 100%;
      padding: 10px 0;
      border-radius: 999px;
      border: none;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      background: #2563eb;
      color: #fff;
    }
    button.primary:disabled { opacity: 0.6; cursor: default; }

    .msg { margin-top: 10px; font-size: 0.9rem; text-align: center; }
    .msg.ok { color: #15803d; }
    .msg.err { color: #b91c1c; }

    .resume {
      margin-top: 10px;
      padding: 8px 10px;
      border-radius: 8px;
      background: #ecfeff;
      font-size: 0.9rem;
    }
    .resume-title { font-weight: 600; margin-bottom: 6px; }
    .resume-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 4px 10px; }
    .resume-item { padding: 4px 6px; border-radius: 6px; background: #e5f3ff; }
    .resume-item strong { display: inline-block; min-width: 2.5em; }

    .resume-loader {
      display: none;
      align-items: center;
      gap: 8px;
      font-size: 0.85rem;
      color: #2563eb;
      margin-top: 10px;
    }
    .resume-loader-spinner {
      width: 16px;
      height: 16px;
      border-radius: 50%;
      border: 2px solid #bfdbfe;
      border-top-color: #2563eb;
      animation: resume-spin 0.7s linear infinite;
    }
    @keyframes resume-spin { to { transform: rotate(360deg); } }

    .scan-loader{
      display:none;
      align-items:center;
      gap:8px;
      font-size:0.9rem;
      color:#2563eb;
      margin-top:10px;
    }
    .scan-loader-spinner{
      width:18px;height:18px;border-radius:50%;
      border:2px solid #bfdbfe;border-top-color:#2563eb;
      animation: resume-spin 0.7s linear infinite;
    }

    @media (max-width: 480px) {
      .card { margin: 12px; padding: 16px 18px; }
    }

    .btnRow { display:flex; gap:10px; flex-wrap:wrap; margin-top: 10px; }
    .btnRow button { 
      width:auto; 
      flex:1; 
      min-width: 140px; 
      margin-top: 0; 
      border-radius: 999px; 
      border: none; 
      padding: 14px 12px; 
      min-height: 56px; 
      font-weight: 700; 
      cursor:pointer; 
      display:flex;
      align-items:center;
      justify-content:center;
      text-align:center;
      line-height:1.15;
      white-space: normal;
    }
    .btnSecondary { background:#0f172a; color:#fff; }
    .btnScan { background:#2563eb; color:#fff; }
    .pill { display:inline-block; padding:4px 10px; border-radius:999px; font-size:12px; font-weight:700; background:#eef2ff; color:#1e3a8a; }
  </style>

  <script src="/js/html5-qrcode.min.js"></script>
</head>
<body>
  <div class="card">
    <div class="logo">
      <img src="https://raw.githubusercontent.com/docudurand/mes-formulaires/main/logodurand.png" alt="Logo Durand Services" />
    </div>

    <h1>Kilom√©trage</h1>

    <div id="infoBloc" class="info">Chargement des informations de tourn√©e...</div>

    <div class="tabs">
      <button type="button" class="tabBtn active" id="tabKmBtn">Kilom√©trage</button>
      <button type="button" class="tabBtn" id="tabScanBtn">Scan</button>
    </div>

    <div id="tabKm">
      <form id="kmForm">
        <label for="date">Date de la journ√©e</label>
        <input type="date" id="date" name="date" required />

        <label for="horaire">Horaire du relev√©</label>
        <select id="horaire" name="horaire">
          <option value="8H">8H</option>
          <option value="12H">12H</option>
          <option value="14H">14H</option>
          <option value="18H">18H</option>
        </select>

        <label for="km">Relev√© compteur √† cette heure</label>
        <input type="number" id="km" name="km" min="0" step="0.1" required />

        <label for="commentaire">Commentaire (optionnel)</label>
        <textarea id="commentaire" name="commentaire" placeholder="Ex : d√©tour, chargement suppl√©mentaire, etc."></textarea>

        <div id="resumeLoader" class="resume-loader">
          <div class="resume-loader-spinner"></div>
          <span>Chargement des relev√©s...</span>
        </div>

        <div id="resumeBloc" class="resume">
          <div class="resume-title">R√©sum√© des relev√©s de la journ√©e</div>
          <div class="resume-grid">
            <div class="resume-item"><strong>8H :</strong> <span id="resume8h">-</span></div>
            <div class="resume-item"><strong>12H :</strong> <span id="resume12h">-</span></div>
            <div class="resume-item"><strong>14H :</strong> <span id="resume14h">-</span></div>
            <div class="resume-item"><strong>18H :</strong> <span id="resume18h">-</span></div>
          </div>
        </div>

        <button type="submit" id="submitBtn" class="primary">Valider</button>
      </form>

      <div id="message" class="msg"></div>
    </div>

    <div id="tabScan" style="display:none"><div class="info" id="colisInfo" style="margin-bottom:10px">
        Tourn√©e: <b id="tourneeNavetteTxt">‚Äî</b> ‚Ä¢ Livreur: <b id="livreurTxt">‚Äî</b> ‚Ä¢ Magasin: <b id="magasinTxt">‚Äî</b>
      </div>

      <div class="btnRow">
        <button type="button" id="btnScanFeuille" class="btnSecondary">üìÑ Scanner feuille √©margement</button>
        <button type="button" id="btnScanCharger" class="btnScan">üì¶ Scanner colis √† charger</button>
        <button type="button" id="btnScanLivrer" class="btnScan">üöö Scanner colis livrer</button>
      </div>

      
      <div id="scanLoader" class="scan-loader">
        <div class="scan-loader-spinner"></div>
        <span id="scanLoaderTxt">Traitement...</span>
      </div>

      <div id="colisMsg" class="msg" style="display:none;margin:10px 0 0 0;text-align:left"></div>

      <div class="info" style="margin-top:10px">
        Restant √† livrer : <b id="restants">0</b>
      </div>
      <div id="listeColis" style="margin-top:10px"></div>
    </div>

    <div id="scanModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.75);z-index:9999;padding:14px">
      <div style="max-width:520px;margin:0 auto;background:#fff;border-radius:14px;overflow:hidden">
        <div style="display:flex;justify-content:space-between;align-items:center;padding:10px 12px;background:#111;color:#fff">
          <b id="scanTitle">Scan</b>
          <button type="button" id="btnCloseScan" style="background:#fff;border:0;border-radius:10px;padding:8px 10px;font-weight:800;cursor:pointer">Fermer</button>
        </div>
        <div style="padding:10px">
          <div id="qr-reader" style="width:100%"></div>
          <div style="font-size:12px;color:#555;margin-top:8px">
            Autorise la cam√©ra. Utilise la cam√©ra arri√®re si possible.
          </div>
        </div>
      </div>
    </div>

  </div>

  <script>
const params = new URLSearchParams(window.location.search);
const NAVETTE_ENABLED = params.get("navette") === "1";

if (!NAVETTE_ENABLED) {
  const tabScanBtn = document.getElementById("tabScanBtn");
  const tabScan = document.getElementById("tabScan");
  if (tabScanBtn) tabScanBtn.style.display = "none";
  if (tabScan) tabScan.style.display = "none";

  try { localStorage.setItem("kmActiveTab", "km"); } catch(e){}
}

    const tabKmBtn = document.getElementById("tabKmBtn");
    const tabScanBtn = document.getElementById("tabScanBtn");
    const tabKm = document.getElementById("tabKm");
    const tabScan = document.getElementById("tabScan");

    function setTab(name) {
      if (name === "scan") {
        tabKmBtn.classList.remove("active");
        tabScanBtn.classList.add("active");
        tabKm.style.display = "none";
        tabScan.style.display = "block";
      } else {
        tabScanBtn.classList.remove("active");
        tabKmBtn.classList.add("active");
        tabScan.style.display = "none";
        tabKm.style.display = "block";
      }
      try { localStorage.setItem("kmActiveTab", name); } catch(e){}
    }

    tabKmBtn.addEventListener("click", () => setTab("km"));
    tabScanBtn.addEventListener("click", () => setTab("scan"));

    const wantedTab = (params.get("tab") || "").toLowerCase();

    if (NAVETTE_ENABLED && wantedTab === "scan") {
      setTab("scan");
    } else {
      setTab("km");
    }

let agence        = params.get("agence")        || "";
let codeAgence    = params.get("codeAgence")    || agence;
let tournee       = params.get("tournee")       || "";
let codeTournee   = params.get("codeTournee")   || "";
let chauffeur     = params.get("chauffeur")     || "";
let codeChauffeur = params.get("codeChauffeur") || "";
let idQr          = params.get("id")            || "";


    const infoBloc = document.getElementById("infoBloc");
    const messageEl = document.getElementById("message");
    const form = document.getElementById("kmForm");
    const submitBtn = document.getElementById("submitBtn");
    const dateInput = document.getElementById("date");
    const horaireSelect = document.getElementById("horaire");
    const kmInput = document.getElementById("km");

    const resume8hEl = document.getElementById("resume8h");
    const resume12hEl = document.getElementById("resume12h");
    const resume14hEl = document.getElementById("resume14h");
    const resume18hEl = document.getElementById("resume18h");
    const resumeLoaderEl = document.getElementById("resumeLoader");

    function urlHasConfigParams() {
      return (
        params.get("codeTournee") ||
        params.get("agence") ||
        params.get("tournee") ||
        params.get("chauffeur") ||
        params.get("codeChauffeur")
      );
    }

    function saveConfigToStorage() {
      const cfg = {
        agence,
        codeAgence,
        tournee,
        codeTournee,
        chauffeur,
        codeChauffeur,
		id: idQr
      };
      try {
        localStorage.setItem("kmConfig", JSON.stringify(cfg));
      } catch (e) {
        console.warn("Impossible de sauvegarder la config km", e);
      }
    }

    function loadConfigFromStorage() {
      try {
        const str = localStorage.getItem("kmConfig");
        if (!str) return false;
        const cfg = JSON.parse(str);

        agence        = cfg.agence        || "";
        codeAgence    = cfg.codeAgence    || cfg.agence || "";
        tournee       = cfg.tournee       || "";
        codeTournee   = cfg.codeTournee   || "";
        chauffeur     = cfg.chauffeur     || "";
        codeChauffeur = cfg.codeChauffeur || "";
		idQr          = cfg.id           || "";

        const newQs = new URLSearchParams({
          agence: agence,
          codeAgence: codeAgence,
          tournee: tournee,
          codeTournee: codeTournee,
          chauffeur: chauffeur,
          codeChauffeur: codeChauffeur,
		  id: idQr
        });
        const newUrl = window.location.pathname + "?" + newQs.toString();
        window.history.replaceState({}, "", newUrl);

        return !!codeTournee;
      } catch (e) {
        console.warn("Impossible de relire la config km", e);
        return false;
      }
    }

    if (urlHasConfigParams()) {
      saveConfigToStorage();
    } else {
      const ok = loadConfigFromStorage();
      if (!ok) {
        infoBloc.innerHTML =
          "Impossible de retrouver les informations de tourn√©e.<br>" +
          "Scanne √† nouveau le QR code pour initialiser la page.";
      }
    }

    const today = new Date();
    const yyyy = today.getFullYear();
    const mm = String(today.getMonth() + 1).padStart(2, "0");
    const dd = String(today.getDate()).padStart(2, "0");
    dateInput.value = `${yyyy}-${mm}-${dd}`;

    function buildInfo() {
      const lines = [];
      if (agence || codeAgence) {
        lines.push(`<strong>Agence :</strong> ${agence || codeAgence}`);
      }
      if (tournee || codeTournee) {
        lines.push(`<strong>Tourn√©e :</strong> ${tournee || codeTournee}`);
      }
      if (chauffeur || codeChauffeur) {
        lines.push(`<strong>Transporteur :</strong> ${chauffeur || codeChauffeur}`);
      }
      if (!lines.length) {
        infoBloc.innerHTML =
          "Les param√®tres de la tourn√©e ne sont pas dans l'URL. Scanne bien le QR code fourni.";
      } else {
        infoBloc.innerHTML = lines.join("<br>");
      }
    }

    buildInfo();

    function setResumeLoading(isLoading) {
      resumeLoaderEl.style.display = isLoading ? "flex" : "none";
    }

    async function loadResume() {
      resume8hEl.textContent  = "-";
      resume12hEl.textContent = "-";
      resume14hEl.textContent = "-";
      resume18hEl.textContent = "-";

      const dateValue = dateInput.value;
      if (!dateValue || !codeTournee) {
        setResumeLoading(false);
        return;
      }

      setResumeLoading(true);

      const year = dateValue.slice(0, 4);

      const qs = new URLSearchParams({
        agence: agence || codeAgence || "",
        year: year
      });

function normalizeRowDate(row) {
  const pick = (v) => (v === null || v === undefined) ? "" : String(v).trim();

  const toLocalYMD = (d) => {
    const y = d.getFullYear();
    const m = String(d.getMonth() + 1).padStart(2, "0");
    const day = String(d.getDate()).padStart(2, "0");
    return `${y}-${m}-${day}`;
  };

  let s = pick(row.date);
  if (s) {
    if (/^\d{4}-\d{2}-\d{2}$/.test(s)) return s;

    if (/^\d{4}-\d{2}-\d{2}T/.test(s)) {
      const d = new Date(s);
      if (!isNaN(d)) return toLocalYMD(d);
      return s.slice(0, 10);
    }

    let m = s.match(/^(\d{2})\/(\d{2})\/(\d{4})/);
    if (m) return `${m[3]}-${m[2]}-${m[1]}`;
  }

  s = pick(row.timestamp);
  if (s) {

    if (/^\d{4}-\d{2}-\d{2}T/.test(s)) {
      const d = new Date(s);
      if (!isNaN(d)) return toLocalYMD(d);
      return s.slice(0, 10);
    }

    if (/^\d{4}-\d{2}-\d{2}/.test(s)) return s.slice(0, 10);

    let m = s.match(/^(\d{2})\/(\d{2})\/(\d{4})/);
    if (m) return `${m[3]}-${m[2]}-${m[1]}`;
  }

  return "";
}

      try {
        const res = await fetch("/api/kilometrage/data?" + qs.toString());
        const data = await res.json().catch(() => null);

        console.log("Donn√©es re√ßues pour r√©sum√© :", data);

        if (!Array.isArray(data) || data.length === 0) {
          console.log("Aucune donn√©e trouv√©e pour cette agence / ann√©e");
          return;
        }

        const dateKey        = dateValue;
        const agenceKey      = (codeAgence || agence || "").toUpperCase();
        const codeTourneeKey = (codeTournee || "").toString().trim();

        const ligne = data.find((row) => {
          const rowAgence = (row.codeAgence || row.agence || "").toString().toUpperCase();
          const rowCodeTournee = (row.codeTournee || "").toString().trim();
          const rowDate = normalizeRowDate(row);

          return (
            rowAgence === agenceKey &&
            rowCodeTournee === codeTourneeKey &&
            rowDate === dateKey
          );
        });

        console.log("Ligne trouv√©e pour r√©sum√© :", ligne);

        if (!ligne) {
          return;
        }

        if (ligne.km8h  !== null && ligne.km8h  !== "") resume8hEl.textContent  = ligne.km8h;
        if (ligne.km12h !== null && ligne.km12h !== "") resume12hEl.textContent = ligne.km12h;
        if (ligne.km14h !== null && ligne.km14h !== "") resume14hEl.textContent = ligne.km14h;
        if (ligne.km18h !== null && ligne.km18h !== "") resume18hEl.textContent = ligne.km18h;
      } catch (err) {
        console.error("Erreur chargement r√©sum√© (via /data) :", err);
      } finally {
        setResumeLoading(false);
      }
    }

    window.addEventListener("load", loadResume);
    dateInput.addEventListener("change", loadResume);

    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      messageEl.textContent = "";
      messageEl.className = "msg";

      const dateValue = dateInput.value;
      const horaireValue = horaireSelect.value;
      const kmValue = kmInput.value;
      const commentaireUser = document.getElementById("commentaire").value || "";

      if (!codeTournee) {
        messageEl.textContent =
          "Erreur : code tourn√©e manquant. Scanne √† nouveau le QR code.";
        messageEl.classList.add("err");
        return;
      }
      if (!dateValue) {
        messageEl.textContent = "Merci de choisir une date.";
        messageEl.classList.add("err");
        return;
      }
      if (kmValue === "" || isNaN(Number(kmValue))) {
        messageEl.textContent =
          "Merci de saisir un kilom√©trage valide.";
        messageEl.classList.add("err");
        return;
      }

      const kmNumber = Number(kmValue);
      const commentaireEncoded = `@${horaireValue}@${commentaireUser}`;

            const payload = {
        agence,
        codeAgence,
        tournee,
        codeTournee,
        chauffeur,
        codeChauffeur,
        date: dateValue,
        km: kmNumber,
        commentaire: commentaireEncoded,
        id: idQr
      };


      submitBtn.disabled = true;
      submitBtn.textContent = "Enregistrement...";

      try {
        const res = await fetch("/api/kilometrage/save", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });

        const data = await res.json().catch(() => ({}));

        if (!res.ok || data.success === false) {
          throw new Error(data.error || "Erreur serveur");
        }

        messageEl.textContent =
          "Relev√© " + horaireValue + " enregistr√© üëç";
        messageEl.classList.add("ok");

        kmInput.value = "";
        document.getElementById("commentaire").value = "";
        kmInput.focus();

        loadResume();
      } catch (err) {
        console.error(err);
        messageEl.textContent =
          "Erreur lors de l'enregistrement. R√©essaie ou contacte le responsable.";
        messageEl.classList.add("err");
      } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = "Valider";
      }
    });

    const magasinNavette = (params.get("magasin") || codeAgence || agence || "").toString().trim().toUpperCase();
    const livreurId = (params.get("livreurId") || codeChauffeur || chauffeur || "").toString().trim();
    let tourneeNavette = (params.get("tourneeNavette") || params.get("tourneeId") || "").toString().trim();

    const tourneeNavetteTxt = document.getElementById("tourneeNavetteTxt");
    const livreurTxt = document.getElementById("livreurTxt");
    const magasinTxt = document.getElementById("magasinTxt");
    const colisMsg = document.getElementById("colisMsg");
    const scanLoader = document.getElementById("scanLoader");
    const scanLoaderTxt = document.getElementById("scanLoaderTxt");

    const restantsEl = document.getElementById("restants");
    const listeColisEl = document.getElementById("listeColis");

    if (!tourneeNavette && magasinNavette) {
      try {
        tourneeNavette = localStorage.getItem("NAVETTE_TOURNEE_" + magasinNavette) || "";
      } catch(e){}
    }

    // Toujours synchroniser sur la tourn√©e active (partag√©e entre profils/appareils)
    (async () => {
      try {
        const active = await getActiveTourneeId();
        if (active) {
          tourneeNavette = active;
          try { localStorage.setItem("NAVETTE_TOURNEE_" + magasinNavette, tourneeNavette); } catch(e){}
          refreshColisHeader();
        }
      } catch(e){}
    })();

    function setColisMsg(t, isErr=false) {
      if (!colisMsg) return;
      colisMsg.textContent = t || "";
      colisMsg.style.display = t ? "block" : "none";
      colisMsg.className = "msg " + (isErr ? "err" : "ok");
    }

    function setScanLoading(isLoading, text) {
      if (!scanLoader) return;
      scanLoader.style.display = isLoading ? "flex" : "none";
      if (scanLoaderTxt && text) scanLoaderTxt.textContent = text;
    }

    function setScanButtonsDisabled(disabled) {
      [btnScanFeuille, btnScanCharger, btnScanLivrer].forEach(b => {
        if (!b) return;
        b.disabled = !!disabled;
        b.style.opacity = disabled ? "0.65" : "1";
        b.style.cursor = disabled ? "default" : "pointer";
      });
    }

    function normalizeBon(v) {
      return (v || "").toString().trim().replace(/[^\d]/g, "");
    }

    function parseBonsFromFeuille(text) {
      const parts = String(text || "")
        .split(/[\n,; \t\r]+/g)
        .map(s => normalizeBon(s))
        .filter(Boolean);

      const seen = new Set();
      const out = [];
      for (const b of parts) {
        if (b.length < 6) continue;
        if (!seen.has(b)) { seen.add(b); out.push(b); }
      }
      return out;
    }

function refreshColisHeader() {
  // Affiche le libell√© de tourn√©e (m√™me valeur que celle affich√©e en haut de la page)
  // pour que l'utilisateur voie toujours la m√™me info, quel que soit le tourneeId technique.
  if (tourneeNavetteTxt) tourneeNavetteTxt.textContent = (tournee || codeTournee || tourneeNavette || "‚Äî");
  if (livreurTxt) livreurTxt.textContent = livreurId || "‚Äî";
  if (magasinTxt) magasinTxt.textContent = magasinNavette || "‚Äî";
}

    refreshColisHeader();

    async function apiPost(url, body) {
      const r = await fetch(url, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(body || {})
      });
      const j = await r.json().catch(() => ({}));
      if (!r.ok || j.success === false) throw new Error(j.error || "Erreur API");
      return j;
    }

    async function apiGet(url) {
      const r = await fetch(url);
      const j = await r.json().catch(() => ({}));
      if (!r.ok || j.success === false) throw new Error(j.error || "Erreur API");
      return j;
    }

    async function getActiveTourneeId() {
      if (!magasinNavette) return "";
      const j = await apiGet(`/api/navette/active?magasin=${encodeURIComponent(magasinNavette)}`);
      return String((j && j.tourneeId) || "");
    }

    function renderList(list) {
      if (!listeColisEl) return;
      if (!Array.isArray(list) || list.length === 0) {
        listeColisEl.innerHTML = "";
        return;
      }
      listeColisEl.innerHTML = `
        <div style="display:flex;flex-direction:column;gap:6px">
          ${list.slice(0, 250).map(it => `
            <div style="display:flex;justify-content:space-between;gap:10px;padding:8px 10px;border:1px solid #eee;border-radius:10px">
              <b>${it.bon || ""}</b>
              <span>${it.statut || ""}</span>
            </div>
          `).join("")}
        </div>
      `;
    }

    async function refreshLivreurList() {
      if (!restantsEl) return;
      if (!livreurId) {
        restantsEl.textContent = "0";
        renderList([]);
        return;
      }

      // Toujours se recaler sur la tourn√©e active du magasin (partag√©e entre profils/appareils)
      try {
        tourneeNavette = tourneeNavette || (await getActiveTourneeId());
      } catch(e){}

      const j = await apiGet(`/api/navette/livreur?tourneeId=${encodeURIComponent(tourneeNavette||"")}&magasin=${encodeURIComponent(magasinNavette)}&livreurId=${encodeURIComponent(livreurId)}`);
      const list = j.colis || [];
      restantsEl.textContent = String(j.restants || 0);

      if (list.length === 0) {
        renderList([]);
        setColisMsg("‚ÑπÔ∏è Feuille import√©e. Scanne les colis avec ¬´ Scanner colis √† charger ¬ª pour les affecter au livreur.", false);
        return;
      }

      if (Number(j.restants || 0) <= 0) {
        renderList([]);
        setColisMsg("‚úÖ Tout est livr√© (liste masqu√©e)", false);
        return;
      }

      renderList(list);
    }

    const scanModal = document.getElementById("scanModal");
    const scanTitle = document.getElementById("scanTitle");
    const btnCloseScan = document.getElementById("btnCloseScan");
    const btnScanFeuille = document.getElementById("btnScanFeuille");
    const btnScanCharger = document.getElementById("btnScanCharger");
    const btnScanLivrer = document.getElementById("btnScanLivrer");

    let html5Qr = null;
    let onScanResult = null;

    async function openScanner(title, cb) {
      onScanResult = cb;
      setScanLoading(false);
      setColisMsg("", false);
      if (scanTitle) scanTitle.textContent = title;
      if (scanModal) scanModal.style.display = "block";

      if (!html5Qr) html5Qr = new Html5Qrcode("qr-reader");

      await html5Qr.start(
        { facingMode: "environment" },
        { fps: 10, qrbox: { width: 250, height: 250 } },
        (decodedText) => {
          closeScanner().finally(() => {
            if (onScanResult) onScanResult(decodedText);
          });
        },
        () => {}
      );
    }

    async function closeScanner() {
      try { if (html5Qr) await html5Qr.stop(); } catch(e){}
      if (scanModal) scanModal.style.display = "none";
    }
    if (btnCloseScan) btnCloseScan.addEventListener("click", closeScanner);

    if (btnScanFeuille) {
      btnScanFeuille.addEventListener("click", async () => {
        try {
          if (!magasinNavette) { setColisMsg("‚ùå Magasin manquant (URL: ?magasin=...)", true); return; }

          await openScanner("Scanner feuille d‚Äô√©margement", async (txt) => {
            try {
              const bons = parseBonsFromFeuille(txt);
              if (!bons.length) { setColisMsg("‚ùå QR feuille : aucune liste de bons d√©tect√©e", true); return; }

              setScanLoading(true, "Import de la feuille en cours...");
              setScanButtonsDisabled(true);
              const j = await apiPost("/api/navette/import", { magasin: magasinNavette, bons: txt, tournee: (tournee||"") || (tournee||""), codeTournee: codeTournee||"" });

              tourneeNavette = j.tourneeId || j.tournee || tourneeNavette;
              try { localStorage.setItem("NAVETTE_TOURNEE_" + magasinNavette, tourneeNavette); } catch(e){}
              refreshColisHeader();

              setScanLoading(false);
              setScanButtonsDisabled(false);
              setColisMsg(`‚úÖ Feuille import√©e ‚Ä¢ tourn√©e ${tourneeNavette} ‚Ä¢ +${j.added || 0} ajout√©s`, false);
              await refreshLivreurList();
            } catch (e) {
              setScanLoading(false);
              setScanButtonsDisabled(false);
              setScanLoading(false);
              setScanButtonsDisabled(false);
              setColisMsg("‚ùå " + e.message, true);
            }
          });
        } catch (e) {
          setScanLoading(false);
              setScanButtonsDisabled(false);
              setColisMsg("‚ùå " + e.message, true);
        }
      });
    }

    if (btnScanCharger) {
      btnScanCharger.addEventListener("click", async () => {
        try {
          if (!magasinNavette) { setColisMsg("‚ùå Magasin manquant", true); return; }
                    if (!livreurId) { setColisMsg("‚ùå Livreur manquant (URL: ?livreurId=...)", true); return; }

          await openScanner("Scanner colis √† charger", async (txt) => {
            try {
              const bon = normalizeBon(txt);
              if (!bon) { setColisMsg("‚ùå QR colis invalide", true); return; }

              setScanLoading(true, `Validation colis ${bon}...`);
              setScanButtonsDisabled(true);
              // si on n'a pas encore de tourneeId (ou si le profil n'est pas celui qui a import√© la feuille),
              // on demande la tourn√©e active du magasin
              if (!tourneeNavette) {
                try { tourneeNavette = await getActiveTourneeId(); } catch(e){}
              }
              const j = await apiPost("/api/navette/valider", { tourneeId: tourneeNavette, magasin: magasinNavette, livreurId, bon, tournee: (tournee||"") || (tournee||""), codeTournee: codeTournee||"" });
              if (j && (j.tourneeId || j.tournee)) {
                tourneeNavette = j.tourneeId || j.tournee;
                try { localStorage.setItem("NAVETTE_TOURNEE_" + magasinNavette, tourneeNavette); } catch(e){}
                refreshColisHeader();
              }
              setScanLoading(false);
              setScanButtonsDisabled(false);
              setColisMsg(`‚úÖ Colis ${bon} valid√© (charg√©)`, false);

              await refreshLivreurList();
            } catch (e) {
              setScanLoading(false);
              setScanButtonsDisabled(false);
              setColisMsg("‚ùå " + e.message, true);
            }
          });
        } catch (e) {
          setScanLoading(false);
              setScanButtonsDisabled(false);
              setColisMsg("‚ùå " + e.message, true);
        }
      });
    }

    if (btnScanLivrer) {
      btnScanLivrer.addEventListener("click", async () => {
        try {
          if (!magasinNavette) { setColisMsg("‚ùå Magasin manquant", true); return; }
                    if (!livreurId) { setColisMsg("‚ùå Livreur manquant (URL: ?livreurId=...)", true); return; }

          await openScanner("Scanner colis livrer", async (txt) => {
            try {
              const bon = normalizeBon(txt);
              if (!bon) { setColisMsg("‚ùå QR colis invalide", true); return; }

              setScanLoading(true, `Livraison colis ${bon}...`);
              setScanButtonsDisabled(true);
              // si on n'a pas encore de tourneeId (ou si le profil n'est pas celui qui a import√© la feuille),
              // on demande la tourn√©e active du magasin
              if (!tourneeNavette) {
                try { tourneeNavette = await getActiveTourneeId(); } catch(e){}
              }
              const j = await apiPost("/api/navette/livrer", { tourneeId: tourneeNavette, magasin: magasinNavette, livreurId, bon, tournee: (tournee||"") || (tournee||""), codeTournee: codeTournee||"" });
              if (j && (j.tourneeId || j.tournee)) {
                tourneeNavette = j.tourneeId || j.tournee;
                try { localStorage.setItem("NAVETTE_TOURNEE_" + magasinNavette, tourneeNavette); } catch(e){}
                refreshColisHeader();
              }
              setScanLoading(false);
              setScanButtonsDisabled(false);
              setColisMsg(`‚úÖ Colis ${bon} livr√©`, false);

              await refreshLivreurList();
            } catch (e) {
              setScanLoading(false);
              setScanButtonsDisabled(false);
              setColisMsg("‚ùå " + e.message, true);
            }
          });
        } catch (e) {
          setScanLoading(false);
              setScanButtonsDisabled(false);
              setColisMsg("‚ùå " + e.message, true);
        }
      });
    }

    setInterval(() => {
      refreshLivreurList().catch(() => {});
    }, 4000);

    refreshLivreurList().catch(() => {});
  </script>
</body>
</html>