<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Présences DSG</title>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#fafafa; --ink:#111; --muted:#666; --line:#e6e6e6;
      --brand:#d21f3c; --chip:#111; --chipText:#fff;
      --radius:14px; --pad:12px;
      --cell:38px; --cellSm:32px;
    }
    *{box-sizing:border-box}
    body{font-family:Montserrat,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--ink);margin:0}
    header{display:flex;gap:12px;align-items:center;justify-content:space-between;padding:16px 20px;border-bottom:1px solid var(--line);background:#fff;position:sticky;top:0;z-index:10}
    h1{font-size:20px;margin:0;font-weight:700;letter-spacing:.3px}
    .filters{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
    select,input{height:38px;padding:0 12px;border:1px solid var(--line);border-radius:10px;background:#fff}
    .tabs{display:flex;gap:8px;padding:10px 20px;border-bottom:1px solid var(--line);background:#fff;position:sticky;top:64px;z-index:9}
    .tab{padding:10px 14px;border:1px solid var(--line);border-radius:999px;background:#fff;cursor:pointer;font-weight:600}
    .tab.active{background:var(--brand);color:#fff;border-color:var(--brand)}
    main{padding:16px 20px}
    .toolbar{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px;align-items:center}
    button{height:38px;padding:0 14px;border:1px solid var(--line);border-radius:10px;background:#fff;cursor:pointer;font-weight:600}
    button.primary{background:var(--brand);color:#fff;border-color:var(--brand)}
    button.ghost{background:#fff}
    .legend{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0 16px}
    .legend .k{display:flex;align-items:center;gap:6px;padding:6px 10px;border:1px solid var(--line);border-radius:999px;background:#fff;cursor:pointer}
    .swatch{width:16px;height:16px;border-radius:4px;border:1px solid rgba(0,0,0,.08)}
    .gridWrap{overflow:auto;border:1px solid var(--line);border-radius:var(--radius);background:#fff}
    table{border-collapse:separate;border-spacing:0;width:max-content;min-width:100%}
    th,td{border-right:1px solid var(--line);border-bottom:1px solid var(--line);text-align:center}
    thead th{position:sticky;top:0;background:#fff;font-weight:700}
    tbody th.sticky{position:sticky;left:0;background:#fff;font-weight:600;z-index:2}
    td,th{height:var(--cell);min-width:42px;padding:0}
    td.cell{cursor:text}
    td.cell[contenteditable="true"]:focus{outline:2px solid #2684ff;outline-offset:-2px}
    td.cell.selected{outline:2px solid #2684ff;outline-offset:-2px}
    td.cell[data-code=""]{background:#fff}
    td.cell[data-code]{color:#fff;font-weight:700}
    td.cell[data-code="P"]{background:#2e7d32}
    td.cell[data-code="CP"]{background:#7e57c2}
    td.cell[data-code="SS"]{background:#c62828}
    td.cell[data-code="F"]{background:#455a64}
    .sub{font-size:11px;color:var(--muted)}

    td.cell.weekend{background:#000 !important;color:#fff !important;cursor:not-allowed}
    th.weekend{background:#111 !important;color:#fff !important}

    .summary{border:1px solid var(--line);border-radius:var(--radius);background:#fff;overflow:auto}
    .summary table td,.summary table th{padding:10px}
    .hint{color:var(--muted);font-size:12px}

    .chips{display:flex;flex-wrap:wrap;gap:6px}
    .chip{border:1px solid var(--line);border-radius:999px;padding:4px 8px;font-size:12px;background:#fff}

    .dayHeader{display:flex;align-items:center;justify-content:center;gap:10px;padding:8px}
    .dayTitle{font-weight:700}
    .navBtn{border:1px solid var(--line);background:#fff;border-radius:999px;padding:2px 10px;height:28px;cursor:pointer;font-weight:700}
    .navBtn:active{transform:translateY(1px)}

    .spinner{width:16px;height:16px;border:2px solid #ddd;border-top-color:var(--brand);border-radius:50%;animation:spin 1s linear infinite}
    @keyframes spin{ to{ transform:rotate(360deg) } }
    .sectionLoading{padding:16px;display:flex;align-items:center;gap:10px;color:var(--muted)}

    .adminBox{border:1px dashed var(--line);border-radius:12px;padding:10px;background:#fff;display:flex;gap:8px;align-items:center;margin-bottom:10px}
    .cards{display:grid;grid-template-columns:repeat(auto-fill,minmax(320px,1fr));gap:12px}
    .card{border:1px solid var(--line);border-radius:12px;background:#fff;padding:12px}
    .card h3{margin:0 0 6px 0;font-size:16px}
    .rowmeta{font-size:12px;color:var(--muted);margin-bottom:8px}
    .actions{display:flex;gap:8px}
    .ok{background:#2e7d32;color:#fff;border-color:#2e7d32}
    .no{background:#c62828;color:#fff;border-color:#c62828}

    @media (max-width:900px){
      :root{--cell:32px}
      header{flex-direction:column;align-items:flex-start;gap:8px}
      .tabs{top:unset;position:static}
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>
<body>
  <header>
    <h1>Présences – Durand Services</h1>
    <div class="filters">
      <select id="store"></select>
      <select id="ptype">
        <option value="EMPLOYE" selected>Employés</option>
        <option value="INTERIM">Intérim</option>
        <option value="LIVREUR">Livreurs</option>
      </select>
      <input type="date" id="day" />
      <input type="month" id="month" />
      <button id="load" class="primary">Charger</button>
    </div>
  </header>

  <nav class="tabs">
    <div class="tab active" data-tab="saisie">Saisie</div>
    <div class="tab" data-tab="resume">Résumé</div>
    <div class="tab" data-tab="conges">Congés</div>
  </nav>

  <main>
    <section id="saisie" class="page">
      <div class="toolbar">
        <button id="fillP">Remplir toutes les cases avec P</button>
        <button id="fillEmpty">Vider sélection</button>
        <button id="save" class="primary">Enregistrer</button>
        <span class="hint">Astuce : clique une cellule (Ctrl/Cmd = multi) puis une puce P/CP. Le bouton met un P partout. Alt+clic sur une puce = remplir tout.</span>
      </div>
      <div class="legend" id="legend"></div>
      <div class="gridWrap"><div id="gridDay"></div></div>
    </section>

    <section id="resume" class="page" style="display:none">
      <div class="toolbar">
        <button id="exportCsv" class="ghost">Exporter CSV</button>
        <span id="exportMsg" class="hint" role="status" aria-live="polite"></span>
      </div>
      <div class="summary">
        <div id="summaryGrid" style="margin-bottom:12px;"></div>
        <div id="summaryTotals"></div>
      </div>
    </section>

    <section id="conges" class="page" style="display:none">
      <div class="adminBox">
        <label for="adminCode"><b>Code d’accès :</b></label>
        <input id="adminCode" type="password" placeholder="••••" style="height:32px;padding:0 8px;width:140px">
        <button id="saveAdminCode">OK</button>
        <span class="hint">Saisis le code une fois pour déverrouiller.</span>
      </div>
      <div class="toolbar">
        <select id="filterStore"></select>
        <input type="month" id="filterMonth" />
        <button id="refreshLeaves" class="ghost">Rafraîchir</button>
      </div>
      <div id="leavesList" class="cards"></div>
    </section>
  </main>

<script>
const API = '/api/presences';
const $ = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));

const state = {
  store:null, ptype:'EMPLOYE', day:null, month:null,
  people:[], shifts:[], codes:[], matrixDay:{},
  monthPeople:[], monthDays:[], monthShifts:[], monthCodes:[], monthRecords:[]
};

const selectedCells = new Set();
let lastCell = null;
function clearSelection(){
  selectedCells.forEach(td=> td.classList.remove('selected'));
  selectedCells.clear();
  lastCell = null;
}
function selectCell(td, additive=false){
  if(td.classList.contains('weekend')) return;
  if(!additive){ clearSelection(); }
  selectedCells.add(td);
  td.classList.add('selected');
  lastCell = td;
}
function getTargetCells(){
  if(selectedCells.size) return Array.from(selectedCells);
  return lastCell ? [lastCell] : [];
}
function setCodesOnTargets(code){
  const targets = getTargetCells();
  if(!targets.length){ alert('Clique d’abord une cellule (Ctrl/Cmd pour multi-sélection), puis sur la puce.'); return; }
  targets.forEach(td=>{
    if(td.classList.contains('weekend')) return;
    const pid = td.dataset.pid;
    const s   = td.dataset.shift;
    state.matrixDay[pid][s] = code || '';
    td.textContent = code || '';
    setCellCodeColor(td, code || '');
  });
}

function setActiveTab(id){
  $$('.tab').forEach(t=>t.classList.toggle('active', t.dataset.tab===id));
  $$('.page').forEach(p=>p.style.display = (p.id===id)?'block':'none');
}
function currentTab(){ return document.querySelector('.tab.active')?.dataset.tab || 'saisie'; }

function dayLabel(d){
  const dt = new Date(d);
  const JOURS_FR = ['Dim','Lun','Mar','Mer','Jeu','Ven','Sam'];
  return `${JOURS_FR[dt.getDay()]}<br><span class="sub">${dt.getDate()}</span>`;
}
function th(html){ const e = document.createElement('th'); e.innerHTML=html; return e; }
function sShort(s){
  const map = {"MATIN":"Matin", "APRÈS-MIDI":"Après-midi", "AM":"Après-midi","NUIT":"Nuit","10H":"10 h","12H":"12 h","16H":"16 h"};
  return map[s] || s;
}
function formatDateLongFR(iso){
  const d = new Date(iso);
  const J=['dim.','lun.','mar.','mer.','jeu.','ven.','sam.'];
  const M=['janv.','févr.','mars','avr.','mai','juin','juil.','août','sept.','oct.','nov.','déc.'];
  return `${J[d.getDay()]} ${String(d.getDate()).padStart(2,'0')} ${M[d.getMonth()]} ${d.getFullYear()}`;
}
function formatDateHeader(iso){
  const d = new Date(iso);
  const J=['dim.','lun.','mar.','mer.','jeu.','ven.','sam.'][d.getDay()];
  const dd = String(d.getDate()).padStart(2,'0');
  const mm = String(d.getMonth()+1).padStart(2,'0');
  return `${J} ${dd}/${mm}`;
}
function setMonthFromDay(){
  if(!state.day) return;
  const d = new Date(state.day);
  const ym = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
  $('#month').value = ym;
  state.month = ym;
}
const isWeekendISO = iso => {
  const g = new Date(iso).getDay();
  return g === 0 || g === 6;
};

function showLoading(){
  const btn = $('#load');
  if(btn){
    btn.disabled = true;
    if(!btn.dataset.oldLabel) btn.dataset.oldLabel = btn.textContent;
    btn.textContent = 'Chargement…';
  }
}
function hideLoading(){
  const btn = $('#load');
  if(btn){
    btn.disabled = false;
    btn.textContent = btn.dataset.oldLabel || 'Charger';
  }
}
function setSectionLoading(targetSel, msg='Chargement…'){
  const el = $(targetSel);
  if(!el) return;
  el.innerHTML = `<div class="sectionLoading"><span class="spinner" aria-hidden="true"></span> ${msg}</div>`;
}

async function apiGet(params, headers={}){
  const url = API + '?' + new URLSearchParams(params);
  const r = await fetch(url, { headers });
  const txt = await r.text();
  let j; try{ j = JSON.parse(txt); }catch(e){ throw new Error('Réponse non JSON: '+txt.slice(0,120)); }
  if(j && j.error){ throw new Error(j.error); }
  return j;
}
async function apiPost(body, headers={}){
  const r = await fetch(API, {method:'POST',headers:{'Content-Type':'application/json',...headers},body:JSON.stringify(body)});
  const txt = await r.text();
  let j; try{ j = JSON.parse(txt); }catch(e){ throw new Error('Réponse non JSON: '+txt.slice(0,120)); }
  if(j && j.error){ throw new Error(j.error); }
  return j;
}

function renderLegend(){
  const el = $('#legend'); el.innerHTML='';
  (state.codes||[]).forEach(c=>{
    const div = document.createElement('div');
    div.className='k';
    div.innerHTML = `<span class="swatch" style="background:${c.couleur_hex}"></span><b>${c.code}</b> <span class="sub">${c.libelle||''}</span>`;
    div.addEventListener('click', (e)=>{
      if(e.altKey){ applyAllDay(c.code); } else { setCodesOnTargets(c.code); }
    });
    el.appendChild(div);
  });
}

function applyAllDay(code){
  if(isWeekendISO(state.day)){
    renderGridDay();
    return;
  }
  for(const pid in state.matrixDay){
    for(const s of state.shifts){
      state.matrixDay[pid][s]=code||'';
    }
  }
  $$('#gridDay td.cell').forEach(td=>{
    if(td.classList.contains('weekend')) return;
    const pid=td.dataset.pid, sh=td.dataset.shift;
    const v=state.matrixDay[pid][sh]||'';
    td.textContent=v;
    setCellCodeColor(td, v);
  });
}
function setCellCodeColor(td, code){
  if(td.classList.contains('weekend')) return;
  const color = (state.codes||[]).find(c=>c.code===code)?.couleur_hex || '';
  td.style.backgroundColor = color || '';
  td.style.color = color ? '#fff' : '';
}
function attachCellHandlers(td){
  td.addEventListener('mousedown', (e)=> selectCell(td, e.ctrlKey || e.metaKey || e.shiftKey));
  td.addEventListener('input', e=>{
    const v = e.target.textContent.trim().toUpperCase();
    const allowed = new Set((state.codes||[]).map(c=>c.code));
    const code = allowed.has(v) ? v : '';
    const pid = td.dataset.pid, s = td.dataset.shift;
    state.matrixDay[pid][s] = code;
    td.textContent = code;
    setCellCodeColor(td, code);
    selectCell(td, true);
  });
}

function renderGridDay(){
  clearSelection();

  const grid = $('#gridDay'); grid.innerHTML='';
  const table = document.createElement('table');

  const thead = document.createElement('thead');
  const tr0 = document.createElement('tr');
  const th0 = document.createElement('th');
  th0.colSpan = 1 + (state.shifts?.length||0);
  th0.innerHTML = `
    <div class="dayHeader">
      <button class="navBtn" id="prevDay" aria-label="Jour précédent">◀</button>
      <span class="dayTitle">${formatDateLongFR(state.day)}</span>
      <button class="navBtn" id="nextDay" aria-label="Jour suivant">▶</button>
    </div>`;
  tr0.appendChild(th0);
  thead.appendChild(tr0);

  const trh = document.createElement('tr');
  trh.appendChild(th('Nom'));
  (state.shifts||[]).forEach(s=> trh.appendChild(th(sShort(s))));
  thead.appendChild(trh);
  table.appendChild(thead);

  const weekendDay = isWeekendISO(state.day);

  const tbody = document.createElement('tbody');
  (state.people||[]).forEach(p=>{
    const tr = document.createElement('tr');
    const thn = th(`${(p.nom||'').toUpperCase()}<br><span class="sub">${p.prenom||''}</span>`); 
    thn.className='sticky';
    tr.appendChild(thn);

    (state.shifts||[]).forEach(s=>{
      const td = document.createElement('td');
      td.className='cell';
      td.dataset.pid=p.id; 
      td.dataset.shift=s;
      const val = state.matrixDay?.[p.id]?.[s] || '';
      td.textContent = val;

      if(weekendDay){
        td.classList.add('weekend');
      }else{
        td.setAttribute('contenteditable','true');
        setCellCodeColor(td, val);
        attachCellHandlers(td);
      }
      tr.appendChild(td);
    });

    tbody.appendChild(tr);
  });

  table.appendChild(tbody);
  grid.appendChild(table);

  const prev = table.querySelector('#prevDay');
  const next = table.querySelector('#nextDay');
  if(prev) prev.onclick = ()=> changeDay(-1);
  if(next) next.onclick = ()=> changeDay(1);
}

async function changeDay(delta){
  if(!state.day){ return; }
  const d = new Date(state.day);
  d.setDate(d.getDate()+delta);
  const iso = d.toISOString().slice(0,10);
  state.day = iso;
  $('#day').value = iso;
  setMonthFromDay();
  setSectionLoading('#gridDay', 'Chargement du jour…');
  showLoading();
  try{
    await loadDay();
    if(currentTab()==='resume'){ await loadMonthly(); }
  } finally {
    hideLoading();
  }
}
async function checkPrevDayWarning(){ /* placeholder */ }

async function loadDay(){
  const {people, shifts, codes, records} = await apiGet({action:'initDay', store:state.store, type:state.ptype, day:state.day});
  state.people = people||[]; state.shifts = shifts||[]; state.codes = codes||[];
  state.matrixDay = {};
  (state.people||[]).forEach(p=>{
    state.matrixDay[p.id] = {};
    (state.shifts||[]).forEach(s=> state.matrixDay[p.id][s]='');
  });
  (records||[]).forEach(r=>{
    if(state.matrixDay[r.person_id] && state.matrixDay[r.person_id][r.shift]!==undefined){
      state.matrixDay[r.person_id][r.shift] = r.code||'';
    }
  });
  renderLegend();
  renderGridDay();
  await checkPrevDayWarning();
}

function renderMonthlyGrid(){
  const container = $('#summaryGrid'); container.innerHTML='';
  if(!state.monthPeople.length){ container.innerHTML = `<div style="padding:12px;color:#666">Aucune donnée à afficher.</div>`; return; }

  const table = document.createElement('table');
  const thead = document.createElement('thead');

  const tr1 = document.createElement('tr');
  tr1.appendChild(document.createElement('th'));

  const weekendFlags = [];
  (state.monthDays||[]).forEach(d=>{
    const th1 = document.createElement('th');
    th1.innerHTML = dayLabel(d);
    th1.colSpan = (state.monthShifts||[]).length;
    th1.style.minWidth = (state.monthShifts.length>2? 64 : 44)+'px';
    const isW = isWeekendISO(d);
    weekendFlags.push(isW);
    if(isW) th1.classList.add('weekend');
    tr1.appendChild(th1);
  });
  thead.appendChild(tr1);

  const tr2 = document.createElement('tr');
  tr2.appendChild(th(''));
  (state.monthDays||[]).forEach((d, idx)=>{
    (state.monthShifts||[]).forEach(s=>{
      const th2 = th(sShort(s));
      if(weekendFlags[idx]) th2.classList.add('weekend');
      tr2.appendChild(th2);
    });
  });
  thead.appendChild(tr2);
  table.appendChild(thead);

  const map = new Map();
  (state.monthRecords||[]).forEach(r=> map.set(`${r.person_id}|${r.date}|${r.shift}`, r.code || ''));

  const tbody = document.createElement('tbody');
  (state.monthPeople||[]).forEach(p=>{
    const tr = document.createElement('tr');
    const name = `${(p.nom||'').toUpperCase()}<br><span class="sub">${p.prenom||''}</span>`;
    const thn = th(name); thn.className='sticky'; tr.appendChild(thn);

    (state.monthDays||[]).forEach((d, idx)=>{
      const isW = weekendFlags[idx];
      (state.monthShifts||[]).forEach(s=>{
        const td = document.createElement('td'); 
        td.className='cell';
        if(isW){
          td.classList.add('weekend');
          td.textContent = '';
        }else{
          const code = map.get(`${p.id}|${d}|${s}`) || '';
          td.dataset.code = code;
          td.textContent = code;
          const color = (state.monthCodes||[]).find(c=>c.code===code)?.couleur_hex || '';
          td.style.backgroundColor = color || ''; 
          td.style.color = color ? '#fff' : '';
        }
        tr.appendChild(td);
      });
    });

    tbody.appendChild(tr);
  });

  table.appendChild(tbody);
  container.appendChild(table);
}
function renderTotalsChips(rows){
  const wrap = $('#summaryTotals'); wrap.innerHTML='';
  if(!rows || !rows.length){ wrap.innerHTML = `<div style="padding:12px;color:#666">Aucun total.</div>`; return; }
  const container = document.createElement('div');
  rows.forEach(r=>{
    const chips = [];
    if((r.P||0)>0) chips.push(`<span class="chip">P: ${r.P}</span>`);
    if((r.CP||0)>0) chips.push(`<span class="chip">CP: ${r.CP}</span>`);
    if((r.SS||0)>0) chips.push(`<span class="chip">SS: ${r.SS}</span>`);
    if((r.F||0)>0) chips.push(`<span class="chip">F: ${r.F}</span>`);
    const line = `
      <div style="display:flex;align-items:center;gap:10px;padding:8px 12px;border-top:1px solid var(--line)">
        <div style="min-width:220px;"><b>${r.nom?.toUpperCase()||''}</b> <span class="sub">${r.prenom||''}</span> — <span class="sub">${r.magasin||''} · ${r.type||''}</span></div>
        <div class="chips">${chips.join(' ') || '<span class="sub">Aucun code utilisé ce mois</span>'}</div>
      </div>`;
    container.insertAdjacentHTML('beforeend', line);
  });
  wrap.appendChild(container);
}
async function loadMonthly(){
  const {people, days, shifts, codes, records} = await apiGet({action:'init', store:state.store, type:state.ptype, month:state.month});
  state.monthPeople=people||[]; state.monthDays=days||[]; state.monthShifts=shifts||[]; state.monthCodes=codes||[]; state.monthRecords=records||[];
  renderMonthlyGrid();
  const totals = await apiGet({action:'summary', store:state.store, type:state.ptype, month:state.month});
  renderTotalsChips(totals.rows||[]);
}

function getAdminCode(){ return localStorage.getItem('pres_admin_code') || ''; }
function setAdminCode(code){ localStorage.setItem('pres_admin_code', code||''); }

async function loadLeaves(){
  const code = getAdminCode();
  if(!code){ $('#leavesList').innerHTML = `<div class="sectionLoading">Saisis le code pour afficher les demandes.</div>`; return; }

  $('#leavesList').innerHTML = `<div class="sectionLoading"><span class="spinner"></span> Chargement des demandes…</div>`;
  const store = $('#filterStore').value || '';
  const month = $('#filterMonth').value || '';
  try{
    const data = await apiGet({action:'leaves', status:'EN_ATTENTE', store:store||'ALL', month:month||''}, {'X-Admin-Code': code});
    const rows = data.rows||[];
    if(rows.length===0){
      $('#leavesList').innerHTML = `<div class="sectionLoading">Aucune demande en attente.</div>`;
      return;
    }
    const wrap = document.createElement('div'); wrap.className='cards';
    rows.forEach(r=>{
      const div = document.createElement('div'); div.className='card';
      div.innerHTML = `
        <h3>${(r.nom||'').toUpperCase()} ${r.prenom||''}</h3>
        <div class="rowmeta">${r.magasin||''} · ${r.service||''} · ${r.email||''}</div>
        <div>Du <b>${r.date_du}</b> au <b>${r.date_au}</b> – ${r.nb_jours||0} jour(s)</div>
        <div class="actions" style="margin-top:10px">
          <button class="ok" data-id="${r.id}">Accepter</button>
          <button class="no" data-id="${r.id}">Refuser</button>
        </div>`;
      wrap.appendChild(div);
    });
    const box = $('#leavesList'); box.innerHTML=''; box.appendChild(wrap);

    $$('#leavesList .ok').forEach(b=> b.onclick = ()=> decideLeave(b.dataset.id, 'ACCEPTE'));
    $$('#leavesList .no').forEach(b=> b.onclick = ()=> decideLeave(b.dataset.id, 'REFUSE'));
  }catch(e){
    $('#leavesList').innerHTML = `<div class="sectionLoading">Erreur: ${e.message}</div>`;
  }
}
async function decideLeave(id, decision){
  const code = getAdminCode(); if(!code) return alert('Code manquant.');
  try{
    showLoading();
    const res = await apiPost({action:'leave_decide', id, decision}, {'X-Admin-Code': code});
    if(res?.accepted){
      await loadLeaves();
      await loadDay();
      alert('Congé accepté et ajouté aux présences (CP).');
    }else if(res?.refused){
      await loadLeaves();
      alert('Demande refusée.');
    }else{
      alert('Action non appliquée: ' + (res?.error||''));
    }
  }catch(e){
    alert('Échec: ' + e.message);
  }finally{
    hideLoading();
  }
}

$('.tab[data-tab="saisie"]').onclick = ()=> setActiveTab('saisie');
$('.tab[data-tab="resume"]').onclick = async ()=>{
  setActiveTab('resume');
  if(state.store && state.ptype && state.month){
    setSectionLoading('#summaryGrid','Chargement du résumé…');
    showLoading();
    try{ await loadMonthly(); }
    catch(e){ console.error(e); alert('Erreur chargement résumé : '+e.message); }
    finally{ hideLoading(); }
  } else {
    $('#summaryGrid').innerHTML = `<div style="padding:12px;color:#666">Choisis magasin / type / mois puis clique <b>Charger</b>.</div>`;
    $('#summaryTotals').innerHTML = '';
  }
};
$('.tab[data-tab="conges"]').onclick = async ()=>{
  setActiveTab('conges');
  if(!$('#filterStore').innerHTML.trim()){
    const stores = (await apiGet({action:'stores'})).stores || [];
    $('#filterStore').innerHTML = ['ALL', ...stores].map(s=>`<option>${s}</option>`).join('');
    const now = new Date();
    $('#filterMonth').value = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`;
  }
  await loadLeaves();
};

$('#saveAdminCode').onclick = ()=>{
  const v = $('#adminCode').value.trim();
  setAdminCode(v);
  loadLeaves();
};
$('#refreshLeaves').onclick = ()=> loadLeaves();

/* Saisie rapide */
$('#fillP').onclick = ()=> applyAllDay('P');
$('#fillEmpty').onclick = ()=>{
  if(selectedCells.size){ setCodesOnTargets(''); }
  else{ applyAllDay(''); }
};

$('#save').onclick = async ()=>{
  try{
    if(!state.store || !state.ptype || !state.day){ alert('Sélectionne magasin / type / jour.'); return; }
    showLoading();
    const res = await apiPost({action:'saveDay', store:state.store, type:state.ptype, day:state.day, matrix:state.matrixDay});
    if(res?.ok){ alert('Présences enregistrées ✔'); }
    else{ throw new Error(res?.error||'Erreur inconnue'); }
  }catch(e){ console.error(e); alert("Échec de l'enregistrement : "+e.message); }
  finally{ hideLoading(); }
};

async function triggerLoad(){
  state.store = $('#store').value;
  state.ptype = $('#ptype').value || 'EMPLOYE';
  state.day   = $('#day').value;
  state.month = $('#month').value;

  if(!state.store || !state.ptype){ alert('Sélectionne magasin et type.'); return; }
  if(!state.day){ const today=new Date().toISOString().slice(0,10); state.day=today; $('#day').value=today; }
  if(!state.month){ setMonthFromDay(); }

  setSectionLoading('#gridDay','Chargement des présences…');
  if(currentTab()==='resume'){ setSectionLoading('#summaryGrid','Chargement du résumé…'); }
  showLoading();

  try{
    await loadDay();
    if(currentTab()==='resume'){ await loadMonthly(); }
  }catch(e){
    console.error('InitDay error', e);
    alert("Échec du chargement (réseau/API). Vérifie l’URL API.");
  } finally {
    hideLoading();
  }
}
$('#load').onclick = triggerLoad;
$('#store').addEventListener('change', triggerLoad);
$('#ptype').addEventListener('change', triggerLoad);

$('#exportCsv').onclick = async ()=>{
  const btn = $('#exportCsv');
  const msg = $('#exportMsg');
  const setMsg = (t)=> msg.textContent = t || '';
  const finishOk = ()=>{ btn.disabled = false; setMsg('Export terminé ✔'); setTimeout(()=> setMsg(''), 2000); };
  const finishKo = ()=>{ btn.disabled = false; setMsg('Échec export'); setTimeout(()=> setMsg(''), 3000); };

  try{
    btn.disabled = true;
    setMsg('Export en cours…');

    const month = $('#month').value;
    const ptype = $('#ptype').value || 'EMPLOYE';
    const storesResp = await apiGet({action:'stores'});
    const stores = (storesResp.stores && storesResp.stores.length) ? storesResp.stores : [$('#store').value];

    const wb = XLSX.utils.book_new();

    for(const store of stores){
      const {people, days, shifts, records} = await apiGet({action:'init', store, type:ptype, month});

      const recMap = new Map();
      (records||[]).forEach(r=>{
        recMap.set(`${r.person_id}|${r.date}|${r.shift}`, r.code || '');
      });

      const header = ['Magasin','Type','Nom','Prénom'];
      (days||[]).forEach(d=> header.push(formatDateHeader(d)));
      header.push('P','CP','SS','F','Total P');

      const rowsPeople = (people||[]).slice().sort((a,b)=>{
        const na=(a.nom||'').localeCompare(b.nom||'', 'fr', {sensitivity:'base'});
        return na!==0 ? na : (a.prenom||'').localeCompare(b.prenom||'', 'fr', {sensitivity:'base'});
      });

      const data = [header];

      for(const p of rowsPeople){
        const row = [store, (p.type||ptype)||'', (p.nom||'').toUpperCase(), p.prenom||''];

        const counts = {P:0, CP:0, SS:0, F:0};
        for(const d of (days||[])){
          const codes = (shifts||[]).map(s=> recMap.get(`${p.id}|${d}|${s}`) || '').filter(Boolean);
          row.push(codes.join('/'));
          codes.forEach(c=>{ if(counts[c]!==undefined) counts[c] += 1; });
        }
        row.push(counts.P||0, counts.CP||0, counts.SS||0, counts.F||0, counts.P||0);
        data.push(row);
      }

      const ws = XLSX.utils.aoa_to_sheet(data);
      ws['!cols'] = header.map(h=>{
        if(['Magasin','Type'].includes(h)) return {wch:12};
        if(['Nom','Prénom'].includes(h))   return {wch:16};
        if(['P','CP','SS','F','Total P'].includes(h)) return {wch:8};
        return {wch:10};
      });
      XLSX.utils.book_append_sheet(wb, ws, String(store).slice(0,31) || 'Feuille');
    }

    const fname = `presences_${ptype}_${month}.xlsx`;

    try{
      const wbArray = XLSX.write(wb, {bookType:'xlsx', type:'array'});
      const blob = new Blob([wbArray], {type:'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = fname;
      a.rel = 'noopener';
      document.body.appendChild(a);
      a.click();
      setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); }, 0);
    }catch(_){ /* ignore */ }

    try{
      const base64 = XLSX.write(wb, {bookType:'xlsx', type:'base64'});
      window.parent?.postMessage({
        type: 'DOWNLOAD_FILE',
        filename: fname,
        mime: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
        base64
      }, '*');
    }catch(_){ /* ignore */ }

    finishOk();
  }catch(e){
    console.error(e);
    alert('Export Excel impossible : ' + e.message);
    finishKo();
  }
};

(async function(){
  const now = new Date();
  const todayISO = now.toISOString().slice(0,10);
  $('#day').value = todayISO;
  $('#month').value = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`;
  $('#ptype').value = 'EMPLOYE';

  try{
    const stores = (await apiGet({action:'stores'})).stores || ['GLEIZE','VILLEFRANCHE','LYON'];
    $('#store').innerHTML = stores.map(s=>`<option>${s}</option>`).join('');
  }catch(e){
    console.error('Stores: échec', e);
    $('#store').innerHTML = ['GLEIZE','VILLEFRANCHE','LYON'].map(s=>`<option>${s}</option>`).join('');
  }

  if(!$('#store').value){
    const first = $('#store').querySelector('option')?.value || '';
    if(first) $('#store').value = first;
  }
  await triggerLoad();
})();
</script>
</body>
</html>