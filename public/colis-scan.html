<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Livraison — Scan colis</title>
  <style>
    body{font-family:system-ui,Segoe UI,Roboto,Arial;margin:0;background:#f6f7fb;color:#111}
    header{padding:12px 14px;background:#111;color:#fff}
    header .sub{opacity:.85;font-size:12px;margin-top:4px}
    .wrap{padding:14px;max-width:680px;margin:auto}
    .card{background:#fff;border:1px solid #e3e6f0;border-radius:18px;padding:14px;box-shadow:0 4px 14px rgba(0,0,0,.04)}
    input{width:100%;padding:14px 12px;border:1px solid #d7dbe7;border-radius:14px;font-size:18px}
    .row{display:flex;gap:10px;margin-top:10px}
    button{flex:1;padding:16px 12px;border-radius:16px;border:0;font-weight:900;font-size:16px;cursor:pointer}
    .btnA{background:#cfe8ff}
    .btnB{background:#c9f2d2}
    .meta{font-size:12px;color:#556;margin-top:8px}
    .pill{display:inline-block;padding:6px 10px;border-radius:999px;background:#eee;font-weight:800;font-size:12px}
    ul{list-style:none;padding:0;margin:10px 0 0 0}
    li{padding:10px 0;border-bottom:1px dashed #eef0f6;display:flex;justify-content:space-between;gap:10px}
    .ok{font-weight:900}
  </style>
</head>
<body>
<header>
  <div><b>Scan colis</b></div>
  <div class="sub" id="who"></div>
</header>

<div class="wrap">
  <div class="card">
    <div class="meta">
      Paramètres URL requis :
      <span class="pill">magasin</span>
      <span class="pill">tourneeId</span>
      <span class="pill">livreurId</span>
    </div>

    <div style="margin-top:10px">
      <input id="bl" inputmode="numeric" placeholder="Scanner ou saisir le BL…" />
      <div class="row">
        <button class="btnA" id="loadBtn">JE CHARGE</button>
        <button class="btnB" id="delBtn">JE LIVRE</button>
      </div>
      <div class="meta" id="msg"></div>
    </div>

    <div style="margin-top:12px">
      <div class="meta"><b>Mes colis (session)</b> — Restant: <span id="rest" class="pill">0</span></div>
      <ul id="list"></ul>
    </div>
  </div>
</div>

<script>
  const $ = s => document.querySelector(s);
  const qs = new URLSearchParams(location.search);
  const magasin = (qs.get("magasin")||"").trim();
  const tourneeId = (qs.get("tourneeId")||"").trim();
  const livreurId = (qs.get("livreurId")||"").trim();

  $("#who").textContent = `Magasin: ${magasin} — Tournée: ${tourneeId} — Livreur: ${livreurId}`;

  const session = new Map(); // bl -> statut ("VALIDE"|"LIVRE")

  function cleanBL(v){ return String(v||"").trim().replace(/[^\d]/g,""); }
  function setMsg(t){ $("#msg").textContent = t; }
  function render(){
    const list = $("#list");
    list.innerHTML = "";
    let restant = 0;
    for (const [bl, st] of session.entries()) {
      if (st !== "LIVRE") restant++;
      const li = document.createElement("li");
      li.innerHTML = `<span>${bl}</span><span class="ok">${st}</span>`;
      list.appendChild(li);
    }
    $("#rest").textContent = restant;

    // si plus rien à livrer => on vide l’écran (comme tu veux)
    if (session.size && restant === 0) {
      setMsg("✅ Tout est livré. La liste va disparaître.");
      setTimeout(() => {
        session.clear();
        render();
        setMsg("");
      }, 1500);
    }
  }

  async function post(url, body){
    const r = await fetch(url, { method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify(body||{}) });
    return await r.json();
  }

  async function validate(mode){
    if (!magasin || !tourneeId || !livreurId) { setMsg("❌ Paramètres manquants dans l’URL"); return; }
    const bl = cleanBL($("#bl").value);
    if (!bl) { setMsg("❌ BL vide"); return; }

    $("#bl").value = "";
    $("#bl").focus();

    try {
      if (mode === "VALIDER") {
        const j = await post("/api/colis/valider", { magasin, tourneeId, livreurId, bl });
        session.set(bl, "VALIDE");
        setMsg(j.created ? "✅ Ajout hors liste + validé" : "✅ Validé");
      } else {
        const j = await post("/api/colis/livrer", { magasin, tourneeId, livreurId, bl });
        session.set(bl, "LIVRE");
        setMsg("✅ Livré");
      }
      render();
    } catch (e) {
      setMsg("❌ Erreur réseau");
    }
  }

  $("#loadBtn").addEventListener("click", () => validate("VALIDER"));
  $("#delBtn").addEventListener("click", () => validate("LIVRER"));

  // Enter = Valider (rapide au magasin)
  $("#bl").addEventListener("keydown", (e) => {
    if (e.key === "Enter") validate("VALIDER");
  });

  render();
  $("#bl").focus();
</script>
</body>
</html>
